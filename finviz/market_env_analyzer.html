<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Macro</title>
    <link rel="shortcut icon" href="./macro.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #718096;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .index-section {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .index-group {
            flex: 1;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        select, input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .clear-btn {
            background: white;
            color: #e53e3e;
            border: 2px solid #e53e3e;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            align-self: flex-end;
        }
        
        .clear-btn:hover {
            background: #e53e3e;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            align-items: start;
        }
        
        .left-column {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        .right-column {
            position: sticky;
            top: 20px;
        }
        
        .section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }
        
        .section-title {
            color: #2d3748;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-number {
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .result-box {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #667eea;
        }
        
        .result-label {
            font-size: 12px;
            color: #718096;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .result-value {
            font-size: 16px;
            color: #2d3748;
            font-weight: 700;
        }
        
        .env-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-height: 400px;
        }
        
        .env-label h2 {
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .env-label .tag {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .env-label .main-tag {
            background: white;
            color: #667eea;
            font-size: 18px;
            padding: 12px 24px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        
        .interpretation {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .score-positive {
            color: #48bb78;
            font-weight: 700;
        }
        
        .score-negative {
            color: #f56565;
            font-weight: 700;
        }
        
        .score-neutral {
            color: #ed8936;
            font-weight: 700;
        }
        
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .right-column {
                position: static;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="index-section">
                <div class="index-group">
                    <label for="indexSelect">é€‰æ‹©æŒ‡æ•° Index</label>
                    <select id="indexSelect">
                        <option value="500">S&P 500</option>
                        <option value="100">NASDAQ 100</option>
                    </select>
                </div>
                <button class="clear-btn" onclick="clearAll()">æ¸…ç©º</button>
            </div>
        </div>
        
        <div class="main-layout">
            <div class="left-column">
                <!-- 1. å¹¿åº¦ -->
                <div class="section">
                    <div class="section-title">
                        <span class="section-number">1</span>
                        å¹¿åº¦åˆ†æ
                    </div>
                    <div class="input-group">
                        <div>
                            <label for="above50dma">Price above SMA50 (æ•°é‡)</label>
                            <input type="number" id="above50dma" min="0" step="1">
                            <div id="above50dma_pct" style="font-size: 12px; color: #667eea; font-weight: 600; margin-top: 4px; min-height: 18px;"></div>
                        </div>
                        <div>
                            <label for="above200dma">Price above SMA200 (æ•°é‡)</label>
                            <input type="number" id="above200dma" min="0" step="1">
                            <div id="above200dma_pct" style="font-size: 12px; color: #667eea; font-weight: 600; margin-top: 4px; min-height: 18px;"></div>
                        </div>
                        <div>
                            <label for="b50_5d_ago">B50 5å¤©å‰ (%)</label>
                            <input type="number" id="b50_5d_ago" min="0" max="100" step="0.1">
                        </div>
                    </div>
                    <div class="result-box" id="breadthResult">
                        <div class="result-label">å¹¿åº¦è¯„ä¼°</div>
                        <div class="result-value">ç­‰å¾…è¾“å…¥æ•°æ®...</div>
                    </div>
                </div>
                
                <!-- 2. æ–°é«˜æ–°ä½ -->
                <div class="section">
                    <div class="section-title">
                        <span class="section-number">2</span>
                        æ–°é«˜/æ–°ä½æ‰©æ•£ï¼ˆæ¸©åº¦è®¡ï¼‰
                    </div>
                    <div class="input-group">
                        <div>
                            <label for="newHigh">New High (æ•°é‡)</label>
                            <input type="number" id="newHigh" min="0" step="1">
                        </div>
                        <div>
                            <label for="newLow">New Low (æ•°é‡)</label>
                            <input type="number" id="newLow" min="0" step="1">
                        </div>
                    </div>
                    <div class="result-box" id="hlResult">
                        <div class="result-label">æ–°é«˜æ–°ä½åˆ†æ</div>
                        <div class="result-value">ç­‰å¾…è¾“å…¥æ•°æ®...</div>
                    </div>
                </div>
                
                <!-- 3. æˆäº¤é‡/æ³¢åŠ¨ -->
                <div class="section">
                    <div class="section-title">
                        <span class="section-number">3</span>
                        æˆäº¤é‡/æ³¢åŠ¨æ¸©åº¦
                    </div>
                    <div class="input-group">
                        <div>
                            <label for="relativeVol">Relative Volume (æ•°é‡ Nrv)</label>
                            <input type="number" id="relativeVol" min="0" step="1">
                        </div>
                        <div>
                            <label for="over2pct">Volatility Over 2% (æ•°é‡)</label>
                            <input type="number" id="over2pct" min="0" step="1">
                        </div>
                        <div>
                            <label for="over3pct">Volatility Over 3% (æ•°é‡)</label>
                            <input type="number" id="over3pct" min="0" step="1">
                        </div>
                        <div>
                            <label for="over4pct">Volatility Over 4% (æ•°é‡)</label>
                            <input type="number" id="over4pct" min="0" step="1">
                        </div>
                    </div>
                    <div class="result-box" id="volResult">
                        <div class="result-label">æˆäº¤é‡/æ³¢åŠ¨åˆ†æ</div>
                        <div class="result-value">ç­‰å¾…è¾“å…¥æ•°æ®...</div>
                    </div>
                </div>
                
                <!-- 4. æ¿å—æ—‹è½¬ -->
                <div class="section">
                    <div class="section-title">
                        <span class="section-number">4</span>
                        è¡Œä¸š/æ¿å—ç›¸å¯¹å¼ºå¼±
                    </div>
                    <div class="input-group">
                        <div>
                            <label for="sectorRotation">æ¿å—åˆ†åŒ–ç¨‹åº¦</label>
                            <select id="sectorRotation">
                                <option value="">è¯·é€‰æ‹©...</option>
                                <option value="concentrated">å¼ºæ¿å—é›†ä¸­ï¼ˆè¶‹åŠ¿æ˜æ˜¾ï¼‰</option>
                                <option value="moderate">æ¿å—åˆ†åŒ–æ¸©å’Œï¼ˆæ¶¨è·Œæ¸©å’Œï¼‰</option>
                                <option value="dispersed">æ¿å—é«˜åº¦åˆ†åŒ–ï¼ˆæ—‹è½¬å¸‚ï¼‰</option>
                            </select>
                        </div>
                    </div>
                    <div class="result-box" id="sectorResult">
                        <div class="result-label">æ¿å—åˆ†æ</div>
                        <div class="result-value">ç­‰å¾…é€‰æ‹©...</div>
                    </div>
                </div>
                
                <!-- 5. è´¢æŠ¥å¯†åº¦ -->
                <div class="section">
                    <div class="section-title">
                        <span class="section-number">5</span>
                        äº‹ä»¶æµ“åº¦ï¼ˆè´¢æŠ¥å‘¨å¯†åº¦ï¼‰
                    </div>
                    <div class="input-group">
                        <div>
                            <label for="earningsNext5">Earnings Next 5 Days (æ•°é‡)</label>
                            <input type="number" id="earningsNext5" min="0" step="1">
                        </div>
                        <div>
                            <label for="earningsPrev5">Earnings Previous 5 Days (æ•°é‡)</label>
                            <input type="number" id="earningsPrev5" min="0" step="1">
                        </div>
                    </div>
                    <div class="result-box" id="earningsResult">
                        <div class="result-label">è´¢æŠ¥å¯†åº¦åˆ†æ</div>
                        <div class="result-value">ç­‰å¾…è¾“å…¥æ•°æ®...</div>
                    </div>
                </div>
            </div>
            
            <div class="right-column">
                <!-- ç¯å¢ƒæ ‡ç­¾ -->
                <div class="env-label" id="envLabel">
                    <h2>ğŸ¯ ç¯å¢ƒæ ‡ç­¾</h2>
                    <div class="main-tag">ç­‰å¾…æ•°æ®è¾“å…¥...</div>
                    <div class="interpretation">
                        è¯·å¡«å†™å·¦ä¾§å„é¡¹æŒ‡æ ‡æ•°æ®ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—å¹¶æ˜¾ç¤ºå½“å‰å¸‚åœºç¯å¢ƒæ ‡ç­¾ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function getT() {
            return parseInt(document.getElementById('indexSelect').value);
        }
        
        function clearAll() {
            document.getElementById('above50dma').value = '';
            document.getElementById('above200dma').value = '';
            document.getElementById('b50_5d_ago').value = '';
            document.getElementById('newHigh').value = '';
            document.getElementById('newLow').value = '';
            document.getElementById('relativeVol').value = '';
            document.getElementById('over2pct').value = '';
            document.getElementById('over3pct').value = '';
            document.getElementById('over4pct').value = '';
            document.getElementById('sectorRotation').value = '';
            document.getElementById('earningsNext5').value = '';
            document.getElementById('earningsPrev5').value = '';
            updateAll();
        }
        
        function updateBreadthPercentages() {
            const T = getT();
            const count50 = parseInt(document.getElementById('above50dma').value);
            const count200 = parseInt(document.getElementById('above200dma').value);
            
            const pct50Div = document.getElementById('above50dma_pct');
            const pct200Div = document.getElementById('above200dma_pct');
            
            if (!isNaN(count50) && count50 >= 0) {
                const pct50 = (count50 / T * 100).toFixed(1);
                pct50Div.textContent = '= ' + pct50 + '%';
            } else {
                pct50Div.textContent = '';
            }
            
            if (!isNaN(count200) && count200 >= 0) {
                const pct200 = (count200 / T * 100).toFixed(1);
                pct200Div.textContent = '= ' + pct200 + '%';
            } else {
                pct200Div.textContent = '';
            }
        }
        
        function analyzeBreadth() {
            const T = getT();
            const count50 = parseInt(document.getElementById('above50dma').value);
            const count200 = parseInt(document.getElementById('above200dma').value);
            const b50_5d_ago = parseFloat(document.getElementById('b50_5d_ago').value);
            
            if (isNaN(count50) || isNaN(count200)) {
                return {
                    html: 'ç­‰å¾…è¾“å…¥æ•°æ®...',
                    score: 0,
                    type: 'neutral',
                    B50: null,
                    B200: null,
                    S: null,
                    delta50: null
                };
            }
            
            const B50 = parseFloat((count50 / T * 100).toFixed(1));
            const B200 = parseFloat((count200 / T * 100).toFixed(1));
            const S = parseFloat((B50 - B200).toFixed(1));
            const delta50 = !isNaN(b50_5d_ago) ? parseFloat((B50 - b50_5d_ago).toFixed(1)) : null;
            
            let result = '';
            let score = 0;
            let type = 'neutral';
            
            let indicators = '<div style="font-size: 13px; color: #4a5568; margin-top: 8px; padding: 8px; background: #edf2f7; border-radius: 4px;">';
            indicators += '<strong>è¡ç”ŸæŒ‡æ ‡ï¼š</strong> S (ä»·å·®) = ' + S + 'pp';
            if (delta50 !== null) {
                indicators += ' | Î”50 (å˜åŒ–ç‡) = ' + (delta50 > 0 ? '+' : '') + delta50 + 'pp';
            }
            indicators += '</div>';
            
            if (B50 > 60 || B200 > 60) {
                result = '<span class="score-positive">å¹¿åº¦å¥½ âœ“</span><br>%>50DMA: ' + B50 + '% (' + count50 + '/' + T + ')<br>%>200DMA: ' + B200 + '% (' + count200 + '/' + T + ')<br>å"æ­£Gamma/åŒºé—´/é’‰ä½"ç¯å¢ƒ' + indicators;
                score = 1;
                type = 'positive';
            } else if (B50 < 40 || B200 < 40) {
                result = '<span class="score-negative">å¹¿åº¦å·® âœ—</span><br>%>50DMA: ' + B50 + '% (' + count50 + '/' + T + ')<br>%>200DMA: ' + B200 + '% (' + count200 + '/' + T + ')<br>å"è´ŸGamma/è¶‹åŠ¿/å°¾éƒ¨"ç¯å¢ƒ' + indicators;
                score = -1;
                type = 'negative';
            } else {
                result = '<span class="score-neutral">å¹¿åº¦ä¸´ç•Œ ~</span><br>%>50DMA: ' + B50 + '% (' + count50 + '/' + T + ')<br>%>200DMA: ' + B200 + '% (' + count200 + '/' + T + ')<br>å¤„äº40-60%çœŸç©ºåŒº' + indicators;
                score = 0;
                type = 'critical';
            }
            
            return { html: result, score: score, type: type, B50: B50, B200: B200, S: S, delta50: delta50 };
        }
        
        function analyzeHL() {
            const T = getT();
            const NH = parseInt(document.getElementById('newHigh').value);
            const NL = parseInt(document.getElementById('newLow').value);
            
            if (isNaN(NH) || isNaN(NL)) {
                return {
                    html: 'ç­‰å¾…è¾“å…¥æ•°æ®...',
                    score: 0,
                    type: 'neutral',
                    NH: null,
                    NL: null,
                    r: null,
                    S_NHNL: null
                };
            }
            
            const S_NHNL = NH + NL;
            const r = S_NHNL > 0 ? parseFloat((NH / S_NHNL).toFixed(2)) : 0;
            const d = NH - NL;
            const pH = ((NH / T) * 100).toFixed(1);
            const pL = ((NL / T) * 100).toFixed(1);
            
            let label = '';
            let interpretation = '';
            let score = 0;
            let type = 'neutral';
            
            let indicators = '<div style="font-size: 13px; color: #4a5568; margin-top: 8px; padding: 8px; background: #edf2f7; border-radius: 4px;">';
            indicators += '<strong>è¡ç”ŸæŒ‡æ ‡ï¼š</strong> r (å¤±è¡¡æ¯”) = ' + r + ' | S_NHNL (æ´»è·ƒåº¦) = ' + S_NHNL;
            indicators += '</div>';
            
            if (NH >= 40 && NH >= 2 * NL) {
                label = '<span class="score-positive">å¼ºå¤š â†‘â†‘</span>';
                interpretation = 'æ–°é«˜æ˜¾è‘—å ä¼˜ï¼Œä¸Šè¡ŒåŠ¨é‡å¼º';
                score = 2;
                type = 'positive';
            } else if (NL >= 40 && NL >= 2 * NH) {
                label = '<span class="score-negative">å¼ºç©º â†“â†“</span>';
                interpretation = 'æ–°ä½æ˜¾è‘—å ä¼˜ï¼Œä¸‹è¡Œé£é™©é«˜';
                score = -2;
                type = 'negative';
            } else if (NH >= 25 && NH <= 39 && d >= 10) {
                label = '<span class="score-positive">è½»å¤š â†‘</span>';
                interpretation = 'åå¤šä½†ä¸æç«¯ï¼Œé¡ºåŠ¿æ›´å®¹æ˜“ä½†è°¨æ…è¿½';
                score = 1;
                type = 'positive';
            } else if (NL >= 25 && NL <= 39 && (NL - NH) >= 10) {
                label = '<span class="score-negative">è½»ç©º â†“</span>';
                interpretation = 'åç©ºï¼Œä¸‹è¡Œå‹åŠ›å­˜åœ¨';
                score = -1;
                type = 'negative';
            } else if ((NH <= 10 && NL <= 10) || S_NHNL <= 20) {
                label = '<span class="score-positive">åŒºé—´ â”€</span>';
                interpretation = 'æ–°é«˜æ–°ä½éƒ½å°‘ï¼ŒåŒºé—´/ç¼©æ³¢æ¦‚ç‡â†‘ï¼ˆå–æ³¢å‹å¥½ï¼‰';
                score = 1;
                type = 'positive';
            } else if (S_NHNL >= 50 && Math.abs(d) < 10) {
                label = '<span class="score-neutral">æ—‹è½¬ âŸ²</span>';
                interpretation = 'ä¸¤å¤´éƒ½å¤šï¼Œå¸‚åœºåˆ†åŒ–ï¼Œé€‰è‚¡éš¾åº¦â†‘';
                score = 0;
                type = 'neutral';
            } else {
                label = '<span class="score-neutral">ä¸­æ€§</span>';
                interpretation = 'æ— æ˜æ˜¾ç‰¹å¾';
                score = 0;
                type = 'neutral';
            }
            
            const result = label + '<br>NH=' + NH + ', NL=' + NL + ', d=' + d + '<br>NHå æ¯”=' + pH + '%, NLå æ¯”=' + pL + '%<br>' + interpretation + indicators;
            
            return { html: result, score: score, type: type, NH: NH, NL: NL, r: r, S_NHNL: S_NHNL };
        }
        
        function analyzeVolatility() {
            const T = getT();
            const Nrv = parseInt(document.getElementById('relativeVol').value);
            const C2 = parseInt(document.getElementById('over2pct').value);
            const C3 = parseInt(document.getElementById('over3pct').value);
            const C4 = parseInt(document.getElementById('over4pct').value);
            
            if (isNaN(Nrv) || isNaN(C2) || isNaN(C3) || isNaN(C4)) {
                return {
                    html: 'ç­‰å¾…è¾“å…¥æ•°æ®...',
                    score: 0,
                    type: 'neutral',
                    L2: null,
                    H4: null
                };
            }
            
            const volRatio = ((Nrv / T) * 100).toFixed(1);
            const L2 = parseFloat(((T - C2) / T * 100).toFixed(1));
            const v2to3 = ((C2 - C3) / T * 100).toFixed(1);
            const v3to4 = ((C3 - C4) / T * 100).toFixed(1);
            const H4 = parseFloat(((C4 / T) * 100).toFixed(1));
            
            const sumMidHigh = parseFloat(v2to3) + parseFloat(v3to4) + H4;
            
            let indicators = '<div style="font-size: 13px; color: #4a5568; margin-top: 8px; padding: 8px; background: #edf2f7; border-radius: 4px;">';
            indicators += '<strong>è¡ç”ŸæŒ‡æ ‡ï¼š</strong> L2 (ä½æ³¢å æ¯”) = ' + L2 + '% | H4 (é«˜æ³¢å æ¯”) = ' + H4 + '%';
            indicators += '</div>';
            
            let label = '';
            let score = 0;
            let type = 'neutral';
            
            const isRange = L2 >= 45 && L2 <= 55 && H4 <= 20 && parseFloat(volRatio) <= 10;
            const isTrend = (H4 >= 25 && H4 <= 30) || (sumMidHigh >= 60 && parseFloat(volRatio) >= 20 && parseFloat(volRatio) <= 25);
            
            if (isRange) {
                label = '<span class="score-positive">åŒºé—´/é’‰ä½å€¾å‘ âœ“</span>';
                score = 1;
                type = 'positive';
            } else if (isTrend) {
                label = '<span class="score-negative">è¶‹åŠ¿/å°¾éƒ¨å€¾å‘ âœ—</span>';
                score = -1;
                type = 'negative';
            } else {
                label = '<span class="score-neutral">ä¸´ç•Œ ~</span>';
                score = 0;
                type = 'neutral';
            }
            
            const result = label + '<br>æ”¾é‡å æ¯”: ' + volRatio + '% (' + Nrv + '/' + T + ')<br>æ³¢åŠ¨åˆ†å¸ƒ: â‰¤2%=' + L2 + '%, 2-3%=' + v2to3 + '%, 3-4%=' + v3to4 + '%, â‰¥4%=' + H4 + '%<br>ä¸­é«˜æ³¢åŠ¨åˆè®¡: ' + sumMidHigh.toFixed(1) + '%' + indicators;
            
            return { html: result, score: score, type: type, L2: L2, H4: H4 };
        }
        
        function analyzeSector() {
            const sector = document.getElementById('sectorRotation').value;
            
            if (!sector) {
                return {
                    html: 'ç­‰å¾…é€‰æ‹©...',
                    score: 0,
                    type: 'neutral'
                };
            }
            
            let result = '';
            let score = 0;
            let type = 'neutral';
            
            if (sector === 'concentrated') {
                result = '<span class="score-negative">å¼ºæ¿å—é›†ä¸­ â†’</span><br>è¶‹åŠ¿ç¥¨æ›´æ˜“å»¶ç»­ï¼Œé¡ºåŠ¿æœºä¼š';
                score = -1;
                type = 'negative';
            } else if (sector === 'moderate') {
                result = '<span class="score-positive">æ¿å—åˆ†åŒ–æ¸©å’Œ â”€</span><br>åŒºé—´/å–æ³¢æ›´å ä¼˜';
                score = 1;
                type = 'positive';
            } else {
                result = '<span class="score-neutral">æ¿å—é«˜åº¦åˆ†åŒ– âŸ²</span><br>æ—‹è½¬å¸‚ï¼Œé€‰æ‹©éš¾åº¦é«˜';
                score = 0;
                type = 'neutral';
            }
            
            return { html: result, score: score, type: type };
        }
        
        function analyzeEarnings() {
            const T = getT();
            const next5 = parseInt(document.getElementById('earningsNext5').value);
            const prev5 = parseInt(document.getElementById('earningsPrev5').value);
            
            if (isNaN(next5) || isNaN(prev5)) {
                return {
                    html: 'ç­‰å¾…è¾“å…¥æ•°æ®...',
                    score: 0,
                    type: 'neutral'
                };
            }
            
            const nextRatio = ((next5 / T) * 100).toFixed(1);
            const prevRatio = ((prev5 / T) * 100).toFixed(1);
            
            let result = '';
            let score = 0;
            let type = 'neutral';
            
            if (parseFloat(nextRatio) >= 15) {
                result = '<span class="score-neutral">è´¢æŠ¥å¯†é›†æœŸå°†è‡³ ğŸ“Š</span><br>Next 5å¤©: ' + next5 + ' (' + nextRatio + '%)<br>åšå¤šæ³¢åŠ¨ï¼ˆLong Volï¼‰æœºä¼šå¤š';
                score = 0;
                type = 'neutral';
            } else if (parseFloat(prevRatio) >= 20) {
                result = '<span class="score-positive">è´¢æŠ¥åˆšè¿‡ âœ“</span><br>Previous 5å¤©: ' + prev5 + ' (' + prevRatio + '%)<br>åShort Vol/å–IV Crushåçš„åŒºé—´å›å½’';
                score = 0.5;
                type = 'positive';
            } else if (parseFloat(nextRatio) < 5 && parseFloat(prevRatio) < 5) {
                result = '<span class="score-positive">äº‹ä»¶ç©ºçª—æœŸ âœ“</span><br>Next: ' + next5 + ', Prev: ' + prev5 + '<br>æœ‰åˆ©äºåŒºé—´ç­–ç•¥';
                score = 0.5;
                type = 'positive';
            } else {
                result = '<span class="score-neutral">è´¢æŠ¥å¸¸è§„æœŸ</span><br>Next 5å¤©: ' + next5 + ' (' + nextRatio + '%), Prev 5å¤©: ' + prev5 + ' (' + prevRatio + '%)';
                score = 0;
                type = 'neutral';
            }
            
            return { html: result, score: score, type: type };
        }
        
        function calculateCriticalBias(breadth, hl, vol, sector) {
            if (breadth.type !== 'critical') {
                return null;
            }
            
            const S = breadth.S;
            const delta50 = breadth.delta50;
            const NH = hl.NH;
            const NL = hl.NL;
            const r = hl.r;
            const S_NHNL = hl.S_NHNL;
            const L2 = vol.L2;
            const H4 = vol.H4;
            const sectorValue = document.getElementById('sectorRotation').value;
            
            if (S === null || NH === null || NL === null || r === null || S_NHNL === null || L2 === null || H4 === null) {
                return { label: 'æ•°æ®ä¸å®Œæ•´', type: 'incomplete', reasoning: ['è¯·å®Œå–„æ‰€æœ‰å¿…è¦æ•°æ®'] };
            }
            
            let biasLabel = '';
            let biasType = '';
            let reasoning = [];
            
            const bullish1 = S >= 10;
            const bullish2 = delta50 !== null && delta50 >= 5 && r >= 0.60 && NH >= 20 && H4 <= 20;
            
            if (bullish1 || bullish2) {
                biasLabel = 'åå¤šï¼ˆé£é™©åå¥½æ”¹å–„ï¼‰';
                biasType = 'bullish';
                if (bullish1) reasoning.push('S=' + S + 'pp â‰¥ +10');
                if (bullish2) reasoning.push('Î”50=' + delta50 + 'pp â‰¥ +5 ä¸” r=' + r + ' â‰¥ 0.60 ä¸” NH=' + NH + ' â‰¥ 20 ä¸” H4=' + H4 + '% â‰¤ 20%');
            }
            
            const bearish1 = S <= -10;
            const bearish2 = delta50 !== null && delta50 <= -5 && r <= 0.40 && NL >= 20;
            const bearish3 = H4 >= 25 && H4 <= 30;
            
            if (bearish1 || bearish2 || bearish3) {
                biasLabel = 'åç©ºï¼ˆé£é™©åå¥½èµ°å¼±ï¼‰';
                biasType = 'bearish';
                if (bearish1) reasoning.push('S=' + S + 'pp â‰¤ -10');
                if (bearish2) reasoning.push('Î”50=' + delta50 + 'pp â‰¤ -5 ä¸” r=' + r + ' â‰¤ 0.40 ä¸” NL=' + NL + ' â‰¥ 20');
                if (bearish3) reasoning.push('H4=' + H4 + '% åœ¨ 25-30% èŒƒå›´');
            }
            
            const pinned = L2 >= 50 && H4 <= 20 && S_NHNL <= 20 && Math.abs(S) < 10;
            
            if (pinned && !biasLabel) {
                biasLabel = 'åé’‰ä½ï¼ˆåŒºé—´/æ­£Gammaï¼‰';
                biasType = 'pinned';
                reasoning.push('L2=' + L2 + '% â‰¥ 50% ä¸” H4=' + H4 + '% â‰¤ 20%');
                reasoning.push('S_NHNL=' + S_NHNL + ' â‰¤ 20ï¼ˆæ–°é«˜æ–°ä½éƒ½å°‘ï¼‰');
                reasoning.push('|S|=' + Math.abs(S) + ' < 10pp');
            }
            
            const rotation1 = S_NHNL >= 50 && r >= 0.40 && r <= 0.60;
            const rotation2 = sectorValue === 'dispersed';
            
            if ((rotation1 || rotation2) && !biasLabel) {
                biasLabel = 'æ—‹è½¬/åˆ†åŒ–ï¼ˆé‡é€‰è‚¡ï¼‰';
                biasType = 'rotation';
                if (rotation1) reasoning.push('S_NHNL=' + S_NHNL + ' â‰¥ 50 ä¸” r=' + r + ' åœ¨ 0.40-0.60ï¼ˆä¸¤è¾¹éƒ½å¤šä½†ä¸å¤±è¡¡ï¼‰');
                if (rotation2) reasoning.push('æ¿å—é«˜åº¦åˆ†åŒ–');
            }
            
            if (!biasLabel) {
                biasLabel = 'ä¸´ç•Œï¼ˆæ— æ˜æ˜¾å€¾å‘ï¼‰';
                biasType = 'neutral';
                reasoning.push('æœªæ»¡è¶³ä»»ä½•ç»†åˆ†æ¡ä»¶ï¼Œä¿æŒä¸­æ€§è§‚æœ›');
            }
            
            return {
                label: biasLabel,
                type: biasType,
                reasoning: reasoning
            };
        }
        
        function calculateEnvironment() {
            const breadth = analyzeBreadth();
            const hl = analyzeHL();
            const vol = analyzeVolatility();
            const sector = analyzeSector();
            const earnings = analyzeEarnings();
            
            const totalScore = breadth.score + hl.score + vol.score + sector.score + earnings.score;
            
            let envLabel = '';
            let envColor = '';
            let interpretation = '';
            let subLabel = '';
            
            if (breadth.type === 'critical') {
                const criticalBias = calculateCriticalBias(breadth, hl, vol, sector);
                
                if (criticalBias) {
                    envLabel = 'ä¸´ç•Œ / æ··åˆä¿¡å·';
                    
                    if (criticalBias.type === 'bullish') {
                        envColor = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                        subLabel = 'â†’ ' + criticalBias.label;
                        interpretation = 'âš¡ ' + criticalBias.reasoning.join('<br>âš¡ ') + '<br><br><strong>ç­–ç•¥å»ºè®®ï¼š</strong>é¡ºåŠ¿å»¶ç»­/å¼ºå›æ’¤å¸çº³ï¼Œä½†ä»éœ€æ§åˆ¶ä»“ä½';
                    } else if (criticalBias.type === 'bearish') {
                        envColor = 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)';
                        subLabel = 'â†’ ' + criticalBias.label;
                        interpretation = 'âš¡ ' + criticalBias.reasoning.join('<br>âš¡ ') + '<br><br><strong>ç­–ç•¥å»ºè®®ï¼š</strong>é€¢é«˜è½¬å¼±åšç©º/é˜²å®ˆï¼Œè°¨æ…è¿½å¤š';
                    } else if (criticalBias.type === 'pinned') {
                        envColor = 'linear-gradient(135deg, #4299e1 0%, #3182ce 100%)';
                        subLabel = 'â†’ ' + criticalBias.label;
                        interpretation = 'âš¡ ' + criticalBias.reasoning.join('<br>âš¡ ') + '<br><br><strong>ç­–ç•¥å»ºè®®ï¼š</strong>åŒºé—´/å–æ³¢ã€å‡å€¼å›å½’ç­–ç•¥æ›´å‹å¥½';
                    } else if (criticalBias.type === 'rotation') {
                        envColor = 'linear-gradient(135deg, #ed8936 0%, #dd6b20 100%)';
                        subLabel = 'â†’ ' + criticalBias.label;
                        interpretation = 'âš¡ ' + criticalBias.reasoning.join('<br>âš¡ ') + '<br><br><strong>ç­–ç•¥å»ºè®®ï¼š</strong>æ¿å—è½®åŠ¨ï¼Œæ‹©å¼ºæ±°å¼±ï¼Œè¶‹åŠ¿ä¸çªç ´æˆåŠŸç‡ä¸€èˆ¬';
                    } else {
                        envColor = 'linear-gradient(135deg, #a0aec0 0%, #718096 100%)';
                        subLabel = 'â†’ ' + criticalBias.label;
                        interpretation = 'âš¡ ' + criticalBias.reasoning.join('<br>âš¡ ') + '<br><br><strong>ç­–ç•¥å»ºè®®ï¼š</strong>ä¿æŒè§‚æœ›ï¼Œç­‰å¾…æ˜ç¡®ä¿¡å·';
                    }
                }
                
            } else if (totalScore >= 2.5 && breadth.type === 'positive') {
                envLabel = 'æ­£Gamma / åŒºé—´å€¾å‘ï¼ˆå–æ³¢å‹å¥½ï¼‰';
                envColor = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
                interpretation = 'âœ“ å¹¿åº¦å¥½ï¼Œæ–°é«˜æ–°ä½éƒ½ä½<br>âœ“ æˆäº¤é‡æ¸©å’Œï¼Œæ³¢åŠ¨æ”¶æ•›<br>âœ“ æ¿å—åˆ†åŒ–å°ï¼Œäº‹ä»¶ç©ºçª—<br><strong>ç­–ç•¥å»ºè®®ï¼š</strong>å–å‡ºæ³¢åŠ¨ç‡ã€é“é¹°/é“ç§ƒé¹°ã€åŒºé—´ç­–ç•¥';
            } else if (totalScore <= -2 && breadth.type === 'negative') {
                envLabel = 'è´ŸGamma / è¶‹åŠ¿å€¾å‘ï¼ˆé¡ºåŠ¿å‹å¥½ï¼‰';
                envColor = 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)';
                interpretation = 'âœ— å¹¿åº¦å·®ï¼Œè¶‹åŠ¿æ˜æ˜¾<br>âœ— æ–°ä½>æ–°é«˜æˆ–æ”¾é‡æ˜¾è‘—<br>âœ— å¼ºæ¿å—é›†ä¸­é¢†æ¶¨/é¢†è·Œ<br><strong>ç­–ç•¥å»ºè®®ï¼š</strong>é¡ºåŠ¿äº¤æ˜“ã€æ–¹å‘æ€§æœŸæƒã€åšå¤šæ³¢åŠ¨';
            } else {
                envLabel = 'ä¸´ç•Œ / æ··åˆä¿¡å·';
                envColor = 'linear-gradient(135deg, #ed8936 0%, #dd6b20 100%)';
                interpretation = 'âš  æŒ‡æ ‡åˆ†åŒ–ï¼Œå¸‚åœºå¤„äºè½¬æŠ˜æˆ–ä¸ç¡®å®šæœŸ<br>âš  ä¸åšå¼ºæ–¹å‘åˆ¤æ–­<br><strong>ç­–ç•¥å»ºè®®ï¼š</strong>ç¼©å°å€™é€‰èŒƒå›´ï¼Œç­‰å¾…æ˜ç¡®è§¦å‘ä¿¡å·ï¼Œé™ä½ä»“ä½';
            }
            
            return { label: envLabel, color: envColor, interpretation: interpretation, totalScore: totalScore, subLabel: subLabel };
        }
        
        function updateAll() {
            updateBreadthPercentages();
            
            const breadth = analyzeBreadth();
            document.getElementById('breadthResult').querySelector('.result-value').innerHTML = breadth.html;
            
            const hl = analyzeHL();
            document.getElementById('hlResult').querySelector('.result-value').innerHTML = hl.html;
            
            const vol = analyzeVolatility();
            document.getElementById('volResult').querySelector('.result-value').innerHTML = vol.html;
            
            const sector = analyzeSector();
            document.getElementById('sectorResult').querySelector('.result-value').innerHTML = sector.html;
            
            const earnings = analyzeEarnings();
            document.getElementById('earningsResult').querySelector('.result-value').innerHTML = earnings.html;
            
            const env = calculateEnvironment();
            const envLabelDiv = document.getElementById('envLabel');
            envLabelDiv.style.background = env.color;
            
            let labelHTML = '<h2>ğŸ¯ ç¯å¢ƒæ ‡ç­¾</h2><div class="main-tag">' + env.label + '</div>';
            
            if (env.subLabel) {
                labelHTML += '<div class="tag" style="background: white; color: #667eea; font-size: 16px; padding: 10px 20px;">' + env.subLabel + '</div>';
            }
            
            labelHTML += '<div class="tag">ç»¼åˆè¯„åˆ†: ' + env.totalScore.toFixed(1) + '</div><div class="interpretation">' + env.interpretation + '</div>';
            
            envLabelDiv.innerHTML = labelHTML;
        }
        
        document.getElementById('indexSelect').addEventListener('change', updateAll);
        document.getElementById('above50dma').addEventListener('input', updateAll);
        document.getElementById('above200dma').addEventListener('input', updateAll);
        document.getElementById('b50_5d_ago').addEventListener('input', updateAll);
        document.getElementById('newHigh').addEventListener('input', updateAll);
        document.getElementById('newLow').addEventListener('input', updateAll);
        document.getElementById('relativeVol').addEventListener('input', updateAll);
        document.getElementById('over2pct').addEventListener('input', updateAll);
        document.getElementById('over3pct').addEventListener('input', updateAll);
        document.getElementById('over4pct').addEventListener('input', updateAll);
        document.getElementById('sectorRotation').addEventListener('change', updateAll);
        document.getElementById('earningsNext5').addEventListener('input', updateAll);
        document.getElementById('earningsPrev5').addEventListener('input', updateAll);
    </script>
</body>
</html>