<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>σ²</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        
        <!-- 改进的消息通知容器 -->
        <div class="message-container" id="messageContainer"></div>
        
        <div class="content-wrapper">
            <div class="left-section">
                <div class="quadrant-section">
                    <div class="quadrant-toolbar">
                        <button class="btn-primary" id="btnAnalyze">分析数据</button>
                        <button class="btn-clear" id="btnClear">清空画布</button>
                    </div>
                    <div class="quadrant-chart">
                        <canvas id="quadrantCanvas" class="quadrant-canvas"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="right-section">
                <div class="date-filter">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label">日期筛选</label>
                            <select id="dateFilterSelect">
                                <option value="">全部日期</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">方向筛选</label>
                            <div class="quadrant-filter">
                                <div class="quadrant-select" id="quadrantSelectBtn">
                                    <span class="quadrant-selected" id="quadrantSelected">全部</span>
                                    <span class="quadrant-arrow">▼</span>
                                </div>
                                <div class="quadrant-dropdown" id="quadrantDropdown">
                                    <div class="quadrant-option">
                                        <input type="checkbox" id="quad-all" value="全部" checked>
                                        <label for="quad-all">全部</label>
                                    </div>
                                    <div class="quadrant-option">
                                        <input type="checkbox" id="quad-1" value="偏多—买波">
                                        <label for="quad-1"><span class="record-quadrant bullish">偏多—买波</span></label>
                                    </div>
                                    <div class="quadrant-option">
                                        <input type="checkbox" id="quad-2" value="偏多—卖波">
                                        <label for="quad-2"><span class="record-quadrant bearish">偏多—卖波</span></label>
                                    </div>
                                    <div class="quadrant-option">
                                        <input type="checkbox" id="quad-3" value="偏空—买波">
                                        <label for="quad-3"><span class="record-quadrant bearish">偏空—买波</span></label>
                                    </div>
                                    <div class="quadrant-option">
                                        <input type="checkbox" id="quad-4" value="偏空—卖波">
                                        <label for="quad-4"><span class="record-quadrant bullish">偏空—卖波</span></label>
                                    </div>
                                    <div class="quadrant-option">
                                        <input type="checkbox" id="quad-5" value="中性/待观察">
                                        <label for="quad-5">中性/待观察</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="records-list" id="recordsList">
                    <div class="empty-state">暂无数据,请先提交分析</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 数据输入 Drawer -->
    <div class="drawer-overlay" id="inputDrawerOverlay"></div>
    <div class="drawer" id="inputDrawer">
        <div class="drawer-header">
            <div class="drawer-title">数据输入</div>
            <button class="drawer-close" id="btnCloseInputDrawer">&times;</button>
        </div>
        <div class="drawer-content input-section">
            <h2>请输入JSON格式数据</h2>
            <textarea id="dataInput" placeholder='请输入JSON格式数据'></textarea>
            <div class="button-group">
                <button class="btn-primary-drawer" id="btnSubmitAnalyze">分析数据</button>
                <button class="btn-cancel-drawer" id="btnCancelAnalyze">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 详细信息 Drawer -->
    <div class="drawer-overlay" id="detailDrawerOverlay"></div>
    <div class="detail-drawer" id="detailDrawer">
        <div class="detail-drawer-header">
            <div class="detail-drawer-title" id="detailDrawerTitle">详细信息</div>
            <button class="drawer-close" id="btnCloseDetailDrawer">&times;</button>
        </div>
        <div class="drawer-content" id="detailDrawerContent"></div>
    </div>
    
    <script>
        var allRecords = [];
        var canvas, ctx;
        var currentFilter = '';
        var selectedQuadrants = ['全部'];
        var expandedDates = new Set();
        var canvasRecords = [];

        // ==================== 改进的消息通知系统 ====================
        function showMessage(text, type) {
            const container = document.getElementById('messageContainer');
            
            // 创建消息盒子
            const messageBox = document.createElement('div');
            messageBox.className = 'message-box';
            
            // 图标映射
            const iconMap = {
                'success': '✓',
                'error': '✕',
                'warning': '!'
            };
            
            // 默认显示时长（毫秒）
            const durationMap = {
                'success': 3000,
                'error': 4000,
                'warning': 3500
            };
            
            const duration = durationMap[type] || 3000;
            const icon = iconMap[type] || '•';
            
            messageBox.innerHTML = `
                <div class="message-icon ${type}">
                    ${icon}
                </div>
                <div class="message-content">
                    <span class="message-text ${type}">${text}</span>
                </div>
                <button class="message-close" onclick="this.closest('.message-box').remove()">
                    ×
                </button>
            `;
            
            container.appendChild(messageBox);
            
            // 自动关闭
            if (duration > 0) {
                setTimeout(() => {
                    if (messageBox.parentNode) {
                        messageBox.classList.add('hide');
                        setTimeout(() => {
                            messageBox.remove();
                        }, 300);
                    }
                }, duration);
            }
        }

        // ==================== 核心功能函数 ====================
        function openInputDrawer() {
            document.getElementById('inputDrawerOverlay').classList.add('open');
            document.getElementById('inputDrawer').classList.add('open');
        }

        function closeInputDrawer() {
            document.getElementById('inputDrawerOverlay').classList.remove('open');
            document.getElementById('inputDrawer').classList.remove('open');
        }

        function openDetailDrawer() {
            document.getElementById('detailDrawerOverlay').classList.add('open');
            document.getElementById('detailDrawer').classList.add('open');
        }

        function closeDetailDrawer() {
            document.getElementById('detailDrawerOverlay').classList.remove('open');
            document.getElementById('detailDrawer').classList.remove('open');
        }

        async function analyzeData() {
            var input = document.getElementById('dataInput').value.trim();
            
            if (!input) {
                showMessage('请输入数据', 'error');
                return;
            }
            
            try {
                input = input.replace(/^\s*\w+\s*=\s*/, '').replace(/;\s*$/, '');
                var records = JSON.parse(input);
                
                if (!Array.isArray(records)) {
                    showMessage('数据必须是数组格式', 'error');
                    return;
                }
                
                if (records.length === 0) {
                    showMessage('数据数组不能为空', 'error');
                    return;
                }
                
                var response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ records: records })
                });
                
                var result = await response.json();
                
                if (response.ok) {
                    showMessage(result.message, 'success');
                    document.getElementById('dataInput').value = '';
                    closeInputDrawer();
                    
                    var newDates = new Set();
                    if (result.results && Array.isArray(result.results)) {
                        result.results.forEach(function(r) {
                            var date = r.timestamp.split(' ')[0];
                            newDates.add(date);
                        });
                        canvasRecords.push.apply(canvasRecords, result.results);
                    }
                    
                    await loadRecords();
                    await loadDates();
                    
                    newDates.forEach(function(date) {
                        expandedDates.add(date);
                        var content = document.getElementById('content-' + date);
                        var toggle = document.getElementById('toggle-' + date);
                        if (content && toggle) {
                            content.classList.add('expanded');
                            toggle.classList.add('expanded');
                        }
                    });
                } else {
                    showMessage(result.error || '分析失败', 'error');
                }
            } catch (e) {
                showMessage('数据格式错误: ' + e.message, 'error');
            }
        }

        async function loadRecords() {
            try {
                var response = await fetch('/api/records');
                if (!response.ok) {
                    allRecords = [];
                    canvasRecords = [];
                    renderRecordsList();
                    drawQuadrant();
                    return;
                }
                
                var data = await response.json();
                allRecords = Array.isArray(data) ? data : [];
                
                if (!window.hasInitializedCanvas) {
                    window.hasInitializedCanvas = true;
                    var today = new Date();
                    var todayStr = today.getFullYear() + '-' + 
                                  String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                                  String(today.getDate()).padStart(2, '0');
                    var todayRecords = allRecords.filter(function(r) {
                        return r.timestamp.startsWith(todayStr);
                    });
                    canvasRecords = todayRecords;
                }
                
                renderRecordsList();
                drawQuadrant();
            } catch (e) {
                console.error('加载数据异常:', e);
                allRecords = [];
                canvasRecords = [];
                renderRecordsList();
                drawQuadrant();
            }
        }

        function toggleQuadrantDropdown() {
            var dropdown = document.getElementById('quadrantDropdown');
            dropdown.classList.toggle('open');
        }

        function handleQuadrantChange(e) {
            var allCheckbox = document.getElementById('quad-all');
            var checkboxes = [
                document.getElementById('quad-1'),
                document.getElementById('quad-2'),
                document.getElementById('quad-3'),
                document.getElementById('quad-4'),
                document.getElementById('quad-5')
            ];
            
            var targetId = e.target.id;
            
            if (targetId === 'quad-all') {
                if (allCheckbox.checked) {
                    checkboxes.forEach(function(cb) { cb.checked = false; });
                    selectedQuadrants = ['全部'];
                }
            } else {
                allCheckbox.checked = false;
                selectedQuadrants = checkboxes.filter(function(cb) { return cb.checked; })
                                               .map(function(cb) { return cb.value; });
                
                if (selectedQuadrants.length === 0) {
                    allCheckbox.checked = true;
                    selectedQuadrants = ['全部'];
                }
            }
            
            updateQuadrantDisplay();
            filterRecords();
        }

        function updateQuadrantDisplay() {
            var display = document.getElementById('quadrantSelected');
            if (selectedQuadrants.includes('全部')) {
                display.textContent = '全部';
            } else if (selectedQuadrants.length === 0) {
                display.textContent = '全部';
            } else if (selectedQuadrants.length === 1) {
                display.textContent = selectedQuadrants[0];
            } else {
                display.textContent = '已选 ' + selectedQuadrants.length + ' 项';
            }
        }

        function filterRecords() {
            currentFilter = document.getElementById('dateFilterSelect').value;
            renderRecordsList();
            drawQuadrant();
        }

        function clearCanvas() {
            canvasRecords = [];
            drawQuadrant();
            showMessage('画布已清空', 'success');
        }

        function getQuadrantClass(quadrant) {
            if (quadrant.includes('偏多—买波') || quadrant.includes('偏空—卖波')) {
                return 'bullish';
            } else if (quadrant.includes('偏多—卖波') || quadrant.includes('偏空—买波')) {
                return 'bearish';
            }
            return '';
        }

        function getBadgeClass(confidence) {
            if (confidence === '高') return 'badge-high';
            if (confidence === '中') return 'badge-medium';
            return 'badge-low';
        }

        function renderRecordsList() {
            var container = document.getElementById('recordsList');
            
            if (!allRecords || allRecords.length === 0) {
                container.innerHTML = '<div class="empty-state">暂无数据,请先提交分析</div>';
                return;
            }
            
            var groupedByDate = {};
            allRecords.forEach(function(record) {
                var date = record.timestamp.split(' ')[0];
                
                if (currentFilter && date !== currentFilter) {
                    return;
                }
                
                if (!groupedByDate[date]) {
                    groupedByDate[date] = [];
                }
                groupedByDate[date].push(record);
            });
            
            if (!selectedQuadrants.includes('全部')) {
                for (var date in groupedByDate) {
                    groupedByDate[date] = groupedByDate[date].filter(function(record) {
                        return selectedQuadrants.includes(record.quadrant);
                    });
                    if (groupedByDate[date].length === 0) {
                        delete groupedByDate[date];
                    }
                }
            }
            
            var sortedDates = Object.keys(groupedByDate).sort().reverse();
            
            if (sortedDates.length === 0) {
                container.innerHTML = '<div class="empty-state">没有符合条件的数据</div>';
                return;
            }
            
            var html = '';
            sortedDates.forEach(function(date) {
                var records = groupedByDate[date];
                var count = records.length;
                var isExpanded = expandedDates.has(date);
                
                html += '<div class="date-group">';
                html += '<div class="date-header" data-date="' + date + '">';
                html += '<div class="date-title">';
                html += '<span class="date-toggle ' + (isExpanded ? 'expanded' : '') + '" id="toggle-' + date + '">▼</span>';
                html += '<span>' + date + ' (' + count + '条)</span>';
                html += '</div>';
                html += '<div class="date-actions">';
                html += '<button class="btn-redraw" data-date="' + date + '">重绘</button>';
                html += '<button class="btn-delete-all" data-date="' + date + '">全部删除</button>';
                html += '</div>';
                html += '</div>';
                html += '<div class="date-content ' + (isExpanded ? 'expanded' : '') + '" id="content-' + date + '">';
                
                records.forEach(function(record) {
                    var quadrantClass = getQuadrantClass(record.quadrant);
                    html += '<div class="record-item" data-timestamp="' + record.timestamp + '" data-symbol="' + record.symbol + '">';
                    html += '<div class="record-info">';
                    html += '<div class="record-symbol">' + record.symbol + '</div>';
                    html += '<div class="record-meta">';
                    html += '<span class="record-quadrant ' + quadrantClass + '">' + record.quadrant + '</span>';
                    html += '<span class="badge ' + getBadgeClass(record.confidence) + '">' + record.confidence + '</span>';
                    html += '<span>流动性: ' + record.liquidity + '</span>';
                    html += '</div></div>';
                    html += '<button class="btn-delete-item" data-timestamp="' + record.timestamp + '" data-symbol="' + record.symbol + '">&times;</button>';
                    html += '</div>';
                });
                
                html += '</div></div>';
            });
            
            container.innerHTML = html;
            container.addEventListener('click', handleRecordsListClick);
        }

        function handleRecordsListClick(e) {
            var target = e.target;
            
            var dateHeader = target.closest('.date-header');
            if (dateHeader) {
                var date = dateHeader.getAttribute('data-date');
                if (date && !target.closest('.date-actions')) {
                    toggleDateGroup(date);
                    return;
                }
            }
            
            if (target.classList.contains('btn-redraw')) {
                e.stopPropagation();
                redrawDate(e, target.getAttribute('data-date'));
                return;
            }
            
            if (target.classList.contains('btn-delete-all')) {
                e.stopPropagation();
                deleteAllByDate(e, target.getAttribute('data-date'));
                return;
            }
            
            var recordItem = target.closest('.record-item');
            if (recordItem && !target.classList.contains('btn-delete-item')) {
                showDrawer(recordItem.getAttribute('data-timestamp'), recordItem.getAttribute('data-symbol'));
                return;
            }
            
            if (target.classList.contains('btn-delete-item')) {
                e.stopPropagation();
                deleteRecord(e, target.getAttribute('data-timestamp'), target.getAttribute('data-symbol'));
                return;
            }
        }

        function toggleDateGroup(date) {
            var content = document.getElementById('content-' + date);
            var toggle = document.getElementById('toggle-' + date);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                expandedDates.delete(date);
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                expandedDates.add(date);
            }
        }

        async function deleteAllByDate(event, date) {
            event.stopPropagation();
            
            try {
                var response = await fetch('/api/records/date/' + date, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('已删除 ' + date + ' 的所有记录', 'success');
                    canvasRecords = canvasRecords.filter(function(r) {
                        return !r.timestamp.startsWith(date);
                    });
                    await loadRecords();
                    await loadDates();
                } else {
                    showMessage('删除失败', 'error');
                }
            } catch (e) {
                showMessage('删除失败: ' + e.message, 'error');
            }
        }

        function redrawDate(event, date) {
            event.stopPropagation();
            
            var dateRecords = allRecords.filter(function(r) {
                return r.timestamp.startsWith(date);
            });
            
            if (dateRecords.length === 0) {
                showMessage('该日期没有数据', 'error');
                return;
            }
            
            var existingCount = canvasRecords.filter(function(r) {
                return r.timestamp.startsWith(date);
            }).length;
            
            if (existingCount > 0) {
                showMessage('画布中已存在 ' + date + ' 的数据', 'warning');
                return;
            }
            
            canvasRecords.push.apply(canvasRecords, dateRecords);
            drawQuadrant();
            showMessage('已重绘 ' + date + ' 的 ' + dateRecords.length + ' 条数据', 'success');
        }

        async function deleteRecord(event, timestamp, symbol) {
            event.stopPropagation();
            
            var date = timestamp.split(' ')[0];
            var wasExpanded = expandedDates.has(date);
            
            try {
                var response = await fetch('/api/records/' + encodeURIComponent(timestamp) + '/' + encodeURIComponent(symbol), {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('删除成功', 'success');
                    
                    if (wasExpanded) {
                        expandedDates.add(date);
                    }
                    
                    canvasRecords = canvasRecords.filter(function(r) {
                        return !(r.timestamp === timestamp && r.symbol === symbol);
                    });
                    
                    await loadRecords();
                } else {
                    showMessage('删除失败', 'error');
                }
            } catch (e) {
                showMessage('删除失败: ' + e.message, 'error');
            }
        }

        function showDrawer(timestamp, symbol) {
            var record = allRecords.find(function(r) {
                return r.timestamp === timestamp && r.symbol === symbol;
            });
            
            if (!record) return;
            
            document.getElementById('detailDrawerTitle').textContent = record.symbol + ' - 详细分析';
            
            var confidenceBadge = getBadgeClass(record.confidence);
            var quadrantClass = getQuadrantClass(record.quadrant);
            
            var html = '<p style="color: #00000045; margin-bottom: 20px;">' + record.timestamp + '</p>';
            html += '<div class="detail-section"><h3>核心结论</h3>';
            html += '<div class="detail-row"><div class="detail-label">四象限定位:</div><div class="detail-value"><strong><span class="record-quadrant ' + quadrantClass + '">' + record.quadrant + '</span></strong></div></div>';
            html += '<div class="detail-row"><div class="detail-label">置信度:</div><div class="detail-value"><span class="badge ' + confidenceBadge + '">' + record.confidence + '</span></div></div>';
            html += '<div class="detail-row"><div class="detail-label">流动性:</div><div class="detail-value">' + record.liquidity + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">方向评分:</div><div class="detail-value">' + record.direction_score + ' (' + record.direction_bias + ')</div></div>';
            html += '<div class="detail-row"><div class="detail-label">波动评分:</div><div class="detail-value">' + record.vol_score + ' (' + record.vol_bias + ')</div></div></div>';
            
            html += '<div class="detail-section"><h3>衍生指标</h3>';
            html += '<div class="detail-row"><div class="detail-label">IVRV 比值:</div><div class="detail-value">' + record.derived_metrics.ivrv_ratio + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">IVRV 差值:</div><div class="detail-value">' + record.derived_metrics.ivrv_diff + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">Regime 比值:</div><div class="detail-value">' + record.derived_metrics.regime_ratio + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">Call/Put 比值:</div><div class="detail-value">' + record.derived_metrics.cp_ratio + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">距离财报天数:</div><div class="detail-value">' + (record.derived_metrics.days_to_earnings !== null ? record.derived_metrics.days_to_earnings + ' 天' : '无财报') + '</div></div></div>';
            
            html += '<div class="detail-section"><h3>方向驱动因素</h3><ul class="factor-list">';
            record.direction_factors.forEach(function(f) {
                html += '<li>' + f + '</li>';
            });
            html += '</ul></div>';
            
            html += '<div class="detail-section"><h3>波动驱动因素</h3><ul class="factor-list">';
            record.vol_factors.forEach(function(f) {
                html += '<li>' + f + '</li>';
            });
            html += '</ul></div>';
            
            html += '<div class="detail-section"><h3>策略建议</h3>';
            html += '<div class="detail-row"><div class="detail-value">' + record.strategy + '</div></div></div>';
            
            html += '<div class="detail-section"><h3>风险提示</h3>';
            html += '<div class="detail-row"><div class="detail-value" style="color: #ff4d4f;">' + record.risk + '</div></div></div>';
            
            document.getElementById('detailDrawerContent').innerHTML = html;
            openDetailDrawer();
        }

        function drawQuadrant() {
            if (!canvas) {
                canvas = document.getElementById('quadrantCanvas');
                ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                canvas.addEventListener('click', handleCanvasClick);
            }
            
            var width = canvas.width;
            var height = canvas.height;
            var centerX = width / 2;
            var centerY = height / 2;
            var padding = 80;
            
            ctx.clearRect(0, 0, width, height);
            
            ctx.globalAlpha = 0.08;
            ctx.fillStyle = '#52c41a';
            ctx.fillRect(padding, padding, centerX - padding, centerY - padding);
            ctx.fillStyle = '#faad14';
            ctx.fillRect(centerX, padding, width - centerX - padding, centerY - padding);
            ctx.fillStyle = '#ff4d4f';
            ctx.fillRect(padding, centerY, centerX - padding, height - centerY - padding);
            ctx.fillStyle = '#1890ff';
            ctx.fillRect(centerX, centerY, width - centerX - padding, height - centerY - padding);
            ctx.globalAlpha = 1.0;
            
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, centerY);
            ctx.lineTo(width - padding, centerY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(centerX, padding);
            ctx.lineTo(centerX, height - padding);
            ctx.stroke();
            
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            
            for (var i = 1; i <= 3; i++) {
                var xRight = centerX + (i * (width - centerX - padding) / 4);
                ctx.beginPath();
                ctx.moveTo(xRight, padding);
                ctx.lineTo(xRight, height - padding);
                ctx.stroke();
                
                var xLeft = centerX - (i * (centerX - padding) / 4);
                ctx.beginPath();
                ctx.moveTo(xLeft, padding);
                ctx.lineTo(xLeft, height - padding);
                ctx.stroke();
                
                var yDown = centerY + (i * (height - centerY - padding) / 4);
                ctx.beginPath();
                ctx.moveTo(padding, yDown);
                ctx.lineTo(width - padding, yDown);
                ctx.stroke();
                
                var yUp = centerY - (i * (centerY - padding) / 4);
                ctx.beginPath();
                ctx.moveTo(padding, yUp);
                ctx.lineTo(width - padding, yUp);
                ctx.stroke();
            }
            
            ctx.setLineDash([]);
            
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('买波', centerX, padding - 15);
            ctx.fillText('卖波', centerX, height - padding + 30);
            ctx.textAlign = 'left';
            ctx.fillText('偏空', padding + 5, centerY - 10);
            ctx.textAlign = 'right';
            ctx.fillText('偏多', width - padding - 5, centerY - 10);
            
            ctx.font = 'bold 13px Arial';
            ctx.fillStyle = '#666';
            ctx.textAlign = 'center';
            ctx.fillText('偏空—买波', padding + (centerX - padding) / 2, padding + 25);
            ctx.fillText('偏多—买波', centerX + (width - centerX - padding) / 2, padding + 25);
            ctx.fillText('偏空—卖波', padding + (centerX - padding) / 2, height - padding - 15);
            ctx.fillText('偏多—卖波', centerX + (width - centerX - padding) / 2, height - padding - 15);
            
            var filteredRecords = canvasRecords.filter(function(r) {
                if (currentFilter && !r.timestamp.startsWith(currentFilter)) return false;
                if (!selectedQuadrants.includes('全部') && !selectedQuadrants.includes(r.quadrant)) return false;
                return true;
            });
            
            if (!Array.isArray(filteredRecords) || filteredRecords.length === 0) {
                ctx.fillStyle = '#999';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('暂无数据', centerX, centerY);
                return;
            }
            
            var points = filteredRecords.map(function(record) {
                var xRange = record.direction_score >= 0 ? (width - centerX - padding) : (centerX - padding);
                var yRange = record.vol_score >= 0 ? (centerY - padding) : (height - centerY - padding);
                var x = centerX + (record.direction_score / 5) * xRange;
                var y = centerY - (record.vol_score / 5) * yRange;
                return { record: record, x: x, y: y };
            });
            
            var minDistance = 30;
            for (var i = 0; i < points.length; i++) {
                for (var j = i + 1; j < points.length; j++) {
                    var dx = points[j].x - points[i].x;
                    var dy = points[j].y - points[i].y;
                    var dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < minDistance && dist > 0) {
                        var angle = Math.atan2(dy, dx);
                        var offset = (minDistance - dist) / 2;
                        points[j].x += Math.cos(angle) * offset;
                        points[j].y += Math.sin(angle) * offset;
                        points[i].x -= Math.cos(angle) * offset;
                        points[i].y -= Math.sin(angle) * offset;
                    }
                }
            }
            
            points.forEach(function(item) {
                var record = item.record;
                var x = item.x;
                var y = item.y;
                
                var color;
                if (record.confidence === '高') {
                    color = '#52c41a';
                } else if (record.confidence === '中') {
                    color = '#faad14';
                } else {
                    color = '#ff4d4f';
                }
                
                ctx.fillStyle = color;
                ctx.font = 'bold 14px "Comic Sans MS", cursive, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(record.symbol, x, y);
                
                var textWidth = ctx.measureText(record.symbol).width;
                record._canvasX = x;
                record._canvasY = y;
                record._clickRadius = Math.max(textWidth / 2 + 5, 15);
            });
        }

        function handleCanvasClick(event) {
            if (!Array.isArray(canvasRecords) || canvasRecords.length === 0) return;
            
            var rect = canvas.getBoundingClientRect();
            var x = event.clientX - rect.left;
            var y = event.clientY - rect.top;
            
            var filteredRecords = canvasRecords.filter(function(r) {
                if (currentFilter && !r.timestamp.startsWith(currentFilter)) return false;
                if (!selectedQuadrants.includes('全部') && !selectedQuadrants.includes(r.quadrant)) return false;
                return true;
            });
            
            for (var i = 0; i < filteredRecords.length; i++) {
                var record = filteredRecords[i];
                if (!record._canvasX || !record._canvasY) continue;
                
                var dx = x - record._canvasX;
                var dy = y - record._canvasY;
                var distance = Math.sqrt(dx * dx + dy * dy);
                var clickRadius = record._clickRadius || 15;
                
                if (distance <= clickRadius) {
                    showDrawer(record.timestamp, record.symbol);
                    return;
                }
            }
        }

        async function loadDates() {
            try {
                var response = await fetch('/api/dates');
                if (!response.ok) return;
                
                var dates = await response.json();
                var select = document.getElementById('dateFilterSelect');
                var currentValue = select.value;
                select.innerHTML = '<option value="">全部日期</option>';
                
                dates.forEach(function(date) {
                    var option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            } catch (e) {
                console.error('加载日期异常:', e);
            }
        }

        window.addEventListener('resize', function() {
            if (canvas) {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                drawQuadrant();
            }
        });

        document.addEventListener('click', function(e) {
            var filter = document.querySelector('.quadrant-filter');
            var dropdown = document.getElementById('quadrantDropdown');
            if (filter && !filter.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        window.onload = function() {
            loadRecords();
            loadDates();
            
            document.getElementById('btnAnalyze').addEventListener('click', openInputDrawer);
            document.getElementById('btnSubmitAnalyze').addEventListener('click', analyzeData);
            document.getElementById('btnCancelAnalyze').addEventListener('click', closeInputDrawer);
            document.getElementById('btnCloseInputDrawer').addEventListener('click', closeInputDrawer);
            document.getElementById('btnClear').addEventListener('click', clearCanvas);
            document.getElementById('dateFilterSelect').addEventListener('change', filterRecords);
            document.getElementById('quadrantSelectBtn').addEventListener('click', toggleQuadrantDropdown);
            document.getElementById('detailDrawerOverlay').addEventListener('click', closeDetailDrawer);
            document.getElementById('btnCloseDetailDrawer').addEventListener('click', closeDetailDrawer);
            document.getElementById('inputDrawerOverlay').addEventListener('click', closeInputDrawer);
            
            var allCheckbox = document.getElementById('quad-all');
            var checkboxIds = ['quad-1', 'quad-2', 'quad-3', 'quad-4', 'quad-5'];
            
            if (allCheckbox) {
                allCheckbox.addEventListener('change', handleQuadrantChange);
            }
            
            checkboxIds.forEach(function(id) {
                var cb = document.getElementById(id);
                if (cb) {
                    cb.addEventListener('change', handleQuadrantChange);
                }
            });
        };
    </script>
</body>
</html>