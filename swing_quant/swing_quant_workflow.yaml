app:
  description: æ³¢æ®µåˆ†æç­–ç•¥
  icon: ğŸ¤–
  icon_background: '#FCE7F3'
  mode: advanced-chat
  name: swing
  use_icon_as_answer_icon: false
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/openai_api_compatible:0.0.24@2266d6adfeafd3a161ba4a033553f4ff8a8b1d07be54f4b11ce9e68032889ac3
    version: null
kind: app
version: 0.5.0
workflow:
  conversation_variables:
  - description: ç¼ºå¤±å­—æ®µæ•°é‡
    id: f695f981-f7a4-4dd0-b09c-13ddf7e007a6
    name: missing_count
    selector:
    - conversation
    - missing_count
    value: 0
    value_type: integer
  - description: 'æ•°æ®å¤„ç†çŠ¶æ€, # initial | awaiting_data | ready | error'
    id: 75095b84-d6c8-4623-b550-c61691a80293
    name: data_status
    selector:
    - conversation
    - data_status
    value: initial
    value_type: string
  - description: å½“å‰åˆ†æçš„è‚¡ç¥¨ä»£ç ï¼Œç”¨äºè¯†åˆ«è¡¥é½å›ä¼ 
    id: 5d24af5c-a996-47e6-8d72-3e443ce99457
    name: current_symbol
    selector:
    - conversation
    - current_symbol
    value: ''
    value_type: string
  - description: '"é¦–æ¬¡è§£æçš„å®Œæ•´æ•°æ®ï¼Œç”¨äºè¡¥é½æ—¶åˆå¹¶"'
    id: 2e987f9c-5667-4dca-9c79-3a97c096af0f
    name: first_parse_data
    selector:
    - conversation
    - first_parse_data
    value: ''
    value_type: string
  environment_variables:
  - description: IVè·¯å¾„ç›¸å¯¹å˜åŒ–é˜ˆå€¼ç™¾åˆ†æ¯”, é˜ˆå€¼=max(2 volç‚¹, 8â€“10%ç›¸å¯¹å˜åŒ–)
    id: 6947dc09-d0c3-4aef-aade-6474c620628c
    name: IV_PATH_THRESHOLD_PCT
    selector:
    - env
    - IV_PATH_THRESHOLD_PCT
    value: '10'
    value_type: string
  - description: å¢™è¯†åˆ«ç°‡å®½åº¦ï¼ˆç°‡å®½ â‰¥ X ç›¸é‚»è¡Œæƒä»·ï¼‰ç°‡å®½â‰¥3ç›¸é‚»è¡Œæƒ
    id: 0e92e13b-cfa8-4210-87d6-5332dde7f755
    name: WALL_CLUSTER_WIDTH
    selector:
    - env
    - WALL_CLUSTER_WIDTH
    value: '3'
    value_type: string
  - description: 'å¢™è¯†åˆ«å³°å€¼å€æ•°ï¼ˆå±€éƒ¨å³° â‰¥ ç›¸é‚»Î³ä¸­ä½æ•° Ã— æ­¤å€æ•°ï¼‰

      å±€éƒ¨å³°â‰¥ç›¸é‚»Î³ä¸­ä½æ•°2å€'
    id: 0d039297-a8fd-4d8e-9475-3adb3f04e925
    name: WALL_PEAK_MULTIPLIER
    selector:
    - env
    - WALL_PEAK_MULTIPLIER
    value: '2.0'
    value_type: string
  - description: æœˆåº¦ä¸­æœŸDTEï¼ˆå½“æ— å‘¨åº¦æ•°æ®æ—¶ä½¿ç”¨ï¼‰
    id: d3156f30-66b4-4f28-a246-e9d8e5e31512
    name: DEFAULT_DTE_MONTHLY_MID
    selector:
    - env
    - DEFAULT_DTE_MONTHLY_MID
    value: '60'
    value_type: string
  - description: ''
    id: 9f7b2a95-fbb2-4032-a689-462f20895111
    name: ALPHA_VANTAGE_API_URL
    selector:
    - env
    - ALPHA_VANTAGE_API_URL
    value: https://www.alphavantage.co/query?
    value_type: string
  - description: ''
    id: 34e50e26-0669-4732-be92-45ae7ff2f4d4
    name: EM1_SQRT_FACTOR
    selector:
    - env
    - EM1_SQRT_FACTOR
    value: '0.06299'
    value_type: string
  - description: ''
    id: 56816405-1daf-4126-8efb-4f753d1375c8
    name: BREAK_WALL_THRESHOLD_LOW
    selector:
    - env
    - BREAK_WALL_THRESHOLD_LOW
    value: '0.4'
    value_type: string
  - description: ''
    id: 3ea750ec-3a32-4500-8fdf-f07acfe1323d
    name: BREAK_WALL_THRESHOLD_HIGH
    selector:
    - env
    - BREAK_WALL_THRESHOLD_HIGH
    value: '0.8'
    value_type: string
  - description: ''
    id: 6e5c1b25-eb44-4858-bcc1-968cf45ae95d
    name: MONTHLY_OVERRIDE_THRESHOLD
    selector:
    - env
    - MONTHLY_OVERRIDE_THRESHOLD
    value: '0.7'
    value_type: string
  - description: ''
    id: 42035f4f-962e-4d41-a3aa-13d4bc86f4c8
    name: MONTHLY_CLUSTER_STRENGTH_RATIO
    selector:
    - env
    - MONTHLY_CLUSTER_STRENGTH_RATIO
    value: '1.5'
    value_type: string
  - description: ''
    id: 1175c26c-d2b4-4e1c-800e-06be95429cd6
    name: CLUSTER_STRENGTH_THRESHOLD_T
    selector:
    - env
    - CLUSTER_STRENGTH_THRESHOLD_T
    value: '1.2'
    value_type: string
  - description: ''
    id: d1f43157-5c94-4f96-9fc5-40d58dc90dca
    name: CLUSTER_STRENGTH_THRESHOLD_S
    selector:
    - env
    - CLUSTER_STRENGTH_THRESHOLD_S
    value: '2.0'
    value_type: string
  - description: ''
    id: d699a30e-4d47-45f1-99a6-f2bf8ef10683
    name: DEX_SAME_DIR_THRESHOLD_STRONG
    selector:
    - env
    - DEX_SAME_DIR_THRESHOLD_STRONG
    value: '70'
    value_type: string
  - description: ''
    id: a6206f27-187f-49f5-85c5-b21b0ca55cd1
    name: DEX_SAME_DIR_THRESHOLD_MEDIUM
    selector:
    - env
    - DEX_SAME_DIR_THRESHOLD_MEDIUM
    value: '60'
    value_type: string
  - description: ''
    id: 1b2e29d4-4b33-4cc6-9e9f-aa81d1391ce8
    name: DEX_SAME_DIR_THRESHOLD_WEAK
    selector:
    - env
    - DEX_SAME_DIR_THRESHOLD_WEAK
    value: '50'
    value_type: string
  - description: ''
    id: ca32c770-d806-4659-944a-d4c899b5aa2b
    name: IV_PATH_THRESHOLD_VOL
    selector:
    - env
    - IV_PATH_THRESHOLD_VOL
    value: '2'
    value_type: string
  - description: ''
    id: 75b790bc-d2a1-4324-b8cf-5467923ba39b
    name: IV_NOISE_THRESHOLD
    selector:
    - env
    - IV_NOISE_THRESHOLD
    value: '30'
    value_type: string
  - description: ''
    id: a42bcd57-8084-4742-a674-468ff4b1eb23
    name: DEFAULT_STRIKES
    selector:
    - env
    - DEFAULT_STRIKES
    value: '25'
    value_type: string
  - description: ''
    id: bff94012-d3ef-4243-899a-6b838cfbd9f9
    name: DEFAULT_NET_WINDOW
    selector:
    - env
    - DEFAULT_NET_WINDOW
    value: '60'
    value_type: string
  - description: ''
    id: 9c062833-fabc-4f9a-871e-edab861724b8
    name: EXTENDED_NET_WINDOW
    selector:
    - env
    - EXTENDED_NET_WINDOW
    value: '120'
    value_type: string
  - description: ''
    id: 159562a1-174f-49f5-bc6f-e2eb5132b18c
    name: DEFAULT_DTE_WEEKLY_SHORT
    selector:
    - env
    - DEFAULT_DTE_WEEKLY_SHORT
    value: '7'
    value_type: string
  - description: ''
    id: d8ca77db-2afc-4c56-a951-0467f8337406
    name: DEFAULT_DTE_WEEKLY_MID
    selector:
    - env
    - DEFAULT_DTE_WEEKLY_MID
    value: '14'
    value_type: string
  - description: ''
    id: c98f3d63-3e41-40d2-8900-ea09dae59bce
    name: DEFAULT_DTE_MONTHLY_SHORT
    selector:
    - env
    - DEFAULT_DTE_MONTHLY_SHORT
    value: '30'
    value_type: string
  - description: ''
    id: 415be580-c0e0-42b6-8b96-455023aaf1a7
    name: DEFAULT_INDEX_PRIMARY
    selector:
    - env
    - DEFAULT_INDEX_PRIMARY
    value: SPX
    value_type: string
  - description: ''
    id: d25ff9d2-7196-440b-9e44-23246e12f4fd
    name: DEFAULT_INDEX_SECONDARY
    selector:
    - env
    - DEFAULT_INDEX_SECONDARY
    value: QQQ
    value_type: string
  - description: ''
    id: e1128bdc-b017-4da3-8493-fc1325cbaf10
    name: SCORE_WEIGHT_GAMMA_REGIME
    selector:
    - env
    - SCORE_WEIGHT_GAMMA_REGIME
    value: '0.4'
    value_type: string
  - description: ''
    id: fc04500c-157d-4ec8-beea-d651828da32e
    name: SCORE_WEIGHT_BREAK_WALL
    selector:
    - env
    - SCORE_WEIGHT_BREAK_WALL
    value: '0.3'
    value_type: string
  - description: ''
    id: 5d072a9d-5fe4-48be-80d4-7ed90134c275
    name: SCORE_WEIGHT_DIRECTION
    selector:
    - env
    - SCORE_WEIGHT_DIRECTION
    value: '0.2'
    value_type: string
  - description: ''
    id: c1c3da25-7559-49d5-aa25-8b46ed02e6b2
    name: SCORE_WEIGHT_IV
    selector:
    - env
    - SCORE_WEIGHT_IV
    value: '0.1'
    value_type: string
  - description: ''
    id: fae0be53-9900-4354-a2c3-1e2f6c013404
    name: TECHNICAL_SCORE_MAX
    selector:
    - env
    - TECHNICAL_SCORE_MAX
    value: '2'
    value_type: string
  - description: ''
    id: 27b59ab6-298e-41d9-8cfe-0b5aac4c6be3
    name: ENTRY_THRESHOLD_SCORE
    selector:
    - env
    - ENTRY_THRESHOLD_SCORE
    value: '3'
    value_type: string
  - description: ''
    id: f31e374b-b544-43bb-a19b-c2248099572d
    name: ENTRY_THRESHOLD_PROBABILITY
    selector:
    - env
    - ENTRY_THRESHOLD_PROBABILITY
    value: '60'
    value_type: string
  - description: ''
    id: 8f84deb9-de9c-4d39-8d2f-71d9a141c43c
    name: LIGHT_POSITION_PROBABILITY
    selector:
    - env
    - LIGHT_POSITION_PROBABILITY
    value: '50'
    value_type: string
  - description: ''
    id: 2e9f3d79-055e-475c-b532-6d877601d0f4
    name: MAX_SINGLE_RISK_PCT
    selector:
    - env
    - MAX_SINGLE_RISK_PCT
    value: '2'
    value_type: string
  - description: ''
    id: 338fc286-e85f-49a5-b878-1e590ebde245
    name: MAX_TOTAL_EXPOSURE_PCT
    selector:
    - env
    - MAX_TOTAL_EXPOSURE_PCT
    value: '10'
    value_type: string
  - description: ''
    id: f065de1d-7ad8-43e4-bd82-2269277505db
    name: DTE_GAP_HIGH_THRESHOLD
    selector:
    - env
    - DTE_GAP_HIGH_THRESHOLD
    value: '3'
    value_type: string
  - description: ''
    id: c5f348f3-ae62-483b-9c7d-feac529d7eef
    name: DTE_GAP_MID_THRESHOLD
    selector:
    - env
    - DTE_GAP_MID_THRESHOLD
    value: '2'
    value_type: string
  - description: ''
    id: fb7fedab-92c3-43ef-b576-7356fa0040fc
    name: DTE_MONTHLY_ADJUSTMENT
    selector:
    - env
    - DTE_MONTHLY_ADJUSTMENT
    value: '7'
    value_type: string
  - description: ''
    id: 00ce1d05-c506-45bb-8908-fb594b659983
    name: PW_CREDIT_BASE
    selector:
    - env
    - PW_CREDIT_BASE
    value: '0.5'
    value_type: string
  - description: ''
    id: 79b63b13-4f69-4045-9189-6f31050b550e
    name: PW_CREDIT_CLUSTER_COEF
    selector:
    - env
    - PW_CREDIT_CLUSTER_COEF
    value: '0.1'
    value_type: string
  - description: ''
    id: 0e39310c-a22c-47dc-95ee-793583183a82
    name: PW_CREDIT_DISTANCE_PENALTY_COEF
    selector:
    - env
    - PW_CREDIT_DISTANCE_PENALTY_COEF
    value: '0.05'
    value_type: string
  - description: ''
    id: 1452f6c4-9241-4bf9-b87f-88d2eaf603f7
    name: PW_CREDIT_MIN
    selector:
    - env
    - PW_CREDIT_MIN
    value: '0.4'
    value_type: string
  - description: ''
    id: 78159142-1ebb-4426-8140-7ccfaa771402
    name: PW_CREDIT_MAX
    selector:
    - env
    - PW_CREDIT_MAX
    value: '0.85'
    value_type: string
  - description: ''
    id: c7a44894-02d2-4375-a48b-b8a4218153f0
    name: PW_DEBIT_BASE
    selector:
    - env
    - PW_DEBIT_BASE
    value: '0.3'
    value_type: string
  - description: ''
    id: ab70607c-9c90-4d3e-8159-ee15c883f3b5
    name: PW_DEBIT_MIN
    selector:
    - env
    - PW_DEBIT_MIN
    value: '0.25'
    value_type: string
  - description: ''
    id: 356ac996-0540-4cf1-9531-9d3851698a53
    name: PW_DEBIT_MAX
    selector:
    - env
    - PW_DEBIT_MAX
    value: '0.75'
    value_type: string
  - description: ''
    id: 1d22dba3-e96f-4d77-a64f-a234739cb6c1
    name: PW_BUTTERFLY_BODY_INSIDE
    selector:
    - env
    - PW_BUTTERFLY_BODY_INSIDE
    value: '0.65'
    value_type: string
  - description: ''
    id: 23fb0ba8-d974-40de-bbaf-56da24f61f49
    name: PW_BUTTERFLY_BODY_OFFSET_1EM
    selector:
    - env
    - PW_BUTTERFLY_BODY_OFFSET_1EM
    value: '0.45'
    value_type: string
  - description: ''
    id: 2eb9a9cc-a1a3-4ced-af39-ceb1f1371bb1
    name: ENABLE_EARNINGS_API
    selector:
    - env
    - ENABLE_EARNINGS_API
    value: 'true'
    value_type: string
  - description: ''
    id: 7bc4ee89-7d0a-4015-ae7f-5bff22bbbe3c
    name: EARNINGS_CACHE_DAYS
    selector:
    - env
    - EARNINGS_CACHE_DAYS
    value: '30'
    value_type: string
  - description: ''
    id: ee0efa9d-cb6d-4973-bbed-257750b991b6
    name: ALPHA_VANTAGE_API_KEY
    selector:
    - env
    - ALPHA_VANTAGE_API_KEY
    value: TKV2HLJJYKSRGR
    value_type: string
  - description: ä¿å®ˆç­–ç•¥Deltaæœ€å°å€¼ï¼ˆæ¥è¿‘ä¸­æ€§ï¼‰
    id: e5f67890-abcd-ef12-3456-7890abcdef12
    name: CONSERVATIVE_DELTA_MIN
    selector:
    - env
    - CONSERVATIVE_DELTA_MIN
    value: '-0.1'
    value_type: string
  - description: ä¿å®ˆç­–ç•¥Deltaæœ€å¤§å€¼ï¼ˆæ¥è¿‘ä¸­æ€§ï¼‰
    id: f6789012-abcd-ef12-3456-7890abcdef23
    name: CONSERVATIVE_DELTA_MAX
    selector:
    - env
    - CONSERVATIVE_DELTA_MAX
    value: '0.1'
    value_type: string
  - description: ä¿å®ˆç­–ç•¥Thetaæœ€å°å€¼ï¼ˆæ—¶é—´ä»·å€¼è¡°å‡æ”¶ç›Šï¼‰
    id: 67890123-abcd-ef12-3456-7890abcdef34
    name: CONSERVATIVE_THETA_MIN
    selector:
    - env
    - CONSERVATIVE_THETA_MIN
    value: '5.0'
    value_type: string
  - description: ä¿å®ˆç­–ç•¥Vegaæœ€å¤§å€¼ï¼ˆåšç©ºæ³¢åŠ¨ç‡ï¼‰
    id: 78901234-abcd-ef12-3456-7890abcdef45
    name: CONSERVATIVE_VEGA_MAX
    selector:
    - env
    - CONSERVATIVE_VEGA_MAX
    value: '-10.0'
    value_type: string
  - description: å‡è¡¡ç­–ç•¥DeltaèŒƒå›´ï¼ˆÂ±æ­¤å€¼ï¼‰
    id: 89012345-abcd-ef12-3456-7890abcdef56
    name: BALANCED_DELTA_RANGE
    selector:
    - env
    - BALANCED_DELTA_RANGE
    value: '0.2'
    value_type: string
  - description: å‡è¡¡ç­–ç•¥Thetaæœ€å°å€¼
    id: 90123456-abcd-ef12-3456-7890abcdef67
    name: BALANCED_THETA_MIN
    selector:
    - env
    - BALANCED_THETA_MIN
    value: '8.0'
    value_type: string
  - description: è¿›å–ç­–ç•¥Deltaæœ€å°å€¼ï¼ˆæ˜ç¡®æ–¹å‘ï¼‰
    id: 01234567-abcd-ef12-3456-7890abcdef78
    name: AGGRESSIVE_DELTA_MIN
    selector:
    - env
    - AGGRESSIVE_DELTA_MIN
    value: '0.3'
    value_type: string
  - description: è¿›å–ç­–ç•¥Deltaæœ€å¤§å€¼
    id: 12345678-abcd-ef12-3456-7890abcdef89
    name: AGGRESSIVE_DELTA_MAX
    selector:
    - env
    - AGGRESSIVE_DELTA_MAX
    value: '0.6'
    value_type: string
  - description: è¿›å–ç­–ç•¥Vegaæœ€å°å€¼ï¼ˆåšå¤šæ³¢åŠ¨ç‡ï¼‰
    id: 23456789-abcd-ef12-3456-7890abcdef90
    name: AGGRESSIVE_VEGA_MIN
    selector:
    - env
    - AGGRESSIVE_VEGA_MIN
    value: '10.0'
    value_type: string
  - description: ä¿å®ˆç­–ç•¥Longè…¿åç§»ï¼ˆÃ— EM1$ï¼‰
    id: 34567890-abcd-ef12-3456-7890abcdefa1
    name: STRIKE_CONSERVATIVE_LONG_OFFSET
    selector:
    - env
    - STRIKE_CONSERVATIVE_LONG_OFFSET
    value: '1.5'
    value_type: string
  - description: å‡è¡¡ç­–ç•¥Wingåç§»ï¼ˆÃ— EM1$ï¼‰
    id: 45678901-abcd-ef12-3456-7890abcdefa2
    name: STRIKE_BALANCED_WING_OFFSET
    selector:
    - env
    - STRIKE_BALANCED_WING_OFFSET
    value: '1.0'
    value_type: string
  - description: æ¯”ç‡ä»·å·®å–æ–¹åç§»ï¼ˆÃ— EM1$ï¼‰
    id: 56789012-abcd-ef12-3456-7890abcdefa3
    name: STRIKE_RATIO_SHORT_OFFSET
    selector:
    - env
    - STRIKE_RATIO_SHORT_OFFSET
    value: '0.5'
    value_type: string
  - description: æ¯”ç‡ä»·å·®ä¹°æ–¹åç§»ï¼ˆÃ— EM1$ï¼‰
    id: 67890123-abcd-ef12-3456-7890abcdefa4
    name: STRIKE_RATIO_LONG_OFFSET
    selector:
    - env
    - STRIKE_RATIO_LONG_OFFSET
    value: '1.5'
    value_type: string
  - description: è¿›å–ç­–ç•¥Longè…¿åç§»ï¼ˆÃ— EM1$ï¼‰
    id: 78901234-abcd-ef12-3456-7890abcdefa5
    name: STRIKE_AGGRESSIVE_LONG_OFFSET
    selector:
    - env
    - STRIKE_AGGRESSIVE_LONG_OFFSET
    value: '0.2'
    value_type: string
  - description: ä¿¡ç”¨ä»·å·®æœ€å°å®½åº¦ï¼ˆÃ— EM1$ï¼‰
    id: 89012345-abcd-ef12-3456-7890abcdefa6
    name: WIDTH_CREDIT_MIN
    selector:
    - env
    - WIDTH_CREDIT_MIN
    value: '0.8'
    value_type: string
  - description: ä¿¡ç”¨ä»·å·®æœ€å¤§å®½åº¦ï¼ˆÃ— EM1$ï¼‰
    id: 90123456-abcd-ef12-3456-7890abcdefa7
    name: WIDTH_CREDIT_MAX
    selector:
    - env
    - WIDTH_CREDIT_MAX
    value: '1.0'
    value_type: string
  - description: å€Ÿè´·ä»·å·®æœ€å°å®½åº¦ï¼ˆÃ— EM1$ï¼‰
    id: 01234567-abcd-ef12-3456-7890abcdefa8
    name: WIDTH_DEBIT_MIN
    selector:
    - env
    - WIDTH_DEBIT_MIN
    value: '1.0'
    value_type: string
  - description: å€Ÿè´·ä»·å·®æœ€å¤§å®½åº¦ï¼ˆÃ— EM1$ï¼‰
    id: 12345678-abcd-ef12-3456-7890abcdefa9
    name: WIDTH_DEBIT_MAX
    selector:
    - env
    - WIDTH_DEBIT_MAX
    value: '1.2'
    value_type: string
  - description: ä¿¡ç”¨ä»·å·®IVR 0-25%æ—¶çš„credit ratio
    id: 23456789-abcd-ef12-3456-7890abcdefb0
    name: CREDIT_IVR_0_25
    selector:
    - env
    - CREDIT_IVR_0_25
    value: '0.20'
    value_type: string
  - description: ä¿¡ç”¨ä»·å·®IVR 25-50%æ—¶çš„credit ratio
    id: 34567890-abcd-ef12-3456-7890abcdefb1
    name: CREDIT_IVR_25_50
    selector:
    - env
    - CREDIT_IVR_25_50
    value: '0.30'
    value_type: string
  - description: ä¿¡ç”¨ä»·å·®IVR 50-75%æ—¶çš„credit ratio
    id: 45678901-abcd-ef12-3456-7890abcdefb2
    name: CREDIT_IVR_50_75
    selector:
    - env
    - CREDIT_IVR_50_75
    value: '0.40'
    value_type: string
  - description: ä¿¡ç”¨ä»·å·®IVR 75-100%æ—¶çš„credit ratio
    id: 56789012-abcd-ef12-3456-7890abcdefb3
    name: CREDIT_IVR_75_100
    selector:
    - env
    - CREDIT_IVR_75_100
    value: '0.50'
    value_type: string
  - description: å€Ÿè´·ä»·å·®IVR 0-40%æ—¶çš„debit ratio
    id: 67890123-abcd-ef12-3456-7890abcdefb4
    name: DEBIT_IVR_0_40
    selector:
    - env
    - DEBIT_IVR_0_40
    value: '0.30'
    value_type: string
  - description: å€Ÿè´·ä»·å·®IVR 40-70%æ—¶çš„debit ratio
    id: 78901234-abcd-ef12-3456-7890abcdefb5
    name: DEBIT_IVR_40_70
    selector:
    - env
    - DEBIT_IVR_40_70
    value: '0.40'
    value_type: string
  - description: å€Ÿè´·ä»·å·®IVR 70-100%æ—¶çš„debit ratio
    id: 89012345-abcd-ef12-3456-7890abcdefb6
    name: DEBIT_IVR_70_100
    selector:
    - env
    - DEBIT_IVR_70_100
    value: '0.50'
    value_type: string
  - description: Pwå€Ÿè´·è®¡ç®—ä¸­çš„DEXç³»æ•°
    id: 90123456-abcd-ef12-3456-7890abcdefb7
    name: PW_DEBIT_DEX_COEF
    selector:
    - env
    - PW_DEBIT_DEX_COEF
    value: '0.1'
    value_type: string
  - description: Pwå€Ÿè´·è®¡ç®—ä¸­çš„Vannaç³»æ•°
    id: 01234567-abcd-ef12-3456-7890abcdefb8
    name: PW_DEBIT_VANNA_COEF
    selector:
    - env
    - PW_DEBIT_VANNA_COEF
    value: '0.2'
    value_type: string
  - description: ä¿¡ç”¨ç­–ç•¥æ­¢ç›ˆç›®æ ‡ï¼ˆæƒåˆ©é‡‘è¡°å‡è‡³å‰©ä½™%ï¼‰
    id: 12345678-abcd-ef12-3456-7890abcdefb9
    name: PROFIT_TARGET_CREDIT_PCT
    selector:
    - env
    - PROFIT_TARGET_CREDIT_PCT
    value: '30'
    value_type: string
  - description: å€Ÿè´·ç­–ç•¥æ­¢ç›ˆç›®æ ‡ï¼ˆæµ®ç›ˆ%ï¼‰
    id: 23456789-abcd-ef12-3456-7890abcdefc0
    name: PROFIT_TARGET_DEBIT_PCT
    selector:
    - env
    - PROFIT_TARGET_DEBIT_PCT
    value: '60'
    value_type: string
  - description: å€Ÿè´·ç­–ç•¥æ­¢æŸçº¿ï¼ˆäºæŸ%ï¼‰
    id: 34567890-abcd-ef12-3456-7890abcdefc1
    name: STOP_LOSS_DEBIT_PCT
    selector:
    - env
    - STOP_LOSS_DEBIT_PCT
    value: '50'
    value_type: string
  - description: ä¿¡ç”¨ç­–ç•¥æ­¢æŸçº¿ï¼ˆæµ®äºè¾¾æƒåˆ©é‡‘%ï¼‰
    id: 45678901-abcd-ef12-3456-7890abcdefc2
    name: STOP_LOSS_CREDIT_PCT
    selector:
    - env
    - STOP_LOSS_CREDIT_PCT
    value: '150'
    value_type: string
  - description: åˆ°æœŸå‰å¼ºåˆ¶å¹³ä»“å¤©æ•°
    id: 56789012-abcd-ef12-3456-7890abcdefc3
    name: TIME_DECAY_EXIT_DAYS
    selector:
    - env
    - TIME_DECAY_EXIT_DAYS
    value: '3'
    value_type: string
  features:
    file_upload:
      allowed_file_extensions:
      - .JPG
      - .JPEG
      - .PNG
      - .GIF
      - .WEBP
      - .SVG
      allowed_file_types:
      - image
      allowed_file_upload_methods:
      - remote_url
      - local_file
      enabled: true
      fileUploadConfig:
        audio_file_size_limit: 50
        batch_count_limit: 5
        file_size_limit: 15
        image_file_size_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 10
    opening_statement: ''
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: edge-1003-2002
      selected: false
      source: '1003'
      sourceHandle: source
      target: '2002'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: answer
      id: edge-2002-2003
      selected: false
      source: '2002'
      sourceHandle: source
      target: '2003'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: edge-1003-3001
      selected: false
      source: '1003'
      sourceHandle: source
      target: '3001'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: 1003-case-ticker-2002-target
      selected: false
      source: '1003'
      sourceHandle: case-ticker
      target: '2002'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: 1003-case-data-3001-target
      selected: false
      source: '1003'
      sourceHandle: case-data
      target: '3001'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: code
      id: 1004-source-1007-target
      selected: false
      source: '1004'
      sourceHandle: source
      target: '1007'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1007-source-5001-target
      selected: false
      source: '1007'
      sourceHandle: source
      target: '5001'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: answer
      id: 7001-source-7002-target
      selected: false
      source: '7001'
      sourceHandle: source
      target: '7002'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 5001-source-1006-target
      selected: false
      source: '5001'
      sourceHandle: source
      target: '1006'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1006-source-6001-target
      selected: false
      source: '1006'
      sourceHandle: source
      target: '6001'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 6001--1008-target
      selected: false
      source: '6001'
      sourceHandle: source
      target: '1008'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1008-source-1005-target
      selected: false
      source: '1008'
      sourceHandle: source
      target: '1005'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: llm
      id: 1005-source-7001-target
      selected: false
      source: '1005'
      sourceHandle: source
      target: '7001'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 3001--1009-target
      selected: false
      source: '3001'
      sourceHandle: source
      target: '1009'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: start
        targetType: if-else
      id: 1001-source-1003-target
      selected: false
      source: '1001'
      sourceHandle: source
      target: '1003'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: code
      id: 3002-case-ready-1004-target
      source: '3002'
      sourceHandle: case-ready
      target: '1004'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: answer
      id: 3002-case-missing-3003-target
      source: '3002'
      sourceHandle: case-missing
      target: '3003'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: answer
      id: 3002-e24094ec-5f1e-4ad2-be2c-c6cb6275b48c-1763130136495-target
      source: '3002'
      sourceHandle: e24094ec-5f1e-4ad2-be2c-c6cb6275b48c
      target: '1763130136495'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: code
        targetType: if-else
      id: 1009-source-3002-target
      source: '1009'
      sourceHandle: source
      target: '3002'
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        desc: ''
        selected: false
        title: user input
        type: start
        variables: []
      height: 73
      id: '1001'
      position:
        x: 30
        y: 300
      positionAbsolute:
        x: 30
        y: 300
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        cases:
        - case_id: case-ticker
          conditions:
          - comparison_operator: empty
            id: cond-ticker
            value: ''
            varType: array[file]
            variable_selector:
            - sys
            - files
          id: case-ticker
          logical_operator: and
        - case_id: case-data
          conditions:
          - comparison_operator: not empty
            id: cond-data
            sub_variable_condition:
              case_id: 6f06a580-b00a-493c-bab4-57cc20c3086a
              conditions: []
              logical_operator: and
            value: ''
            varType: array[file]
            variable_selector:
            - sys
            - files
          id: case-data
          logical_operator: and
        desc: ''
        selected: false
        title: åˆ¤å®šåˆ†æ”¯
        type: if-else
      height: 172
      id: '1003'
      position:
        x: 466.8589549331674
        y: 161.59366846092928
      positionAbsolute:
        x: 466.8589549331674
        y: 161.59366846092928
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: 'Agent 2: Generates the command list.'
        model:
          completion_params:
            temperature: 0.3
          mode: chat
          name: Qwen3-8B
          provider: langgenius/openai_api_compatible/openai_api_compatible
        prompt_template:
        - id: sys-cmdlist
          role: system
          text: "ä½ æ˜¯ä¸€ä¸ªç¾è‚¡æœŸæƒåˆ†æåŠ©æ‰‹ã€‚ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„ä»£ç ,ä¸¥æ ¼æŒ‰ç…§ã€æ•°æ®æŠ“å–å‘½ä»¤æ¸…å•ã€‘çš„æ ¼å¼,ä¸ºæ¯ä¸ªæ ‡çš„(å’ŒæŒ‡æ•°)ç”Ÿæˆä¸€ä¸ªæ¸…æ™°çš„ã€å¯ä¾›ç”¨æˆ·å¤åˆ¶ç²˜è´´å»æ‰§è¡Œçš„å‘½ä»¤åˆ—è¡¨ã€‚\n\
            \nã€é¢„å¤„ç†ã€‘\n1. æå–ä»£ç :ä¾‹å¦‚ \"amzn us, QQQ\" -> [\"AMZN\", \"QQQ\"]\n2. å¤§å†™å»é‡ã€‚\n\
            \nã€æ•°æ®æŠ“å–å‘½ä»¤æ¸…å•ã€‘\n### å¿…è·‘å‘½ä»¤ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰\n**1. å¢™ä¸ç°‡è¯†åˆ«**\n!gexr {SYMBOL} {{#env.DEFAULT_STRIKES#}}\
            \ {{#env.DEFAULT_DTE_WEEKLY_SHORT#}} w \n!gexr {SYMBOL} {{#env.DEFAULT_STRIKES#}}\
            \ {{#env.DEFAULT_DTE_WEEKLY_MID#}} w\n **2. å‡€Î³ä¸é›¶Î³**\n!gexn {SYMBOL} {{#env.DEFAULT_NET_WINDOW#}}\
            \ 98 !trigger {SYMBOL} {{#env.DEFAULT_NET_WINDOW#}}\n **3. DEXæ–¹å‘ä¸€è‡´æ€§**\
            \ ``` \n!dexn {SYMBOL} {{#env.DEFAULT_STRIKES#}} {{#env.DEFAULT_DTE_WEEKLY_MID#}}\
            \ w\n **4. Vanna** \n!vanna {SYMBOL} ntm {{#env.DEFAULT_NET_WINDOW#}}\
            \ m\n\n**5. æ³¢åŠ¨ç‡**  \n!skew {SYMBOL} ivmid atm {{#env.DEFAULT_DTE_WEEKLY_SHORT#}}\
            \ \n!skew {SYMBOL} ivmid atm {{#env.DEFAULT_DTE_WEEKLY_MID#}} \n!skew\
            \ {SYMBOL} ivmid ntm {{#env.DEFAULT_DTE_WEEKLY_MID#}} w \n!term {SYMBOL}\
            \ {{#env.DEFAULT_NET_WINDOW#}}\n\n### æ‰©å±•å‘½ä»¤ï¼ˆæ¡ä»¶è§¦å‘ï¼‰\n  **è‹¥å‘¨åº¦ç°‡ç¨€ç–æˆ–æœˆåº¦ä¸»å¯¼**ï¼š \n\
            !gexr {SYMBOL} {{#env.DEFAULT_DTE_MONTHLY_SHORT#}} m \n**è‹¥éœ€æ›´è¿œåˆ°æœŸå½±å“**ï¼š \n\
            \ !gexn {SYMBOL} {{#env.EXTENDED_NET_WINDOW#}} 98 \n!dexn {SYMBOL} {{#env.DEFAULT_STRIKES#}}\
            \ {{#env.DEFAULT_DTE_MONTHLY_SHORT#}} w  \n**è‹¥7D ATM-IVå™ªå£°å¤§**ï¼ˆä¸14Då·®å¼‚>{{#env.IV_NOISE_THRESHOLD#}}%ï¼‰ï¼š\n\
            \ !skew {SYMBOL} ivmid atm 21 \n **éªŒè¯Vannaç¨³å®šæ€§**ï¼š\n !vanna {SYMBOL} ntm\
            \ {{#env.DEFAULT_DTE_MONTHLY_SHORT#}} m \n **è§£é‡Šå¯é€‰**ï¼š\n!vexn {SYMBOL} {{#env.DEFAULT_DTE_MONTHLY_SHORT#}}\
            \ 190\n### æŒ‡æ•°èƒŒæ™¯ï¼ˆå¿…éœ€ï¼‰ \n**{{#env.DEFAULT_INDEX_PRIMARY#}}ï¼ˆä¸»è¦æŒ‡æ•°ï¼‰**ï¼š !gexn\
            \ {{#env.DEFAULT_INDEX_PRIMARY#}} {{#env.DEFAULT_DTE_MONTHLY_SHORT#}}\
            \ 98 \n!trigger {{#env.DEFAULT_INDEX_PRIMARY#}} {{#env.DEFAULT_NET_WINDOW#}}\
            \ \n!skew {{#env.DEFAULT_INDEX_PRIMARY#}} ivmid atm {{#env.DEFAULT_DTE_WEEKLY_SHORT#}}\
            \ \n!skew {{#env.DEFAULT_INDEX_PRIMARY#}} ivmid atm {{#env.DEFAULT_DTE_WEEKLY_MID#}}\
            \ \n**{{#env.DEFAULT_INDEX_SECONDARY#}}ï¼ˆå¯é€‰ï¼Œç§‘æŠ€è‚¡ï¼‰**ï¼š\n !gexn {{#env.DEFAULT_INDEX_SECONDARY#}}\
            \ {{#env.DEFAULT_DTE_MONTHLY_SHORT#}} 98 \n!skew {{#env.DEFAULT_INDEX_SECONDARY#}}\
            \ ivmid atm {{#env.DEFAULT_DTE_WEEKLY_SHORT#}} \n!skew {{#env.DEFAULT_INDEX_SECONDARY#}}\
            \ ivmid atm {{#env.DEFAULT_DTE_WEEKLY_MID#}}\n\n### iv_path\n** iv_path:\
            \ æ¯”è¾ƒä»Šæ—¥ 7D ATM-IV ä¸æ˜¨æ—¥/å‰ä¸‰æ—¥,å­˜æ¡£æ•°æ®è·å–\n\n### å›ä¼ è¦æ±‚ \nâœ“ **æ¯å¼ å›¾/è¾“å‡ºè¯·æ³¨æ˜**ï¼š \n    \
            \ - å‘½ä»¤å…¨æ–‡ \n     - æ”¶ç›˜ä»·ä¸å½“æ—¥å˜åŠ¨ï¼ˆå¯é€‰ï¼‰ \nâœ“ **è‹¥ä»»ä¸€å¿…è·‘å‘½ä»¤è¾“å‡ºä¸ºç©ºæˆ–å¼‚å¸¸**ï¼š \n      - è¯·ç›´æ¥è¯´æ˜ï¼Œæˆ‘ä¼šç»™æ›¿ä»£å£å¾„\
            \ \nâœ“ **æ•°æ®å®Œæ•´æ€§æ£€æŸ¥**ï¼š \n      - ç¡®ä¿åŒ…å«SPOT PRICE \n      - ç¡®ä¿åŒ…å«Call/Put Wallæ ‡æ³¨\
            \ \n      - ç¡®ä¿åŒ…å«VOL_TRIGGERæˆ–Gamma Flipæ•°å€¼ \n\n--- \n\nè¯·ç«‹å³ä¸º **{SYMBOL}**\
            \ ç”Ÿæˆå‘½ä»¤æ¸…å•ã€‚\n\n"
        - id: user-cmdlist
          role: user
          text: è¯·ç«‹å³å¼€å§‹ä¸º{{#sys.query#}}ç”Ÿæˆå‘½ä»¤æ¸…å•ã€‚
        selected: false
        title: Agent 2 å‘½ä»¤æ¸…å•
        type: llm
        vision:
          enabled: false
      height: 116
      id: '2002'
      position:
        x: 997.7916492926931
        y: 188.21014794909684
      positionAbsolute:
        x: 997.7916492926931
        y: 188.21014794909684
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: '{{#2002.text#}}'
        desc: ''
        selected: false
        title: å›å¤å‘½ä»¤æ¸…å•
        type: answer
      height: 103
      id: '2003'
      position:
        x: 1409.7707104668832
        y: -7.965831120450034
      positionAbsolute:
        x: 1409.7707104668832
        y: -7.965831120450034
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: è§£æåŸå§‹æ•°æ®ã€è®¡ç®—æŒ‡æ ‡ã€æ£€æŸ¥å®Œæ•´æ€§
        model:
          completion_params:
            json_schema: "{\n  \"properties\": {\n    \"indices\": {\n      \"properties\"\
              : {\n        \"qqq\": {\n          \"properties\": {\n            \"\
              em1_dollar_idx\": {\n              \"description\": \"QQQçš„EM1$ï¼Œè‹¥ä¸éœ€è¦ä½¿ç”¨\
              \ -999\",\n              \"type\": \"number\"\n            },\n    \
              \        \"net_gex_idx\": {\n              \"description\": \"QQQå‡€Gammaï¼Œè‹¥ä¸éœ€è¦ä½¿ç”¨\
              \ -999\",\n              \"type\": \"number\"\n            },\n    \
              \        \"spot_idx\": {\n              \"description\": \"QQQç°ä»·ï¼Œè‹¥ä¸éœ€è¦ä½¿ç”¨\
              \ -999\",\n              \"type\": \"number\"\n            }\n     \
              \     },\n          \"required\": [\n            \"net_gex_idx\",\n\
              \            \"em1_dollar_idx\",\n            \"spot_idx\"\n       \
              \   ],\n          \"type\": \"object\"\n        },\n        \"spx\"\
              : {\n          \"properties\": {\n            \"em1_dollar_idx\": {\n\
              \              \"description\": \"SPXçš„EM1$ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n         \
              \     \"type\": \"number\"\n            },\n            \"net_gex_idx\"\
              : {\n              \"description\": \"SPXå‡€Gammaï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n    \
              \          \"type\": \"number\"\n            },\n            \"spot_idx\"\
              : {\n              \"description\": \"SPXç°ä»·ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n        \
              \      \"type\": \"number\"\n            }\n          },\n         \
              \ \"required\": [\n            \"net_gex_idx\",\n            \"em1_dollar_idx\"\
              ,\n            \"spot_idx\"\n          ],\n          \"type\": \"object\"\
              \n        }\n      },\n      \"required\": [\n        \"spx\",\n   \
              \     \"qqq\"\n      ],\n      \"type\": \"object\"\n    },\n    \"\
              missing_fields\": {\n      \"description\": \"ç¼ºå¤±å­—æ®µåˆ—è¡¨ï¼Œè‹¥æ— ç¼ºå¤±åˆ™ä¸ºç©ºæ•°ç»„\",\n\
              \      \"items\": {\n        \"properties\": {\n          \"category\"\
              : {\n            \"type\": \"string\"\n          },\n          \"field\"\
              : {\n            \"type\": \"string\"\n          },\n          \"severity\"\
              : {\n            \"enum\": [\n              \"critical\",\n        \
              \      \"high\",\n              \"medium\",\n              \"low\"\n\
              \            ],\n            \"type\": \"string\"\n          },\n  \
              \        \"target\": {\n            \"type\": \"string\"\n         \
              \ }\n        },\n        \"required\": [\n          \"field\",\n   \
              \       \"target\",\n          \"severity\",\n          \"category\"\
              \n        ],\n        \"type\": \"object\"\n      },\n      \"type\"\
              : \"array\"\n    },\n    \"next_step\": {\n      \"enum\": [\n     \
              \   \"proceed_to_analysis\",\n        \"request_missing_data\"\n   \
              \   ],\n      \"type\": \"string\"\n    },\n    \"status\": {\n    \
              \  \"description\": \"æ•°æ®çŠ¶æ€\",\n      \"enum\": [\n        \"data_ready\"\
              ,\n        \"missing_data\"\n      ],\n      \"type\": \"string\"\n\
              \    },\n    \"targets\": {\n      \"properties\": {\n        \"atm_iv\"\
              : {\n          \"properties\": {\n            \"iv_14d\": {\n      \
              \        \"description\": \"14æ—¥ATMéšå«æ³¢åŠ¨ç‡ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n            \
              \  \"type\": \"number\"\n            },\n            \"iv_7d\": {\n\
              \              \"description\": \"7æ—¥ATMéšå«æ³¢åŠ¨ç‡ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n       \
              \       \"type\": \"number\"\n            },\n            \"iv_source\"\
              : {\n              \"description\": \"IVæ•°æ®æº\",\n              \"enum\"\
              : [\n                \"7d\",\n                \"14d\",\n           \
              \     \"21d_fallback\",\n                \"N/A\"\n              ],\n\
              \              \"type\": \"string\"\n            }\n          },\n \
              \         \"required\": [\n            \"iv_7d\",\n            \"iv_14d\"\
              ,\n            \"iv_source\"\n          ],\n          \"type\": \"object\"\
              \n        },\n        \"directional_metrics\": {\n          \"properties\"\
              : {\n            \"dex_same_dir_pct\": {\n              \"description\"\
              : \"DEXæ–¹å‘ä¸€è‡´æ€§ç™¾åˆ†æ¯”ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n              \"type\": \"number\"\n\
              \            },\n            \"iv_path\": {\n              \"description\"\
              : \"éšå«æ³¢åŠ¨ç‡è·¯å¾„\",\n              \"enum\": [\n                \"å‡\",\n\
              \                \"é™\",\n                \"å¹³\",\n                \"\
              æ•°æ®ä¸è¶³\"\n              ],\n              \"type\": \"string\"\n     \
              \       },\n            \"iv_path_confidence\": {\n              \"\
              description\": \"IVè·¯å¾„ç½®ä¿¡åº¦\",\n              \"enum\": [\n           \
              \     \"high\",\n                \"medium\",\n                \"low\"\
              \n              ],\n              \"type\": \"string\"\n           \
              \ },\n            \"vanna_confidence\": {\n              \"description\"\
              : \"Vannaç½®ä¿¡åº¦ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ N/A\",\n              \"enum\": [\n             \
              \   \"high\",\n                \"medium\",\n                \"low\"\
              ,\n                \"N/A\"\n              ],\n              \"type\"\
              : \"string\"\n            },\n            \"vanna_dir\": {\n       \
              \       \"description\": \"Vannaæ–¹å‘ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ N/A\",\n              \"enum\"\
              : [\n                \"up\",\n                \"down\",\n          \
              \      \"flat\",\n                \"N/A\"\n              ],\n      \
              \        \"type\": \"string\"\n            }\n          },\n       \
              \   \"required\": [\n            \"dex_same_dir_pct\",\n           \
              \ \"vanna_dir\",\n            \"vanna_confidence\",\n            \"\
              iv_path\",\n            \"iv_path_confidence\"\n          ],\n     \
              \     \"type\": \"object\"\n        },\n        \"em1_dollar\": {\n\
              \          \"description\": \"é¢„æœŸå•æ—¥æ³¢å¹…ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n          \"type\"\
              : \"number\"\n        },\n        \"gamma_metrics\": {\n          \"\
              properties\": {\n            \"cluster_strength_ratio\": {\n       \
              \       \"description\": \"ç°‡å¼ºåº¦æ¯”ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n              \"type\"\
              : \"number\"\n            },\n            \"gap_distance_dollar\": {\n\
              \              \"description\": \"è·å¢™è·ç¦»ç¾å…ƒå€¼ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n          \
              \    \"type\": \"number\"\n            },\n            \"gap_distance_em1_multiple\"\
              : {\n              \"description\": \"è·å¢™è·ç¦»EM1å€æ•°ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n    \
              \          \"type\": \"number\"\n            },\n            \"monthly_cluster_override\"\
              : {\n              \"description\": \"æ˜¯å¦æœˆåº¦ç°‡å ä¼˜\",\n              \"type\"\
              : \"boolean\"\n            },\n            \"net_gex\": {\n        \
              \      \"description\": \"å‡€Gammaæ•å£ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n              \"type\"\
              : \"number\"\n            },\n            \"net_gex_sign\": {\n    \
              \          \"description\": \"å‡€Gammaç¬¦å·ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ N/A\",\n              \"\
              enum\": [\n                \"positive_gamma\",\n                \"negative_gamma\"\
              ,\n                \"neutral\",\n                \"N/A\"\n         \
              \     ],\n              \"type\": \"string\"\n            },\n     \
              \       \"spot_vs_trigger\": {\n              \"description\": \"ç°ä»·ç›¸å¯¹è§¦å‘çº¿ä½ç½®ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨\
              \ N/A\",\n              \"enum\": [\n                \"above\",\n  \
              \              \"below\",\n                \"near\",\n             \
              \   \"N/A\"\n              ],\n              \"type\": \"string\"\n\
              \            },\n            \"vol_trigger\": {\n              \"description\"\
              : \"æ³¢åŠ¨ç‡è§¦å‘ä»·ä½ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n              \"type\": \"number\"\n    \
              \        }\n          },\n          \"required\": [\n            \"\
              gap_distance_dollar\",\n            \"gap_distance_em1_multiple\",\n\
              \            \"cluster_strength_ratio\",\n            \"net_gex\",\n\
              \            \"net_gex_sign\",\n            \"vol_trigger\",\n     \
              \       \"spot_vs_trigger\",\n            \"monthly_cluster_override\"\
              \n          ],\n          \"type\": \"object\"\n        },\n       \
              \ \"spot_price\": {\n          \"description\": \"ç°ä»·ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n\
              \          \"type\": \"number\"\n        },\n        \"status\": {\n\
              \          \"enum\": [\n            \"ready\",\n            \"missing_data\"\
              \n          ],\n          \"type\": \"string\"\n        },\n       \
              \ \"symbol\": {\n          \"type\": \"string\"\n        },\n      \
              \  \"walls\": {\n          \"properties\": {\n            \"call_wall\"\
              : {\n              \"description\": \"çœ‹æ¶¨æœŸæƒå¢™ä»·ä½ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n      \
              \        \"type\": \"number\"\n            },\n            \"major_wall\"\
              : {\n              \"description\": \"ä¸»è¦å¢™ä»·ä½ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n        \
              \      \"type\": \"number\"\n            },\n            \"major_wall_type\"\
              : {\n              \"description\": \"ä¸»è¦å¢™ç±»å‹ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ N/A\",\n         \
              \     \"enum\": [\n                \"call\",\n                \"put\"\
              ,\n                \"N/A\"\n              ],\n              \"type\"\
              : \"string\"\n            },\n            \"put_wall\": {\n        \
              \      \"description\": \"çœ‹è·ŒæœŸæƒå¢™ä»·ä½ï¼Œè‹¥ç¼ºå¤±ä½¿ç”¨ -999\",\n              \"type\"\
              : \"number\"\n            }\n          },\n          \"required\": [\n\
              \            \"call_wall\",\n            \"put_wall\",\n           \
              \ \"major_wall\",\n            \"major_wall_type\"\n          ],\n \
              \         \"type\": \"object\"\n        }\n      },\n      \"required\"\
              : [\n        \"symbol\",\n        \"status\",\n        \"spot_price\"\
              ,\n        \"em1_dollar\",\n        \"walls\",\n        \"gamma_metrics\"\
              ,\n        \"directional_metrics\",\n        \"atm_iv\"\n      ],\n\
              \      \"type\": \"object\"\n    },\n    \"timestamp\": {\n      \"\
              description\": \"æ—¶é—´æˆ³ï¼Œæ ¼å¼ YYYY-MM-DDTHH:mm:ss\",\n      \"type\": \"string\"\
              \n    },\n    \"validation_summary\": {\n      \"properties\": {\n \
              \       \"completion_rate\": {\n          \"type\": \"integer\"\n  \
              \      },\n        \"fields_provided\": {\n          \"type\": \"integer\"\
              \n        },\n        \"missing_count\": {\n          \"type\": \"integer\"\
              \n        },\n        \"targets_ready\": {\n          \"type\": \"integer\"\
              \n        },\n        \"total_fields_required\": {\n          \"type\"\
              : \"integer\"\n        },\n        \"total_targets\": {\n          \"\
              type\": \"integer\"\n        }\n      },\n      \"required\": [\n  \
              \      \"total_targets\",\n        \"targets_ready\",\n        \"total_fields_required\"\
              ,\n        \"fields_provided\",\n        \"missing_count\",\n      \
              \  \"completion_rate\"\n      ],\n      \"type\": \"object\"\n    },\n\
              \    \"è¡¥é½åç»­\": {\n      \"description\": \"è¡¥é½åçš„åç»­æ­¥éª¤ï¼Œå½“status=data_readyæ—¶å¡«\
              \ N/A\",\n      \"type\": \"string\"\n    },\n    \"è¡¥é½æŒ‡å¼•\": {\n    \
              \  \"description\": \"è¡¥é½æŒ‡å¼•åˆ—è¡¨ï¼Œå½“status=data_readyæ—¶ä¸ºç©ºæ•°ç»„\",\n      \"items\"\
              : {\n        \"properties\": {\n          \"alternative\": {\n     \
              \       \"description\": \"å¤‡é€‰æ–¹æ¡ˆï¼Œè‹¥æ— åˆ™å¡« N/A\",\n            \"type\": \"\
              string\"\n          },\n          \"command\": {\n            \"description\"\
              : \"å»ºè®®æ‰§è¡Œçš„å‘½ä»¤\",\n            \"type\": \"string\"\n          },\n   \
              \       \"description\": {\n            \"description\": \"å­—æ®µè¯´æ˜\",\n\
              \            \"type\": \"string\"\n          },\n          \"extraction_note\"\
              : {\n            \"description\": \"æ•°æ®æå–è¯´æ˜\",\n            \"type\"\
              : \"string\"\n          },\n          \"impact\": {\n            \"\
              description\": \"ç¼ºå¤±å½±å“è¯´æ˜\",\n            \"type\": \"string\"\n     \
              \     },\n          \"missing_field\": {\n            \"description\"\
              : \"ç¼ºå¤±å­—æ®µå\",\n            \"type\": \"string\"\n          },\n     \
              \     \"priority\": {\n            \"description\": \"ä¼˜å…ˆçº§1-5\",\n  \
              \          \"maximum\": 5,\n            \"minimum\": 1,\n          \
              \  \"type\": \"integer\"\n          }\n        },\n        \"required\"\
              : [\n          \"missing_field\",\n          \"description\",\n    \
              \      \"command\",\n          \"alternative\",\n          \"extraction_note\"\
              ,\n          \"priority\",\n          \"impact\"\n        ],\n     \
              \   \"type\": \"object\"\n      },\n      \"type\": \"array\"\n    }\n\
              \  },\n  \"required\": [\n    \"status\",\n    \"timestamp\",\n    \"\
              validation_summary\",\n    \"targets\",\n    \"indices\",\n    \"missing_fields\"\
              ,\n    \"next_step\",\n    \"è¡¥é½æŒ‡å¼•\",\n    \"è¡¥é½åç»­\"\n  ],\n  \"type\"\
              : \"object\"\n}"
            response_format: json_schema
          mode: chat
          name: Qwen3-VL-235B-A22B-Thinking
          provider: langgenius/openai_api_compatible/openai_api_compatible
        prompt_config:
          jinja2_variables: []
        prompt_template:
        - id: sys-validate
          role: system
          text: "ä½ æ˜¯æœŸæƒç»“æ„å’Œæ³¢åŠ¨ç‡ç‰¹å¾å›¾åƒè§£æå™¨ã€æ•°æ®æ ¡éªŒå’Œè®¡ç®— Agentã€‚\n**æ ¸å¿ƒä»»åŠ¡**: \n1. è§£ææœŸæƒæ•°æ®å›¾è¡¨(GEX/DEX/Vanna/IV/Skew)\n\
            2. æå–æŠ€æœ¯é¢æŒ‡æ ‡(EMA/RSI/BB/MACD/Volume)\n3. è®¡ç®—æ ¸å¿ƒæŒ‡æ ‡(EM1$/gapè·ç¦»/ç°‡å¼ºåº¦ç­‰)\n4. æ‰§è¡Œä¸‰çº§æ•°æ®éªŒè¯\n\
            5. ç”Ÿæˆè¡¥é½æŒ‡å¼•(è‹¥æ•°æ®ç¼ºå¤±)\n**ç›®æ ‡**: \nç›®æ ‡æ˜¯è¾“å‡ºæ ‡å‡†æ•°æ®å¹¶ä¸¥æ ¼æŒ‰ç…§ã€æ•°æ®å£å¾„ä¸æŒ‡æ ‡å®šä¹‰ã€‘è®¡ç®—æ‰€æœ‰æ ¸å¿ƒå­—æ®µ\n\nã€ç³»ç»Ÿç¯å¢ƒå˜é‡\
            \ - è®¡ç®—å‚æ•°ã€‘ \n- EM1$è®¡ç®—å› å­ï¼šsqrt(1/252) = {{#env.EM1_SQRT_FACTOR#}} \n- ç ´å¢™é˜ˆå€¼ä¸‹é™ï¼š{{#env.BREAK_WALL_THRESHOLD_LOW#}}\
            \ Ã— EM1$ \n- ç ´å¢™é˜ˆå€¼ä¸Šé™ï¼š{{#env.BREAK_WALL_THRESHOLD_HIGH#}} Ã— EM1$ \n- æœˆåº¦å ä¼˜é˜ˆå€¼ç³»æ•°ï¼š{{#env.MONTHLY_OVERRIDE_THRESHOLD#}}\
            \ \n- æœˆåº¦ç°‡å¼ºåº¦è§¦å‘æ¯”ï¼š{{#env.MONTHLY_CLUSTER_STRENGTH_RATIO#}} \n- ç°‡å¼ºåº¦è¶‹åŠ¿é˜ˆå€¼ï¼š{{#env.CLUSTER_STRENGTH_THRESHOLD_T#}}\
            \ \n- ç°‡å¼ºåº¦æå¼ºé˜ˆå€¼ï¼š{{#env.CLUSTER_STRENGTH_THRESHOLD_S#}} \n- å¢™è¯†åˆ«å³°å€¼å€æ•°ï¼š{{#env.WALL_PEAK_MULTIPLIER#}}\
            \ \n- å¢™è¯†åˆ«ç°‡å®½åº¦ï¼š{{#env.WALL_CLUSTER_WIDTH#}} \n- DEXå¼ºä¿¡å·é˜ˆå€¼ï¼š{{#env.DEX_SAME_DIR_THRESHOLD_STRONG#}}%\
            \ \n- DEXä¸­ç­‰ä¿¡å·é˜ˆå€¼ï¼š{{#env.DEX_SAME_DIR_THRESHOLD_MEDIUM#}}% \n- IVè·¯å¾„é˜ˆå€¼ï¼š{{#env.IV_PATH_THRESHOLD_VOL#}}\
            \ vol æˆ– {{#env.IV_PATH_THRESHOLD_PCT#}}% \n- IVå™ªå£°é˜ˆå€¼ï¼š{{#env.IV_NOISE_THRESHOLD#}}%\
            \ \n- é»˜è®¤strikesï¼š{{#env.DEFAULT_STRIKES#}} \n- é»˜è®¤NETçª—å£ï¼š{{#env.DEFAULT_NET_WINDOW#}}å¤©\n\
            \n\n## é˜¶æ®µ 1: æ•°æ®æå–è§„åˆ™\n\n\n### 1.1 æœŸæƒæ ¸å¿ƒæ•°æ®(22 å¿…éœ€å­—æ®µ)\n\n\n#### A. åŸºç¡€ä»·æ ¼æ•°æ®\n\
            - **spot_price**: å½“å‰æ ‡çš„ä»·æ ¼,ä»å›¾è¡¨æ ‡é¢˜æˆ–æœ€æ–°Kçº¿æå–\n- **em1_dollar**: é¢„æœŸå•æ—¥æ³¢å¹…ç¾å…ƒå€¼\n \
            \ - å…¬å¼: `Spot Ã— min(ATM_IV_7D, ATM_IV_14D) Ã— {{#env.EM1_SQRT_FACTOR#}}`\n\
            \  - ä¼˜å…ˆä½¿ç”¨ 7D ATM-IV\n  - è‹¥ 7D ä¸ 14D å·®å¼‚ > {{#env.IV_NOISE_THRESHOLD#}}%,åˆ™ç”¨\
            \ 14D\n\n\n#### B. å¢™ä¸ç°‡è¯†åˆ«\nä» `!gexr SYMBOL {{#env.DEFAULT_STRIKES#}} 7w`\
            \ å’Œ `14w` è¾“å‡ºè¯†åˆ«:\n\n\n**å¢™è¯†åˆ«è§„åˆ™**:\n- å±€éƒ¨å³° â‰¥ ç›¸é‚» Î³ ä¸­ä½æ•° Ã— {{#env.WALL_PEAK_MULTIPLIER#}}\
            \ å€\n- ä¸”ç°‡å®½ â‰¥ {{#env.WALL_CLUSTER_WIDTH#}} ä¸ªç›¸é‚»è¡Œæƒä»·\n\n\n**è¾“å‡ºå­—æ®µ**:\n- **call_wall**:\
            \ çœ‹æ¶¨æœŸæƒå¢™ä»·ä½\n- **put_wall**: çœ‹è·ŒæœŸæƒå¢™ä»·ä½\n- **major_wall**: Call/Put å¢™ä¸­ GEX\
            \ ç»å¯¹å€¼æ›´å¤§è€…\n- **major_wall_type**: \"call\" æˆ– \"put\"\n\n\n#### C. Gamma\
            \ çŠ¶æ€åˆ¤å®š\nä» `!trigger SYMBOL {{#env.DEFAULT_NET_WINDOW#}}` æå–:\n\n\n- **vol_trigger**:\
            \ Gamma ç¿»è½¬ä»·ä½(VOL_TRIGGER æˆ– Gamma Flip)\n- **spot_vs_trigger**: ç°ä»·ç›¸å¯¹è§¦å‘çº¿ä½ç½®\n\
            \  - è‹¥ SPOT > VOL_TRIGGER: \"above\"\n  - è‹¥ SPOT < VOL_TRIGGER: \"below\"\
            \n  - è‹¥ SPOT æ¥è¿‘ VOL_TRIGGER (Â±0.3Ã—EM1$): \"near\"\n\n\nä» `!gexn SYMBOL\
            \ {{#env.DEFAULT_NET_WINDOW#}} 98` æå–:\n- **net_gex**: NET-GEX æ•°å€¼\n- **net_gex_sign**:\
            \ å‡€ Gamma ç¬¦å·\n  - NET-GEX < 0: \"negative_gamma\"\n  - NET-GEX > 0: \"\
            positive_gamma\"\n  - NET-GEX â‰ˆ 0: \"neutral\"\n\n\n#### D. è·ç¦»ä¸å¼ºåº¦æŒ‡æ ‡\n\
            ä» `!gexr` è¾“å‡ºçš„ ABS_GEX åˆ†å¸ƒè®¡ç®—:\n\n\n- **gap_distance_dollar**: å½“å‰ä»·åˆ°ä¸‹ä¸€ ABS_GEX\
            \ å³°ç°‡çš„ç¾å…ƒè·ç¦»\n  - æ–¹å‘: è‹¥ spot_vs_trigger=\"above\" å‘ä¸Šçœ‹ Call_Wall\n  - æ–¹å‘:\
            \ è‹¥ spot_vs_trigger=\"below\" å‘ä¸‹çœ‹ Put_Wall\n\n\n- **gap_distance_em1_multiple**:\
            \ gap_distance_dollar Ã· EM1$\n\n\n- **cluster_strength_ratio**: ä¸»å¢™ GEX\
            \ ç»å¯¹å€¼ Ã· æ¬¡å¢™ GEX ç»å¯¹å€¼\n  - è‹¥ä»…å•å³°æ— å¯¹ç…§,è¡¥è·‘ `!gexr SYMBOL {{#env.DEFAULT_STRIKES#}}\
            \ {{#env.DEFAULT_DTE_MONTHLY_SHORT#}} m`\n  - æˆ–å»¶é•¿ DTE ä»¥å¯»å‚ç…§å³°\n\n\n- **monthly_cluster_override**:\
            \ æœˆåº¦ç°‡æ˜¯å¦å ä¼˜\n  - è‹¥æœˆåº¦ç°‡å¼ºåº¦ â‰¥ å‘¨åº¦ Ã— {{#env.MONTHLY_CLUSTER_STRENGTH_RATIO#}}:\
            \ true\n  - å¦åˆ™: false\n\n\n#### E. æ–¹å‘ä¿¡å·\nä» `!dexn SYMBOL {{#env.DEFAULT_STRIKES#}}\
            \ 14w` æå–:\n\n\n- **dex_same_dir_pct**: gap åŒºé—´å†…åŒå‘ DEX å‡€å’Œåœ¨ 60 æ—¥å†å²ä¸­çš„åˆ†ä½ç™¾åˆ†æ¯”(0-100)\n\
            \n\nä» `!vanna SYMBOL ntm {{#env.DEFAULT_NET_WINDOW#}} m` æå–(ä¸‰çº§å›é€€):\n-\
            \ **vanna_dir**: Vanna æ–¹å‘ (\"up\" | \"down\" | \"flat\")\n- **vanna_confidence**:\
            \ Vanna ç½®ä¿¡åº¦ (\"high\" | \"medium\" | \"low\")\n  - ä¼˜å…ˆ: ntm 60 day monthly\
            \ â†’ confidence = \"high\"\n  - è‹¥ç¼º: ntm {{#env.DEFAULT_DTE_MONTHLY_SHORT#}}\
            \ m â†’ confidence = \"medium\"\n  - è‹¥ä»ç¼º: æŒ‰ skew ä¸ delta åæ–œä¸´æ—¶æ¨æ–­ â†’ confidence\
            \ = \"low\"\n\n\n#### F. IV åŠ¨æ€\nä» `!skew SYMBOL ivmid atm 7` å’Œ `14` æå–:\n\
            \n\n- **iv_7d**: 7 æ—¥ ATM éšå«æ³¢åŠ¨ç‡(å°æ•°å½¢å¼,å¦‚ 0.45)\n- **iv_14d**: 14 æ—¥ ATM éšå«æ³¢åŠ¨ç‡\n\
            - **iv_source**: IV æ•°æ®æº (\"7d\" | \"14d\" | \"21d_fallback\")\n  - ä¼˜å…ˆä½¿ç”¨\
            \ 7D\n  - è‹¥ 7D ä¸ 14D å·®å¼‚ > {{#env.IV_NOISE_THRESHOLD#}}%,åˆ™ç”¨ 14D\n  - ä¸¤è€…çš†ç¼ºæ—¶è¡¥\
            \ 21D\n\n\nä»å†å² IV æ•°æ®æˆ– `!term SYMBOL` æ¨æ–­:\n- **iv_path**: IV è·¯å¾„è¶‹åŠ¿ (\"å‡\"\
            \ | \"é™\" | \"å¹³\" | \"æ•°æ®ä¸è¶³\")\n  - æ¯”è¾ƒä»Šæ—¥ 7D_ATM_IV ä¸æ˜¨æ—¥/å‰ä¸‰æ—¥\n  - æ˜¾è‘—é˜ˆå€¼: Â±{{#env.IV_PATH_THRESHOLD_VOL#}}\
            \ vol æˆ– Â±{{#env.IV_PATH_THRESHOLD_PCT#}}% ç›¸å¯¹å˜åŒ–\n\n\n- **iv_path_confidence**:\
            \ IV è·¯å¾„ç½®ä¿¡åº¦ (\"high\" | \"medium\" | \"low\")\n  - æœ‰å†å²æ•°æ®: \"high\"\n  -\
            \ ä»… term structure æ¨æ–­: \"medium\"\n  - Backwardation â†’ \"å‡\", Contango\
            \ â†’ \"é™\"\n\n\n---\n\n\n### 1.2 æŠ€æœ¯é¢æ•°æ®(å¯é€‰å­—æ®µ)\n\n\n**é‡è¦**: æŠ€æœ¯é¢æ•°æ®å®Œå…¨å¯é€‰,è‹¥å›¾è¡¨æœªåŒ…å«æŠ€æœ¯æŒ‡æ ‡,ä¸å½±å“\
            \ status åˆ¤å®šã€‚\n\n\n#### A. å›¾è¡¨å…ƒæ•°æ®\n- **platform**: è¯†åˆ«å¹³å°(TradingView/Thinkorswim/Yahoo\
            \ Finance/å…¶ä»–)\n- **timeframe**: æ—¶é—´å‘¨æœŸ(Daily/4H/1H)\n- **latest_timestamp**:\
            \ æœ€æ–°æ—¶é—´æˆ³\n\n\n#### B. ä»·æ ¼ä¸å‡çº¿\nä»å›¾è¡¨æœ€æ–° K çº¿æå–:\n\n\n- **close**: æ”¶ç›˜ä»·\n- **ema20**:\
            \ EMA20 æ•°å€¼\n- **ema50**: EMA50 æ•°å€¼\n- **price_vs_ema20_pct**: (close -\
            \ ema20) / ema20 Ã— 100\n- **price_vs_ema50_pct**: (close - ema50) / ema50\
            \ Ã— 100\n- **ema20_slope**: EMA20 æ–œç‡(\"ä¸Šè¡Œ\" | \"èµ°å¹³\" | \"ä¸‹è¡Œ\")\n- **ema50_slope**:\
            \ EMA50 æ–œç‡\n- **golden_cross**: æ˜¯å¦é‡‘å‰(ema20 > ema50: true)\n\n\n#### C.\
            \ RSI æŒ‡æ ‡\n- **rsi_value**: RSI(14) å½“å‰å€¼\n- **rsi_zone**: RSI åŒºé—´(\"è¶…ä¹°\"\
            \ | \"ä¸­æ€§åå¼º\" | \"ä¸­æ€§\" | \"ä¸­æ€§åå¼±\" | \"è¶…å–\")\n- **rsi_divergence**: èƒŒç¦»å½¢æ€(\"\
            é¡¶èƒŒç¦»\" | \"åº•èƒŒç¦»\" | \"æ— \")\n\n\n#### D. å¸ƒæ—å¸¦\n- **bb_width**: BB å®½åº¦(ä¸Šè½¨ -\
            \ ä¸‹è½¨)\n- **bb_width_percentile**: å½“å‰å®½åº¦åœ¨å†å²ä¸­çš„åˆ†ä½(0-100)\n- **bb_position**:\
            \ ä»·æ ¼ç›¸å¯¹å¸ƒæ—å¸¦ä½ç½®(\"ä¸Šè½¨ä¸Šæ–¹\" | \"ä¸­è½¨ä¸Šæ–¹\" | \"ä¸­è½¨\" | \"ä¸­è½¨ä¸‹æ–¹\" | \"ä¸‹è½¨ä¸‹æ–¹\")\n- **bb_band_direction**:\
            \ å¸¦å£æ–¹å‘(\"æ‰©å¼ \" | \"å¹³è¡Œ\" | \"æ”¶ç¼©\")\n\n\n#### E. MACD\n- **macd_histogram**:\
            \ æŸ±çŠ¶å›¾è¶‹åŠ¿(\"æ­£å€¼æ‰©å¤§\" | \"æ­£å€¼æ”¶æ•›\" | \"è´Ÿå€¼æ‰©å¤§\" | \"è´Ÿå€¼æ”¶æ•›\")\n- **macd_signal_line_cross**:\
            \ å¿«æ…¢çº¿äº¤å‰(\"é‡‘å‰åç¬¬Næ—¥\" | \"æ­»å‰åç¬¬Næ—¥\" | \"æ— äº¤å‰\")\n- **macd_zero_line**: ç›¸å¯¹é›¶è½´ä½ç½®(\"\
            ä¸Šæ–¹\" | \"ä¸‹æ–¹\" | \"æ¥è¿‘é›¶è½´\")\n\n\n#### F. æˆäº¤é‡\n- **volume_current**: å½“å‰æˆäº¤é‡\n\
            - **volume_avg_20d**: 20 æ—¥å¹³å‡æˆäº¤é‡\n- **volume_ratio**: current / avg_20d\n\
            - **volume_status**: æˆäº¤é‡çŠ¶æ€(\"æ˜¾è‘—æ”¾é‡\" | \"æ¸©å’Œæ”¾é‡\" | \"æ­£å¸¸\" | \"ç¼©é‡\")\n\n\n\
            #### G. æŠ€æœ¯é¢è¯„åˆ†\næ ¹æ®ä»¥ä¸‹è§„åˆ™è®¡ç®— **ta_score**(0-2 åˆ†,æœ€å¤š +2):\n\n\n**è¯„åˆ†è§„åˆ™**:\n- EMA\
            \ åˆ¤æ–­(æœ€å¤š +1):\n  - EMA20/50 å‘æ•£å‘ä¸Šä¸” golden_cross=true â†’ +1\n  - EMA20/50\
            \ èµ°å¹³æˆ–ç²˜åˆ â†’ +1\n  - å…¶ä»– â†’ 0\n\n\n- RSI åˆ¤æ–­(æœ€å¤š +1):\n  - RSI > 60 ä¸”æ— é¡¶èƒŒç¦» â†’ +1\n\
            \  - RSI åœ¨ 40-60 â†’ +1\n  - RSI èƒŒç¦» â†’ -1\n\n\n- BB åˆ¤æ–­(æœ€å¤š +1,å¯å åŠ ä½†æ€»åˆ†ä¸Šé™ 2):\n\
            \  - BB å®½åº¦ä½åˆ†ä½ + åŒå‘å¼€å£ â†’ +1(æ‹©ä¸€è®¡åˆ†)\n\n\n**è¯„åˆ†ä¸Šé™**: æœ€å¤šç´¯è®¡ +2 åˆ†\n\n\n**ta_commentary**:\
            \ ç®€è¿°è¯„åˆ†ç†ç”±(ä¸è¶…è¿‡ 80 å­—)\n\n\n---\n\n\n## é˜¶æ®µ 2: æŒ‡æ•°èƒŒæ™¯æ•°æ®(ä½ä¼˜å…ˆçº§)\n\n\né»˜è®¤ {{#env.DEFAULT_INDEX_PRIMARY#}}(SPX),å¿…è¦æ—¶\
            \ {{#env.DEFAULT_INDEX_SECONDARY#}}(QQQ)ã€‚\n\n\nä» `!gexn SPX {{#env.DEFAULT_DTE_MONTHLY_SHORT#}}\
            \ 98` å’Œ `!trigger SPX {{#env.DEFAULT_NET_WINDOW#}}` æå–:\n\n\n- **indices.spx.net_gex_idx**:\
            \ SPX çš„ NET-GEX\n- **indices.spx.spot_idx**: SPX ç°ä»·\n\n\nä» `!skew SPX\
            \ ivmid atm 7` å’Œ `14` è®¡ç®—:\n- **indices.spx.em1_dollar_idx**: SPX çš„ EM1$\n\
            \n\nåŒç†å¤„ç† QQQ(å¯é€‰)ã€‚\n\n\n**é‡è¦**: è‹¥æŒ‡æ•°æ•°æ®å…¨ä¸º -999,ä¸å½±å“ status åˆ¤å®š,ä»…åœ¨ validation_summary.warnings\
            \ ä¸­æ ‡æ³¨ã€‚\n\n\n---\n\n\n## é˜¶æ®µ 3: æ•°æ®éªŒè¯ä¸çŠ¶æ€åˆ¤å®š\n\n\n### ä¸‰çº§éªŒè¯è§„åˆ™(å†³ç­–æ ‘)\n\n\n```\n\
            ç¬¬ä¸€çº§:æ£€æŸ¥ 22 ä¸ªå¿…éœ€å­—æ®µ\n  â”œâ”€ è‹¥ä»»ä¸€å­—æ®µä¸º -999/null/\"N/A\"/\"æ•°æ®ä¸è¶³\"\n  â”‚   â””â”€ status\
            \ = \"missing_data\"\n  â””â”€ è‹¥å…¨éƒ¨æœ‰æ•ˆ\n      â””â”€ è¿›å…¥ç¬¬äºŒçº§\n\n\nç¬¬äºŒçº§:æ£€æŸ¥æŒ‡æ•°èƒŒæ™¯\n  â”œâ”€\
            \ è‹¥ SPX å’Œ QQQ å…¨ä¸º -999\n  â”‚   â”œâ”€ æ·»åŠ  warning: \"âš ï¸ æŒ‡æ•°èƒŒæ™¯æ•°æ®ç¼ºå¤±,ä¸å½±å“ä¸ªè‚¡åˆ†æ\"\n\
            \  â”‚   â””â”€ ç»§ç»­ç¬¬ä¸‰çº§\n  â””â”€ è‹¥è‡³å°‘ä¸€ä¸ªæŒ‡æ•°æœ‰æ•ˆ\n      â””â”€ è¿›å…¥ç¬¬ä¸‰çº§\n\n\nç¬¬ä¸‰çº§:æ£€æŸ¥æŠ€æœ¯é¢(å¯é€‰)\n \
            \ â”œâ”€ è‹¥ technical_analysis ä¸å­˜åœ¨æˆ– ta_score = 0\n  â”‚   â””â”€ æ·»åŠ  warning: \"\U0001F4A1\
            \ æŠ€æœ¯é¢æ•°æ®ç¼ºå¤±,ä»…å½±å“è¯„åˆ†\"\n  â””â”€ æœ€ç»ˆ status = \"data_ready\"\n```\n\n\n### status\
            \ æœ€ç»ˆåˆ¤å®š\n\n\n**å”¯ä¸€åˆ¤å®šæ ‡å‡†**: 22 ä¸ªå¿…éœ€å­—æ®µæ˜¯å¦å…¨éƒ¨æœ‰æ•ˆ\n\n\n- è‹¥å…¨éƒ¨æœ‰æ•ˆ â†’ `status = \"data_ready\"\
            `\n- è‹¥ä»»ä¸€ç¼ºå¤± â†’ `status = \"missing_data\"`\n\n\n**æ¬¡è¦å­—æ®µ(ä¸å½±å“ status)**:\n\
            - æŒ‡æ•°èƒŒæ™¯(indices): ç¼ºå¤±æ—¶ä»…è­¦å‘Š\n- æŠ€æœ¯é¢(technical_analysis): ç¼ºå¤±æ—¶ä»…è­¦å‘Š\n\n\n---\n\n\
            \n## é˜¶æ®µ 4: è¡¥é½æŒ‡å¼•ç”Ÿæˆ(ä»… status=\"missing_data\" æ—¶)\n\n\n### ä¼˜å…ˆçº§å®šä¹‰\n\n\n**Priority\
            \ 1 (Critical)**: å½±å“ Gamma Regime åˆ¤æ–­\n- vol_trigger\n- spot_vs_trigger\n\
            - net_gex\n- net_gex_sign\n\n\n**Priority 2 (High)**: å½±å“æ ¸å¿ƒè®¡ç®—\n- em1_dollar\n\
            - gap_distance_dollar\n- gap_distance_em1_multiple\n- call_wall / put_wall\n\
            \n\n**Priority 3 (Medium)**: å½±å“æ–¹å‘åˆ¤æ–­\n- dex_same_dir_pct\n- vanna_dir /\
            \ vanna_confidence\n- iv_path / iv_path_confidence\n\n\n**Priority 4-5\
            \ (Low/Optional)**: è¡¥å……æ€§å­—æ®µ\n- cluster_strength_ratio\n- monthly_cluster_override\n\
            \n\n### è¡¥é½æŒ‡å¼•æ ¼å¼\n\n\nä¸ºæ¯ä¸ªç¼ºå¤±å­—æ®µç”Ÿæˆ:\n\n\n- **missing_field**: å­—æ®µå\n- **description**:\
            \ å­—æ®µè¯´æ˜\n- **command**: å»ºè®®æ‰§è¡Œçš„å‘½ä»¤\n- **alternative**: å¤‡é€‰æ–¹æ¡ˆ\n- **extraction_note**:\
            \ æ•°æ®æå–è¯´æ˜\n- **priority**: ä¼˜å…ˆçº§(1-5)\n- **impact**: ç¼ºå¤±å½±å“è¯´æ˜\n---\n\n## é˜¶æ®µ\
            \ 5: è¾“å‡ºè§„èŒƒ\n\n\n### å…³é”®åŸåˆ™\n\n\n1. **ä¸¥æ ¼ä¾èµ– JSON Schema**: ä¸è¦åœ¨ prompt ä¸­å†™ JSON\
            \ ç¤ºä¾‹\n2. **ä½¿ç”¨å ä½ç¬¦**: æ‰€æœ‰ç¯å¢ƒå˜é‡çš„å¼•ç”¨\n3. **è‡ªç„¶è¯­è¨€æè¿°**: ç”¨å†³ç­–æ ‘/è§„åˆ™æè¿°,ä¸ç”¨ Python ä»£ç å—\n\
            4. **çŠ¶æ€ä¸€è‡´æ€§**: validation_summary å¿…é¡»ä¸ status ä¸€è‡´\n\n\n### æ•°æ®è´¨é‡æ ‡æ³¨\n\n\n####\
            \ validation_summary å­—æ®µè¯´æ˜\n\n\n- **total_targets**: 1(å›ºå®š)\n- **targets_ready**:\
            \ status=\"data_ready\" ? 1 : 0\n- **total_fields_required**: 22(å›ºå®š)\n\
            - **fields_provided**: å®é™…æä¾›çš„æœ‰æ•ˆå­—æ®µæ•°\n- **missing_count**: ç¼ºå¤±å­—æ®µæ•°é‡\n- **completion_rate**:\
            \ fields_provided / 22 Ã— 100\n\n\n#### æ–°å¢å­—æ®µ(å¯é€‰)\n\n\n- **optional_fields_provided**:\
            \ æŠ€æœ¯é¢å­—æ®µæä¾›æ•°é‡\n- **background_fields_provided**: æŒ‡æ•°èƒŒæ™¯å­—æ®µæä¾›æ•°é‡\n- **warnings**:\
            \ è­¦å‘Šä¿¡æ¯åˆ—è¡¨\n\n\n---\n\n\n## å…³é”®æ³¨æ„äº‹é¡¹\n\n\n### å¼‚å¸¸å¤„ç†\n\n\n1. **å›¾è¡¨æ¨¡ç³Šä¸æ¸…**:\n \
            \  - åœ¨ chart_metadata ä¸­æ ‡æ³¨ `\"chart_quality\": \"low\"`\n   - åœ¨ validation_summary.warnings\
            \ ä¸­è¯´æ˜\n\n\n2. **æ— æ³•è¯†åˆ«å¹³å°**:\n   - `\"platform\": \"unknown\"`\n\n\n3. **ç¼ºå¤±æ ¸å¿ƒæŒ‡æ ‡**:\n\
            \   - è‹¥ RSI ä¸å¯ç”¨: `\"indicators_raw.rsi.available\": false`\n\n\n### æ•°æ®è§„èŒƒ\n\
            \n\n1. **ä»·æ ¼ç²¾åº¦**: ä¿ç•™ 2 ä½å°æ•°\n2. **ç™¾åˆ†æ¯”**: ä¿ç•™ 1 ä½å°æ•°(å¦‚ 1.5%)\n3. **æ¯”ç‡**: ä¿ç•™\
            \ 2 ä½å°æ•°(å¦‚ 3.25)\n4. **RSI/IV**: ä¿ç•™å°æ•°å½¢å¼(0.45 è€Œé 45%)\n\n\n### çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥\n\
            \n\næœ€ç»ˆè¾“å‡ºå‰éªŒè¯:\n- `targets.status` å¿…é¡»ä¸é¡¶å±‚ `status` ä¸€è‡´\n- `missing_fields`\
            \ æ•°ç»„é•¿åº¦å¿…é¡»ç­‰äº `validation_summary.missing_count`\n- `status=\"data_ready\"\
            ` æ—¶,`missing_fields` å’Œ `è¡¥é½æŒ‡å¼•` å¿…é¡»ä¸ºç©ºæ•°ç»„\n\n\n---\n\n\n## è¾“å‡ºæµç¨‹\n\n\n1. è¯†åˆ«å›¾è¡¨ç±»å‹å’Œæ—¶é—´å‘¨æœŸ\n\
            2. æå–æ‰€æœ‰å¯è§çš„æœŸæƒæ•°æ®å’ŒæŠ€æœ¯æŒ‡æ ‡\n3. æ‰§è¡Œä¸‰çº§æ•°æ®éªŒè¯\n4. è®¡ç®— validation_summary\n5. è‹¥ status=\"\
            missing_data\",ç”Ÿæˆè¡¥é½æŒ‡å¼•\n6. è¾“å‡ºç¬¦åˆ JSON Schema çš„ç»“æ„åŒ–æ•°æ®\n\n\n**é‡è¦**: \n- ä¸è¦å°è¯•\"\
            è®°å¿†\"ä¹‹å‰çš„æ•°æ®,ä¸“æ³¨äºè§£æå½“å‰ä¸Šä¼ çš„å›¾è¡¨å†…å®¹ã€‚ä¸‹æ¸¸ä¼šè‡ªåŠ¨èšåˆå¤šæ¬¡è§£æçš„ç»“æœã€‚\n- æ— è®ºå›¾è¡¨å†…å®¹å¦‚ä½•ï¼Œtargets å­—æ®µå¿…é¡»è¿”å›å­—å…¸æ ¼å¼ï¼Œä¸èƒ½è¿”å›ç©ºåˆ—è¡¨\
            \ []\n- å¦‚æœå›¾è¡¨ä¸­æ²¡æœ‰å¯è¯†åˆ«çš„æ•°æ®ï¼Œåº”è¯¥è¿”å›: { \"targets\": { \"symbol\": \"UNKNOWN\",\
            \ \"status\": \"missing_data\", \"spot_price\": -999, ... } }\n- ç¦æ­¢è¿”å›:\
            \ {\"targets\": []} æˆ– {\"targets\": null}"
        - edition_type: basic
          id: user-validate
          role: user
          text: '{{#sys.query#}}

            ã€ä¸Šä¼ æ–‡ä»¶ã€‘

            {{#sys.files#}}

            **æ•°æ®æºè¯†åˆ«**ï¼š

            - `!gexr` å›¾è¡¨ â†’ walls, cluster_strength

            - `!trigger` å›¾è¡¨ â†’ vol_trigger, net_gex

            - `!dexn` å›¾è¡¨ â†’ dex_same_dir_pct

            - `!vanna` å›¾è¡¨ â†’ vanna_dir, vanna_confidence

            - `!skew` å›¾è¡¨ â†’ atm_iv.iv_7d, atm_iv.iv_14d

            - `iv_path_*.png` æ—¶é—´åºåˆ— â†’ iv_path, iv_path_confidence



            **å…³é”®è§„åˆ™**ï¼š

            1. è¾“å‡ºå®Œæ•´çš„ JSON Schemaï¼ˆåŒ…å«æ‰€æœ‰ 22 ä¸ªæ ¸å¿ƒå­—æ®µï¼‰

            2. æ— æ³•è¯†åˆ«çš„å­—æ®µä½¿ç”¨å ä½å€¼ï¼ˆ-999 / "N/A"ï¼‰

            3. IV Path æ—¶é—´åºåˆ—å¿…é¡»åŒ…å« `iv_path_details` å¯¹è±¡

            4. ä¸è¦å°è¯•"è®°å¿†"ä¹‹å‰çš„æ•°æ®ï¼Œä¸‹æ¸¸ä¼šè‡ªåŠ¨èšåˆ

            5. ä¸“æ³¨äºè§£æå½“å‰ä¸Šä¼ çš„å›¾è¡¨å†…å®¹'
        reasoning_format: tagged
        selected: false
        structured_output:
          schema:
            properties:
              indices:
                properties:
                  qqq:
                    properties:
                      em1_dollar_idx:
                        description: QQQçš„EM1$,è‹¥ä¸éœ€è¦ä½¿ç”¨ -999
                        type: number
                      net_gex_idx:
                        description: QQQçš„NET-GEX,è‹¥ä¸éœ€è¦ä½¿ç”¨ -999
                        type: number
                      spot_idx:
                        description: QQQç°ä»·,è‹¥ä¸éœ€è¦ä½¿ç”¨ -999
                        type: number
                    required:
                    - net_gex_idx
                    - em1_dollar_idx
                    - spot_idx
                    type: object
                  spx:
                    properties:
                      em1_dollar_idx:
                        description: SPXçš„EM1$,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                        type: number
                      net_gex_idx:
                        description: SPXçš„NET-GEX,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                        type: number
                      spot_idx:
                        description: SPXç°ä»·,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                        type: number
                    required:
                    - net_gex_idx
                    - em1_dollar_idx
                    - spot_idx
                    type: object
                required:
                - spx
                - qqq
                type: object
              missing_fields:
                description: ç¼ºå¤±å­—æ®µåˆ—è¡¨,è‹¥æ— ç¼ºå¤±åˆ™ä¸ºç©ºæ•°ç»„
                items:
                  properties:
                    category:
                      type: string
                    field:
                      type: string
                    severity:
                      enum:
                      - critical
                      - high
                      - medium
                      - low
                      type: string
                    target:
                      type: string
                  required:
                  - field
                  - target
                  - severity
                  - category
                  type: object
                type: array
              next_step:
                enum:
                - proceed_to_analysis
                - request_missing_data
                type: string
              status:
                description: æ•°æ®çŠ¶æ€
                enum:
                - data_ready
                - missing_data
                type: string
              targets:
                properties:
                  atm_iv:
                    properties:
                      iv_14d:
                        description: 14æ—¥ATMéšå«æ³¢åŠ¨ç‡,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                        type: number
                      iv_7d:
                        description: 7æ—¥ATMéšå«æ³¢åŠ¨ç‡,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                        type: number
                      iv_source:
                        description: IVæ•°æ®æº
                        enum:
                        - 7d
                        - 14d
                        - 21d_fallback
                        - N/A
                        type: string
                    required:
                    - iv_7d
                    - iv_14d
                    - iv_source
                    type: object
                  directional_metrics:
                    properties:
                      dex_same_dir_pct:
                        description: DEXæ–¹å‘ä¸€è‡´æ€§ç™¾åˆ†æ¯”,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                        type: number
                      iv_path:
                        description: éšå«æ³¢åŠ¨ç‡è·¯å¾„
                        enum:
                        - å‡
                        - é™
                        - å¹³
                        - æ•°æ®ä¸è¶³
                        type: string
                      iv_path_confidence:
                        description: IVè·¯å¾„ç½®ä¿¡åº¦
                        enum:
                        - high
                        - medium
                        - low
                        type: string
                      vanna_confidence:
                        description: Vannaç½®ä¿¡åº¦,è‹¥ç¼ºå¤±ä½¿ç”¨ N/A
                        enum:
                        - high
                        - medium
                        - low
                        - N/A
                        type: string
                      vanna_dir:
                        description: Vannaæ–¹å‘,è‹¥ç¼ºå¤±ä½¿ç”¨ N/A
                        enum:
                        - up
                        - down
                        - flat
                        - N/A
                        type: string
                    required:
                    - dex_same_dir_pct
                    - vanna_dir
                    - vanna_confidence
                    - iv_path
                    - iv_path_confidence
                    type: object
                  em1_dollar:
                    description: é¢„æœŸå•æ—¥æ³¢å¹…,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                    type: number
                  gamma_metrics:
                    properties:
                      cluster_strength_ratio:
                        description: ç°‡å¼ºåº¦æ¯”,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                        type: number
                      gap_distance_dollar:
                        description: è·å¢™è·ç¦»ç¾å…ƒå€¼,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                        type: number
                      gap_distance_em1_multiple:
                        description: è·å¢™è·ç¦»EM1å€æ•°,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                        type: number
                      monthly_cluster_override:
                        description: æ˜¯å¦æœˆåº¦ç°‡å ä¼˜
                        enum:
                        - 'true'
                        - 'false'
                        type: string
                      net_gex:
                        description: å‡€Gammaæ•å£,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                        type: number
                      net_gex_sign:
                        description: å‡€Gammaç¬¦å·,è‹¥ç¼ºå¤±ä½¿ç”¨ N/A
                        enum:
                        - positive_gamma
                        - negative_gamma
                        - neutral
                        - N/A
                        type: string
                      spot_vs_trigger:
                        description: ç°ä»·ç›¸å¯¹è§¦å‘çº¿ä½ç½®,è‹¥ç¼ºå¤±ä½¿ç”¨ N/A
                        enum:
                        - above
                        - below
                        - near
                        - N/A
                        type: string
                      vol_trigger:
                        description: æ³¢åŠ¨ç‡è§¦å‘ä»·ä½,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                        type: number
                    required:
                    - gap_distance_dollar
                    - gap_distance_em1_multiple
                    - cluster_strength_ratio
                    - net_gex
                    - net_gex_sign
                    - vol_trigger
                    - spot_vs_trigger
                    - monthly_cluster_override
                    type: object
                  spot_price:
                    description: ç°ä»·,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                    type: number
                  status:
                    enum:
                    - ready
                    - missing_data
                    type: string
                  symbol:
                    type: string
                  walls:
                    properties:
                      call_wall:
                        description: çœ‹æ¶¨æœŸæƒå¢™ä»·ä½,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                        type: number
                      major_wall:
                        description: ä¸»è¦å¢™ä»·ä½,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                        type: number
                      major_wall_type:
                        description: ä¸»è¦å¢™ç±»å‹,è‹¥ç¼ºå¤±ä½¿ç”¨ N/A
                        enum:
                        - call
                        - put
                        - N/A
                        type: string
                      put_wall:
                        description: çœ‹è·ŒæœŸæƒå¢™ä»·ä½,è‹¥ç¼ºå¤±ä½¿ç”¨ -999
                        type: number
                    required:
                    - call_wall
                    - put_wall
                    - major_wall
                    - major_wall_type
                    type: object
                required:
                - symbol
                - status
                - spot_price
                - em1_dollar
                - walls
                - gamma_metrics
                - directional_metrics
                - atm_iv
                type: object
              technical_analysis:
                description: æŠ€æœ¯é¢æ•°æ®(å¯é€‰)
                properties:
                  chart_metadata:
                    properties:
                      latest_timestamp:
                        type: string
                      platform:
                        type: string
                      timeframe:
                        type: string
                    type: object
                  indicators_raw:
                    properties:
                      avwap:
                        properties:
                          available:
                            type: boolean
                          note:
                            type: string
                        type: object
                      bb:
                        properties:
                          band_direction:
                            type: string
                          position:
                            type: string
                          width:
                            type: number
                          width_percentile:
                            type: integer
                        type: object
                      macd:
                        properties:
                          histogram:
                            type: string
                          signal_line_cross:
                            type: string
                          zero_line:
                            type: string
                        type: object
                      price:
                        properties:
                          close:
                            type: number
                          ema20:
                            type: number
                          ema20_slope:
                            type: string
                          ema50:
                            type: number
                          ema50_slope:
                            type: string
                          golden_cross:
                            type: boolean
                          price_vs_ema20_pct:
                            type: number
                          price_vs_ema50_pct:
                            type: number
                        type: object
                      rsi:
                        properties:
                          divergence:
                            type: string
                          value:
                            type: number
                          zone:
                            type: string
                        type: object
                      volume:
                        properties:
                          avg_20d:
                            type: number
                          current:
                            type: number
                          ratio:
                            type: number
                          status:
                            type: string
                        type: object
                    type: object
                  key_patterns:
                    items:
                      type: string
                    type: array
                  ta_commentary:
                    description: æŠ€æœ¯é¢è¯„åˆ†ç†ç”±
                    type: string
                  ta_score:
                    description: æŠ€æœ¯é¢è¯„åˆ†(0-2åˆ†)
                    maximum: 2
                    minimum: 0
                    type: integer
                type: object
              timestamp:
                description: æ—¶é—´æˆ³,æ ¼å¼ YYYY-MM-DDTHH:mm:ss
                type: string
              validation_summary:
                properties:
                  background_fields_provided:
                    description: æŒ‡æ•°èƒŒæ™¯å­—æ®µæä¾›æ•°é‡(å¯é€‰)
                    type: integer
                  completion_rate:
                    type: integer
                  fields_provided:
                    type: integer
                  missing_count:
                    type: integer
                  optional_fields_provided:
                    description: æŠ€æœ¯é¢å­—æ®µæä¾›æ•°é‡(å¯é€‰)
                    type: integer
                  targets_ready:
                    type: integer
                  total_fields_required:
                    type: integer
                  total_targets:
                    type: integer
                  warnings:
                    description: è­¦å‘Šä¿¡æ¯åˆ—è¡¨(å¯é€‰)
                    items:
                      type: string
                    type: array
                required:
                - total_targets
                - targets_ready
                - total_fields_required
                - fields_provided
                - missing_count
                - completion_rate
                type: object
              è¡¥é½åç»­:
                description: è¡¥é½åçš„åç»­æ­¥éª¤,å½“status=data_readyæ—¶å¡« N/A
                type: string
              è¡¥é½æŒ‡å¼•:
                description: è¡¥é½æŒ‡å¼•åˆ—è¡¨,å½“status=data_readyæ—¶ä¸ºç©ºæ•°ç»„
                items:
                  properties:
                    alternative:
                      description: å¤‡é€‰æ–¹æ¡ˆ,è‹¥æ— åˆ™å¡« N/A
                      type: string
                    command:
                      description: å»ºè®®æ‰§è¡Œçš„å‘½ä»¤
                      type: string
                    description:
                      description: å­—æ®µè¯´æ˜
                      type: string
                    extraction_note:
                      description: æ•°æ®æå–è¯´æ˜
                      type: string
                    impact:
                      description: ç¼ºå¤±å½±å“è¯´æ˜
                      type: string
                    missing_field:
                      description: ç¼ºå¤±å­—æ®µå
                      type: string
                    priority:
                      description: ä¼˜å…ˆçº§1-5
                      maximum: 5
                      minimum: 1
                      type: integer
                  required:
                  - missing_field
                  - description
                  - command
                  - alternative
                  - extraction_note
                  - priority
                  - impact
                  type: object
                type: array
            required:
            - status
            - timestamp
            - validation_summary
            - targets
            - indices
            - missing_fields
            - next_step
            - è¡¥é½æŒ‡å¼•
            - è¡¥é½åç»­
            type: object
        structured_output_enabled: true
        title: Agent 3 æ•°æ®æ ¡éªŒ
        type: llm
        vision:
          configs:
            detail: high
            variable_selector:
            - sys
            - files
          enabled: true
      height: 116
      id: '3001'
      position:
        x: 825.1406328934224
        y: 426.71192818232186
      positionAbsolute:
        x: 825.1406328934224
        y: 426.71192818232186
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        cases:
        - case_id: case-ready
          conditions:
          - comparison_operator: is
            id: cond-ready
            value: ready
            varType: string
            variable_selector:
            - '1009'
            - data_status
          id: case-ready
          logical_operator: and
        - case_id: case-missing
          conditions:
          - comparison_operator: is
            id: cond-missing
            value: awaiting_data
            varType: string
            variable_selector:
            - '1009'
            - data_status
          id: case-missing
          logical_operator: and
        - case_id: e24094ec-5f1e-4ad2-be2c-c6cb6275b48c
          conditions:
          - comparison_operator: is
            id: d55483c5-46bd-499c-b26e-a105b53c8658
            value: error
            varType: string
            variable_selector:
            - '1009'
            - data_status
          id: e24094ec-5f1e-4ad2-be2c-c6cb6275b48c
          logical_operator: and
        desc: ''
        selected: false
        title: æ ¡éªŒåˆ†æ”¯
        type: if-else
      height: 220
      id: '3002'
      position:
        x: 1331.8076428705288
        y: 182.75916073235004
      positionAbsolute:
        x: 1331.8076428705288
        y: 182.75916073235004
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: "{{#1009.user_guide_summary#}} \n### \U0001F4CB éœ€è¦æ‰§è¡Œçš„å‘½ä»¤ \n``` \n{{#1009.user_guide_commands#}}\
          \ \n``` \n### âš ï¸ ç¼ºå¤±å­—æ®µæ˜ç»† \n**Criticalï¼ˆå¿…é¡»è¡¥é½ï¼‰**ï¼š {{#1009.user_guide_priority_critical#}}\
          \ \n**Highï¼ˆå¼ºçƒˆå»ºè®®ï¼‰**ï¼š\n {{#1009.user_guide_priority_high#}} \n**Mediumï¼ˆå¯é€‰ï¼‰**ï¼š\
          \ {{#1009.user_guide_priority_medium#}} \n--- \n### \U0001F4A1 ä¸‹ä¸€æ­¥æ“ä½œ\n {{#1009.user_guide_next_action#}}\
          \ \n--- \n**å½“å‰çŠ¶æ€**ï¼šç­‰å¾…è¡¥é½æ•°æ®ï¼ˆå·²ç¼“å­˜é¦–æ¬¡è§£æç»“æœï¼‰ \n**è‚¡ç¥¨ä»£ç **ï¼š{{#1009.current_symbol#}}\
          \ *\n*ç¼ºå¤±æ•°é‡**ï¼š{{#1009.missing_count#}}ä¸ªå­—æ®µ"
        desc: ''
        selected: false
        title: å›å¤ç¼ºå¤±æ•°æ®
        type: answer
      height: 392
      id: '3003'
      position:
        x: 1855.0990986195761
        y: 255.53566904516737
      positionAbsolute:
        x: 1855.0990986195761
        y: 255.53566904516737
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: 'Agent 5: Core analysis, scoring, and scenario probability.'
        model:
          completion_params:
            enable_thinking: true
            json_schema: "{\n  \"properties\": {\n    \"break_wall_assessment\": {\n\
              \      \"properties\": {\n        \"break_note\": {\n          \"type\"\
              : \"string\"\n        },\n        \"break_probability\": {\n       \
              \   \"type\": \"string\"\n        },\n        \"cluster_strength\":\
              \ {\n          \"type\": \"number\"\n        },\n        \"gap_distance_em1\"\
              : {\n          \"type\": \"number\"\n        }\n      },\n      \"type\"\
              : \"object\"\n    },\n    \"directional_signals\": {\n      \"properties\"\
              : {\n        \"dex_same_dir\": {\n          \"type\": \"number\"\n \
              \       },\n        \"direction_note\": {\n          \"type\": \"string\"\
              \n        },\n        \"direction_strength\": {\n          \"type\"\
              : \"string\"\n        },\n        \"vanna_confidence\": {\n        \
              \  \"type\": \"string\"\n        },\n        \"vanna_dir\": {\n    \
              \      \"type\": \"string\"\n        }\n      },\n      \"type\": \"\
              object\"\n    },\n    \"entry_rationale\": {\n      \"type\": \"string\"\
              \n    },\n    \"entry_threshold_check\": {\n      \"enum\": [\n    \
              \    \"å…¥åœº\",\n        \"è½»ä»“è¯•æ¢\",\n        \"è§‚æœ›\"\n      ],\n      \"\
              type\": \"string\"\n    },\n    \"gamma_regime\": {\n      \"properties\"\
              : {\n        \"regime_note\": {\n          \"type\": \"string\"\n  \
              \      },\n        \"spot_vs_trigger\": {\n          \"enum\": [\n \
              \           \"above\",\n            \"below\",\n            \"near\"\
              \n          ],\n          \"type\": \"string\"\n        },\n       \
              \ \"vol_trigger\": {\n          \"type\": \"number\"\n        }\n  \
              \    },\n      \"required\": [\n        \"vol_trigger\",\n        \"\
              spot_vs_trigger\",\n        \"regime_note\"\n      ],\n      \"type\"\
              : \"object\"\n    },\n    \"iv_dynamics\": {\n      \"properties\":\
              \ {\n        \"iv_note\": {\n          \"type\": \"string\"\n      \
              \  },\n        \"iv_path\": {\n          \"type\": \"string\"\n    \
              \    },\n        \"iv_path_confidence\": {\n          \"type\": \"string\"\
              \n        },\n        \"iv_signal\": {\n          \"type\": \"string\"\
              \n        }\n      },\n      \"type\": \"object\"\n    },\n    \"key_levels\"\
              : {\n      \"properties\": {\n        \"current_spot\": {\n        \
              \  \"type\": \"number\"\n        },\n        \"resistance\": {\n   \
              \       \"type\": \"number\"\n        },\n        \"support\": {\n \
              \         \"type\": \"number\"\n        },\n        \"trigger_line\"\
              : {\n          \"type\": \"number\"\n        }\n      },\n      \"type\"\
              : \"object\"\n    },\n    \"risk_warning\": {\n      \"type\": \"string\"\
              \n    },\n    \"scenario_classification\": {\n      \"properties\":\
              \ {\n        \"adjustment_note\": {\n          \"type\": \"string\"\n\
              \        },\n        \"primary_scenario\": {\n          \"type\": \"\
              string\"\n        },\n        \"scenario_probability\": {\n        \
              \  \"type\": \"integer\"\n        },\n        \"secondary_scenarios\"\
              : {\n          \"items\": {\n            \"properties\": {\n       \
              \       \"probability\": {\n                \"type\": \"integer\"\n\
              \              },\n              \"type\": {\n                \"type\"\
              : \"string\"\n              }\n            },\n            \"type\"\
              : \"object\"\n          },\n          \"type\": \"array\"\n        }\n\
              \      },\n      \"type\": \"object\"\n    },\n    \"scoring\": {\n\
              \      \"properties\": {\n        \"break_wall_score\": {\n        \
              \  \"type\": \"number\"\n        },\n        \"direction_score\": {\n\
              \          \"type\": \"number\"\n        },\n        \"gamma_regime_score\"\
              : {\n          \"type\": \"number\"\n        },\n        \"iv_score\"\
              : {\n          \"type\": \"number\"\n        },\n        \"total_score\"\
              : {\n          \"type\": \"number\"\n        },\n        \"weight_breakdown\"\
              : {\n          \"type\": \"string\"\n        }\n      },\n      \"type\"\
              : \"object\"\n    }\n  },\n  \"required\": [\n    \"gamma_regime\",\n\
              \    \"scoring\",\n    \"scenario_classification\",\n    \"entry_threshold_check\"\
              \n  ],\n  \"type\": \"object\"\n}"
            response_format: json_schema
            temperature: 0.5
          mode: chat
          name: deepseek-v3.2-exp-thinking
          provider: langgenius/openai_api_compatible/openai_api_compatible
        prompt_template:
        - id: sys-scenario
          role: system
          text: "ä½ æ˜¯æœŸæƒé‡åŒ–åˆ†æå¸ˆï¼Œè´Ÿè´£å°†é‡åŒ–åˆ†æç»“æœ**è½¬åŒ–ä¸ºæ˜“è¯»çš„æ–‡å­—æŠ¥å‘Š**ã€‚\nã€ä»»åŠ¡ã€‘\n  Code2 å·²å®Œæˆæ‰€æœ‰è®¡ç®—å’Œé€»è¾‘æ¨ç†ï¼ŒåŒ…æ‹¬ï¼š\n\
            \        - âœ… å››ç»´è¯„åˆ†è®¡ç®—\n        - âœ… å‰§æœ¬åˆ†ç±»\n        - âœ… æ¦‚ç‡è¯„ä¼°\n        - âœ… é£é™©è­¦ç¤º\n\
            \        - âœ… ä»“ä½å»ºè®®\nä½ çš„èŒè´£æ˜¯ï¼š\n1. **éªŒè¯æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µå­˜åœ¨\n2. **é€»è¾‘æ£€æŸ¥**ï¼šç¡®ä¿ç»“è®ºä¸æ•°æ®ä¸€è‡´ï¼ˆå¦‚æœ‰æ˜æ˜¾çŸ›ç›¾éœ€æŒ‡å‡ºï¼‰\n\
            3. **æ ¼å¼ä¼˜åŒ–**ï¼šç»Ÿä¸€æœ¯è¯­ã€æ ‡ç‚¹ã€æ•°å€¼æ ¼å¼\n4. **æ–‡æœ¬æ¶¦è‰²**ï¼šå°†æŠ€æœ¯æ€§æè¿°æ”¹å†™ä¸ºé€šé¡ºã€ä¸“ä¸šçš„ä¸­æ–‡\nã€è¾“å…¥æ•°æ®ã€‘(æ¥è‡ª Code2)\n\
            {{#1007.result#}}\nã€æŠ€æœ¯é¢æ•°æ®ã€‘(æ¥è‡ª Agent 4ï¼Œå¯é€‰å‚è€ƒ)\n{{#3001.structured_output.technical_analysis#}}\n\
            \n## å¤„ç†è§„åˆ™\n        \n        ### 1.æ•°æ®å®Œæ•´æ€§æ£€æŸ¥\n        \n        å¿…éœ€å­—æ®µæ¸…å•ï¼š\n\
            \        ```\n        âœ“ gamma_regime.vol_trigger\n        âœ“ gamma_regime.spot_vs_trigger\n\
            \        âœ“ gamma_regime.regime_note\n        âœ“ scoring.total_score\n \
            \       âœ“ scenario_classification.primary_scenario\n        âœ“ scenario_classification.scenario_probability\n\
            \        âœ“ entry_threshold_check\n        âœ“ risk_warning\n        âœ“ position_suggestion\n\
            \        ```\n**è‹¥ç¼ºå¤±å…³é”®å­—æ®µ**ï¼šåœ¨è¾“å‡º JSON ä¸­æ·»åŠ  `\"data_integrity_issue\": \"ç¼ºå¤±å­—æ®µ:\
            \ XXX\"`\n\n### 2.é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥\n        \n        **æ£€æŸ¥é¡¹Aï¼šå‰§æœ¬ä¸è¯„åˆ†åŒ¹é…**\n      \
            \  ```\n        if total_score >= 7 and primary_scenario in [\"è§‚æœ›\", \"\
            åŒºé—´éœ‡è¡\"]:\n            â†’ æ·»åŠ æ³¨é‡Š: \"æ³¨æ„ï¼šé«˜è¯„åˆ†ä½†å‰§æœ¬ä¿å®ˆï¼Œå¯èƒ½å› ä¸´ç•ŒçŠ¶æ€æˆ–é£é™©å› ç´ \"\n        \n\
            \        if total_score < 5 and primary_scenario in [\"å¼ºè¶‹åŠ¿ä¸Šè¡Œ\", \"å¼ºè¶‹åŠ¿ä¸‹è¡Œ\"\
            ]:\n            â†’ æ·»åŠ æ³¨é‡Š: \"è­¦å‘Šï¼šä½è¯„åˆ†ä½†å‰§æœ¬æ¿€è¿›ï¼Œé€»è¾‘å­˜åœ¨çŸ›ç›¾\"\n        ```\n        \n\
            \        **æ£€æŸ¥é¡¹Bï¼šæ¦‚ç‡æ€»å’Œ**\n        ```\n        primary_prob + secondary_prob_1\
            \ + secondary_prob_2 â‰ˆ 100% (è¯¯å·® Â±5%)\n        \n        è‹¥è¶…å‡ºèŒƒå›´ â†’ æ·»åŠ æ³¨é‡Š:\
            \ \"æ³¨æ„ï¼šæ¦‚ç‡æ€»å’Œä¸º{sum}%ï¼Œå­˜åœ¨{è¯¯å·®}%åå·®\"\n        ```\n        \n        **æ£€æŸ¥é¡¹Cï¼šä»“ä½ä¸æ¦‚ç‡åŒ¹é…**\n\
            \        ```\n        if scenario_probability < 55 and \"æ­£å¸¸ä»“ä½\" in position_suggestion:\n\
            \            â†’ æ·»åŠ æ³¨é‡Š: \"å»ºè®®ï¼šæ¦‚ç‡ä¸è¶³55%ï¼Œä»“ä½å»ºè®®åæ¿€è¿›\"\n        ```\n         ###\
            \ 3.æ ¼å¼ä¼˜åŒ–\n        \n        **æ•°å€¼æ ¼å¼**ï¼š\n        - è¯„åˆ†ï¼šä¿ç•™1ä½å°æ•°ï¼ˆ5.7åˆ†ï¼‰\n   \
            \     - æ¦‚ç‡ï¼šæ•´æ•°ï¼ˆ55%ï¼‰\n        - ä»·æ ¼ï¼šæ ¹æ®å“ç§ç‰¹æ€§ï¼ˆè‚¡ç¥¨ä¿ç•™2ä½ï¼ŒæŒ‡æ•°ä¿ç•™1ä½ï¼‰\n        - è·ç¦»ï¼šä¿ç•™2ä½å°æ•°ï¼ˆ3.34å€ï¼‰\n\
            \        \n        **æ ‡ç‚¹ç¬¦å·**ï¼š\n        - ä¸­æ–‡è¯­å¢ƒä½¿ç”¨ä¸­æ–‡æ ‡ç‚¹ï¼ˆï¼Œã€‚ï¼›ï¼‰\n        - è‹±æ–‡ç¼©å†™åæ— éœ€åŠ ç‚¹ï¼ˆå¦‚\
            \ DEX è€Œé D.E.X.ï¼‰\n        - é¿å…è¿ç»­ä½¿ç”¨ç›¸åŒæ ‡ç‚¹\n        \n        **æœ¯è¯­ä¸€è‡´**ï¼š\n\
            \        - ç»Ÿä¸€ä½¿ç”¨\"ä¸»å¯¼å‰§æœ¬\"è€Œé\"primary scenario\"\n        - ç»Ÿä¸€ä½¿ç”¨\"æ¬¡çº§å‰§æœ¬\"\
            è€Œé\"secondary scenarios\"\n        - ç»Ÿä¸€ä½¿ç”¨\"å…¥åœºåˆ¤å®š\"è€Œé\"entry check\"\n\n\
            ### 4.æ–‡æœ¬æ¶¦è‰²åŸåˆ™\n        \n        **åŸåˆ™Aï¼šä¿æŒæ•°å€¼å‡†ç¡®**\n        - âŒ ä¸è¦ä¿®æ”¹ä»»ä½•æ•°å­—ï¼ˆè¯„åˆ†ã€æ¦‚ç‡ã€ä»·æ ¼ã€è·ç¦»ç­‰ï¼‰\n\
            \        - âœ… åªä¼˜åŒ–æ•°å­—çš„è¡¨è¾¾æ–¹å¼\n        \n        **ç¤ºä¾‹**ï¼š\n        ```\n    \
            \    åŸæ–‡: \"gap_distanceåå¤§éœ€3.34å€EM1$æ‰èƒ½åˆ°Call Wall\"\n        æ¶¦è‰²: \"åˆ°è¾¾Call\
            \ Walléœ€3.34å€EM1$è·ç¦»ï¼Œgap_distanceåå¤§\"\n        ```\n        \n        **åŸåˆ™Bï¼šç»Ÿä¸€æœ¯è¯­**\n\
            \        - Gamma Regime â†’ GammaçŠ¶æ€ / Î³çŠ¶æ€\n        - spot_vs_trigger â†’ ç°ä»·ç›¸å¯¹ç¿»è½¬çº¿ä½ç½®\n\
            \        - DEXåŒå‘ â†’ DEXæ–¹å‘ä¸€è‡´æ€§\n        - Vanna â†’ Vannaæ•ˆåº” / æ³¢åŠ¨ç‡æ•æ„Ÿåº¦\n    \
            \    \n        **åŸåˆ™Cï¼šæ”¹å–„å¯è¯»æ€§**\n        - å°†æŠ€æœ¯æ€§å¼ºçš„å¥å­æ‹†åˆ†ä¸ºçŸ­å¥\n        - ä½¿ç”¨è¿æ¥è¯ï¼ˆå› æ­¤ã€ä½†æ˜¯ã€ç»¼åˆæ¥çœ‹ï¼‰\n\
            \        - é¿å…è¿‡å¤šæ‹¬å·å’Œç¼©å†™\n        \n        **ç¤ºä¾‹**ï¼š\n        ```\n       \
            \ åŸæ–‡: \"è™½åœ¨æ­£Î³åŒºåŸŸbaseä¸ºåŒºé—´ï¼ˆspot_vs_trigger=aboveï¼‰ï¼Œä½†direction_score 7åˆ†æ˜¾ç¤ºä¸­ç­‰åå¼ºæ–¹å‘ä¿¡å·ï¼Œä¸”vanna_dir=upä¸iv_path=å‡ä¸€è‡´\"\
            \n        \n        æ¶¦è‰²: \"å½“å‰å¤„äºæ­£GammaåŒºåŸŸï¼ŒåŸºç¡€å‰§æœ¬ä¸ºåŒºé—´éœ‡è¡ã€‚ä½†æ˜¯ï¼Œæ–¹å‘è¯„åˆ†è¾¾åˆ°7åˆ†ï¼Œæ˜¾ç¤ºä¸­ç­‰åå¼ºçš„æ–¹å‘ä¿¡å·ã€‚åŒæ—¶ï¼ŒVannaæ•ˆåº”å‘ä¸Šä¸”éšå«æ³¢åŠ¨ç‡è·¯å¾„å‘ˆä¸Šå‡è¶‹åŠ¿ï¼Œä¸¤è€…æ–¹å‘ä¸€è‡´ã€‚\"\
            \n        ```\n\n        ## å…³é”®æ³¨æ„äº‹é¡¹\n        \n        1. **ç¦æ­¢é‡æ–°è®¡ç®—**ï¼šæ‰€æœ‰é€»è¾‘å·²ç”±\
            \ Code Node å®Œæˆï¼Œä¸è¦ä¿®æ”¹ä»»ä½•ç»“è®º\n        2. **ä¿æŒæ•°å€¼ä¸å˜**ï¼šè¯„åˆ†ã€æ¦‚ç‡ã€ä»·æ ¼ç­‰æ•°å­—ç»å¯¹ä¸èƒ½æ”¹åŠ¨\n   \
            \     3. **ä»…æ¶¦è‰²æ–‡æœ¬**ï¼šåªå¯¹æè¿°æ€§æ–‡å­—è¿›è¡Œæ”¹å†™ï¼Œæå‡å¯è¯»æ€§\n        4. **æ ‡æ³¨çŸ›ç›¾**ï¼šè‹¥å‘ç°é€»è¾‘ä¸ä¸€è‡´ï¼Œåœ¨è¾“å‡ºä¸­æ·»åŠ \
            \ `logic_check_notes` å­—æ®µè¯´æ˜\n        5. **ä¿æŒJSONæ ¼å¼**ï¼šè¾“å‡ºå¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSONï¼Œä¸è¾“å…¥ç»“æ„å®Œå…¨ä¸€è‡´\n\
            \        \n ---\n        \nç°åœ¨è¯·å¯¹è¾“å…¥çš„ JSON æ•°æ®è¿›è¡Œæ–‡æœ¬æ¶¦è‰²ï¼Œè¾“å‡ºå®Œæ•´çš„æ¶¦è‰²å JSONã€‚"
        - id: user-scenario
          role: user
          text: è¯·æ•´åˆæ•°æ®,è¿›è¡Œå‰§æœ¬æ¨æ¼”ä¸è¯„åˆ†ã€‚
        selected: false
        structured_output:
          schema:
            properties:
              break_wall_assessment:
                properties:
                  break_note:
                    type: string
                  break_probability:
                    type: string
                  cluster_strength:
                    type: number
                  gap_distance_em1:
                    type: number
                type: object
              directional_signals:
                properties:
                  dex_same_dir:
                    type: number
                  direction_note:
                    type: string
                  direction_strength:
                    type: string
                  vanna_confidence:
                    type: string
                  vanna_dir:
                    type: string
                type: object
              entry_rationale:
                type: string
              entry_threshold_check:
                enum:
                - å…¥åœº
                - è½»ä»“è¯•æ¢
                - è§‚æœ›
                type: string
              gamma_regime:
                properties:
                  regime_note:
                    type: string
                  spot_vs_trigger:
                    enum:
                    - above
                    - below
                    - near
                    type: string
                  vol_trigger:
                    type: number
                required:
                - vol_trigger
                - spot_vs_trigger
                - regime_note
                type: object
              iv_dynamics:
                properties:
                  iv_note:
                    type: string
                  iv_path:
                    type: string
                  iv_path_confidence:
                    type: string
                  iv_signal:
                    type: string
                type: object
              key_levels:
                properties:
                  current_spot:
                    type: number
                  resistance:
                    type: number
                  support:
                    type: number
                  trigger_line:
                    type: number
                type: object
              risk_warning:
                type: string
              scenario_classification:
                properties:
                  adjustment_note:
                    type: string
                  primary_scenario:
                    type: string
                  scenario_probability:
                    type: integer
                  secondary_scenarios:
                    items:
                      properties:
                        probability:
                          type: integer
                        type:
                          type: string
                      type: object
                    type: array
                type: object
              scoring:
                properties:
                  break_wall_score:
                    type: number
                  direction_score:
                    type: number
                  gamma_regime_score:
                    type: number
                  iv_score:
                    type: number
                  total_score:
                    type: number
                  weight_breakdown:
                    type: string
                type: object
            required:
            - gamma_regime
            - scoring
            - scenario_classification
            - entry_threshold_check
            type: object
        structured_output_enabled: true
        title: Agent 5 å‰§æœ¬åˆ†æ
        type: llm
        vision:
          enabled: false
      height: 132
      id: '5001'
      position:
        x: 2304.946199402789
        y: 332.41002500221094
      positionAbsolute:
        x: 2304.946199402789
        y: 332.41002500221094
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: 'Agent 6: Generate actionable strategies with RR/Pw.'
        model:
          completion_params:
            json_schema: "{\n  \"properties\": {\n    \"strategies\": {\n      \"\
              items\": {\n        \"properties\": {\n          \"description\": {\n\
              \            \"type\": \"string\"\n          },\n          \"dte\":\
              \ {\n            \"type\": \"string\"\n          },\n          \"dte_rationale\"\
              : {\n            \"type\": \"string\"\n          },\n          \"entry_timing\"\
              : {\n            \"type\": \"string\"\n          },\n          \"entry_trigger\"\
              : {\n            \"type\": \"string\"\n          },\n          \"exit_plan\"\
              : {\n            \"properties\": {\n              \"adjustment\": {\n\
              \                \"type\": \"string\"\n              },\n          \
              \    \"profit_target\": {\n                \"type\": \"string\"\n  \
              \            },\n              \"stop_loss\": {\n                \"\
              type\": \"string\"\n              },\n              \"time_decay_exit\"\
              : {\n                \"type\": \"string\"\n              }\n       \
              \     },\n            \"type\": \"object\"\n          },\n         \
              \ \"greeks_target\": {\n            \"properties\": {\n            \
              \  \"delta\": {\n                \"type\": \"string\"\n            \
              \  },\n              \"delta_range\": {\n                \"type\": \"\
              string\"\n              },\n              \"theta_min\": {\n       \
              \         \"type\": \"string\"\n              },\n              \"vega_max\"\
              : {\n                \"type\": \"string\"\n              },\n      \
              \        \"vega_min\": {\n                \"type\": \"string\"\n   \
              \           }\n            },\n            \"type\": \"object\"\n  \
              \        },\n          \"legs\": {\n            \"items\": {\n     \
              \         \"properties\": {\n                \"action\": {\n       \
              \           \"type\": \"string\"\n                },\n             \
              \   \"quantity\": {\n                  \"type\": \"number\"\n      \
              \          },\n                \"rationale\": {\n                  \"\
              type\": \"string\"\n                },\n                \"strike\":\
              \ {\n                  \"type\": \"number\"\n                },\n  \
              \              \"type\": {\n                  \"type\": \"string\"\n\
              \                }\n              },\n              \"type\": \"object\"\
              \n            },\n            \"type\": \"array\"\n          },\n  \
              \        \"pw_calculation\": {\n            \"properties\": {\n    \
              \          \"formula\": {\n                \"type\": \"string\"\n  \
              \            },\n              \"pw_estimate\": {\n                \"\
              type\": \"string\"\n              },\n              \"pw_note\": {\n\
              \                \"type\": \"string\"\n              },\n          \
              \    \"pw_ç»¼åˆåˆ¤æ–­\": {\n                \"type\": \"string\"\n        \
              \      }\n            },\n            \"type\": \"object\"\n       \
              \   },\n          \"risk_note\": {\n            \"type\": \"string\"\
              \n          },\n          \"rr_calculation\": {\n            \"properties\"\
              : {\n              \"credit\": {\n                \"type\": \"number\"\
              \n              },\n              \"debit\": {\n                \"type\"\
              : \"number\"\n              },\n              \"formula\": {\n     \
              \           \"type\": \"string\"\n              },\n              \"\
              max_loss\": {\n                \"type\": \"number\"\n              },\n\
              \              \"max_profit\": {\n                \"type\": \"number\"\
              \n              },\n              \"rr_note\": {\n                \"\
              type\": \"string\"\n              },\n              \"rr_ratio\": {\n\
              \                \"type\": \"string\"\n              }\n           \
              \ },\n            \"type\": \"object\"\n          },\n          \"strategy_type\"\
              : {\n            \"type\": \"string\"\n          },\n          \"structure\"\
              : {\n            \"type\": \"string\"\n          }\n        },\n   \
              \     \"required\": [\n          \"strategy_type\",\n          \"structure\"\
              ,\n          \"description\",\n          \"legs\",\n          \"dte\"\
              ,\n          \"greeks_target\",\n          \"rr_calculation\",\n   \
              \       \"pw_calculation\",\n          \"entry_trigger\",\n        \
              \  \"exit_plan\",\n          \"risk_note\"\n        ],\n        \"type\"\
              : \"object\"\n      },\n      \"type\": \"array\"\n    }\n  },\n  \"\
              required\": [\n    \"strategies\"\n  ],\n  \"type\": \"object\"\n}"
            response_format: json_schema
          mode: chat
          name: deepseek-v3.2-exp-thinking
          provider: langgenius/openai_api_compatible/openai_api_compatible
        prompt_template:
        - id: sys-strategy
          role: system
          text: "ä½ æ˜¯æœŸæƒç­–ç•¥ç ”ç©¶å‘˜ä¸æœŸæƒäº¤æ˜“æ•™ç»ƒï¼Œè´Ÿè´£æœŸæƒç­–ç•¥ç”Ÿæˆ Agentã€‚\n\nã€ä»»åŠ¡ã€‘ åŸºäºå‰§æœ¬åˆ†æå’Œè®¡ç®—è¾…åŠ©ç»“æœï¼Œè®¾è®¡ä¸‰ç§é£é™©ç­‰çº§çš„æœŸæƒç­–ç•¥ã€‚\n\
            \nã€è¾“å…¥æ•°æ®ã€‘\n **å‰§æœ¬åˆ†æ**(æ¥è‡ª Agent 5):\n{{#5001.structured_output#}}\n**è®¡ç®—è¾…åŠ©**(CODE3):\n\
            {{#1006.result#}}\n**åŸå§‹æ•°æ®**(æ¥è‡ª Agent 3,ç”¨äºå‚è€ƒ):\n{{#3001.structured_output#}}\n\
            \n## æ ¸å¿ƒèŒè´£ ### \n### 1. ç­–ç•¥ç±»å‹é€‰æ‹©ï¼ˆåŸºäºæ¨ç†ï¼‰\n    \næ ¹æ® Gamma çŠ¶æ€å’Œä¸»å¯¼åœºæ™¯é€‰æ‹©ç­–ç•¥ï¼š\n````\n\
            if GammaçŠ¶æ€ = \"above\" and ä¸»å¯¼åœºæ™¯ = \"åŒºé—´\":\n    é¦–é€‰: Iron Condor (ä¿å®ˆ)\n\
            \    å¤‡é€‰: Iron Butterfly (ä¿å®ˆ), Bull Put Spread (å‡è¡¡)\n\n\nelif GammaçŠ¶æ€ =\
            \ \"below\" and ä¸»å¯¼åœºæ™¯ = \"è¶‹åŠ¿ä¸Šè¡Œ\":\n    é¦–é€‰: Bull Call Spread (å‡è¡¡)\n    å¤‡é€‰:\
            \ Call Ratio Spread (å‡è¡¡), Long Call (è¿›å–)\n\n\nelif GammaçŠ¶æ€ = \"below\"\
            \ and ä¸»å¯¼åœºæ™¯ = \"è¶‹åŠ¿ä¸‹è¡Œ\":\n    é¦–é€‰: Bear Put Spread (å‡è¡¡)\n    å¤‡é€‰: Put Ratio\
            \ Spread (å‡è¡¡), Long Put (è¿›å–)\n\n\nelif GammaçŠ¶æ€ = \"near\":\n    é¦–é€‰: è§‚æœ›\n\
            \    å¤‡é€‰: Collar (å¯¹å†²)\n\n\n### 2.è…¿éƒ¨ç»“æ„è®¾è®¡ï¼ˆä½¿ç”¨è®¡ç®—ç»“æœï¼‰\n**å¯ç”¨çš„è¡Œæƒä»·æ•°æ®**ï¼ˆä» Agent 3\
            \ æå–ï¼‰ï¼š \n- æ ‡çš„: {{#3001.structured_output.symbol#}}\n- ç°ä»·: {{#3001.structured_output.spot_price#}}\n\
            - EM1$: {{#3001.structured_output.em1_dollar#}}\n- Call Wall: {{#3001.structured_output.walls.call_wall#}}\n\
            - Put Wall: {{#3001.structured_output.walls.put_wall#}}\n- Major Wall:\
            \ {{#3001.structured_output.walls.major_wall#}} ({{#3001.structured_output.walls.major_wall_type#}})\n\
            \n**è¡Œæƒä»·é€‰æ‹©åŸåˆ™**ï¼š \n- ä¿å®ˆç­–ç•¥ï¼šShort è…¿è´´è¿‘å¢™ä½ï¼ŒLong è…¿è·ç¦» Short è…¿ 1.0-1.5Ã—EM1$ \n-\
            \ å‡è¡¡ç­–ç•¥ï¼šLong è…¿è·ç¦»ç°ä»· 0.2-0.5Ã—EM1$ï¼ŒShort è…¿é è¿‘å¢™ä½ \n- è¿›å–ç­–ç•¥ï¼šLong è…¿è·ç¦»ç°ä»· 0.2Ã—EM1$\
            \ ä»¥å†… *\n\n*æ¯æ¡è…¿å¿…é¡»åŒ…å« rationale**ï¼Œè§£é‡Šï¼š \n1. ä¸ºä½•é€‰æ‹©è¯¥è¡Œæƒä»·ï¼ˆå‚è€ƒå¢™ä½/EM1$ï¼‰ \n2. è¯¥è…¿åœ¨ç­–ç•¥ä¸­çš„ä½œç”¨ï¼ˆæ”¶æƒåˆ©é‡‘/é™åˆ¶é£é™©/æ–¹å‘æ•å£ï¼‰\
            \ \n3. ä¸ Gamma çŠ¶æ€/å‰§æœ¬çš„é€‚é…æ€§\n\n### 3. DTE ä¸ Greeks(ç›´æ¥å¼•ç”¨)\n**DTE**:\n- æœ€ç»ˆ\
            \ DTE: {{#1006.result.dte_final#}} æ—¥\n- é€‰æ‹©ç†ç”±: {{#1006.result.dte_rationale#}}\n\
            \n**Greeks ç›®æ ‡**(æ ¹æ®ç­–ç•¥ç±»å‹é€‰æ‹©):\n**ä¿å®ˆç­–ç•¥**:\n- Delta: {{#1006.result.greeks_conservative_desc#}}\n\
            - èŒƒå›´: [{{#1006.result.greeks_conservative_delta_min#}}, {{#1006.result.greeks_conservative_delta_max#}}]\n\
            - Theta æœ€å°å€¼: {{#1006.result.greeks_conservative_theta_min#}}/æ—¥\n- Vega\
            \ æœ€å¤§å€¼: {{#1006.result.greeks_conservative_vega_max#}}\n\n**å‡è¡¡ç­–ç•¥**:\n-\
            \ Delta: {{#1006.result.greeks_balanced_desc#}}\n- èŒƒå›´: Â±{{#1006.result.greeks_balanced_delta_range#}}\n\
            - Theta æœ€å°å€¼: {{#1006.result.greeks_balanced_theta_min#}}/æ—¥\n\n**è¿›å–ç­–ç•¥**:\n\
            - Delta: {{#1006.result.greeks_aggressive_desc#}}\n- èŒƒå›´: [{{#1006.result.greeks_aggressive_delta_min#}},\
            \ {{#1006.result.greeks_aggressive_delta_max#}}]\n- Vega æœ€å°å€¼: {{#1006.result.greeks_aggressive_vega_min#}}\n\
            \n### 4. RR/Pwï¼ˆç›´æ¥å¼•ç”¨è®¡ç®—ç»“æœï¼‰\n**å…³é”®ï¼šä¸è¦é‡æ–°è®¡ç®—ï¼Œç›´æ¥å¼•ç”¨ CODE3 çš„æ•°å€¼å’Œå…¬å¼**\n```json\n \
            \   {\n      \"rr_calculation\": {\n        \"credit\": {{#1006.result.rr_ic_credit#}},\n\
            \        \"max_profit\": {{#1006.result.rr_ic_max_profit#}},\n       \
            \ \"max_loss\": {{#1006.result.rr_ic_max_loss#}},\n        \"rr_ratio\"\
            : \"{{#1006.result.rr_ic_ratio#}}\",\n        \"formula\": \"{{#1006.result.rr_ic_formula#}}\"\
            ,\n        \"rr_note\": \"ç›ˆäºæ¯” {{#1006.result.rr_ic_ratio#}} é€‚åˆé«˜èƒœç‡ç­–ç•¥ï¼Œå½“å‰\
            \ IVR {{#1006.result.meta_ivr#}}% å¤„äºä¸­ç­‰æ°´å¹³ï¼Œæƒåˆ©é‡‘æ”¶å– {{#1006.result.rr_ic_credit#}}\
            \ åˆç†\"\n      },\n      \"pw_calculation\": {\n        \"pw_estimate\"\
            : \"{{#1006.result.pw_credit_estimate#}}\",\n        \"formula\": \"{{#1006.result.pw_credit_formula#}}\"\
            ,\n        \"pw_note\": \"{{#1006.result.pw_credit_note#}}\",\n      \
            \  \"pw_ç»¼åˆåˆ¤æ–­\": \"ä¸»å¯¼åœºæ™¯ {{#1006.result.meta_primary_scenario#}} æ¦‚ç‡ {{#1006.result.meta_scenario_probability#}}%ï¼ŒæŠ€æœ¯é¢è¯„åˆ†\
            \ {{#1006.result.meta_technical_score#}} åˆ†æ”¯æŒï¼Œç°‡å¼ºåº¦ {{#1006.result.pw_credit_cluster_adj#}}\
            \ ä¸­ç­‰åŠ åˆ†ï¼Œgap è·ç¦»æƒ©ç½š {{#1006.result.pw_credit_distance_penalty#}}ï¼ŒæŠ€æœ¯é¢æå‡ {{#1006.result.pw_credit_technical_boost#}}ï¼Œç»¼åˆèƒœç‡\
            \ {{#1006.result.pw_credit_estimate#}} å¯ä¿¡åº¦é«˜\"\n      }\n    }\n```\n \
            \       \n#### å‡è¡¡/è¿›å–ç­–ç•¥ï¼ˆBull Call Spread ç¤ºä¾‹ï¼‰\n```json\n      {\n      \
            \  \"rr_calculation\": {\n          \"debit\": {{#1006.result.rr_bull_debit#}},\n\
            \          \"max_profit\": {{#1006.result.rr_bull_max_profit#}},\n   \
            \       \"max_loss\": {{#1006.result.rr_bull_max_loss#}},\n          \"\
            rr_ratio\": \"{{#1006.result.rr_bull_ratio#}}\",\n          \"formula\"\
            : \"{{#1006.result.rr_bull_formula#}}\",\n          \"rr_note\": \"ç›ˆäºæ¯”\
            \ {{#1006.result.rr_bull_ratio#}} é€‚åˆè¶‹åŠ¿ç­–ç•¥ï¼Œé£é™© {{#1006.result.rr_bull_max_loss#}}\
            \ å¯æ§\"\n        },\n        \"pw_calculation\": {\n          \"pw_estimate\"\
            : \"{{#1006.result.pw_debit_estimate#}}\",\n          \"formula\": \"\
            {{#1006.result.pw_debit_formula#}}\",\n          \"pw_note\": \"{{#1006.result.pw_debit_note#}}\"\
            ,\n          \"pw_ç»¼åˆåˆ¤æ–­\": \"DEX è°ƒæ•´ {{#1006.result.pw_debit_dex_adj#}}ï¼ŒVanna\
            \ è°ƒæ•´ {{#1006.result.pw_debit_vanna_adj#}}ï¼Œgap æƒ©ç½š {{#1006.result.pw_debit_gap_penalty#}}ï¼Œç»¼åˆèƒœç‡\
            \ {{#1006.result.pw_debit_estimate#}}\"\n        }\n      }\n``` \n---\n\
            ### 5.æ‰§è¡Œæ–¹æ¡ˆï¼ˆéœ€è¦ä½ çš„è¯­è¨€èƒ½åŠ›ï¼‰ \n**å…¥åœºè§¦å‘**ï¼š \nä» Agent 5 æå–å…³é”®ä¿¡å·ï¼š \n- Spot vs Triggerï¼š{{#5001.structured_output.gamma_regime.spot_vs_trigger#}}\
            \ - æ–¹å‘å¼ºåº¦ï¼š{{#5001.structured_output.directional_signals.direction_strength#}}\
            \ - DEX åŒå‘ï¼š{{#5001.structured_output.directional_signals.dex_same_dir#}}%\
            \ - Vanna æ–¹å‘ï¼š{{#5001.structured_output.directional_signals.vanna_dir#}}\
            \ ({{#5001.structured_output.directional_signals.vanna_confidence#}})\
            \ - IV è·¯å¾„ï¼š{{#5001.structured_output.iv_dynamics.iv_path#}} ({{#5001.structured_output.iv_dynamics.iv_path_confidence#}})\
            \ \n\n**æè¿°å…·ä½“å…¥åœºæ¡ä»¶**ï¼ˆæ ¹æ®ç­–ç•¥ç±»å‹è°ƒæ•´ï¼‰ï¼š\n- ä¿å®ˆç­–ç•¥ï¼šå¦‚ \"Spot åœ¨ [Put_Wall, Call_Wall]\
            \ åŒºé—´å¾˜å¾Šï¼ŒIV æœªæ˜¾è‘—ä¸Šå‡ï¼ˆ7D ATM-IV å¹³ç¨³ï¼‰ï¼ŒDEX åŒå‘ç»´æŒ >60%\"\n- å‡è¡¡ç­–ç•¥ï¼šå¦‚ \"Spot å‘ Call_Wall\
            \ æ–¹å‘ç§»åŠ¨ä½†æœªçªç ´ï¼ŒVanna_dir=up ä¸” iv_path=å‡ï¼ŒDEX åŒå‘ >65%\"\n- è¿›å–ç­–ç•¥ï¼šå¦‚ \"Spot æœ‰æ•ˆçªç ´å¢™ä½\
            \ â‰¥0.5Ã—EM1$ï¼Œæˆäº¤é‡ç¡®è®¤ï¼ŒVanna ä¸ IV è·¯å¾„ä¸€è‡´\"\n\n#### å‡ºåœºè®¡åˆ’ï¼ˆå¼•ç”¨ç¯å¢ƒå‚æ•°ï¼‰\n\n**ä¿¡ç”¨ç­–ç•¥**ï¼š\n\
            - æ­¢ç›ˆï¼šæƒåˆ©é‡‘è¡°å‡è‡³ {{#1006.result.exit_credit_profit_pct#}}% æ—¶å›è¡¥\n- æ­¢æŸï¼šæµ®äºè¾¾æœ€å¤§äºæŸ\
            \ {{#1006.result.exit_credit_stop_pct#}}% æ—¶å¹³ä»“\n- æ—¶é—´ï¼šåˆ°æœŸå‰ {{#1006.result.exit_time_days#}}\
            \ æ—¥å¼ºåˆ¶å¹³ä»“\n- è°ƒæ•´ï¼šSpot æ¥è¿‘ Short è…¿ <0.5Ã—EM1$ æ—¶è€ƒè™‘ roll out\n\n**å€Ÿè®°ç­–ç•¥**ï¼š\n- æ­¢ç›ˆï¼šæµ®ç›ˆè¾¾\
            \ {{#1006.result.exit_debit_profit_pct#}}% æ—¶å…ˆè½è¢‹ 50%\n- æ­¢æŸï¼šäºæŸè¾¾ {{#1006.result.exit_debit_stop_pct#}}%\
            \ æ—¶å¹³ä»“\n- æ—¶é—´ï¼šåˆ°æœŸå‰ {{#1006.result.exit_time_days#}} æ—¥è¯„ä¼°å±•æœŸæˆ–å¹³ä»“\n\n#### é£é™©è¯„ä¼°\
            \ ç»¼åˆè¯„ä¼°ç­–ç•¥é£é™©ï¼š\n - \"æœ€å¤§é£é™© {{RRä¸­çš„max_loss}} éœ€ä¸¥æ ¼æ­¢æŸ\" \n- \"å•ç¬”é£é™©åº”æ§åˆ¶åœ¨è´¦æˆ·æ€»èµ„é‡‘ 2%\
            \ ä»¥å†…\"ï¼ˆå‚è€ƒ MAX_SINGLE_RISK_PCTï¼‰ \n- \"è‹¥äº‹ä»¶ä¸´è¿‘ï¼ˆå¦‚è´¢æŠ¥å‰ 5 æ—¥ï¼‰æˆ– IV çªç„¶æ‰©å¼  >20%ï¼Œæå‰å¹³ä»“\"\
            \n\n---\nã€è¾“å‡º JSON æ ¼å¼ã€‘ç”Ÿæˆä¸‰ä¸ªç­–ç•¥å¯¹è±¡ï¼ˆä¿å®ˆ/å‡è¡¡/è¿›å–ï¼‰ï¼Œæ¯ä¸ªåŒ…å«ï¼š\n```json \n{\n  \"strategies\"\
            : [\n    {\n      \"strategy_type\": \"ä¿å®ˆ\",\n      \"structure\": \"\
            Iron Condor\",\n      \"description\": \"å››è…¿é“é¹°æ”¶å–æƒåˆ©é‡‘ç­–ç•¥ï¼Œé€‚åˆæ­£Î³åŒºé—´ç¯å¢ƒ\",\n   \
            \   \"legs\": [\n        {\n          \"action\": \"sell\",\n        \
            \  \"type\": \"call\",\n          \"strike\": 180.0,\n          \"quantity\"\
            : 1,\n          \"rationale\": \"Short Call åœ¨ call_wall é˜»åŠ›ä½ 180 æ”¶å–æƒåˆ©é‡‘ï¼Œåˆ©ç”¨æ­£\
            \ Gamma ç¯å¢ƒï¼ˆspot_vs_trigger=aboveï¼‰å‹åˆ¶ä¸Šè¡Œï¼Œgap_distance=3.34Ã—EM1$ æä¾›å®‰å…¨è¾¹é™…\"\n\
            \        },\n        {\n          \"action\": \"buy\",\n          \"type\"\
            : \"call\",\n          \"strike\": 184.5,\n          \"quantity\": 1,\n\
            \          \"rationale\": \"Long Call åœ¨ 184.5 é™åˆ¶ä¸Šè¡Œé£é™©ï¼Œå®½åº¦ 4.5 = 1.5Ã—EM1$ï¼Œç¬¦åˆä¿å®ˆç­–ç•¥é£æ§è¦æ±‚\"\
            \n        },\n        {\n          \"action\": \"sell\",\n          \"\
            type\": \"put\",\n          \"strike\": 165.0,\n          \"quantity\"\
            : 1,\n          \"rationale\": \"Short Put åœ¨ put_wall æ”¯æ’‘ä½ 165 æ”¶å–æƒåˆ©é‡‘\"\n\
            \        },\n        {\n          \"action\": \"buy\",\n          \"type\"\
            : \"put\",\n          \"strike\": 160.5,\n          \"quantity\": 1,\n\
            \          \"rationale\": \"Long Put åœ¨ 160.5 é™åˆ¶ä¸‹è¡Œé£é™©ï¼Œå¯¹ç§°ç»“æ„å¹³è¡¡é£é™©\"\n     \
            \   }\n      ],\n      \"dte\": \"{{#1006.result.dte_final#}}\",\n   \
            \   \"dte_rationale\": \"{{#1006.result.dte_rationale#}}\",\n      \"\
            greeks_target\": {\n        \"delta\": \"{{#1006.result.greeks_conservative_desc#}}\"\
            ,\n        \"delta_range\": \"[{{#1006.result.greeks_conservative_delta_min#}},\
            \ {{#1006.result.greeks_conservative_delta_max#}}]\",\n        \"theta_min\"\
            : \"{{#1006.result.greeks_conservative_theta_min#}}\",\n        \"vega_max\"\
            : \"{{#1006.result.greeks_conservative_vega_max#}}\"\n      },\n     \
            \ \"rr_calculation\": {\n        \"credit\": {{#1006.result.rr_ic_credit#}},\n\
            \        \"max_profit\": {{#1006.result.rr_ic_max_profit#}},\n       \
            \ \"max_loss\": {{#1006.result.rr_ic_max_loss#}},\n        \"rr_ratio\"\
            : \"{{#1006.result.rr_ic_ratio#}}\",\n        \"formula\": \"{{#1006.result.rr_ic_formula#}}\"\
            ,\n        \"rr_note\": \"ç›ˆäºæ¯” {{#1006.result.rr_ic_ratio#}} é€‚åˆé«˜èƒœç‡ç­–ç•¥\"\n\
            \      },\n      \"pw_calculation\": {\n        \"pw_estimate\": \"{{#1006.result.pw_credit_estimate#}}\"\
            ,\n        \"formula\": \"{{#1006.result.pw_credit_formula#}}\",\n   \
            \     \"pw_note\": \"{{#1006.result.pw_credit_note#}}\",\n        \"pw_ç»¼åˆåˆ¤æ–­\"\
            : \"ä¸»å¯¼åœºæ™¯æ¦‚ç‡ {{#1006.result.meta_scenario_probability#}}%ï¼ŒæŠ€æœ¯é¢è¯„åˆ† {{#1006.result.meta_technical_score#}}\
            \ åˆ†ï¼Œç»¼åˆèƒœç‡å¯ä¿¡åº¦é«˜\"\n      },\n      \"entry_trigger\": \"Spot åœ¨åŒºé—´å¾˜å¾Šï¼ŒIV å¹³ç¨³ï¼ŒDEX\
            \ åŒå‘ >60%\",\n      \"entry_timing\": \"æ¬¡æ—¥å¼€ç›˜å 15-30 åˆ†é’Ÿï¼Œé™ä»·æŒ‚ midï¼Œæ»‘ç‚¹å®¹å¿ Â±$0.03\"\
            ,\n      \"exit_plan\": {\n        \"profit_target\": \"æƒåˆ©é‡‘è¡°å‡è‡³ {{#1006.result.exit_credit_profit_pct#}}%\
            \ æ—¶å›è¡¥\",\n        \"stop_loss\": \"æµ®äºè¾¾ {{#1006.result.exit_credit_stop_pct#}}%\
            \ æ—¶å¹³ä»“\",\n        \"time_decay_exit\": \"åˆ°æœŸå‰ {{#1006.result.exit_time_days#}}\
            \ æ—¥å¼ºå¹³\",\n        \"adjustment\": \"Spot æ¥è¿‘ short è…¿æ—¶è€ƒè™‘ roll\"\n      },\n\
            \      \"risk_note\": \"æœ€å¤§é£é™© {{#1006.result.rr_ic_max_loss#}}ï¼Œéœ€ä¸¥æ ¼æ­¢æŸï¼Œé€‚åˆè´¦æˆ·\
            \ 2% é£é™©æ•å£\"\n    },\n    {\n      \"strategy_type\": \"å‡è¡¡\",\n      \"\
            structure\": \"Bull Call Spread\",\n      \"description\": \"çœ‹æ¶¨å€Ÿè®°ä»·å·®ï¼Œé€‚åˆè¶‹åŠ¿åˆæœŸ\"\
            ,\n      \"legs\": [\n        {\n          \"action\": \"buy\",\n    \
            \      \"type\": \"call\",\n          \"strike\": \"è®¡ç®—: {{#1006.result.meta_spot#}}\
            \ + 0.2Ã—{{#1006.result.meta_em1#}}\",\n          \"quantity\": 1,\n  \
            \        \"rationale\": \"Long Call è·ç°ä»· 0.2Ã—EM1$ï¼Œè·å–ä¸Šè¡Œæ•å£\"\n        },\n\
            \        {\n          \"action\": \"sell\",\n          \"type\": \"call\"\
            ,\n          \"strike\": \"{{#3001.targets[0].walls.call_wall#}}\",\n\
            \          \"quantity\": 1,\n          \"rationale\": \"Short Call åœ¨ call_wall\
            \ é™åˆ¶é£é™©å¹¶é™ä½æˆæœ¬\"\n        }\n      ],\n      \"dte\": \"{{#1006.result.dte_final#}}\"\
            ,\n      \"dte_rationale\": \"{{#1006.result.dte_rationale#}}\",\n   \
            \   \"greeks_target\": {\n        \"delta\": \"{{#1006.result.greeks_balanced_desc#}}\"\
            ,\n        \"delta_range\": \"Â±{{#1006.result.greeks_balanced_delta_range#}}\"\
            ,\n        \"theta_min\": \"{{#1006.result.greeks_balanced_theta_min#}}\"\
            \n      },\n      \"rr_calculation\": {\n        \"debit\": {{#1006.result.rr_bull_debit#}},\n\
            \        \"max_profit\": {{#1006.result.rr_bull_max_profit#}},\n     \
            \   \"max_loss\": {{#1006.result.rr_bull_max_loss#}},\n        \"rr_ratio\"\
            : \"{{#1006.result.rr_bull_ratio#}}\",\n        \"formula\": \"{{#1006.result.rr_bull_formula#}}\"\
            ,\n        \"rr_note\": \"ç›ˆäºæ¯” {{#1006.result.rr_bull_ratio#}} é€‚åˆè¶‹åŠ¿ç­–ç•¥\"\
            \n      },\n      \"pw_calculation\": {\n        \"pw_estimate\": \"{{#1006.result.pw_debit_estimate#}}\"\
            ,\n        \"formula\": \"{{#1006.result.pw_debit_formula#}}\",\n    \
            \    \"pw_note\": \"{{#1006.result.pw_debit_note#}}\",\n        \"pw_ç»¼åˆåˆ¤æ–­\"\
            : \"DEX/Vanna ä¿¡å·æ”¯æŒï¼Œç»¼åˆèƒœç‡ {{#1006.result.pw_debit_estimate#}}\"\n      },\n\
            \      \"entry_trigger\": \"Spot å‘å¢™ä½ç§»åŠ¨ï¼ŒVanna/IV è·¯å¾„ä¸€è‡´\",\n      \"entry_timing\"\
            : \"æ¬¡æ—¥å¼€ç›˜åç¡®è®¤æ–¹å‘\",\n      \"exit_plan\": {\n        \"profit_target\": \"\
            æµ®ç›ˆ {{#1006.result.exit_debit_profit_pct#}}% å…ˆè½è¢‹ 50%\",\n        \"stop_loss\"\
            : \"äºæŸ {{#1006.result.exit_debit_stop_pct#}}% å¹³ä»“\",\n        \"time_decay_exit\"\
            : \"åˆ°æœŸå‰ {{#1006.result.exit_time_days#}} æ—¥è¯„ä¼°\",\n        \"adjustment\"\
            : \"è‹¥æ–¹å‘ä¿¡å·è½¬å¼±æå‰ç¦»åœº\"\n      },\n      \"risk_note\": \"æœ€å¤§é£é™© {{#1006.result.rr_bull_max_loss#}}ï¼Œå¯æ§\"\
            \n    },\n    {\n      \"strategy_type\": \"è¿›å–\",\n      \"structure\"\
            : \"Long Call\",\n      \"description\": \"å•è…¿çœ‹æ¶¨æœŸæƒï¼Œé€‚åˆå¼ºè¶‹åŠ¿åŠ é€Ÿ\",\n      \"\
            legs\": [\n        {\n          \"action\": \"buy\",\n          \"type\"\
            : \"call\",\n          \"strike\": \"è®¡ç®—: {{#1006.result.meta_spot#}} +\
            \ 0.1Ã—{{#1006.result.meta_em1#}}\",\n          \"quantity\": 1,\n    \
            \      \"rationale\": \"Long Call è½»åº¦è™šå€¼ 0.1Ã—EM1$ï¼Œæœ€å¤§åŒ– Delta æ•å£\"\n     \
            \   }\n      ],\n      \"dte\": \"{{#1006.result.dte_final#}}\",\n   \
            \   \"dte_rationale\": \"{{#1006.result.dte_rationale#}}\",\n      \"\
            greeks_target\": {\n        \"delta\": \"{{#1006.result.greeks_aggressive_desc#}}\"\
            ,\n        \"delta_range\": \"[{{#1006.result.greeks_aggressive_delta_min#}},\
            \ {{#1006.result.greeks_aggressive_delta_max#}}]\",\n        \"vega_min\"\
            : \"{{#1006.result.greeks_aggressive_vega_min#}}\"\n      },\n      \"\
            rr_calculation\": {\n        \"debit\": \"ä¼°ç®—: æƒåˆ©é‡‘çº¦ {{#1006.result.rr_bull_debit#}}\
            \ Ã— 1.2\",\n        \"max_profit\": \"ç†è®ºæ— é™\",\n        \"max_loss\": \"\
            æƒåˆ©é‡‘å…¨æŸ\",\n        \"rr_ratio\": \"3:1 è‡³ 5:1\",\n        \"rr_note\": \"\
            é«˜ RR ä½†éœ€å¼ºè¶‹åŠ¿æ”¯æŒ\"\n      },\n      \"pw_calculation\": {\n        \"pw_estimate\"\
            : \"çº¦ 35-50%\",\n        \"pw_note\": \"ä¾èµ– Vannaã€ç©ºç¼ºã€IV è·¯å¾„ä¸‰è€…å…±æŒ¯\",\n   \
            \     \"pw_ç»¼åˆåˆ¤æ–­\": \"ä»…å½“æ–¹å‘ä¿¡å·æå¼ºæ—¶è€ƒè™‘\"\n      },\n      \"entry_trigger\"\
            : \"æœ‰æ•ˆç ´å¢™ â‰¥0.5Ã—EM1$ï¼Œæˆäº¤é‡ç¡®è®¤\",\n      \"entry_timing\": \"çªç ´åæ¬¡æ—¥è¿½æ¶¨\",\n  \
            \    \"exit_plan\": {\n        \"profit_target\": \"æµ®ç›ˆ 100% åˆ†æ‰¹ç¦»åœº\",\n\
            \        \"stop_loss\": \"äºæŸ 50% æˆ–æ–¹å‘ä¿¡å·è½¬å¼±\",\n        \"time_decay_exit\"\
            : \"åˆ°æœŸå‰ {{#1006.result.exit_time_days#}} æ—¥\",\n        \"adjustment\"\
            : \"è‹¥ IV çªç„¶å‹ç¼©è€ƒè™‘æ¢ spread\"\n      },\n      \"risk_note\": \"é«˜é£é™©é«˜å›æŠ¥ï¼Œä»…é€‚åˆå°ä»“ä½è¯•æ¢\"\
            \n    }\n  ]\n}\n```\n\n## å…³é”®æ³¨æ„äº‹é¡¹ \n1. **ä¸¥æ ¼ä½¿ç”¨æ‰å¹³åŒ–å­—æ®µ**ï¼šæ‰€æœ‰æ•°å€¼ã€å…¬å¼ã€æè¿°éƒ½ç”¨ CODE3\
            \ å¼•ç”¨ï¼Œä¸è¦åµŒå¥— \n2. **Rationale å¿…é¡»å…·ä½“**ï¼šæ¯æ¡è…¿éƒ½è¦è§£é‡Š\"ä¸ºä½•é€‰æ‹©è¯¥è¡Œæƒä»·\"\"åœ¨ç­–ç•¥ä¸­çš„ä½œç”¨\"\"ä¸å‰§æœ¬çš„é€‚é…\"\
            \ \n3. **æ‰§è¡Œæ–¹æ¡ˆè¦å¯æ“ä½œ**ï¼šå…¥åœºè§¦å‘æ¡ä»¶è¦å…·ä½“åˆ°å¯éªŒè¯ï¼ˆå¦‚\"DEX >60%\"è€Œé\"æ–¹å‘æ˜ç¡®\"ï¼‰ \n4. **é£é™©æè¿°è¦é‡åŒ–**ï¼šæ˜ç¡®æœ€å¤§äºæŸæ•°å€¼ã€æ­¢æŸç™¾åˆ†æ¯”ã€ä»“ä½é™åˆ¶\
            \ \n5. **ä¸‰ç§ç­–ç•¥è¦æœ‰å·®å¼‚**ï¼šä¿å®ˆ/å‡è¡¡/è¿›å–çš„ç»“æ„ã€Greeksã€RR/Pw éƒ½åº”æ˜æ˜¾ä¸åŒ\n---\n ç°åœ¨è¯·åŸºäºè¾“å…¥æ•°æ®ç”Ÿæˆä¸‰ç§ç­–ç•¥æ–¹æ¡ˆã€‚\n"
        - id: user-strategy
          role: user
          text: 'è¯·æ ¹æ®å‰§æœ¬åˆ†æå’Œè®¡ç®—è¾…åŠ©ç»“æœï¼Œç”Ÿæˆä¸‰ç§é£é™©ç­‰çº§çš„æœŸæƒç­–ç•¥ã€‚

            ã€å½“å‰å¸‚åœºçŠ¶æ€ã€‘

            - ä¸»å¯¼å‰§æœ¬: {{#5001.structured_output.scenario_classification.primary_scenario#}}

            - å‰§æœ¬æ¦‚ç‡: {{#5001.structured_output.scenario_classification.scenario_probability#}}%

            - Gamma çŠ¶æ€: {{#1006.result.meta_gamma_regime#}}

            - æŠ€æœ¯é¢è¯„åˆ†: {{#1006.result.meta_technical_score#}}/2


            ã€å…³é”®ä¿¡å·ã€‘

            - DEX åŒå‘: {{#5001.structured_output.directional_signals.dex_same_dir#}}%

            - Vanna æ–¹å‘: {{#5001.structured_output.directional_signals.vanna_dir#}}({{#5001.structured_output.directional_signals.vanna_confidence#}})

            - IV è·¯å¾„: {{#5001.structured_output.iv_dynamics.iv_path#}}({{#5001.structured_output.iv_dynamics.iv_path_confidence#}})


            è¯·ä¸¥æ ¼æŒ‰ç…§ç³»ç»Ÿæç¤ºçš„ JSON æ ¼å¼è¾“å‡ºä¸‰ç§ç­–ç•¥ã€‚

            '
        selected: false
        structured_output:
          schema:
            properties:
              strategies:
                items:
                  properties:
                    description:
                      type: string
                    dte:
                      type: string
                    dte_rationale:
                      type: string
                    entry_timing:
                      type: string
                    entry_trigger:
                      type: string
                    exit_plan:
                      properties:
                        adjustment:
                          type: string
                        profit_target:
                          type: string
                        stop_loss:
                          type: string
                        time_decay_exit:
                          type: string
                      type: object
                    greeks_target:
                      properties:
                        delta:
                          type: string
                        delta_range:
                          type: string
                        theta_min:
                          type: string
                        vega_max:
                          type: string
                        vega_min:
                          type: string
                      type: object
                    legs:
                      items:
                        properties:
                          action:
                            type: string
                          quantity:
                            type: number
                          rationale:
                            type: string
                          strike:
                            type: number
                          type:
                            type: string
                        type: object
                      type: array
                    pw_calculation:
                      properties:
                        formula:
                          type: string
                        pw_estimate:
                          type: string
                        pw_note:
                          type: string
                        pw_ç»¼åˆåˆ¤æ–­:
                          type: string
                      type: object
                    risk_note:
                      type: string
                    rr_calculation:
                      properties:
                        credit:
                          type: number
                        debit:
                          type: number
                        formula:
                          type: string
                        max_loss:
                          type: number
                        max_profit:
                          type: number
                        rr_note:
                          type: string
                        rr_ratio:
                          type: string
                      type: object
                    strategy_type:
                      type: string
                    structure:
                      type: string
                  required:
                  - strategy_type
                  - structure
                  - description
                  - legs
                  - dte
                  - greeks_target
                  - rr_calculation
                  - pw_calculation
                  - entry_trigger
                  - exit_plan
                  - risk_note
                  type: object
                type: array
            required:
            - strategies
            type: object
        structured_output_enabled: true
        title: Agent 6 ç­–ç•¥ç”Ÿæˆ
        type: llm
        vision:
          enabled: false
      height: 132
      id: '6001'
      position:
        x: 2836.128375627802
        y: 332.41002500221094
      positionAbsolute:
        x: 2836.128375627802
        y: 332.41002500221094
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: 'Agent 8: Assemble the final report based on the template.'
        model:
          completion_params:
            temperature: 0.5
          mode: chat
          name: deepseek-v3.2-exp-thinking
          provider: langgenius/openai_api_compatible/openai_api_compatible
        prompt_template:
        - id: sys-report
          role: system
          text: "ä½ æ˜¯æœ€ç»ˆæŠ¥å‘Šç”Ÿæˆ Agentï¼Œè´Ÿè´£æ±‡æ€»æ‰€æœ‰åˆ†æç»“æœï¼Œç”Ÿæˆæ˜“è¯»çš„ Markdown æŠ¥å‘Šã€‚\n\nã€ä»»åŠ¡ã€‘ æ±‡æ€»æ‰€æœ‰åˆ†æï¼Œç”Ÿæˆå•æ ‡çš„å®Œæ•´æŠ¥å‘Šï¼ˆå«äº‹ä»¶é£é™©ï¼‰ã€‚\n\
            ã€è¾“å…¥æ•°æ®æºã€‘\n  - æ•°æ®æ ¡éªŒ: Agent 3 {{#3001.structured_output#}}\n  - å‰§æœ¬åˆ†æ: Agent\
            \ 5 {{#5001.structured_output#}}\n  - ç­–ç•¥æ¨è: Agent 7 {{#1005.structured_output#}}\n\
            \  - äº‹ä»¶æ£€æµ‹: CODE1 {{#1004.result#}}\nã€æŠ€æœ¯é¢å¤„ç†è§„åˆ™ã€‘\næŠ€æœ¯é¢æ•°æ®å·²æ•´åˆåˆ° Agent 3 ä¸­:\n\
            \  - è‹¥å­˜åœ¨: ä» {{#3001.structured_output.technical_analysis#}} æå–\n  - è‹¥ç¼ºå¤±:\
            \ æŠ¥å‘Šä¸­æ ‡æ³¨ \"æŠ€æœ¯é¢æ•°æ®ç¼ºå¤±,ä»…å½±å“è¯„åˆ†\"\n\n ã€è¾“å‡ºæ¨¡æ¿ã€‘\n  ç”Ÿæˆç®€æ´çš„ Markdown æŠ¥å‘Šï¼Œéµå¾ªä»¥ä¸‹ç»“æ„ï¼š\n\n\
            \  # ç¾è‚¡æœŸæƒåˆ†ææŠ¥å‘Š\n  \n  **æ ‡çš„**: {symbol} | **ç°ä»·**: {spot} | **EM1$**: {em1}\
            \  \n  **åˆ†ææ—¶é—´**: {timestamp} | **é£é™©ç­‰çº§**: {event_risk_level} {\U0001F7E2\
            /\U0001F7E1/\U0001F534}\n\n  ## 0. äº‹ä»¶é£é™©è¯„ä¼° âš ï¸\n  \n  **æ£€æµ‹æ—¥æœŸ**: {detection_date}\
            \  \n  **é£é™©ç­‰çº§**: {risk_level}\n  \n  {è‹¥æ— äº‹ä»¶}\n  âœ… æœªæ£€æµ‹åˆ°è¿‘æœŸé‡å¤§äº‹ä»¶ï¼Œå¯æ­£å¸¸æ‰§è¡Œç­–ç•¥\n\
            \  \n  {è‹¥æœ‰äº‹ä»¶ï¼Œè¾“å‡ºè¡¨æ ¼}\n  | äº‹ä»¶ç±»å‹ | æ—¥æœŸ | è·ç¦» | å½±å“ | è¯´æ˜ |\n  |---------|------|------|------|------|\n\
            \  | {type} | {date} | {days_away}æ—¥ | {impact} | {note} |\n  \n  ### ç­–ç•¥è°ƒæ•´å»ºè®®\n\
            \  - **ç¦æ­¢è·¨æœŸ**: {no_cross_earnings ? \"\U0001F6AB æ˜¯\" : \"âœ… å¦\"}  \n  \
            \  {è‹¥æ˜¯: è´¢æŠ¥æˆ–é‡å¤§äº‹ä»¶ä¸´è¿‘ï¼Œå»ºè®®DTEâ‰¤{max_dte}æ—¥æˆ–ç­‰å¾…äº‹ä»¶å}\n  - **ç¼©çŸ­DTE**: {adjust_dte\
            \ ? \"âš ï¸ æ˜¯\" : \"âœ… å¦\"}  \n    {è‹¥æ˜¯: OPEXä¸´è¿‘ï¼Œå»ºè®®DTEâ‰¤{max_dte}æ—¥}\n  - **å‡ä»“æ“ä½œ**:\
            \ {reduce_position ? \"âš ï¸ æ˜¯\" : \"âœ… å¦\"}  \n    {è‹¥æ˜¯: FOMCä¸´è¿‘ï¼Œå»ºè®®åŠä»“æˆ–è§‚æœ›}\n\
            \  \n  ---\n\n  ## 1. ç»¼åˆç»“è®º\n  \n  **æ€»è¯„åˆ†**: {total_score}/10  \n  **å…¥åœºåˆ¤å®š**:\
            \ {entry_check} â†’ {å…¥åœºç†ç”±ç®€è¿°ï¼Œ100å­—}\n  \n  **è¯„åˆ†æ„æˆ**:\n  - GammaçŠ¶æ€: {gamma_score}/10\
            \ ({regime_noteç®€åŒ–})\n  - ç ´å¢™å¯èƒ½: {break_wall_score}/10 ({break_noteç®€åŒ–})\n\
            \  - æ–¹å‘ä¸€è‡´: {direction_score}/10 ({direction_noteç®€åŒ–})\n  - IVåŠ¨æ€: {iv_score}/10\
            \ ({iv_noteç®€åŒ–})\n  \n  **ä¸»å¯¼å‰§æœ¬**: {primary_scenario} (æ¦‚ç‡{probability}%)\
            \  \n  {adjustment_note}\n  \n  ---\n\n  ## 2. ç­–ç•¥æ¨è\n  \n  ### æ’åºæ€»è§ˆ\n\
            \  | æ’å | ç­–ç•¥ | æœŸæœ›å€¼ | é£é™©è°ƒæ•´æ”¶ç›Š | å‰§æœ¬åŒ¹é… | æµåŠ¨æ€§ | æ¨èç­‰çº§ |\n  |------|------|--------|--------------|----------|--------|----------|\n\
            \  | 1 | {type} | {ev} | {rar} | {match} | {pass} | {level} |\n  | 2 |\
            \ {type} | {ev} | {rar} | {match} | {pass} | {level} |\n  | 3 | {type}\
            \ | {ev} | {rar} | {match} | {pass} | {level} |\n  \n  **æœ€ç»ˆæ¨è**: {final_recommendation}\n\
            \  \n  ### é¦–é€‰ç­–ç•¥è¯¦è¿°\n  \n  **ç­–ç•¥**: {primary_strategy_type} - {structure}\
            \  \n  **é…ç½®**: {allocation}  \n  **ç†ç”±**: {rationaleç®€åŒ–ï¼Œ150å­—}\n  \n  **é‡åŒ–æŒ‡æ ‡**:\n\
            \  - ç›ˆäºæ¯”: {rr_ratio} | èƒœç‡: {pw}%\n  - æœŸæœ›å€¼: {ev} | é£é™©è°ƒæ•´æ”¶ç›Š: {rar}\n  - æœ€å¤§ç›ˆåˆ©:\
            \ {max_profit} | æœ€å¤§äºæŸ: {max_loss}\n  \n  **æ‰§è¡Œè¦ç‚¹**:\n  - å…¥åœº: {entry_triggerç®€åŒ–}\n\
            \  - æ­¢ç›ˆ: {profit_target}\n  - æ­¢æŸ: {stop_loss}\n  - æ—¶é—´: {time_exit}\n \
            \ \n  ---\n\n  ## 3. ç›‘æ§è¦ç‚¹\n  \n  **å…³é”®ä½**:\n  - æ”¯æ’‘: {put_wall} | é˜»åŠ›: {call_wall}\n\
            \  - è§¦å‘çº¿: {vol_trigger} | ç°ä»·: {spot}\n  \n  **å®æ—¶å…³æ³¨**:\n  {æ ¹æ®é¦–é€‰ç­–ç•¥ç±»å‹è°ƒæ•´}\n\
            \  - {è‹¥ä¿å®ˆ(ä¿¡ç”¨ä»·å·®/é“é¹°)}: å¢™ä½ç¨³å®šæ€§ã€é›¶Î³æ¼‚ç§»â‰¤0.3Ã—EM1ã€Thetaæ”¶ç›Šç´¯ç§¯ã€IVå‹ç¼©\n  - {è‹¥å‡è¡¡(å€Ÿè®°ç«–å¼/æ—¥å†)}:\
            \ æ–¹å‘ç¡®è®¤ã€DEXåŒå‘ç´¯ç§¯>60%åˆ†ä½ã€Vannaæ”¯æŒã€gapç¼©å°\n  - {è‹¥è¿›å–(å•è…¿/çª„è·debit)}: æœ‰æ•ˆç ´å¢™ä¸”ç¦»å¢™â‰¥0.5Ã—EM1ã€ç©ºç¼ºæ”¯æŒã€Vanna+IVè·¯å¾„å…±æŒ¯ã€æŒ‡æ•°ä¸€è‡´\n\
            \  \n  **æ­¢æŸè§¦å‘** (ç«‹å³å¹³ä»“æ¡ä»¶):\n  - Spotç©¿è¶ŠVOL_TRIGGER (Gamma regimeåè½¬)\n  -\
            \ è¾¾åˆ°ç­–ç•¥æ­¢æŸç‚¹\n  - gap_distance<0.5Ã—EM1 (æ¥è¿‘å¢™ä½)\n  - vanna_diråè½¬\n  - dex_same_dir<40%\n\
            \  \n  ---\n\n  ## 4. æ ¸å¿ƒæ•°æ® (è¯¦ç»†)\n  \n  ```\n  æ ‡çš„: {symbol}\n  Spot: {spot}\
            \ | EM1$: {em1}\n  \n  GammaçŠ¶æ€:\n  - VOL_TRIGGER: {vol_trigger}\n  - ç°ä»·ä½ç½®:\
            \ {spot_vs_trigger}\n  - NET-GEX: {net_gex} ({sign})\n  \n  å¢™ä½:\n  - Call\
            \ Wall: {call_wall}\n  - Put Wall: {put_wall}\n  - Major Wall: {major_wall}\
            \ ({type})\n  \n  ç©ºç¼ºä¸æ–¹å‘:\n  - gapè·ç¦»: {gap_distance}$ ({gap_em1}Ã—EM1$)\n\
            \  - ç°‡å¼ºåº¦: {cluster_strength}\n  - æœˆåº¦å åŠ : {monthly_override}\n  - DEXåŒå‘:\
            \ {dex_same_dir}%\n  - Vannaæ–¹å‘: {vanna_dir} ({confidence})\n  - IVè·¯å¾„:\
            \ {iv_path} ({iv_confidence})\n  \n  æ³¢åŠ¨ç‡:\n  - ATM IV 7D: {iv_7d}\n  -\
            \ ATM IV 14D: {iv_14d}\n  - IVæ•°æ®æº: {iv_source}\n  \n  æŒ‡æ•°èƒŒæ™¯:\n  - SPX NET-GEX:\
            \ {spx_net_gex}\n  - SPX EM1$: {spx_em1}\n  ```\n  \n  **æ•°æ®è´¨é‡**: å®Œæ•´åº¦{completion_rate}%\
            \ | ç¼ºå¤±{missing_count}é¡¹\n  \n  ---\n  \n  **æŠ¥å‘Šç”Ÿæˆ**: {å½“å‰æ—¶é—´}  \n  **ä¸‹æ¬¡æ›´æ–°**:\
            \ ç›˜å‰æˆ–å…³é”®æ•°æ®å˜åŒ–æ—¶\n"
        - id: user-report
          role: user
          text: "è¯·æ±‡æ€»æ‰€æœ‰åˆ†æï¼Œç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šã€‚\n  \nè¯·ä¸¥æ ¼æŒ‰ç…§ç³»ç»Ÿæç¤ºä¸­çš„æ¨¡æ¿è¾“å‡º Markdown æ ¼å¼æŠ¥å‘Šã€‚\nä»…è¾“å‡ºæŠ¥å‘Šå†…å®¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•å‰ç½®è¯´æ˜æˆ–åç½®æ€»ç»“ã€‚"
        selected: false
        title: Agent 8 æœ€ç»ˆæŠ¥å‘Š
        type: llm
        vision:
          enabled: false
      height: 132
      id: '7001'
      position:
        x: 3637.3205297388795
        y: 332.41002500221094
      positionAbsolute:
        x: 3637.3205297388795
        y: 332.41002500221094
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: '{{#7001.text#}}'
        desc: ''
        selected: false
        title: ğŸ“ˆ å›å¤æœ€ç»ˆåˆ†ææŠ¥å‘Š
        type: answer
      height: 103
      id: '7002'
      position:
        x: 3976.0080521670707
        y: 332.41002500221094
      positionAbsolute:
        x: 3976.0080521670707
        y: 332.41002500221094
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nfrom datetime import datetime, timedelta\nimport re\n\n\
          # å…¨å±€ç¼“å­˜å­—å…¸ï¼ˆåœ¨å·¥ä½œæµç”Ÿå‘½å‘¨æœŸå†…ä¿æŒï¼‰\n_earnings_cache = {}\n\ndef get_earnings_from_alpha_vantage(symbol,\
          \ api_key, enable_api, cache_days, url):\n    \"\"\"ä»Alpha Vantageè·å–è´¢æŠ¥æ—¥æœŸï¼ˆå¸¦ç¼“å­˜ï¼‰\"\
          \"\"\n\n    # æ£€æŸ¥å¼€å…³\n    enable_api_bool = str(enable_api).lower() in ['true',\
          \ '1', 'yes']\n    if not enable_api_bool:\n        return None  # APIå·²ç¦ç”¨ï¼Œè·³è¿‡\n\
          \n    # æ£€æŸ¥ç¼“å­˜\n    current_time = datetime.now()\n    cache_key = f\"earnings_{symbol}\"\
          \n\n    if cache_key in _earnings_cache:\n        cached_data, cached_time\
          \ = _earnings_cache[cache_key]\n        # æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ\n        if (current_time\
          \ - cached_time).days < int(cache_days):\n            return cached_data\
          \  # è¿”å›ç¼“å­˜æ•°æ®\n\n    # è°ƒç”¨API\n    try:\n        import urllib.request\n  \
          \      import urllib.error\n        \n        url = f\"{url}function=EARNINGS_CALENDAR&horizon=12month&apikey={api_key}&symbol={symbol}\"\
          \n        \n        req = urllib.request.Request(url)\n        with urllib.request.urlopen(req,\
          \ timeout=5) as response:\n            data = response.read().decode('utf-8')\n\
          \        \n        lines = data.strip().split('\\n')\n        if len(lines)\
          \ > 1:\n            first_earnings = lines[1].split(',')\n            if\
          \ len(first_earnings) >= 3:\n                earnings_date = first_earnings[2]\n\
          \                # å­˜å…¥ç¼“å­˜\n                _earnings_cache[cache_key] = (earnings_date,\
          \ current_time)\n                return earnings_date\n        \n      \
          \  # APIè¿”å›ç©ºï¼Œç¼“å­˜ç©ºç»“æœé¿å…é‡å¤è°ƒç”¨\n        _earnings_cache[cache_key] = (None, current_time)\n\
          \        return None\n        \n    except urllib.error.HTTPError as e:\n\
          \        if e.code == 429:\n            return \"API_LIMIT_REACHED\"\n \
          \       return None\n    except Exception as e:\n        return None\n\n\
          def detect_events(symbol, current_date_str, api_key, enable_api, cache_days,\
          \ url):\n    \"\"\"äº‹ä»¶æ£€æµ‹ä¸»å‡½æ•°\"\"\"\n    try:\n        current_date = datetime.strptime(current_date_str,\
          \ \"%Y-%m-%d\")\n    except:\n        current_date = datetime.now()\n  \
          \  \n    events = []\n    recommendations = {\n        \"no_cross_earnings\"\
          : False,\n        \"adjust_dte\": False,\n        \"reduce_position_size\"\
          : False,\n        \"max_dte_suggestion\": None,\n        \"note\": \"\"\
          ,\n        \"api_status\": \"disabled\" if str(enable_api).lower() not in\
          \ ['true', '1', 'yes'] else \"enabled\"\n    }\n    \n    # === 1. OPEXæ£€æµ‹\
          \ ===\n    year = current_date.year\n    month = current_date.month\n  \
          \  first_day = datetime(year, month, 1)\n    days_until_friday = (4 - first_day.weekday())\
          \ % 7\n    first_friday = first_day + timedelta(days=days_until_friday)\n\
          \    third_friday = first_friday + timedelta(weeks=2)\n    days_to_opex\
          \ = (third_friday - current_date).days\n    \n    if -5 <= days_to_opex\
          \ <= 14:\n        is_quarterly = month in [3, 6, 9, 12]\n        events.append({\n\
          \            \"type\": \"Quarterly_OPEX\" if is_quarterly else \"Monthly_OPEX\"\
          ,\n            \"date\": third_friday.strftime(\"%Y-%m-%d\"),\n        \
          \    \"days_away\": days_to_opex,\n            \"impact\": \"high\" if is_quarterly\
          \ else \"medium\"\n        })\n        if 0 <= days_to_opex <= 7:\n    \
          \        recommendations[\"adjust_dte\"] = True\n            recommendations[\"\
          max_dte_suggestion\"] = max(days_to_opex - 2, 3)\n            recommendations[\"\
          note\"] += f\"è·ç¦»{'å­£åº¦' if is_quarterly else 'æœˆåº¦'}OPEX {days_to_opex}æ—¥ï¼Œå»ºè®®DTEâ‰¤{recommendations['max_dte_suggestion']}æ—¥;\
          \ \"\n    \n    # === 2. FOMCæ£€æµ‹ ===\n    fomc_dates_2025 = [\n        \"\
          2025-01-28\", \"2025-01-29\", \"2025-03-18\", \"2025-03-19\",\n        \"\
          2025-05-06\", \"2025-05-07\", \"2025-06-17\", \"2025-06-18\",\n        \"\
          2025-07-29\", \"2025-07-30\", \"2025-09-16\", \"2025-09-17\",\n        \"\
          2025-10-28\", \"2025-10-29\", \"2025-12-09\", \"2025-12-10\",\n    ]\n \
          \   for fomc_date_str in fomc_dates_2025:\n        fomc_date = datetime.strptime(fomc_date_str,\
          \ \"%Y-%m-%d\")\n        days_to_fomc = (fomc_date - current_date).days\n\
          \        if 0 <= days_to_fomc <= 30:\n            events.append({\n    \
          \            \"type\": \"FOMC\",\n                \"date\": fomc_date_str,\n\
          \                \"days_away\": days_to_fomc,\n                \"impact\"\
          : \"high\" if days_to_fomc <= 7 else \"medium\"\n            })\n      \
          \      if days_to_fomc <= 7:\n                recommendations[\"reduce_position_size\"\
          ] = True\n                recommendations[\"note\"] += f\"è·ç¦»FOMCä¼šè®®{days_to_fomc}æ—¥ï¼Œå»ºè®®å‡åŠä»“ä½æˆ–è§‚æœ›;\
          \ \"\n            break\n    \n    # === 3. è´¢æŠ¥å­£æ£€æµ‹ ===\n    earnings_seasons\
          \ = {\n        \"Q4\": (1, 15, 2, 28), \"Q1\": (4, 15, 5, 31),\n       \
          \ \"Q2\": (7, 15, 8, 31), \"Q3\": (10, 15, 11, 30),\n    }\n    for quarter,\
          \ (sm, sd, em, ed) in earnings_seasons.items():\n        try:\n        \
          \    season_start = datetime(year, sm, sd)\n            season_end = datetime(year,\
          \ em, ed)\n            if season_start <= current_date <= season_end:\n\
          \                events.append({\n                    \"type\": \"Earnings_Season\"\
          ,\n                    \"date\": f\"{quarter} Earnings Season\",\n     \
          \               \"days_away\": 0,\n                    \"impact\": \"medium\"\
          ,\n                    \"note\": f\"å½“å‰å¤„äº{quarter}è´¢æŠ¥å­£\"\n               \
          \ })\n                recommendations[\"no_cross_earnings\"] = True\n  \
          \              recommendations[\"max_dte_suggestion\"] = 7\n           \
          \     recommendations[\"note\"] += f\"å½“å‰å¤„äº{quarter}è´¢æŠ¥å­£ï¼Œä¸å»ºè®®è·¨æœŸï¼Œä¼˜å…ˆ5-7æ—¥DTE;\
          \ \"\n                break\n        except:\n            continue\n   \
          \ \n    # === 4. Alpha Vantage APIè·å–ä¸ªè‚¡è´¢æŠ¥ï¼ˆå¸¦å¼€å…³å’Œç¼“å­˜ï¼‰===\n    symbol_upper =\
          \ symbol.upper()\n    \n    if str(enable_api).lower() in ['true', '1',\
          \ 'yes']:\n        # APIå·²å¯ç”¨\n        earnings_date_api = get_earnings_from_alpha_vantage(\n\
          \            symbol_upper, api_key, enable_api, cache_days, url\n      \
          \  )\n        \n        if earnings_date_api and earnings_date_api != \"\
          API_LIMIT_REACHED\":\n            try:\n                earnings_date =\
          \ datetime.strptime(earnings_date_api, \"%Y-%m-%d\")\n                days_to_earnings\
          \ = (earnings_date - current_date).days\n                if -5 <= days_to_earnings\
          \ <= 14:\n                    events.append({\n                        \"\
          type\": \"Earnings\",\n                        \"date\": earnings_date_api,\n\
          \                        \"days_away\": days_to_earnings,\n            \
          \            \"impact\": \"high\",\n                        \"symbol\":\
          \ symbol_upper,\n                        \"source\": \"Alpha Vantage API\"\
          ,\n                        \"cached\": cache_key in _earnings_cache and\
          \ (current_time - _earnings_cache[cache_key][1]).days < int(cache_days)\n\
          \                    })\n                    if -2 <= days_to_earnings <=\
          \ 5:\n                        recommendations[\"no_cross_earnings\"] = True\n\
          \                        recommendations[\"max_dte_suggestion\"] = 5\n \
          \                       recommendations[\"note\"] += f\"{symbol_upper}è´¢æŠ¥{earnings_date_api}ï¼Œ{'å·²è¿‡'\
          \ if days_to_earnings < 0 else 'å³å°†'}({abs(days_to_earnings)}æ—¥)ï¼Œä¸¥ç¦è·¨æœŸï¼Œå»ºè®®ç­‰å¾…æˆ–â‰¤5æ—¥DTE;\
          \ \"\n            except:\n                pass\n        elif earnings_date_api\
          \ == \"API_LIMIT_REACHED\":\n            events.append({\n             \
          \   \"type\": \"API_Warning\",\n                \"date\": \"N/A\",\n   \
          \             \"days_away\": 0,\n                \"impact\": \"low\",\n\
          \                \"note\": \"Alpha Vantage APIé…é¢ç”¨å°½\"\n            })\n \
          \           recommendations[\"api_status\"] = \"quota_exceeded\"\n    else:\n\
          \        # APIå·²ç¦ç”¨ï¼Œæ·»åŠ æç¤º\n        if not any(e.get(\"type\") == \"Earnings_Season\"\
          \ for e in events):\n            # åªåœ¨ä¸åœ¨è´¢æŠ¥å­£æ—¶æ‰æç¤º\n            recommendations[\"\
          note\"] += \"ï¼ˆè´¢æŠ¥APIå·²ç¦ç”¨ï¼Œä»…æ£€æµ‹è´¢æŠ¥å­£ï¼‰; \"\n    \n    # === 5. ç»¼åˆåˆ¤æ–­ ===\n    if\
          \ not recommendations[\"note\"]:\n        recommendations[\"note\"] = \"\
          æœªæ£€æµ‹åˆ°è¿‘æœŸé‡å¤§äº‹ä»¶ï¼Œå¯æ­£å¸¸æ‰§è¡Œç­–ç•¥\"\n    if recommendations[\"max_dte_suggestion\"] is\
          \ None:\n        recommendations[\"max_dte_suggestion\"] = 14\n    \n  \
          \  result = {\n        \"symbol\": symbol_upper,\n        \"detection_date\"\
          : current_date.strftime(\"%Y-%m-%d\"),\n        \"events\": events,\n  \
          \      \"event_count\": len([e for e in events if e[\"type\"] not in [\"\
          API_Warning\", \"Earnings_Season\"]]),\n        \"recommendations\": recommendations,\n\
          \        \"risk_level\": \"high\" if (recommendations[\"no_cross_earnings\"\
          ] or recommendations[\"reduce_position_size\"]) else (\"medium\" if recommendations[\"\
          adjust_dte\"] else \"low\"),\n        \"cache_info\": {\n            \"\
          earnings_cached_count\": len(_earnings_cache),\n            \"api_enabled\"\
          : recommendations[\"api_status\"]\n        }\n    }\n    return json.dumps(result,\
          \ indent=2, ensure_ascii=False)\n\ndef main():\n    user_input = \"\"\"\
          {{#1001.query#}}\"\"\"\n    api_key = \"\"\"{{#env.ALPHA_VANTAGE_API_KEY#}}\"\
          \"\"\n    url = \"\"\"{{#env.ALPHA_VANTAGE_API_URL#}}\"\"\"\n    enable_api\
          \ = \"\"\"{{#env.ENABLE_EARNINGS_API#}}\"\"\"\n    cache_days = \"\"\"{{#env.EARNINGS_CACHE_DAYS#}}\"\
          \"\"\n    \n    match = re.search(r'\\b([A-Z]{1,5})\\b', user_input.upper())\n\
          \    symbol = match.group(1) if match else \"UNKNOWN\"\n    current_date\
          \ = datetime.now().strftime(\"%Y-%m-%d\")\n    \n    result = detect_events(symbol,\
          \ current_date, api_key, enable_api, cache_days, url)\n    return {\"result\"\
          : result}"
        code_language: python3
        desc: è´¢æŠ¥ã€FOMCã€OPEX äº‹ä»¶æ£€æµ‹
        outputs:
          result:
            children: null
            type: string
        selected: false
        title: CODE1 äº‹ä»¶æ£€æµ‹
        type: code
        variables: []
      height: 80
      id: '1004'
      position:
        x: 1695.8317617749378
        y: 161.59366846092928
      positionAbsolute:
        x: 1695.8317617749378
        y: 161.59366846092928
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "\nimport json\nfrom typing import Dict, Any, List, Tuple\n\n\ndef main(agent3_output:\
          \ str, technical_score: float = 0, **env_vars) -> dict:\n    \"\"\"\n  \
          \  Dify Code Node å…¥å£å‡½æ•°\n    \n    Args:\n        agent3_output: Agent 3\
          \ çš„æ•°æ®æ ¡éªŒç»“æœ JSON å­—ç¬¦ä¸²\n        agent4_output: Agent 4 çš„æŠ€æœ¯é¢åˆ†æ JSON å­—ç¬¦ä¸² (å¯é€‰)\n\
          \        **env_vars: ç¯å¢ƒå˜é‡å­—å…¸\n        \n    Returns:\n        {\"result\"\
          : è¯„åˆ†ç»“æœ JSON å­—ç¬¦ä¸²}\n    \"\"\"\n    try:\n        # è§£æè¾“å…¥\n        agent3_data\
          \ = json.loads(agent3_output)\n        \n        # åˆå§‹åŒ–è¯„åˆ†å¼•æ“\n        scoring\
          \ = OptionsScoring(env_vars)\n        \n        # æ‰§è¡Œè¯„åˆ†è®¡ç®—\n        result\
          \ = scoring.process(agent3_data)\n        \n        # è¿”å› JSON å­—ç¬¦ä¸²\n    \
          \    return {\n            \"result\": json.dumps(result, ensure_ascii=False,\
          \ indent=2)\n        }\n        \n    except Exception as e:\n        #\
          \ é”™è¯¯å¤„ç†\n        error_result = {\n            \"error\": True,\n       \
          \     \"error_message\": str(e),\n            \"error_type\": type(e).__name__\n\
          \        }\n        return {\n            \"result\": json.dumps(error_result,\
          \ ensure_ascii=False, indent=2)\n        }\n\n\nclass OptionsScoring:\n\
          \    \"\"\"æœŸæƒé‡åŒ–è¯„åˆ†è®¡ç®—å¼•æ“\"\"\"\n    \n    def __init__(self, env_vars: Dict[str,\
          \ Any]):\n        \"\"\"\n        åˆå§‹åŒ–ç¯å¢ƒå˜é‡é˜ˆå€¼\n        \n        Args:\n \
          \           env_vars: ç¯å¢ƒå˜é‡å­—å…¸ï¼ŒåŒ…å«æ‰€æœ‰é˜ˆå€¼å‚æ•°\n        \"\"\"\n        self.env\
          \ = self._parse_env_vars(env_vars)\n        \n    def _parse_env_vars(self,\
          \ env_vars: Dict[str, Any]) -> Dict[str, float]:\n        \"\"\"è§£æå¹¶éªŒè¯ç¯å¢ƒå˜é‡\"\
          \"\"\n        parsed = {}\n        \n        # å¿…éœ€çš„ç¯å¢ƒå˜é‡åŠå…¶é»˜è®¤å€¼\n        defaults\
          \ = {\n            'SCORE_WEIGHT_GAMMA_REGIME': \"\"\"{{#env.SCORE_WEIGHT_GAMMA_REGIME#}}\"\
          \"\",\n            'SCORE_WEIGHT_BREAK_WALL': \"\"\"{{#env.SCORE_WEIGHT_BREAK_WALL#}}\"\
          \"\",\n            'SCORE_WEIGHT_DIRECTION': \"\"\"{{#env.SCORE_WEIGHT_DIRECTION#}}\"\
          \"\",\n            'SCORE_WEIGHT_IV': \"\"\"{{#env.SCORE_WEIGHT_IV#}}\"\"\
          \",\n            'BREAK_WALL_THRESHOLD_LOW': \"\"\"{{#env.BREAK_WALL_THRESHOLD_LOW#}}\"\
          \"\",\n            'BREAK_WALL_THRESHOLD_HIGH': \"\"\"{{#env.BREAK_WALL_THRESHOLD_HIGH#}}\"\
          \"\",\n            'MONTHLY_OVERRIDE_THRESHOLD': \"\"\"{{#env.MONTHLY_OVERRIDE_THRESHOLD#}}\"\
          \"\",\n            'MONTHLY_CLUSTER_STRENGTH_RATIO': \"\"\"{{#env.MONTHLY_CLUSTER_STRENGTH_RATIO#}}\"\
          \"\",\n            'CLUSTER_STRENGTH_THRESHOLD_STRONG': \"\"\"{{#env.CLUSTER_STRENGTH_THRESHOLD_STRONG#}}\"\
          \"\",\n            'CLUSTER_STRENGTH_THRESHOLD_TREND': \"\"\"{{#env.CLUSTER_STRENGTH_THRESHOLD_TREND#}}\"\
          \"\",\n            'DEX_SAME_DIR_THRESHOLD_STRONG': \"\"\"{{#env.DEX_SAME_DIR_THRESHOLD_STRONG#}}\"\
          \"\",\n            'DEX_SAME_DIR_THRESHOLD_MEDIUM': \"\"\"{{#env.DEX_SAME_DIR_THRESHOLD_MEDIUM#}}\"\
          \"\",\n            'DEX_SAME_DIR_THRESHOLD_WEAK': \"\"\"{{#env.DEX_SAME_DIR_THRESHOLD_WEAK#}}\"\
          \"\",\n            'PW_DEBIT_VANNA_WEIGHT_HIGH': \"\"\"{{#env.PW_DEBIT_VANNA_WEIGHT_HIGH#}}\"\
          \"\",\n            'PW_DEBIT_VANNA_WEIGHT_MEDIUM': \"\"\"{{#env.PW_DEBIT_VANNA_WEIGHT_MEDIUM#}}\"\
          \"\",\n            'PW_DEBIT_VANNA_WEIGHT_LOW': \"\"\"{{#env.PW_DEBIT_VANNA_WEIGHT_LOW#}}\"\
          \"\",\n            'ENTRY_THRESHOLD_SCORE': \"\"\"{{#env.ENTRY_THRESHOLD_SCORE#}}\"\
          \"\",\n            'ENTRY_THRESHOLD_PROBABILITY': \"\"\"{{#env.ENTRY_THRESHOLD_PROBABILITY#}}\"\
          \"\",\n            'LIGHT_POSITION_PROBABILITY': \"\"\"{{#env.LIGHT_POSITION_PROBABILITY#}}\"\
          \"\"\n        }\n        \n        for key, default_value in defaults.items():\n\
          \            value = env_vars.get(key, default_value)\n            # è½¬æ¢ä¸º\
          \ float\n            try:\n                parsed[key] = float(value)\n\
          \            except (ValueError, TypeError):\n                parsed[key]\
          \ = default_value\n                \n        return parsed\n    \n    def\
          \ calculate_gamma_regime_score(self, gamma_metrics: Dict) -> Dict:\n   \
          \     \"\"\"\n        1. Gamma Regime åˆ¤å®šï¼ˆæƒé‡ 40%ï¼‰\n        \n        è¿™æ˜¯æœ€å…³é”®çš„å¸‚åœºçŠ¶æ€åˆ¤æ–­ï¼š\n\
          \        - above: æ­£Î³å€¾å‘ï¼Œåšå¸‚å•†å‹åˆ¶æ³¢åŠ¨\n        - below: è´ŸÎ³å€¾å‘ï¼Œåšå¸‚å•†æ”¾å¤§æ³¢åŠ¨\n        -\
          \ near: ä¸´ç•ŒçŠ¶æ€ï¼Œå¯èƒ½åè½¬\n        \n        Args:\n            gamma_metrics: Gamma\
          \ æŒ‡æ ‡æ•°æ®\n            \n        Returns:\n            è¯„åˆ†ç»“æœå­—å…¸\n        \"\"\
          \"\n        spot = gamma_metrics.get('spot_price', 0)\n        vol_trigger\
          \ = gamma_metrics.get('vol_trigger', 0)\n        spot_vs_trigger = gamma_metrics.get('spot_vs_trigger',\
          \ 'unknown')\n        \n        if spot_vs_trigger == \"above\":\n     \
          \       base_scenario = \"åŒºé—´\"\n            regime_note = f\"ç°ä»·{spot}åœ¨VOL_TRIGGER\
          \ {vol_trigger}ä¸Šæ–¹ï¼Œæ­£Î³å€¾å‘ï¼Œåšå¸‚å•†å‹åˆ¶æ³¢åŠ¨ç»´æŒåŒºé—´\"\n            score = 7\n          \
          \  rationale = \"æ˜ç¡®aboveçŠ¶æ€ç»™7åˆ†\"\n            \n        elif spot_vs_trigger\
          \ == \"below\":\n            base_scenario = \"è¶‹åŠ¿\"\n            regime_note\
          \ = f\"ç°ä»·{spot}åœ¨VOL_TRIGGER {vol_trigger}ä¸‹æ–¹ï¼Œè´ŸÎ³å€¾å‘ï¼Œåšå¸‚å•†æ”¾å¤§æ³¢åŠ¨è¶‹åŠ¿åŠ é€Ÿ\"\n       \
          \     score = 7\n            rationale = \"æ˜ç¡®belowçŠ¶æ€ç»™7åˆ†\"\n            \n\
          \        else:  # near æˆ–å…¶ä»–\n            base_scenario = \"è¿‡æ¸¡\"\n       \
          \     regime_note = f\"ç°ä»·{spot}æ¥è¿‘VOL_TRIGGER {vol_trigger}ï¼Œä¸´ç•ŒçŠ¶æ€ï¼Œå¯èƒ½Gammaç¿»è½¬é«˜æ³¢åŠ¨\"\
          \n            score = 4\n            rationale = \"ä¸´ç•ŒnearçŠ¶æ€ç»™4åˆ†ï¼Œè­¦ç¤ºé£é™©\"\n\
          \            \n        return {\n            \"score\": score,\n       \
          \     \"base_scenario\": base_scenario,\n            \"regime_note\": regime_note,\n\
          \            \"rationale\": rationale\n        }\n    \n    def calculate_break_wall_score(self,\
          \ gamma_metrics: Dict) -> Dict:\n        \"\"\"\n        2. ç ´å¢™å¯èƒ½æ€§è¯„ä¼°ï¼ˆæƒé‡ 30%ï¼‰\n\
          \        \n        è¯„ä¼°çªç ´ä¸»è¦å¢™ä½çš„éš¾åº¦ï¼š\n        - è€ƒè™‘è·ç¦»ã€ç°‡å¼ºåº¦ã€æœˆåº¦å åŠ \n        \n   \
          \     Args:\n            gamma_metrics: Gamma æŒ‡æ ‡æ•°æ®\n            \n     \
          \   Returns:\n            è¯„åˆ†ç»“æœå­—å…¸\n        \"\"\"\n        gap_distance =\
          \ gamma_metrics.get('gap_distance_em1_multiple', 999)\n        cluster_strength\
          \ = gamma_metrics.get('cluster_strength_ratio', 0)\n        monthly_override\
          \ = gamma_metrics.get('monthly_cluster_override', False)\n        spot_vs_trigger\
          \ = gamma_metrics.get('spot_vs_trigger', 'unknown')\n        \n        #\
          \ æ­¥éª¤1: åˆ¤æ–­é˜ˆå€¼\n        if monthly_override:\n            threshold = self.env['MONTHLY_OVERRIDE_THRESHOLD']\n\
          \            threshold_note = f\"æœˆåº¦ç°‡å¼ºåº¦â‰¥å‘¨åº¦{self.env['MONTHLY_CLUSTER_STRENGTH_RATIO']}å€\"\
          \n        else:\n            threshold = self.env['BREAK_WALL_THRESHOLD_HIGH']\n\
          \            threshold_note = f\"æ ‡å‡†é˜ˆå€¼{threshold}Ã—EM1$\"\n        \n    \
          \    # æ­¥éª¤2: è¯„ä¼°ç ´å¢™æ¦‚ç‡\n        if gap_distance < self.env['BREAK_WALL_THRESHOLD_LOW']:\n\
          \            break_probability = \"é«˜\"\n            base_score = 9\n   \
          \         prob_desc = \"è·ç¦»è¿‘\"\n        elif gap_distance < self.env['BREAK_WALL_THRESHOLD_HIGH']:\n\
          \            break_probability = \"ä¸­\"\n            base_score = 6\n   \
          \         prob_desc = \"è·ç¦»é€‚ä¸­\"\n        else:\n            break_probability\
          \ = \"ä½\"\n            base_score = 3\n            prob_desc = \"è·ç¦»è¿œ\"\n\
          \        \n        # æ­¥éª¤3: ç°‡å¼ºåº¦è°ƒæ•´\n        if cluster_strength >= self.env['CLUSTER_STRENGTH_THRESHOLD_STRONG']:\n\
          \            adjustment = -1\n            cluster_note = f\"ç°‡å¼ºåº¦{cluster_strength:.2f}â‰¥{self.env['CLUSTER_STRENGTH_THRESHOLD_STRONG']}ï¼Œä¸»å¢™æå¼º\"\
          \n            cluster_desc = \"æå¼ºé˜»åŠ›\"\n        elif cluster_strength >=\
          \ self.env['CLUSTER_STRENGTH_THRESHOLD_TREND']:\n            adjustment\
          \ = 0\n            cluster_note = f\"ç°‡å¼ºåº¦{cluster_strength:.2f}åœ¨{self.env['CLUSTER_STRENGTH_THRESHOLD_TREND']}-{self.env['CLUSTER_STRENGTH_THRESHOLD_STRONG']}ï¼Œä¸­ç­‰å¼ºåº¦\"\
          \n            cluster_desc = \"ä¸­ç­‰é˜»åŠ›\"\n        else:\n            adjustment\
          \ = 1\n            cluster_note = f\"ç°‡å¼ºåº¦{cluster_strength:.2f}<{self.env['CLUSTER_STRENGTH_THRESHOLD_TREND']}ï¼Œè¾ƒæ˜“çªç ´\"\
          \n            cluster_desc = \"è¾ƒå¼±é˜»åŠ›\"\n        \n        final_score = max(1,\
          \ min(10, base_score + adjustment))  # é™åˆ¶åœ¨ 1-10\n        \n        # ç¡®å®šå¢™ä½æ–¹å‘\n\
          \        wall_direction = \"Call Wall\" if spot_vs_trigger == 'above' else\
          \ \"Put Wall\"\n        \n        # ç»¼åˆè¯´æ˜\n        break_note = (\n     \
          \       f\"éœ€{gap_distance:.2f}å€EM1$è·ç¦»åˆ°è¾¾{wall_direction}ï¼Œ\"\n           \
          \ f\"{cluster_note}ï¼Œç ´å¢™éš¾åº¦\"\n            f\"{'é«˜' if final_score < 5 else\
          \ 'ä¸­' if final_score < 7 else 'ä½'}\"\n        )\n        \n        rationale\
          \ = (\n            f\"gap_distance {gap_distance:.2f}({prob_desc})ç»™{base_score}åˆ†ï¼Œ\"\
          \n            f\"cluster {cluster_strength:.2f}({cluster_desc})è°ƒæ•´{adjustment:+d}åˆ†\"\
          \n        )\n        \n        return {\n            \"score\": final_score,\n\
          \            \"break_probability\": break_probability,\n            \"threshold\"\
          : threshold,\n            \"threshold_note\": threshold_note,\n        \
          \    \"break_note\": break_note,\n            \"rationale\": rationale,\n\
          \            \"gap_distance_em1\": gap_distance,\n            \"cluster_strength\"\
          : cluster_strength,\n            \"monthly_override\": monthly_override\n\
          \        }\n    \n    def calculate_direction_score(self, directional_metrics:\
          \ Dict) -> Dict:\n        \"\"\"\n        3. æ–¹å‘ä¸€è‡´æ€§è¯„ä¼°ï¼ˆæƒé‡ 20%ï¼‰\n        \n\
          \        ç»¼åˆ DEX åŒå‘æ€§å’Œ Vanna æ–¹å‘ä¿¡å·\n        \n        Args:\n            directional_metrics:\
          \ æ–¹å‘æŒ‡æ ‡æ•°æ®\n            \n        Returns:\n            è¯„åˆ†ç»“æœå­—å…¸\n        \"\
          \"\"\n        dex_same_dir = directional_metrics.get('dex_same_dir_pct',\
          \ 0)\n        vanna_dir = directional_metrics.get('vanna_dir', 'neutral')\n\
          \        vanna_confidence = directional_metrics.get('vanna_confidence',\
          \ 'low')\n        \n        # è®¡ç®— vanna æƒé‡\n        vanna_weight_map = {\n\
          \            'high': self.env['PW_DEBIT_VANNA_WEIGHT_HIGH'],\n         \
          \   'medium': self.env['PW_DEBIT_VANNA_WEIGHT_MEDIUM'],\n            'low':\
          \ self.env['PW_DEBIT_VANNA_WEIGHT_LOW']\n        }\n        vanna_weight\
          \ = vanna_weight_map.get(vanna_confidence, 0.3)\n        \n        # åˆ¤æ–­æ–¹å‘å¼ºåº¦\n\
          \        has_strong_dex = dex_same_dir >= self.env['DEX_SAME_DIR_THRESHOLD_STRONG']\n\
          \        has_clear_vanna = vanna_dir in ['up', 'down']\n        has_medium_vanna\
          \ = vanna_weight >= self.env['PW_DEBIT_VANNA_WEIGHT_MEDIUM']\n        \n\
          \        if has_strong_dex and has_clear_vanna and has_medium_vanna:\n \
          \           direction_strength = \"å¼ºæ–¹å‘ä¿¡å·\"\n            score = 9\n    \
          \        strength_desc = \"DEXå¼º+Vannaé«˜ç½®ä¿¡\"\n            \n        elif dex_same_dir\
          \ >= self.env['DEX_SAME_DIR_THRESHOLD_MEDIUM'] or vanna_weight == self.env['PW_DEBIT_VANNA_WEIGHT_MEDIUM']:\n\
          \            direction_strength = \"ä¸­ç­‰æ–¹å‘ä¿¡å·\"\n            score = 6\n  \
          \          strength_desc = \"DEXä¸­ç­‰æˆ–Vannaä¸­ç­‰ç½®ä¿¡\"\n            \n        elif\
          \ dex_same_dir < self.env['DEX_SAME_DIR_THRESHOLD_WEAK'] or vanna_confidence\
          \ == 'low':\n            direction_strength = \"å¼±æ–¹å‘ä¿¡å·\"\n            score\
          \ = 3\n            strength_desc = \"DEXå¼±æˆ–Vannaä½ç½®ä¿¡\"\n        else:\n  \
          \          direction_strength = \"ä¸­ç­‰åå¼±ä¿¡å·\"\n            score = 5\n    \
          \        strength_desc = \"ä¿¡å·æ¨¡ç³Š\"\n        \n        # DEX è¯„ä»·\n        if\
          \ dex_same_dir >= self.env['DEX_SAME_DIR_THRESHOLD_STRONG']:\n         \
          \   dex_eval = \"å¼º\"\n        elif dex_same_dir >= self.env['DEX_SAME_DIR_THRESHOLD_MEDIUM']:\n\
          \            dex_eval = \"ä¸­ç­‰\"\n        else:\n            dex_eval = \"\
          å¼±\"\n        \n        direction_note = (\n            f\"DEXåŒå‘{dex_same_dir:.1f}%({dex_eval})ï¼Œ\"\
          \n            f\"Vannaæ–¹å‘{vanna_dir}ä¸”ç½®ä¿¡åº¦{vanna_confidence}æƒé‡{vanna_weight:.1f}ï¼Œ\"\
          \n            f\"ç»¼åˆ{direction_strength}\"\n        )\n        \n       \
          \ rationale = f\"dex {dex_same_dir:.1f}%+vanna {vanna_confidence}({strength_desc})ç»¼åˆç»™{score}åˆ†\"\
          \n        \n        return {\n            \"score\": score,\n          \
          \  \"direction_strength\": direction_strength,\n            \"vanna_weight\"\
          : vanna_weight,\n            \"direction_note\": direction_note,\n     \
          \       \"rationale\": rationale,\n            \"dex_same_dir\": dex_same_dir,\n\
          \            \"vanna_dir\": vanna_dir,\n            \"vanna_confidence\"\
          : vanna_confidence\n        }\n    \n    def calculate_iv_score(self, directional_metrics:\
          \ Dict) -> Dict:\n        \"\"\"\n        4. IV åŠ¨æ€è¯„ä¼°ï¼ˆæƒé‡ 10%ï¼‰\n        \n\
          \        è¯„ä¼°éšå«æ³¢åŠ¨ç‡çš„è·¯å¾„å’Œç½®ä¿¡åº¦\n        \n        Args:\n            directional_metrics:\
          \ æ–¹å‘æŒ‡æ ‡æ•°æ®\n            \n        Returns:\n            è¯„åˆ†ç»“æœå­—å…¸\n        \"\
          \"\"\n        iv_path = directional_metrics.get('iv_path', 'å¹³')\n      \
          \  iv_confidence = directional_metrics.get('iv_path_confidence', 'low')\n\
          \        \n        if iv_path == \"å‡\" and iv_confidence in ['high', 'medium']:\n\
          \            iv_signal = \"æ³¢åŠ¨ç‡æ‰©å¼ \"\n            note = \"åˆ©å¤šæ³¢åŠ¨ç‡ç­–ç•¥\"\n   \
          \         score = 8 if iv_confidence == 'high' else 6\n            conf_desc\
          \ = \"é«˜ç½®ä¿¡\" if iv_confidence == 'high' else \"ä¸­ç­‰ç½®ä¿¡\"\n            \n   \
          \     elif iv_path == \"é™\":\n            iv_signal = \"æ³¢åŠ¨ç‡å‹ç¼©\"\n      \
          \      note = \"åˆ©ç©ºæ³¢åŠ¨ç‡\"\n            if iv_confidence == 'high':\n     \
          \           score = 3\n                conf_desc = \"é«˜ç½®ä¿¡ä¸‹é™\"\n         \
          \   elif iv_confidence == 'medium':\n                score = 4\n       \
          \         conf_desc = \"ä¸­ç­‰ç½®ä¿¡ä¸‹é™\"\n            else:\n                score\
          \ = 5\n                conf_desc = \"ä½ç½®ä¿¡ä¸‹é™\"\n                \n       \
          \ else:  # \"å¹³\" æˆ– \"æ•°æ®ä¸è¶³\"\n            iv_signal = \"ä¸­æ€§\"\n          \
          \  note = \"æ³¢åŠ¨ç‡ç¨³å®šæˆ–æ•°æ®ä¸è¶³\"\n            score = 5\n            conf_desc =\
          \ \"å¹³ç¨³æˆ–ä¸ç¡®å®š\"\n        \n        iv_note = f\"IVè·¯å¾„æ˜¾ç¤º{iv_path}è¶‹åŠ¿ï¼Œç½®ä¿¡åº¦{iv_confidence}ï¼Œ{note}\"\
          \n        rationale = f\"iv_path {iv_path}ä¸”confidence {iv_confidence}({conf_desc})ç»™{score}åˆ†\"\
          \n        \n        return {\n            \"score\": score,\n          \
          \  \"iv_signal\": iv_signal,\n            \"iv_note\": iv_note,\n      \
          \      \"rationale\": rationale,\n            \"iv_path\": iv_path,\n  \
          \          \"iv_path_confidence\": iv_confidence\n        }\n    \n    def\
          \ calculate_total_score(self, scores: Dict) -> Dict:\n        \"\"\"\n \
          \       ç»¼åˆè¯„åˆ†è®¡ç®—\n        \n        å››ç»´åŠ æƒæ±‚å’Œ\n        \n        Args:\n    \
          \        scores: å„ç»´åº¦è¯„åˆ†å­—å…¸\n            \n        Returns:\n            æ€»åˆ†å’Œæƒé‡åˆ†è§£\n\
          \        \"\"\"\n        gamma_score = scores['gamma']['score']\n      \
          \  break_score = scores['break_wall']['score']\n        direction_score\
          \ = scores['direction']['score']\n        iv_score = scores['iv']['score']\n\
          \        \n        w = self.env\n        \n        # åŠ æƒè®¡ç®—\n        total\
          \ = (\n            gamma_score * w['SCORE_WEIGHT_GAMMA_REGIME'] +\n    \
          \        break_score * w['SCORE_WEIGHT_BREAK_WALL'] +\n            direction_score\
          \ * w['SCORE_WEIGHT_DIRECTION'] +\n            iv_score * w['SCORE_WEIGHT_IV']\n\
          \        )\n        \n        # è¯¦ç»†åˆ†è§£\n        breakdown = (\n          \
          \  f\"{gamma_score}Ã—{w['SCORE_WEIGHT_GAMMA_REGIME']:.1f}+\"\n          \
          \  f\"{break_score}Ã—{w['SCORE_WEIGHT_BREAK_WALL']:.1f}+\"\n            f\"\
          {direction_score}Ã—{w['SCORE_WEIGHT_DIRECTION']:.1f}+\"\n            f\"\
          {iv_score}Ã—{w['SCORE_WEIGHT_IV']:.1f}=\"\n            f\"{gamma_score *\
          \ w['SCORE_WEIGHT_GAMMA_REGIME']:.1f}+\"\n            f\"{break_score *\
          \ w['SCORE_WEIGHT_BREAK_WALL']:.1f}+\"\n            f\"{direction_score\
          \ * w['SCORE_WEIGHT_DIRECTION']:.1f}+\"\n            f\"{iv_score * w['SCORE_WEIGHT_IV']:.1f}=\"\
          \n            f\"{total:.1f}\"\n        )\n        \n        return {\n\
          \            \"total_score\": round(total, 1),\n            \"weight_breakdown\"\
          : breakdown\n        }\n    \n    def check_entry_conditions(self, target_data:\
          \ Dict, total_score: float) -> Dict:\n        \"\"\"\n        å…¥åœºé—¨æ§›æ£€æŸ¥\n \
          \       \n        æ£€æŸ¥ 4 ä¸ªå…³é”®æ¡ä»¶ï¼š\n        1. spot_vs_trigger æ˜ç¡®\n        2.\
          \ gap_distance é€‚ä¸­\n        3. DEX åŒå‘æ€§\n        4. Vanna ç½®ä¿¡åº¦\n        \n\
          \        Args:\n            target_data: æ ‡çš„å®Œæ•´æ•°æ®\n            total_score:\
          \ æ€»è¯„åˆ†\n            \n        Returns:\n            å…¥åœºåˆ¤å®šç»“æœ\n        \"\"\"\
          \n        gamma = target_data.get('gamma_metrics', {})\n        directional\
          \ = target_data.get('directional_metrics', {})\n        \n        conditions_met\
          \ = []\n        conditions_failed = []\n        \n        # æ¡ä»¶1: spot_vs_trigger\
          \ æ˜ç¡®\n        spot_vs_trigger = gamma.get('spot_vs_trigger', 'unknown')\n\
          \        if spot_vs_trigger in ['above', 'below']:\n            conditions_met.append(f\"\
          æ¡ä»¶1: spot_vs_trigger={spot_vs_trigger}æ˜ç¡®\")\n        else:\n           \
          \ conditions_failed.append(f\"æ¡ä»¶1: spot_vs_trigger={spot_vs_trigger}ä¸´ç•ŒçŠ¶æ€\"\
          )\n        \n        # æ¡ä»¶2: gap_distance é€‚ä¸­\n        gap = gamma.get('gap_distance_em1_multiple',\
          \ 999)\n        if gap < 2:\n            conditions_met.append(f\"æ¡ä»¶2: gap_distance_em1={gap:.2f}<2\"\
          )\n        else:\n            conditions_failed.append(f\"æ¡ä»¶2: gap_distance_em1={gap:.2f}â‰¥2åå¤§\"\
          )\n        \n        # æ¡ä»¶3: DEX åŒå‘æ€§\n        dex = directional.get('dex_same_dir_pct',\
          \ 0)\n        if dex >= self.env['DEX_SAME_DIR_THRESHOLD_MEDIUM']:\n   \
          \         conditions_met.append(f\"æ¡ä»¶3: dex_same_dir={dex:.1f}â‰¥{self.env['DEX_SAME_DIR_THRESHOLD_MEDIUM']:.0f}%\"\
          )\n        else:\n            conditions_failed.append(f\"æ¡ä»¶3: dex_same_dir={dex:.1f}<{self.env['DEX_SAME_DIR_THRESHOLD_MEDIUM']:.0f}%\"\
          )\n        \n        # æ¡ä»¶4: Vanna ç½®ä¿¡åº¦\n        vanna_conf = directional.get('vanna_confidence',\
          \ 'low')\n        if vanna_conf in ['high', 'medium']:\n            conditions_met.append(f\"\
          æ¡ä»¶4: vanna_confidence={vanna_conf}\")\n        else:\n            conditions_failed.append(f\"\
          æ¡ä»¶4: vanna_confidence={vanna_conf}ä½ç½®ä¿¡\")\n        \n        # åˆ¤å®šé€»è¾‘\n   \
          \     met_count = len(conditions_met)\n        total_conditions = 4\n  \
          \      \n        # å…¥åœºåˆ¤å®š\n        if total_score >= self.env['ENTRY_THRESHOLD_SCORE']\
          \ and met_count >= 3:\n            entry_check = \"å…¥åœº\"\n            rationale_parts\
          \ = [\n                f\"æ€»åˆ†{total_score:.1f}â‰¥{self.env['ENTRY_THRESHOLD_SCORE']:.1f}æ»¡è¶³\"\
          ,\n                f\"å…³é”®ä¿¡å·ï¼š{met_count}/{total_conditions}ä¸ªæ¡ä»¶æ»¡è¶³\"\n     \
          \       ]\n            \n        elif total_score >= self.env['ENTRY_THRESHOLD_SCORE']\
          \ and met_count >= 2:\n            entry_check = \"è½»ä»“è¯•æ¢\"\n            rationale_parts\
          \ = [\n                f\"æ€»åˆ†{total_score:.1f}â‰¥{self.env['ENTRY_THRESHOLD_SCORE']:.1f}æ»¡è¶³\"\
          ,\n                f\"ä½†å…³é”®ä¿¡å·ä»…{met_count}/{total_conditions}ä¸ªæ¡ä»¶æ»¡è¶³\",\n   \
          \             \"å»ºè®®è½»ä»“è¯•æ¢\"\n            ]\n            \n        else:\n \
          \           entry_check = \"è§‚æœ›\"\n            rationale_parts = [\n    \
          \            f\"æ€»åˆ†{total_score:.1f}æˆ–æ¡ä»¶ä¸è¶³ï¼ˆ{met_count}/{total_conditions}ï¼‰\"\
          ,\n                \"å»ºè®®è§‚æœ›\"\n            ]\n        \n        # ç»„è£… rationale\n\
          \        rationale = \"ã€‚\".join(rationale_parts) + \"ã€‚\"\n        rationale\
          \ += f\"\\næ»¡è¶³ï¼š{', '.join(conditions_met) if conditions_met else 'æ— '}\"\n\
          \        rationale += f\"\\nä¸æ»¡è¶³ï¼š{', '.join(conditions_failed) if conditions_failed\
          \ else 'æ— '}\"\n        \n        return {\n            \"entry_threshold_check\"\
          : entry_check,\n            \"entry_rationale\": rationale,\n          \
          \  \"conditions_met_count\": met_count,\n            \"conditions_total\"\
          : total_conditions,\n            \"conditions_met\": conditions_met,\n \
          \           \"conditions_failed\": conditions_failed\n        }\n    \n\
          \    def generate_risk_warnings(self, target_data: Dict, scores: Dict) ->\
          \ str:\n        \"\"\"\n        ç”Ÿæˆé£é™©è­¦ç¤º\n        \n        Args:\n      \
          \      target_data: æ ‡çš„å®Œæ•´æ•°æ®\n            scores: å„ç»´åº¦è¯„åˆ†\n            \n  \
          \      Returns:\n            é£é™©è­¦ç¤ºå­—ç¬¦ä¸²\n        \"\"\"\n        warnings =\
          \ []\n        \n        gamma = target_data.get('gamma_metrics', {})\n \
          \       directional = target_data.get('directional_metrics', {})\n     \
          \   \n        gap_distance = gamma.get('gap_distance_em1_multiple', 0)\n\
          \        spot_vs_trigger = gamma.get('spot_vs_trigger', 'unknown')\n   \
          \     cluster_strength = gamma.get('cluster_strength_ratio', 0)\n      \
          \  vanna_dir = directional.get('vanna_dir', 'neutral')\n        iv_path\
          \ = directional.get('iv_path', 'å¹³')\n        \n        # è­¦ç¤º1: gap_distance\
          \ åå¤§\n        if gap_distance > 2:\n            wall_type = \"Call Wall\"\
          \ if spot_vs_trigger == 'above' else \"Put Wall\"\n            warnings.append(\n\
          \                f\"gap_distanceåå¤§éœ€{gap_distance:.2f}å€EM1$æ‰èƒ½åˆ°{wall_type}ï¼Œ\"\
          \n                f\"è‹¥çŸ­æœŸå†…æœªçªç ´éœ€è°ƒæ•´ä¸ºåŒºé—´ç­–ç•¥\"\n            )\n        \n      \
          \  # è­¦ç¤º2: ä¸´ç•ŒçŠ¶æ€\n        if spot_vs_trigger == \"near\":\n            warnings.append(\n\
          \                \"ç°ä»·æ¥è¿‘Gammaç¿»è½¬çº¿ï¼Œregimeå¯èƒ½åè½¬ï¼Œé«˜æ³¢åŠ¨é£é™©\"\n            )\n    \
          \    \n        # è­¦ç¤º3: Vanna ä¸ IV å†²çª\n        vanna_up = vanna_dir == 'up'\n\
          \        vanna_down = vanna_dir == 'down'\n        iv_up = iv_path == 'å‡'\n\
          \        iv_down = iv_path == 'é™'\n        \n        if (vanna_up and iv_down)\
          \ or (vanna_down and iv_up):\n            warnings.append(\n           \
          \     f\"Vannaæ–¹å‘{vanna_dir}ä¸IVè·¯å¾„{iv_path}å†²çªï¼Œä¿¡å·ä¸ä¸€è‡´ï¼Œå¢åŠ ä¸ç¡®å®šæ€§\"\n           \
          \ )\n        \n        # è­¦ç¤º4: ç°‡å¼ºåº¦æå¼º\n        if cluster_strength >= self.env['CLUSTER_STRENGTH_THRESHOLD_STRONG']:\n\
          \            warnings.append(\n                f\"ç°‡å¼ºåº¦{cluster_strength:.2f}â‰¥{self.env['CLUSTER_STRENGTH_THRESHOLD_STRONG']:.1f}ï¼Œ\"\
          \n                f\"ä¸»å¢™æå¼ºï¼Œç ´å¢™éš¾åº¦é«˜\"\n            )\n        \n        # è­¦ç¤º5:\
          \ ç°‡å¼ºåº¦æ¥è¿‘æå¼ºé˜ˆå€¼\n        elif cluster_strength >= self.env['CLUSTER_STRENGTH_THRESHOLD_STRONG']\
          \ - 0.2:\n            warnings.append(\n                f\"ç°‡å¼ºåº¦{cluster_strength:.2f}æ¥è¿‘{self.env['CLUSTER_STRENGTH_THRESHOLD_STRONG']:.1f}ï¼Œ\"\
          \n                f\"æ³¨æ„ä¸»å¢™é˜»åŠ›\"\n            )\n        \n        return \"\
          ; \".join(warnings) if warnings else \"é£é™©å¯æ§\"\n    \n    def process(self,\
          \ agent3_data: Dict) -> Dict:\n        \"\"\"\n        ä¸»å¤„ç†æµç¨‹\n        \n\
          \        Args:\n            agent3_data: Agent 3 çš„æ•°æ®æ ¡éªŒç»“æœ\n            \n\
          \        Returns:\n            å®Œæ•´çš„è¯„åˆ†ç»“æœ JSON\n        \"\"\"\n        # æå–ç›®æ ‡æ•°æ®ï¼ˆå‡è®¾å•æ ‡çš„ï¼‰\n\
          \        targets = agent3_data.get('targets', [])\n        if not targets:\n\
          \            raise ValueError(\"Agent 3 æ•°æ®ä¸­æœªæ‰¾åˆ° targets å­—æ®µ\")\n        \n\
          \        target = targets[0]\n        \n        # å››ç»´è¯„åˆ†\n        gamma_result\
          \ = self.calculate_gamma_regime_score(\n            target.get('gamma_metrics',\
          \ {})\n        )\n        \n        break_wall_result = self.calculate_break_wall_score(\n\
          \            target.get('gamma_metrics', {})\n        )\n        \n    \
          \    direction_result = self.calculate_direction_score(\n            target.get('directional_metrics',\
          \ {})\n        )\n        \n        iv_result = self.calculate_iv_score(\n\
          \            target.get('directional_metrics', {})\n        )\n        \n\
          \        # æ±‡æ€»è¯„åˆ†\n        scores = {\n            'gamma': gamma_result,\n\
          \            'break_wall': break_wall_result,\n            'direction':\
          \ direction_result,\n            'iv': iv_result\n        }\n        \n\
          \        # æ€»åˆ†è®¡ç®—\n        total_result = self.calculate_total_score(scores)\n\
          \        \n        # å…¥åœºæ£€æŸ¥\n        entry_result = self.check_entry_conditions(target,\
          \ total_result['total_score'])\n        \n        # é£é™©è­¦ç¤º\n        risk_warning\
          \ = self.generate_risk_warnings(target, scores)\n        \n        # æå–å…³é”®ä½\n\
          \        walls = target.get('walls', {})\n        gamma_metrics = target.get('gamma_metrics',\
          \ {})\n        \n        # ç»„è£…æœ€ç»ˆè¾“å‡º\n        result = {\n            \"gamma_regime\"\
          : {\n                \"vol_trigger\": gamma_metrics.get('vol_trigger'),\n\
          \                \"spot_vs_trigger\": gamma_metrics.get('spot_vs_trigger'),\n\
          \                \"base_scenario\": gamma_result['base_scenario'],\n   \
          \             \"regime_note\": gamma_result['regime_note']\n           \
          \ },\n            \"break_wall_assessment\": {\n                \"gap_distance_em1\"\
          : break_wall_result['gap_distance_em1'],\n                \"cluster_strength\"\
          : break_wall_result['cluster_strength'],\n                \"monthly_override\"\
          : break_wall_result['monthly_override'],\n                \"threshold\"\
          : break_wall_result['threshold'],\n                \"threshold_note\": break_wall_result['threshold_note'],\n\
          \                \"break_probability\": break_wall_result['break_probability'],\n\
          \                \"break_note\": break_wall_result['break_note']\n     \
          \       },\n            \"directional_signals\": {\n                \"dex_same_dir\"\
          : direction_result['dex_same_dir'],\n                \"vanna_dir\": direction_result['vanna_dir'],\n\
          \                \"vanna_confidence\": direction_result['vanna_confidence'],\n\
          \                \"vanna_weight\": direction_result['vanna_weight'],\n \
          \               \"direction_strength\": direction_result['direction_strength'],\n\
          \                \"direction_note\": direction_result['direction_note']\n\
          \            },\n            \"iv_dynamics\": {\n                \"iv_path\"\
          : iv_result['iv_path'],\n                \"iv_path_confidence\": iv_result['iv_path_confidence'],\n\
          \                \"iv_signal\": iv_result['iv_signal'],\n              \
          \  \"iv_note\": iv_result['iv_note']\n            },\n            \"scoring\"\
          : {\n                \"gamma_regime_score\": gamma_result['score'],\n  \
          \              \"gamma_regime_rationale\": gamma_result['rationale'],\n\
          \                \"break_wall_score\": break_wall_result['score'],\n   \
          \             \"break_wall_rationale\": break_wall_result['rationale'],\n\
          \                \"direction_score\": direction_result['score'],\n     \
          \           \"direction_rationale\": direction_result['rationale'],\n  \
          \              \"iv_score\": iv_result['score'],\n                \"iv_score_rationale\"\
          : iv_result['rationale'],\n                \"total_score\": total_result['total_score'],\n\
          \                \"weight_breakdown\": total_result['weight_breakdown']\n\
          \            },\n            \"entry_threshold_check\": entry_result['entry_threshold_check'],\n\
          \            \"entry_rationale\": entry_result['entry_rationale'],\n   \
          \         \"key_levels\": {\n                \"support\": walls.get('put_wall'),\n\
          \                \"resistance\": walls.get('call_wall'),\n             \
          \   \"trigger_line\": gamma_metrics.get('vol_trigger'),\n              \
          \  \"current_spot\": target.get('spot_price')\n            },\n        \
          \    \"risk_warning\": risk_warning\n        }\n        \n        return\
          \ result\n"
        code_language: python3
        desc: é‡åŒ–è®¡ç®—ï¼šæ‰§è¡Œå››ç»´è¯„åˆ†å’Œå…¥åœºæ¡ä»¶åˆ¤æ–­ --1007
        outputs:
          result:
            children: null
            type: object
        selected: true
        title: CODE2 è¯„åˆ†è®¡ç®—å¼•æ“
        type: code
        variables:
        - value_selector:
          - '3001'
          - text
          value_type: string
          variable: agent3_output
        - value_selector:
          - '3001'
          - structured_output
          - technical_analysis
          - ta_score
          value_type: object
          variable: technical_score
      height: 96
      id: '1007'
      position:
        x: 2057.53475768152
        y: 112.48397693418775
      positionAbsolute:
        x: 2057.53475768152
        y: 112.48397693418775
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: å¯¹æ¯”ä¸‰ç§ç­–ç•¥ï¼Œç»™å‡ºæ¨èæ’åº 1005
        model:
          completion_params:
            json_schema: "{\n  \"properties\": {\n    \"comparison_summary\": {\n\
              \      \"properties\": {\n        \"analysis_timestamp\": {\n      \
              \    \"type\": \"string\"\n        },\n        \"positive_ev_count\"\
              : {\n          \"type\": \"integer\"\n        },\n        \"recommended_count\"\
              : {\n          \"type\": \"integer\"\n        },\n        \"total_strategies\"\
              : {\n          \"type\": \"integer\"\n        }\n      },\n      \"\
              type\": \"object\"\n    },\n    \"execution_priority\": {\n      \"\
              properties\": {\n        \"avoid\": {\n          \"properties\": {\n\
              \            \"reason\": {\n              \"type\": \"string\"\n   \
              \         },\n            \"strategy_type\": {\n              \"type\"\
              : \"string\"\n            }\n          },\n          \"type\": \"object\"\
              \n        },\n        \"primary\": {\n          \"properties\": {\n\
              \            \"allocation\": {\n              \"type\": \"string\"\n\
              \            },\n            \"rationale\": {\n              \"type\"\
              : \"string\"\n            },\n            \"strategy_type\": {\n   \
              \           \"type\": \"string\"\n            }\n          },\n    \
              \      \"type\": \"object\"\n        },\n        \"secondary\": {\n\
              \          \"properties\": {\n            \"allocation\": {\n      \
              \        \"type\": \"string\"\n            },\n            \"rationale\"\
              : {\n              \"type\": \"string\"\n            },\n          \
              \  \"strategy_type\": {\n              \"type\": \"string\"\n      \
              \      }\n          },\n          \"type\": \"object\"\n        }\n\
              \      },\n      \"type\": \"object\"\n    },\n    \"final_recommendation\"\
              : {\n      \"type\": \"string\"\n    },\n    \"ranking\": {\n      \"\
              items\": {\n        \"properties\": {\n          \"assessment\": {\n\
              \            \"properties\": {\n              \"composite_score\": {\n\
              \                \"type\": \"integer\"\n              },\n         \
              \     \"liquidity_note\": {\n                \"type\": \"string\"\n\
              \              },\n              \"liquidity_pass\": {\n           \
              \     \"type\": \"boolean\"\n              },\n              \"match_reason\"\
              : {\n                \"type\": \"string\"\n              },\n      \
              \        \"scenario_match\": {\n                \"type\": \"string\"\
              \n              }\n            },\n            \"type\": \"object\"\n\
              \          },\n          \"metrics\": {\n            \"properties\"\
              : {\n              \"ev\": {\n                \"type\": \"number\"\n\
              \              },\n              \"max_loss\": {\n                \"\
              type\": \"number\"\n              },\n              \"max_profit\":\
              \ {\n                \"type\": \"number\"\n              },\n      \
              \        \"pw\": {\n                \"type\": \"number\"\n         \
              \     },\n              \"rar\": {\n                \"type\": \"number\"\
              \n              },\n              \"rr_ratio\": {\n                \"\
              type\": \"string\"\n              }\n            },\n            \"\
              type\": \"object\"\n          },\n          \"note\": {\n          \
              \  \"type\": \"string\"\n          },\n          \"rank\": {\n     \
              \       \"type\": \"integer\"\n          },\n          \"recommendation\"\
              : {\n            \"type\": \"string\"\n          },\n          \"strategy_type\"\
              : {\n            \"type\": \"string\"\n          },\n          \"structure\"\
              : {\n            \"type\": \"string\"\n          }\n        },\n   \
              \     \"type\": \"object\"\n      },\n      \"type\": \"array\"\n  \
              \  },\n    \"symbol\": {\n      \"type\": \"string\"\n    }\n  },\n\
              \  \"required\": [\n    \"symbol\",\n    \"comparison_summary\",\n \
              \   \"ranking\",\n    \"final_recommendation\",\n    \"execution_priority\"\
              \n  ],\n  \"type\": \"object\"\n}"
            response_format: json_schema
            temperature: 0.5
          mode: chat
          name: deepseek-v3.2-exp-thinking
          provider: langgenius/openai_api_compatible/openai_api_compatible
        prompt_template:
        - id: 62397f3f-2606-4bb8-b151-b0100ed177c1
          role: system
          text: "ä½ æ˜¯ç­–ç•¥å¯¹æ¯” Agentã€‚\n\nã€ä»»åŠ¡ã€‘åŸºäºæœŸæœ›å€¼ã€é£é™©è°ƒæ•´æ”¶ç›Šã€å‰§æœ¬åŒ¹é…åº¦ã€æµåŠ¨æ€§ç­‰ç»´åº¦ï¼Œç»™å‡ºç­–ç•¥æ¨èæ’åºã€‚\n\nã€è¾“å…¥æ•°æ®ã€‘\n\
            **é‡åŒ–è®¡ç®—ç»“æœ**(æ¥è‡ª CODE4):\n{{#1008.result#}}\n**å‰§æœ¬åˆ†æ**(æ¥è‡ª Agent5):\n{{#5001.structured_output#}}\n\
            **åŸå§‹ç­–ç•¥**(æ¥è‡ª Agent6,ç”¨äºå¼•ç”¨è¯¦ç»†ä¿¡æ¯):\n{{#6001.structured_output#}}\n\n**é¦–é€‰ç­–ç•¥\
            \ (Top1)**:\n- æ’å: {{#1008.result.top1_rank#}}\n- ç±»å‹: {{#1008.result.top1_strategy_type#}}\n\
            - ç»“æ„: {{#1008.result.top1_structure#}}\n- æœŸæœ›å€¼: {{#1008.result.top1_ev#}}\n\
            - é£é™©è°ƒæ•´æ”¶ç›Š: {{#1008.result.top1_rar#}}\n- èƒœç‡: {{#1008.result.top1_pw#}}\n\
            - å‰§æœ¬åŒ¹é…åº¦: {{#1008.result.top1_scenario_match#}}\n- åŒ¹é…ç†ç”±: {{#1008.result.top1_match_reason#}}\n\
            - æµåŠ¨æ€§é€šè¿‡: {{#1008.result.top1_liquidity_pass#}}\n- æµåŠ¨æ€§è¯´æ˜: {{#1008.result.top1_liquidity_note#}}\n\
            - ç»¼åˆè¯„åˆ†: {{#1008.result.top1_composite_score#}}\n\n**æ¬¡é€‰ç­–ç•¥ (Top2)**:\n-\
            \ ç±»å‹: {{#1008.result.top2_strategy_type#}}\n- æœŸæœ›å€¼: {{#1008.result.top2_ev#}}\n\
            - ç»¼åˆè¯„åˆ†: {{#1008.result.top2_composite_score#}}\n\n**ç¬¬ä¸‰é€‰æ‹© (Top3)**:\n-\
            \ ç±»å‹: {{#1008.result.top3_strategy_type#}}\n- æœŸæœ›å€¼: {{#1008.result.top3_ev#}}\n\
            \n## æ ¸å¿ƒèŒè´£\n### 1. ç»¼åˆæ¨èåˆ¤æ–­\nåŸºäº CODE4 çš„æ’åºç»“æœ,ç”Ÿæˆæ¨è:\n\n```\nif top1_ev <= 0:\n\
            \    â†’ \"ä¸æ¨è: æœŸæœ›å€¼ä¸ºè´Ÿ\"\n\nelif top1_liquidity_pass == false:\n    â†’ \"\
            è°¨æ…: å­˜åœ¨æµåŠ¨æ€§é—®é¢˜\"\n\nelif top1_scenario_match == \"ä½\":\n    â†’ \"è§‚æœ›: å‰§æœ¬åŒ¹é…åº¦ä½\"\
            \n\nelif top1_composite_score >= 80:\n    â†’ \"å¼ºçƒˆæ¨è: ç»¼åˆè¯„åˆ†ä¼˜ç§€\"\n```\n\n\
            ### 2. æ¨èç†ç”±ç”Ÿæˆ\nå°†é‡åŒ–æ•°æ®è½¬åŒ–ä¸ºäººç±»è¯­è¨€:\n\n```\nç¤ºä¾‹:\n\"æ¨èæ‰§è¡Œã€{{#1008.result.top1_strategy_type#}}\
            \ - {{#1008.result.top1_structure#}}ã€‘,\næœŸæœ›å€¼ {{#1008.result.top1_ev#}}\
            \ ç¾å…ƒä¸ºæ­£å‘,\né£é™©è°ƒæ•´æ”¶ç›Š {{#1008.result.top1_rar#}} ä¼˜ç§€,\n{{#1008.result.top1_match_reason#}},\n\
            ç»¼åˆè¯„åˆ† {{#1008.result.top1_composite_score#}} åˆ†,\nå¼ºçƒˆæ¨èæ‰§è¡Œã€‚\"\n```\n\n###\
            \ 3. æ¬¡é€‰ç­–ç•¥å»ºè®®\n**æ•°æ®æ¥æº**: å¿…é¡»ä» {{#1008.result.ranking_json#}} è§£æå®Œæ•´æ•°ç»„\n```\n\
            # è§£æ ranking_json å­—ç¬¦ä¸²å¾—åˆ°å®Œæ•´æ’åºæ•°ç»„\nranking = JSON.parse({{#1008.result.ranking_json#}})\n\
            \n# è·å–ç¬¬2åç­–ç•¥ï¼ˆrank=2ï¼‰\nsecond_strategy = ranking.find(s => s.rank === 2)\n\
            \n# åˆ¤æ–­æ¡ä»¶\nif second_strategy.metrics.ev > 0 AND second_strategy.assessment.composite_score\
            \ >= 60:\n    â†’ æä¾›æ¬¡é€‰æ–¹æ¡ˆ (execution_priority.secondary):\n      - strategy_type:\
            \ second_strategy.strategy_type + \" - \" + second_strategy.structure\n\
            \      - allocation: \"20-30%é…ç½®\"\n      - rationale: ç®€è¿°æœŸæœ›å€¼ã€è¯„åˆ†åŠé€‚ç”¨åœºæ™¯\n\
            else:\n    â†’ ä¸è¾“å‡º secondary å­—æ®µï¼ˆæˆ–è®¾ä¸º nullï¼‰\n```\n**æ³¨æ„**: \n  - ä¸èƒ½ä½¿ç”¨ {{#1008.result.top2_ev#}}\
            \ ç­‰æ‰å¹³å­—æ®µï¼Œè¿™äº›ä»…ä¸ºæ˜¾ç¤ºç”¨\n  - å¿…é¡»è§£æ ranking_json è·å–ç¬¬2åçš„å®Œæ•´ metrics å’Œ assessment å¯¹è±¡\n\
            \  - æ¡ä»¶åˆ¤æ–­åŸºäº ranking[1] (å³rank=2çš„ç­–ç•¥ï¼Œå› ä¸ºæ•°ç»„ç´¢å¼•ä»0å¼€å§‹)\n\n### 4. æ‰§è¡Œä¼˜å…ˆçº§\nè¾“å‡ºæ¸…æ™°çš„è¡ŒåŠ¨æŒ‡å—,åŒ…å«:\n\
            - **primary**: é¦–é€‰ç­–ç•¥ + é…ç½®æ¯”ä¾‹ + ç†ç”±\n- **secondary**: æ¬¡é€‰ç­–ç•¥ + é…ç½®æ¯”ä¾‹ + ç†ç”±\n-\
            \ **avoid**: é¿å…ç­–ç•¥ + åŸå› \n---\n\n## å…³é”®åŸåˆ™\n\n1. **æ•°æ®é©±åŠ¨**: æ‰€æœ‰æ¨èéƒ½åŸºäº CODE4 çš„è®¡ç®—ç»“æœ\n\
            2. **ç®€æ´æ˜äº†**: é¿å…é‡å¤ CODE4 å·²è®¡ç®—çš„æ•°å€¼,åªéœ€è§£è¯»\n3. **è¡ŒåŠ¨å¯¼å‘**: ç»™å‡ºæ˜ç¡®çš„æ‰§è¡Œå»ºè®®\n4. **é£é™©é€æ˜**:\
            \ æ¸…æ™°è¯´æ˜æ¯ä¸ªç­–ç•¥çš„é£é™©ç‚¹\n5. **ç¦æ­¢é‡æ–°è®¡ç®—**: ä¸è¦å°è¯•éªŒè¯æˆ–ä¿®æ”¹ CODE4 çš„æ•°å€¼\n\n\nç°åœ¨è¯·åŸºäºè¾“å…¥æ•°æ®è¿›è¡Œç­–ç•¥å¯¹æ¯”å’Œæ’åºã€‚"
        - id: d6ff96ac-f577-4cdf-ac82-a19f6ce22151
          role: user
          text: "ã€å®Œæ•´æ’åºæ•°æ®ã€‘\n  {{#1008.result.ranking_json#}}\n\n  ã€Top1 ç­–ç•¥æ‘˜è¦ã€‘\n  -\
            \ æ’å: {{#1008.result.top1_rank#}}\n  - ç±»å‹: {{#1008.result.top1_strategy_type#}}\n\
            \  - ç»“æ„: {{#1008.result.top1_structure#}}\n  - æœŸæœ›å€¼: {{#1008.result.top1_ev#}}\n\
            \  - é£é™©è°ƒæ•´æ”¶ç›Š: {{#1008.result.top1_rar#}}\n  - èƒœç‡: {{#1008.result.top1_pw#}}\n\
            \  - å‰§æœ¬åŒ¹é…åº¦: {{#1008.result.top1_scenario_match#}}\n  - åŒ¹é…ç†ç”±: {{#1008.result.top1_match_reason#}}\n\
            \  - æµåŠ¨æ€§é€šè¿‡: {{#1008.result.top1_liquidity_pass#}}\n  - æµåŠ¨æ€§è¯´æ˜: {{#1008.result.top1_liquidity_note#}}\n\
            \  - ç»¼åˆè¯„åˆ†: {{#1008.result.top1_composite_score#}}\n\n  ã€Top2 ç­–ç•¥æ‘˜è¦ã€‘\n \
            \ - ç±»å‹: {{#1008.result.top2_strategy_type#}}\n  - æœŸæœ›å€¼: {{#1008.result.top2_ev#}}\n\
            \  - ç»¼åˆè¯„åˆ†: {{#1008.result.top2_composite_score#}}\n\nè¯·ä¸¥æ ¼æŒ‰ç…§ JSON Schema\
            \ è¾“å‡ºç­–ç•¥æ¨èæ’åºã€‚"
        selected: false
        structured_output:
          schema:
            properties:
              comparison_summary:
                properties:
                  analysis_timestamp:
                    type: string
                  positive_ev_count:
                    type: integer
                  recommended_count:
                    type: integer
                  total_strategies:
                    type: integer
                type: object
              execution_priority:
                properties:
                  avoid:
                    properties:
                      reason:
                        type: string
                      strategy_type:
                        type: string
                    type: object
                  primary:
                    properties:
                      allocation:
                        type: string
                      rationale:
                        type: string
                      strategy_type:
                        type: string
                    type: object
                  secondary:
                    properties:
                      allocation:
                        type: string
                      rationale:
                        type: string
                      strategy_type:
                        type: string
                    type: object
                type: object
              final_recommendation:
                type: string
              ranking:
                items:
                  properties:
                    assessment:
                      properties:
                        composite_score:
                          type: integer
                        liquidity_note:
                          type: string
                        liquidity_pass:
                          type: boolean
                        match_reason:
                          type: string
                        scenario_match:
                          type: string
                      type: object
                    metrics:
                      properties:
                        ev:
                          type: number
                        max_loss:
                          type: number
                        max_profit:
                          type: number
                        pw:
                          type: number
                        rar:
                          type: number
                        rr_ratio:
                          type: string
                      type: object
                    note:
                      type: string
                    rank:
                      type: integer
                    recommendation:
                      type: string
                    strategy_type:
                      type: string
                    structure:
                      type: string
                  type: object
                type: array
              symbol:
                type: string
            required:
            - symbol
            - comparison_summary
            - ranking
            - final_recommendation
            - execution_priority
            type: object
        structured_output_enabled: true
        title: AGENT 7 ç­–ç•¥å¯¹æ¯”
        type: llm
        vision:
          enabled: false
      height: 116
      id: '1005'
      position:
        x: 3342.950228515668
        y: 332.41002500221094
      positionAbsolute:
        x: 3342.950228515668
        y: 332.41002500221094
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nfrom typing import Dict, Any, Optional\n\n\ndef main(agent3_output:\
          \ dict, agent5_output: dict, technical_score: float = 0, **env_vars) ->\
          \ dict:\n    \"\"\"\n    Agent 6 ç­–ç•¥è®¡ç®—è¾…åŠ©å‡½æ•°\n    \n    Args:\n        agent3_output:\
          \ Agent 3 çš„æ•°æ®æ ¡éªŒç»“æœ JSON\n        agent5_output: Agent 5 çš„å‰§æœ¬åˆ†æç»“æœ JSON\n  \
          \      technical_score: æŠ€æœ¯é¢è¯„åˆ†(0-2)\n        **env_vars: ç¯å¢ƒå˜é‡å­—å…¸\n       \
          \ \n    Returns:\n        {\"result\": ç­–ç•¥è®¡ç®—è¾…åŠ©ç»“æœ JSON å­—ç¬¦ä¸²}\n    \"\"\"\n\
          \    try:\n        agent3_data = agent3_output\n        agent5_data = agent5_output\n\
          \        \n        calculator = StrategyCalculator(env_vars)\n        result\
          \ = calculator.process(agent3_data, agent5_data, technical_score)\n    \
          \    \n        return {\n            \"result\": json.dumps(result, ensure_ascii=False,\
          \ indent=2)\n        }\n        \n    except Exception as e:\n        return\
          \ {\n            \"result\": json.dumps({\n                \"error\": True,\n\
          \                \"error_message\": str(e)\n            }, ensure_ascii=False,\
          \ indent=2)\n        }\n\n\nclass StrategyCalculator:\n    \"\"\"ç­–ç•¥è®¡ç®—å¼•æ“\"\
          \"\"\n    \n    def __init__(self, env_vars: Dict[str, Any]):\n        \"\
          \"\"åˆå§‹åŒ–ç¯å¢ƒå˜é‡\"\"\"\n        self.env = self._parse_env_vars(env_vars)\n \
          \   \n    def _parse_env_vars(self, env_vars: Dict[str, Any]) -> Dict[str,\
          \ float]:\n        \"\"\"è§£æç¯å¢ƒå˜é‡å¹¶è®¾ç½®é»˜è®¤å€¼\"\"\"\n        defaults = {\n    \
          \        # Greeks ç›®æ ‡èŒƒå›´\n            'CONSERVATIVE_DELTA_MIN': -0.1,\n  \
          \          'CONSERVATIVE_DELTA_MAX': 0.1,\n            'CONSERVATIVE_THETA_MIN':\
          \ 5.0,\n            'CONSERVATIVE_VEGA_MAX': -10.0,\n            'BALANCED_DELTA_RANGE':\
          \ 0.2,\n            'BALANCED_THETA_MIN': 8.0,\n            'AGGRESSIVE_DELTA_MIN':\
          \ 0.3,\n            'AGGRESSIVE_DELTA_MAX': 0.6,\n            'AGGRESSIVE_VEGA_MIN':\
          \ 10.0,\n            \n            # DTE é€‰æ‹©\n            'DTE_GAP_HIGH_THRESHOLD':\
          \ 3.0,\n            'DTE_GAP_MID_THRESHOLD': 2.0,\n            'DTE_MONTHLY_ADJUSTMENT':\
          \ 7,\n            \n            # è¡Œæƒä»·åç§»\n            'STRIKE_CONSERVATIVE_LONG_OFFSET':\
          \ 1.5,\n            'STRIKE_BALANCED_WING_OFFSET': 1.0,\n            'STRIKE_RATIO_SHORT_OFFSET':\
          \ 0.5,\n            'STRIKE_RATIO_LONG_OFFSET': 1.5,\n            'STRIKE_AGGRESSIVE_LONG_OFFSET':\
          \ 0.2,\n            \n            # ä»·å·®å®½åº¦\n            'WIDTH_CREDIT_MIN':\
          \ 0.8,\n            'WIDTH_CREDIT_MAX': 1.0,\n            'WIDTH_DEBIT_MIN':\
          \ 1.0,\n            'WIDTH_DEBIT_MAX': 1.2,\n            \n            #\
          \ RR è®¡ç®— - ä¿¡ç”¨ IVR æ˜ å°„\n            'CREDIT_IVR_0_25': 0.20,\n            'CREDIT_IVR_25_50':\
          \ 0.30,\n            'CREDIT_IVR_50_75': 0.40,\n            'CREDIT_IVR_75_100':\
          \ 0.50,\n            \n            # RR è®¡ç®— - å€Ÿè´· IVR æ˜ å°„\n            'DEBIT_IVR_0_40':\
          \ 0.30,\n            'DEBIT_IVR_40_70': 0.40,\n            'DEBIT_IVR_70_100':\
          \ 0.50,\n            \n            # Pw è®¡ç®— - ä¿¡ç”¨\n            'PW_CREDIT_BASE':\
          \ 0.5,\n            'PW_CREDIT_CLUSTER_COEF': 0.1,\n            'PW_CREDIT_DISTANCE_PENALTY_COEF':\
          \ 0.05,\n            'PW_CREDIT_MIN': 0.4,\n            'PW_CREDIT_MAX':\
          \ 0.85,\n            \n            # Pw è®¡ç®— - å€Ÿè´·\n            'PW_DEBIT_BASE':\
          \ 0.3,\n            'PW_DEBIT_DEX_COEF': 0.1,\n            'PW_DEBIT_VANNA_COEF':\
          \ 0.2,\n            'PW_DEBIT_VANNA_WEIGHT_HIGH': 1.0,\n            'PW_DEBIT_VANNA_WEIGHT_MEDIUM':\
          \ 0.6,\n            'PW_DEBIT_VANNA_WEIGHT_LOW': 0.3,\n            'PW_DEBIT_MIN':\
          \ 0.25,\n            'PW_DEBIT_MAX': 0.75,\n            \n            #\
          \ Pw è®¡ç®— - è¶å¼\n            'PW_BUTTERFLY_BODY_INSIDE': 0.65,\n          \
          \  'PW_BUTTERFLY_BODY_OFFSET_1EM': 0.45,\n            \n            # æ­¢ç›ˆæ­¢æŸ\n\
          \            'PROFIT_TARGET_CREDIT_PCT': 30,\n            'PROFIT_TARGET_DEBIT_PCT':\
          \ 60,\n            'STOP_LOSS_DEBIT_PCT': 50,\n            'STOP_LOSS_CREDIT_PCT':\
          \ 150,\n            'TIME_DECAY_EXIT_DAYS': 3,\n            \n         \
          \   # é£é™©ç®¡ç†\n            'MAX_SINGLE_RISK_PCT': 2,\n        }\n        \n\
          \        parsed = {}\n        for key, default_value in defaults.items():\n\
          \            value = env_vars.get(key, default_value)\n            try:\n\
          \                parsed[key] = float(value)\n            except (ValueError,\
          \ TypeError):\n                parsed[key] = default_value\n        \n \
          \       return parsed\n    \n    # ============= 1. è¡Œæƒä»·è®¡ç®— =============\n\
          \    \n    def calculate_strikes(self, spot: float, em1: float, walls: Dict)\
          \ -> Dict:\n        \"\"\"\n        è®¡ç®—å„ç­–ç•¥çš„è¡Œæƒä»·\n        \n        Args:\n\
          \            spot: ç°ä»·\n            em1: EM1$ é¢„æœŸå•æ—¥æ³¢å¹…\n            walls:\
          \ å¢™ä½ä¿¡æ¯ {call_wall, put_wall, major_wall}\n        \n        Returns:\n \
          \           å„ç­–ç•¥çš„è¡Œæƒä»·å­—å…¸\n        \"\"\"\n        call_wall = walls.get(\"\
          call_wall\", spot * 1.05)\n        put_wall = walls.get(\"put_wall\", spot\
          \ * 0.95)\n        \n        return {\n            \"iron_condor\": {\n\
          \                \"short_call\": round(call_wall, 2),\n                \"\
          long_call\": round(call_wall + self.env['STRIKE_CONSERVATIVE_LONG_OFFSET']\
          \ * em1, 2),\n                \"short_put\": round(put_wall, 2),\n     \
          \           \"long_put\": round(put_wall - self.env['STRIKE_CONSERVATIVE_LONG_OFFSET']\
          \ * em1, 2),\n                \"width_call\": round(self.env['STRIKE_CONSERVATIVE_LONG_OFFSET']\
          \ * em1, 2),\n                \"width_put\": round(self.env['STRIKE_CONSERVATIVE_LONG_OFFSET']\
          \ * em1, 2)\n            },\n            \"iron_butterfly\": {\n       \
          \         \"body\": round(spot, 2),\n                \"call_wing\": round(spot\
          \ + self.env['STRIKE_BALANCED_WING_OFFSET'] * em1, 2),\n               \
          \ \"put_wing\": round(spot - self.env['STRIKE_BALANCED_WING_OFFSET'] * em1,\
          \ 2),\n                \"wing_width\": round(self.env['STRIKE_BALANCED_WING_OFFSET']\
          \ * em1, 2)\n            },\n            \"bull_call_spread\": {\n     \
          \           \"long_call\": round(spot + self.env['STRIKE_AGGRESSIVE_LONG_OFFSET']\
          \ * em1, 2),\n                \"short_call\": round(call_wall, 2),\n   \
          \             \"width\": round(call_wall - (spot + self.env['STRIKE_AGGRESSIVE_LONG_OFFSET']\
          \ * em1), 2)\n            },\n            \"bear_put_spread\": {\n     \
          \           \"long_put\": round(spot - self.env['STRIKE_AGGRESSIVE_LONG_OFFSET']\
          \ * em1, 2),\n                \"short_put\": round(put_wall, 2),\n     \
          \           \"width\": round((spot - self.env['STRIKE_AGGRESSIVE_LONG_OFFSET']\
          \ * em1) - put_wall, 2)\n            },\n            \"bull_put_spread\"\
          : {\n                \"long_put\": round(put_wall - self.env['STRIKE_CONSERVATIVE_LONG_OFFSET']\
          \ * em1, 2),\n                \"short_put\": round(put_wall, 2),\n     \
          \           \"width\": round(self.env['STRIKE_CONSERVATIVE_LONG_OFFSET']\
          \ * em1, 2)\n            },\n            \"bear_call_spread\": {\n     \
          \           \"long_call\": round(call_wall + self.env['STRIKE_CONSERVATIVE_LONG_OFFSET']\
          \ * em1, 2),\n                \"short_call\": round(call_wall, 2),\n   \
          \             \"width\": round(self.env['STRIKE_CONSERVATIVE_LONG_OFFSET']\
          \ * em1, 2)\n            },\n            \"call_ratio_spread\": {\n    \
          \            \"long_call\": round(spot + self.env['STRIKE_RATIO_SHORT_OFFSET']\
          \ * em1, 2),\n                \"short_call\": round(spot + self.env['STRIKE_RATIO_LONG_OFFSET']\
          \ * em1, 2),\n                \"ratio\": \"1:2\"\n            },\n     \
          \       \"put_ratio_spread\": {\n                \"long_put\": round(spot\
          \ - self.env['STRIKE_RATIO_SHORT_OFFSET'] * em1, 2),\n                \"\
          short_put\": round(spot - self.env['STRIKE_RATIO_LONG_OFFSET'] * em1, 2),\n\
          \                \"ratio\": \"1:2\"\n            },\n            \"long_call\"\
          : {\n                \"strike\": round(spot + self.env['STRIKE_AGGRESSIVE_LONG_OFFSET']\
          \ * em1, 2)\n            },\n            \"long_put\": {\n             \
          \   \"strike\": round(spot - self.env['STRIKE_AGGRESSIVE_LONG_OFFSET'] *\
          \ em1, 2)\n            }\n        }\n    \n    # ============= 2. DTE è®¡ç®—\
          \ =============\n    \n    def calculate_dte(self, gap_distance_em1: float,\
          \ monthly_override: bool) -> Dict:\n        \"\"\"\n        åŠ¨æ€ DTE è®¡ç®—\n\
          \        \n        Args:\n            gap_distance_em1: gap è·ç¦»ï¼ˆEM1$ å€æ•°ï¼‰\n\
          \            monthly_override: æ˜¯å¦æœˆåº¦å åŠ \n        \n        Returns:\n    \
          \        DTE ä¿¡æ¯å­—å…¸\n        \"\"\"\n        # åŸºç¡€è§„åˆ™\n        if gap_distance_em1\
          \ > self.env['DTE_GAP_HIGH_THRESHOLD']:\n            base_dte = 14\n   \
          \         gap_level = \"high\"\n        elif gap_distance_em1 >= self.env['DTE_GAP_MID_THRESHOLD']:\n\
          \            base_dte = 10\n            gap_level = \"mid\"\n        else:\n\
          \            base_dte = 7\n            gap_level = \"low\"\n        \n \
          \       # æœˆåº¦è°ƒæ•´\n        if monthly_override:\n            adjustment = int(self.env['DTE_MONTHLY_ADJUSTMENT'])\n\
          \            final_dte = base_dte + adjustment\n            rationale =\
          \ f\"gap_distance_em1={gap_distance_em1:.2f}>{self.env['DTE_GAP_HIGH_THRESHOLD']if\
          \ gap_level=='high' else f'åœ¨{self.env['DTE_GAP_MID_THRESHOLD']}-{self.env['DTE_GAP_HIGH_THRESHOLD']}'\
          \ if gap_level=='mid' else f'<{self.env['DTE_GAP_MID_THRESHOLD']}'}é€‰æ‹©{base_dte}æ—¥DTEï¼Œæœˆåº¦å åŠ +{adjustment}æ—¥={final_dte}æ—¥\"\
          \n        else:\n            final_dte = base_dte\n            rationale\
          \ = f\"gap_distance_em1={gap_distance_em1:.2f}é€‰æ‹©{final_dte}æ—¥DTEï¼Œæ— æœˆåº¦å åŠ \"\n\
          \        \n        return {\n            \"base_dte\": base_dte,\n     \
          \       \"final_dte\": final_dte,\n            \"gap_level\": gap_level,\n\
          \            \"monthly_override\": monthly_override,\n            \"rationale\"\
          : rationale\n        }\n    \n    # ============= 3. RR ç›ˆäºæ¯”è®¡ç®— =============\n\
          \    \n    def calculate_rr_credit(self, width: float, ivr: float = 40)\
          \ -> Dict:\n        \"\"\"\n        ä¿¡ç”¨ä»·å·® RR è®¡ç®—\n        \n        Args:\n\
          \            width: ä»·å·®å®½åº¦\n            ivr: éšå«æ³¢åŠ¨ç‡ç™¾åˆ†ä½ï¼ˆ0-100ï¼‰\n        \n \
          \       Returns:\n            RR è®¡ç®—ç»“æœ\n        \"\"\"\n        # IVR æ˜ å°„\n\
          \        if ivr <= 25:\n            credit_ratio = self.env['CREDIT_IVR_0_25']\n\
          \            ivr_range = \"0-25%\"\n        elif ivr <= 50:\n          \
          \  credit_ratio = self.env['CREDIT_IVR_25_50']\n            ivr_range =\
          \ \"25-50%\"\n        elif ivr <= 75:\n            credit_ratio = self.env['CREDIT_IVR_50_75']\n\
          \            ivr_range = \"50-75%\"\n        else:\n            credit_ratio\
          \ = self.env['CREDIT_IVR_75_100']\n            ivr_range = \"75-100%\"\n\
          \        \n        credit = width * credit_ratio\n        max_loss = width\
          \ - credit\n        \n        # æ ¼å¼åŒ– RR æ¯”ç‡\n        if credit > 0:\n    \
          \        rr_simplified = f\"1:{max_loss/credit:.1f}\"\n        else:\n \
          \           rr_simplified = \"N/A\"\n        \n        formula = f\"Width={width:.2f},\
          \ IVR={ivr}%åœ¨{ivr_range}â†’credit_ratio={credit_ratio}, Credit={credit:.2f},\
          \ MaxLoss={max_loss:.2f}, RR={credit:.2f}:{max_loss:.2f}\"\n        \n \
          \       return {\n            \"width\": round(width, 2),\n            \"\
          ivr\": ivr,\n            \"ivr_range\": ivr_range,\n            \"credit_ratio\"\
          : credit_ratio,\n            \"credit\": round(credit, 2),\n           \
          \ \"max_profit\": round(credit, 2),\n            \"max_loss\": round(max_loss,\
          \ 2),\n            \"rr_ratio\": rr_simplified,\n            \"formula\"\
          : formula\n        }\n    \n    def calculate_rr_debit(self, width: float,\
          \ ivr: float = 40) -> Dict:\n        \"\"\"\n        å€Ÿè´·ä»·å·® RR è®¡ç®—\n      \
          \  \n        Args:\n            width: ä»·å·®å®½åº¦\n            ivr: éšå«æ³¢åŠ¨ç‡ç™¾åˆ†ä½ï¼ˆ0-100ï¼‰\n\
          \        \n        Returns:\n            RR è®¡ç®—ç»“æœ\n        \"\"\"\n     \
          \   # IVR æ˜ å°„\n        if ivr <= 40:\n            debit_ratio = self.env['DEBIT_IVR_0_40']\n\
          \            ivr_range = \"0-40%\"\n        elif ivr <= 70:\n          \
          \  debit_ratio = self.env['DEBIT_IVR_40_70']\n            ivr_range = \"\
          40-70%\"\n        else:\n            debit_ratio = self.env['DEBIT_IVR_70_100']\n\
          \            ivr_range = \"70-100%\"\n        \n        debit = width *\
          \ debit_ratio\n        max_profit = width - debit\n        \n        # æ ¼å¼åŒ–\
          \ RR æ¯”ç‡\n        if debit > 0:\n            rr_simplified = f\"{max_profit/debit:.1f}:1\"\
          \n        else:\n            rr_simplified = \"N/A\"\n        \n       \
          \ formula = f\"Width={width:.2f}, IVR={ivr}%åœ¨{ivr_range}â†’debit_ratio={debit_ratio},\
          \ Debit={debit:.2f}, MaxProfit={max_profit:.2f}, RR={max_profit:.2f}:{debit:.2f}\"\
          \n        \n        return {\n            \"width\": round(width, 2),\n\
          \            \"ivr\": ivr,\n            \"ivr_range\": ivr_range,\n    \
          \        \"debit_ratio\": debit_ratio,\n            \"debit\": round(debit,\
          \ 2),\n            \"max_profit\": round(max_profit, 2),\n            \"\
          max_loss\": round(debit, 2),\n            \"rr_ratio\": rr_simplified,\n\
          \            \"formula\": formula\n        }\n    \n    # =============\
          \ 4. Pw èƒœç‡è®¡ç®— =============\n    \n    def calculate_pw_credit(self, cluster_strength:\
          \ float, gap_distance_em1: float, \n                           technical_score:\
          \ float = 0) -> Dict:\n        \"\"\"\n        ä¿¡ç”¨ä»·å·®èƒœç‡è®¡ç®—\n        \n    \
          \    Args:\n            cluster_strength: ç°‡å¼ºåº¦æ¯”ç‡\n            gap_distance_em1:\
          \ gap è·ç¦»ï¼ˆEM1$ å€æ•°ï¼‰\n            technical_score: æŠ€æœ¯é¢è¯„åˆ†ï¼ˆ0-2ï¼‰\n        \n \
          \       Returns:\n            Pw è®¡ç®—ç»“æœ\n        \"\"\"\n        base = self.env['PW_CREDIT_BASE']\n\
          \        cluster_adj = self.env['PW_CREDIT_CLUSTER_COEF'] * cluster_strength\n\
          \        distance_penalty = self.env['PW_CREDIT_DISTANCE_PENALTY_COEF']\
          \ * gap_distance_em1\n        \n        pw_raw = base + cluster_adj - distance_penalty\n\
          \        \n        # æŠ€æœ¯é¢æå‡\n        technical_boost = 0.05 * technical_score\
          \ if technical_score > 0 else 0\n        \n        # é™åˆ¶èŒƒå›´\n        pw_adjusted\
          \ = max(self.env['PW_CREDIT_MIN'], \n                          min(self.env['PW_CREDIT_MAX'],\
          \ \n                              pw_raw + technical_boost))\n        \n\
          \        formula = f\"base {base} + cluster {cluster_adj:.3f} - distance\
          \ {distance_penalty:.3f} + technical {technical_boost:.2f} = {pw_adjusted:.2f}\"\
          \n        \n        return {\n            \"base\": base,\n            \"\
          cluster_strength\": cluster_strength,\n            \"cluster_adj\": round(cluster_adj,\
          \ 3),\n            \"gap_distance_em1\": gap_distance_em1,\n           \
          \ \"distance_penalty\": round(distance_penalty, 3),\n            \"technical_score\"\
          : technical_score,\n            \"technical_boost\": round(technical_boost,\
          \ 2),\n            \"pw_raw\": round(pw_raw, 3),\n            \"pw_adjusted\"\
          : round(pw_adjusted, 2),\n            \"pw_estimate\": f\"{int(pw_adjusted\
          \ * 100)}%\",\n            \"formula\": formula\n        }\n    \n    def\
          \ calculate_pw_debit(self, dex_same_dir_pct: float, vanna_confidence: str,\
          \ \n                          gap_distance_em1: float) -> Dict:\n      \
          \  \"\"\"\n        å€Ÿè´·ä»·å·®èƒœç‡è®¡ç®—\n        \n        Args:\n            dex_same_dir_pct:\
          \ DEX åŒå‘ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰\n            vanna_confidence: Vanna ç½®ä¿¡åº¦ï¼ˆhigh/medium/lowï¼‰\n\
          \            gap_distance_em1: gap è·ç¦»ï¼ˆEM1$ å€æ•°ï¼‰\n        \n        Returns:\n\
          \            Pw è®¡ç®—ç»“æœ\n        \"\"\"\n        # Vanna æƒé‡\n        vanna_weight_map\
          \ = {\n            'high': self.env['PW_DEBIT_VANNA_WEIGHT_HIGH'],\n   \
          \         'medium': self.env['PW_DEBIT_VANNA_WEIGHT_MEDIUM'],\n        \
          \    'low': self.env['PW_DEBIT_VANNA_WEIGHT_LOW']\n        }\n        vanna_weight\
          \ = vanna_weight_map.get(vanna_confidence, self.env['PW_DEBIT_VANNA_WEIGHT_LOW'])\n\
          \        \n        # åŸºç¡€è®¡ç®—\n        base = self.env['PW_DEBIT_BASE']\n  \
          \      dex_adj = self.env['PW_DEBIT_DEX_COEF'] * (dex_same_dir_pct / 100)\n\
          \        vanna_adj = vanna_weight * self.env['PW_DEBIT_VANNA_COEF']\n  \
          \      \n        pw_raw = base + dex_adj + vanna_adj\n        \n       \
          \ # gap è·ç¦»æƒ©ç½š\n        if gap_distance_em1 > 3:\n            gap_penalty\
          \ = -0.05\n        elif gap_distance_em1 > 2:\n            gap_penalty =\
          \ -0.03\n        else:\n            gap_penalty = 0\n        \n        #\
          \ é™åˆ¶èŒƒå›´\n        pw_adjusted = max(self.env['PW_DEBIT_MIN'], \n         \
          \                 min(self.env['PW_DEBIT_MAX'], \n                     \
          \         pw_raw + gap_penalty))\n        \n        formula = f\"base {base}\
          \ + dex {dex_adj:.3f} + vanna {vanna_adj:.2f} + gap_penalty {gap_penalty:.2f}\
          \ = {pw_adjusted:.2f}\"\n        \n        return {\n            \"base\"\
          : base,\n            \"dex_same_dir_pct\": dex_same_dir_pct,\n         \
          \   \"dex_adj\": round(dex_adj, 3),\n            \"vanna_confidence\": vanna_confidence,\n\
          \            \"vanna_weight\": vanna_weight,\n            \"vanna_adj\"\
          : round(vanna_adj, 2),\n            \"gap_distance_em1\": gap_distance_em1,\n\
          \            \"gap_penalty\": gap_penalty,\n            \"pw_raw\": round(pw_raw,\
          \ 3),\n            \"pw_adjusted\": round(pw_adjusted, 2),\n           \
          \ \"pw_estimate\": f\"{int(pw_adjusted * 100)}%\",\n            \"formula\"\
          : formula\n        }\n    \n    def calculate_pw_butterfly(self, spot: float,\
          \ body: float, em1: float, \n                               iv_path: str\
          \ = \"å¹³\") -> Dict:\n        \"\"\"\n        è¶å¼ç­–ç•¥èƒœç‡è®¡ç®—\n        \n      \
          \  Args:\n            spot: ç°ä»·\n            body: è¶å¼ä¸­å¿ƒä»·æ ¼\n            em1:\
          \ EM1$\n            iv_path: IV è·¯å¾„ï¼ˆå‡/é™/å¹³ï¼‰\n        \n        Returns:\n\
          \            Pw è®¡ç®—ç»“æœ\n        \"\"\"\n        distance_em1 = abs(spot -\
          \ body) / em1 if em1 > 0 else 0\n        \n        # åŸºç¡€èƒœç‡\n        if distance_em1\
          \ < 0.3:\n            pw_base = self.env['PW_BUTTERFLY_BODY_INSIDE']\n \
          \           distance_desc = \"spotåœ¨bodyå†…\"\n        elif distance_em1 <\
          \ 1.0:\n            pw_base = 0.55\n            distance_desc = \"è½»å¾®åç¦»\"\
          \n        else:\n            pw_base = self.env['PW_BUTTERFLY_BODY_OFFSET_1EM']\n\
          \            distance_desc = \"åç¦»1EM1$\"\n        \n        # IV è°ƒæ•´\n  \
          \      if iv_path == \"å‡\":\n            iv_adj = -0.05\n            iv_note\
          \ = \"IVæ‰©å¼ ä¸åˆ©è¶å¼\"\n        elif iv_path == \"é™\":\n            iv_adj = 0.05\n\
          \            iv_note = \"IVå‹ç¼©æœ‰åˆ©è¶å¼\"\n        else:\n            iv_adj =\
          \ 0\n            iv_note = \"IVç¨³å®š\"\n        \n        pw_adjusted = max(0.3,\
          \ min(0.75, pw_base + iv_adj))\n        \n        formula = f\"è·ç¦»body {distance_em1:.2f}Ã—EM1$({distance_desc})â†’base\
          \ {pw_base}, IVè·¯å¾„{iv_path}è°ƒæ•´{iv_adj:+.2f} = {pw_adjusted:.2f}\"\n      \
          \  \n        return {\n            \"spot\": spot,\n            \"body\"\
          : body,\n            \"distance_em1\": round(distance_em1, 2),\n       \
          \     \"distance_desc\": distance_desc,\n            \"iv_path\": iv_path,\n\
          \            \"iv_adj\": iv_adj,\n            \"iv_note\": iv_note,\n  \
          \          \"pw_base\": pw_base,\n            \"pw_adjusted\": round(pw_adjusted,\
          \ 2),\n            \"pw_estimate\": f\"{int(pw_adjusted * 100)}%\",\n  \
          \          \"formula\": formula\n        }\n    \n    # ============= 5.\
          \ Greeks èŒƒå›´ =============\n    \n    def get_greeks_ranges(self) -> Dict:\n\
          \        \"\"\"\n        è·å–å„ç­–ç•¥ç±»å‹çš„ Greeks ç›®æ ‡èŒƒå›´\n        \n        Returns:\n\
          \            Greeks èŒƒå›´å­—å…¸\n        \"\"\"\n        return {\n           \
          \ \"conservative\": {\n                \"delta_min\": self.env['CONSERVATIVE_DELTA_MIN'],\n\
          \                \"delta_max\": self.env['CONSERVATIVE_DELTA_MAX'],\n  \
          \              \"theta_min\": self.env['CONSERVATIVE_THETA_MIN'],\n    \
          \            \"vega_max\": self.env['CONSERVATIVE_VEGA_MAX'],\n        \
          \        \"description\": \"ä¿å®ˆç­–ç•¥ï¼šæ¥è¿‘ä¸­æ€§Deltaï¼Œæ­£Thetaæ”¶ç›Šï¼Œè´ŸVegaåšç©ºæ³¢åŠ¨ç‡\"\n     \
          \       },\n            \"balanced\": {\n                \"delta_range\"\
          : self.env['BALANCED_DELTA_RANGE'],\n                \"theta_min\": self.env['BALANCED_THETA_MIN'],\n\
          \                \"vega_range\": [-5, 5],\n                \"description\"\
          : \"å‡è¡¡ç­–ç•¥ï¼šè½»å¾®æ–¹å‘æ•å£Â±Delta_rangeï¼Œæ­£Thetaï¼ŒVegaä¸­æ€§\"\n            },\n          \
          \  \"aggressive\": {\n                \"delta_min\": self.env['AGGRESSIVE_DELTA_MIN'],\n\
          \                \"delta_max\": self.env['AGGRESSIVE_DELTA_MAX'],\n    \
          \            \"vega_min\": self.env['AGGRESSIVE_VEGA_MIN'],\n          \
          \      \"description\": \"è¿›å–ç­–ç•¥ï¼šæ˜ç¡®æ–¹å‘Delta 0.3-0.6ï¼ŒThetaå¯ä¸ºè´Ÿï¼Œæ­£Vegaåšå¤šæ³¢åŠ¨ç‡\"\n\
          \            }\n        }\n    \n    # ============= 6. æ­¢ç›ˆæ­¢æŸå‚æ•° =============\n\
          \    \n    def get_exit_parameters(self) -> Dict:\n        \"\"\"\n    \
          \    è·å–æ­¢ç›ˆæ­¢æŸå‚æ•°\n        \n        Returns:\n            æ­¢ç›ˆæ­¢æŸå‚æ•°å­—å…¸\n      \
          \  \"\"\"\n        return {\n            \"credit_strategies\": {\n    \
          \            \"profit_target_pct\": int(self.env['PROFIT_TARGET_CREDIT_PCT']),\n\
          \                \"stop_loss_pct\": int(self.env['STOP_LOSS_CREDIT_PCT']),\n\
          \                \"time_decay_exit_days\": int(self.env['TIME_DECAY_EXIT_DAYS']),\n\
          \                \"description\": f\"ä¿¡ç”¨ç­–ç•¥ï¼šæƒåˆ©é‡‘è¡°å‡è‡³{int(self.env['PROFIT_TARGET_CREDIT_PCT'])}%æ­¢ç›ˆï¼Œæµ®äº{int(self.env['STOP_LOSS_CREDIT_PCT'])}%æ­¢æŸ\"\
          \n            },\n            \"debit_strategies\": {\n                \"\
          profit_target_pct\": int(self.env['PROFIT_TARGET_DEBIT_PCT']),\n       \
          \         \"stop_loss_pct\": int(self.env['STOP_LOSS_DEBIT_PCT']),\n   \
          \             \"time_decay_exit_days\": int(self.env['TIME_DECAY_EXIT_DAYS']),\n\
          \                \"description\": f\"å€Ÿè´·ç­–ç•¥ï¼šæµ®ç›ˆ{int(self.env['PROFIT_TARGET_DEBIT_PCT'])}%æ­¢ç›ˆï¼ŒäºæŸ{int(self.env['STOP_LOSS_DEBIT_PCT'])}%æ­¢æŸ\"\
          \n            },\n            \"time_management\": {\n                \"\
          exit_days_before_expiry\": int(self.env['TIME_DECAY_EXIT_DAYS']),\n    \
          \            \"description\": f\"æ—¶é—´ç®¡ç†ï¼šåˆ°æœŸå‰{int(self.env['TIME_DECAY_EXIT_DAYS'])}æ—¥å¹³ä»“é¿å…Pin\
          \ Risk\"\n            }\n        }\n    \n    # ============= ä¸»å¤„ç†å‡½æ•° =============\n\
          \    \n    def process(self, agent3_data: Dict, agent5_data: Dict, technical_score:\
          \ float = 0) -> Dict:\n        \"\"\"\n        ä¸»å¤„ç†æµç¨‹\n        \n       \
          \ Args:\n            agent3_data: Agent 3 æ•°æ®\n            agent5_data: Agent\
          \ 5 æ•°æ®\n            technical_score: æŠ€æœ¯é¢è¯„åˆ†\n        \n        Returns:\n\
          \            å®Œæ•´è®¡ç®—ç»“æœ\n        \"\"\"\n        \n        # ç›´æ¥ä»æ ¹èŠ‚ç‚¹è·å–æ•°æ®ï¼ˆä¸å†å¤„ç†\
          \ targets æ•°ç»„ï¼‰\n        spot = agent3_data.get(\"spot_price\", 0)\n     \
          \   em1 = agent3_data.get(\"em1_dollar\", 0)\n        walls = agent3_data.get(\"\
          walls\", {})\n        gamma_metrics = agent3_data.get(\"gamma_metrics\"\
          , {})\n        directional_metrics = agent3_data.get(\"directional_metrics\"\
          , {})\n        \n        # æ ¡éªŒå¿…éœ€å­—æ®µ\n        if spot == 0 or em1 == 0:\n \
          \           raise ValueError(\"Agent 3 æ•°æ®ç¼ºå¤±å…³é”®å­—æ®µï¼šspot_price æˆ– em1_dollar\"\
          )\n        \n        # Agent 5 æ•°æ®\n        scenario = agent5_data.get(\"\
          scenario_classification\", {})\n        \n        # æ‰§è¡Œè®¡ç®—\n        strikes\
          \ = self.calculate_strikes(spot, em1, walls)\n        dte_info = self.calculate_dte(\n\
          \            gamma_metrics.get(\"gap_distance_em1_multiple\", 2.0),\n  \
          \          gamma_metrics.get(\"monthly_cluster_override\", False)\n    \
          \    )\n        \n        # ä¼°ç®— IVRï¼ˆç®€åŒ–å¤„ç†ï¼Œå®é™…åº”ä»å¸‚åœºæ•°æ®è·å–ï¼‰\n        ivr_estimate\
          \ = 40  # é»˜è®¤ä¸­ç­‰ IVR\n        \n        # RR è®¡ç®—ï¼ˆä½¿ç”¨å®é™…å®½åº¦ï¼‰\n        rr_credit_ic\
          \ = self.calculate_rr_credit(\n            strikes[\"iron_condor\"][\"width_call\"\
          ],\n            ivr_estimate\n        )\n        \n        rr_debit_bull\
          \ = self.calculate_rr_debit(\n            strikes[\"bull_call_spread\"][\"\
          width\"],\n            ivr_estimate\n        )\n        \n        # Pw è®¡ç®—\n\
          \        pw_credit = self.calculate_pw_credit(\n            gamma_metrics.get(\"\
          cluster_strength_ratio\", 1.5),\n            gamma_metrics.get(\"gap_distance_em1_multiple\"\
          , 2.0),\n            technical_score\n        )\n        \n        pw_debit\
          \ = self.calculate_pw_debit(\n            directional_metrics.get(\"dex_same_dir_pct\"\
          , 50),\n            directional_metrics.get(\"vanna_confidence\", \"medium\"\
          ),\n            gamma_metrics.get(\"gap_distance_em1_multiple\", 2.0)\n\
          \        )\n        \n        pw_butterfly = self.calculate_pw_butterfly(\n\
          \            spot,\n            spot,  # body åœ¨ç°ä»·\n            em1,\n  \
          \          directional_metrics.get(\"iv_path\", \"å¹³\")\n        )\n    \
          \    \n        # Greeks èŒƒå›´\n        greeks_ranges = self.get_greeks_ranges()\n\
          \        \n        # æ­¢ç›ˆæ­¢æŸå‚æ•°\n        exit_params = self.get_exit_parameters()\n\
          \        \n        # ç»„è£…ç»“æœ\n        result = {\n            # è¡Œæƒä»·ï¼ˆä¿ç•™ç»“æ„ï¼Œä¾›\
          \ Agent 6 é€‰æ‹©ï¼‰\n            \"strikes\": strikes,\n            \n       \
          \     # DTEï¼ˆæ‰å¹³åŒ–ï¼‰\n            \"dte_final\": dte_info[\"final_dte\"],\n\
          \            \"dte_rationale\": dte_info[\"rationale\"],\n            \"\
          dte_base\": dte_info[\"base_dte\"],\n            \"dte_gap_level\": dte_info[\"\
          gap_level\"],\n            \"dte_monthly_override\": dte_info[\"monthly_override\"\
          ],\n            \n            # RR - Iron Condorï¼ˆæ‰å¹³åŒ–ï¼‰\n            \"rr_ic_credit\"\
          : rr_credit_ic[\"credit\"],\n            \"rr_ic_max_profit\": rr_credit_ic[\"\
          max_profit\"],\n            \"rr_ic_max_loss\": rr_credit_ic[\"max_loss\"\
          ],\n            \"rr_ic_ratio\": rr_credit_ic[\"rr_ratio\"],\n         \
          \   \"rr_ic_formula\": rr_credit_ic[\"formula\"],\n            \"rr_ic_width\"\
          : rr_credit_ic[\"width\"],\n            \"rr_ic_ivr\": rr_credit_ic[\"ivr\"\
          ],\n            \n            # RR - Bull Call Spreadï¼ˆæ‰å¹³åŒ–ï¼‰\n           \
          \ \"rr_bull_debit\": rr_debit_bull[\"debit\"],\n            \"rr_bull_max_profit\"\
          : rr_debit_bull[\"max_profit\"],\n            \"rr_bull_max_loss\": rr_debit_bull[\"\
          max_loss\"],\n            \"rr_bull_ratio\": rr_debit_bull[\"rr_ratio\"\
          ],\n            \"rr_bull_formula\": rr_debit_bull[\"formula\"],\n     \
          \       \"rr_bull_width\": rr_debit_bull[\"width\"],\n            \n   \
          \         # Pw - Creditï¼ˆæ‰å¹³åŒ–ï¼‰\n            \"pw_credit_estimate\": pw_credit[\"\
          pw_estimate\"],\n            \"pw_credit_formula\": pw_credit[\"formula\"\
          ],\n            \"pw_credit_note\": pw_credit[\"pw_note\"],\n          \
          \  \"pw_credit_base\": pw_credit[\"base\"],\n            \"pw_credit_cluster_adj\"\
          : pw_credit[\"cluster_adj\"],\n            \"pw_credit_distance_penalty\"\
          : pw_credit[\"distance_penalty\"],\n            \"pw_credit_technical_boost\"\
          : pw_credit[\"technical_boost\"],\n            \"pw_credit_adjusted\": pw_credit[\"\
          pw_adjusted\"],\n            \n            # Pw - Debitï¼ˆæ‰å¹³åŒ–ï¼‰\n         \
          \   \"pw_debit_estimate\": pw_debit[\"pw_estimate\"],\n            \"pw_debit_formula\"\
          : pw_debit[\"formula\"],\n            \"pw_debit_note\": pw_debit[\"pw_note\"\
          ],\n            \"pw_debit_base\": pw_debit[\"base\"],\n            \"pw_debit_dex_adj\"\
          : pw_debit[\"dex_adj\"],\n            \"pw_debit_vanna_adj\": pw_debit[\"\
          vanna_adj\"],\n            \"pw_debit_gap_penalty\": pw_debit[\"gap_penalty\"\
          ],\n            \"pw_debit_adjusted\": pw_debit[\"pw_adjusted\"],\n    \
          \        \n            # Pw - Butterflyï¼ˆæ‰å¹³åŒ–ï¼‰\n            \"pw_butterfly_estimate\"\
          : pw_butterfly[\"pw_estimate\"],\n            \"pw_butterfly_formula\":\
          \ pw_butterfly[\"formula\"],\n            \"pw_butterfly_note\": pw_butterfly[\"\
          pw_note\"],\n            \"pw_butterfly_distance_em1\": pw_butterfly[\"\
          distance_em1\"],\n            \n            # Greeks - Conservativeï¼ˆæ‰å¹³åŒ–ï¼‰\n\
          \            \"greeks_conservative_delta_min\": greeks_ranges[\"conservative\"\
          ][\"delta_min\"],\n            \"greeks_conservative_delta_max\": greeks_ranges[\"\
          conservative\"][\"delta_max\"],\n            \"greeks_conservative_theta_min\"\
          : greeks_ranges[\"conservative\"][\"theta_min\"],\n            \"greeks_conservative_vega_max\"\
          : greeks_ranges[\"conservative\"][\"vega_max\"],\n            \"greeks_conservative_desc\"\
          : greeks_ranges[\"conservative\"][\"description\"],\n            \n    \
          \        # Greeks - Balancedï¼ˆæ‰å¹³åŒ–ï¼‰\n            \"greeks_balanced_delta_range\"\
          : greeks_ranges[\"balanced\"][\"delta_range\"],\n            \"greeks_balanced_theta_min\"\
          : greeks_ranges[\"balanced\"][\"theta_min\"],\n            \"greeks_balanced_desc\"\
          : greeks_ranges[\"balanced\"][\"description\"],\n            \n        \
          \    # Greeks - Aggressiveï¼ˆæ‰å¹³åŒ–ï¼‰\n            \"greeks_aggressive_delta_min\"\
          : greeks_ranges[\"aggressive\"][\"delta_min\"],\n            \"greeks_aggressive_delta_max\"\
          : greeks_ranges[\"aggressive\"][\"delta_max\"],\n            \"greeks_aggressive_vega_min\"\
          : greeks_ranges[\"aggressive\"][\"vega_min\"],\n            \"greeks_aggressive_desc\"\
          : greeks_ranges[\"aggressive\"][\"description\"],\n            \n      \
          \      # Exit Parameters - Creditï¼ˆæ‰å¹³åŒ–ï¼‰\n            \"exit_credit_profit_pct\"\
          : exit_params[\"credit_strategies\"][\"profit_target_pct\"],\n         \
          \   \"exit_credit_stop_pct\": exit_params[\"credit_strategies\"][\"stop_loss_pct\"\
          ],\n            \"exit_credit_time_days\": exit_params[\"credit_strategies\"\
          ][\"time_decay_exit_days\"],\n            \"exit_credit_desc\": exit_params[\"\
          credit_strategies\"][\"description\"],\n            \n            # Exit\
          \ Parameters - Debitï¼ˆæ‰å¹³åŒ–ï¼‰\n            \"exit_debit_profit_pct\": exit_params[\"\
          debit_strategies\"][\"profit_target_pct\"],\n            \"exit_debit_stop_pct\"\
          : exit_params[\"debit_strategies\"][\"stop_loss_pct\"],\n            \"\
          exit_debit_time_days\": exit_params[\"debit_strategies\"][\"time_decay_exit_days\"\
          ],\n            \"exit_debit_desc\": exit_params[\"debit_strategies\"][\"\
          description\"],\n            \n            # Exit Parameters - Timeï¼ˆæ‰å¹³åŒ–ï¼‰\n\
          \            \"exit_time_days\": exit_params[\"time_management\"][\"exit_days_before_expiry\"\
          ],\n            \"exit_time_desc\": exit_params[\"time_management\"][\"\
          description\"],\n            \n            # Metadataï¼ˆæ‰å¹³åŒ–ï¼‰\n           \
          \ \"meta_spot\": spot,\n            \"meta_em1\": em1,\n            \"meta_ivr\"\
          : ivr_estimate,\n            \"meta_technical_score\": technical_score,\n\
          \            \"meta_primary_scenario\": scenario.get(\"primary_scenario\"\
          , \"æœªçŸ¥\"),\n            \"meta_scenario_probability\": scenario.get(\"scenario_probability\"\
          , 0),\n            \"meta_gamma_regime\": agent5_data.get(\"gamma_regime\"\
          , {}).get(\"spot_vs_trigger\", \"unknown\")\n        }\n        \n     \
          \   return result"
        code_language: python3
        desc: ç­–ç•¥è¾…åŠ©è®¡ç®— 1006
        outputs:
          result:
            children: null
            type: object
        selected: false
        title: CODE3 ç­–ç•¥è¾…åŠ©ç®—æ³•
        type: code
        variables:
        - value_selector:
          - '3001'
          - structured_output
          value_type: object
          variable: agent3_output
        - value_selector:
          - '5001'
          - structured_output
          value_type: object
          variable: agent5_output
        - value_selector:
          - '3001'
          - structured_output
          - technical_analysis
          - ta_score
          value_type: object
          variable: technical_score
      height: 80
      id: '1006'
      position:
        x: 2573.6138666231614
        y: 107.40802282053434
      positionAbsolute:
        x: 2573.6138666231614
        y: 107.40802282053434
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "\nimport json\nfrom typing import Dict, List, Tuple\n\ndef calculate_ev(pw:\
          \ float, max_profit: float, max_loss: float) -> float:\n    \"\"\"è®¡ç®—æœŸæœ›å€¼\"\
          \"\"\n    return pw * max_profit - (1 - pw) * max_loss\n\ndef calculate_rar(ev:\
          \ float, max_loss: float) -> float:\n    \"\"\"è®¡ç®—é£é™©è°ƒæ•´æ”¶ç›Š\"\"\"\n    return\
          \ ev / max_loss if max_loss > 0 else 0\n\ndef calculate_scenario_match(strategy_type:\
          \ str, primary_scenario: str, \n                            scenario_probability:\
          \ int) -> Tuple[str, str]:\n    \"\"\"è®¡ç®—å‰§æœ¬åŒ¹é…åº¦\"\"\"\n    if strategy_type\
          \ == \"ä¿å®ˆ\":\n        if \"åŒºé—´\" in primary_scenario and scenario_probability\
          \ >= 60:\n            return \"é«˜\", f\"åŒºé—´å‰§æœ¬æ¦‚ç‡ {scenario_probability}%,ä¿¡ç”¨ç­–ç•¥å®Œç¾åŒ¹é…\"\
          \n        elif \"åŒºé—´\" in primary_scenario:\n            return \"ä¸­\", f\"\
          åŒºé—´å‰§æœ¬æ¦‚ç‡ {scenario_probability}% ç•¥ä½,ä½†ä»é€‚é…\"\n        else:\n            return\
          \ \"ä½\", f\"è¶‹åŠ¿å‰§æœ¬ {primary_scenario},åŒºé—´ç­–ç•¥ä¸é€‚é…\"\n    \n    elif strategy_type\
          \ == \"å‡è¡¡\":\n        if \"è¶‹åŠ¿\" in primary_scenario and scenario_probability\
          \ >= 55:\n            return \"é«˜\", f\"è¶‹åŠ¿å‰§æœ¬æ¦‚ç‡ {scenario_probability}%,å€Ÿè®°ç­–ç•¥é€‚é…\"\
          \n        elif \"åŒºé—´\" in primary_scenario:\n            return \"ä¸­\", \"\
          åŒºé—´å‰§æœ¬ä¸‹å¯è·å–éƒ¨åˆ†æ–¹å‘æ”¶ç›Š\"\n        else:\n            return \"ä½\", \"å‰§æœ¬ä¸æ˜ç¡®,æ–¹å‘ç­–ç•¥é£é™©å¤§\"\
          \n    \n    elif strategy_type == \"è¿›å–\":\n        if \"å¼ºè¶‹åŠ¿\" in primary_scenario\
          \ or scenario_probability >= 65:\n            return \"é«˜\", f\"å¼ºç¡®ä¿¡åœºæ™¯({scenario_probability}%),å•è…¿æ•å£å¯æœ€å¤§åŒ–æ”¶ç›Š\"\
          \n        elif \"è¶‹åŠ¿\" in primary_scenario:\n            return \"ä¸­\", \"\
          è¶‹åŠ¿åˆæœŸ,å•è…¿é£é™©è¾ƒå¤§\"\n        else:\n            return \"ä½\", \"éè¶‹åŠ¿åœºæ™¯,å•è…¿æ—¶é—´ä»·å€¼æµå¤±å¿«\"\
          \n    \n    return \"ä½\", \"æ— æ³•åˆ¤æ–­åŒ¹é…åº¦\"\n\ndef check_liquidity(strategy: dict,\
          \ spot: float, em1: float) -> Tuple[bool, str]:\n    \"\"\"æµåŠ¨æ€§æ£€æŸ¥\"\"\"\n\
          \    legs = strategy.get(\"legs\", [])\n    \n    # 1. æ£€æŸ¥è…¿éƒ¨æ•°é‡\n    leg_count\
          \ = len(legs)\n    if leg_count > 4:\n        return False, f\"è…¿éƒ¨æ•°é‡ {leg_count}\
          \ è¿‡å¤š,æµåŠ¨æ€§é£é™©é«˜\"\n    \n    # 2. æ£€æŸ¥è¡Œæƒä»·è·ç¦»\n    for leg in legs:\n        strike\
          \ = leg.get(\"strike\")\n        if not isinstance(strike, (int, float)):\n\
          \            continue\n        \n        distance_em1 = abs(strike - spot)\
          \ / em1 if em1 > 0 else 0\n        \n        if distance_em1 > 3:\n    \
          \        return False, f\"{leg['type']} @ {strike} è·ç°ä»· {distance_em1:.1f}Ã—EM1$,æµåŠ¨æ€§ä¸è¶³\"\
          \n    \n    return True, \"æµåŠ¨æ€§è¾¾æ ‡\"\n\ndef rank_strategies(strategies: List[dict],\
          \ primary_scenario: str, \n                    scenario_probability: int,\
          \ spot: float, em1: float) -> List[dict]:\n    \"\"\"ç­–ç•¥æ’åºä¸»å‡½æ•°\"\"\"\n   \
          \ ranked = []\n    \n    for strategy in strategies:\n        # æå–æ•°æ®\n \
          \       rr = strategy.get(\"rr_calculation\", {})\n        pw_calc = strategy.get(\"\
          pw_calculation\", {})\n        \n        max_profit = rr.get(\"max_profit\"\
          , 0)\n        max_loss = rr.get(\"max_loss\", 0)\n        pw_str = pw_calc.get(\"\
          pw_estimate\", \"50%\")\n        \n        # è§£æ Pw\n        pw = 0.5\n \
          \       try:\n            if \"çº¦\" in pw_str:\n                pw = 0.4\n\
          \            elif \"-\" in pw_str:\n                parts = pw_str.replace(\"\
          %\", \"\").split(\"-\")\n                pw = (float(parts[0]) + float(parts[1]))\
          \ / 200\n            else:\n                pw = float(pw_str.rstrip(\"\
          %\")) / 100\n        except:\n            pw = 0.5\n        \n        #\
          \ è®¡ç®—æŒ‡æ ‡\n        ev = calculate_ev(pw, max_profit, max_loss)\n        rar\
          \ = calculate_rar(ev, max_loss)\n        \n        scenario_match, match_reason\
          \ = calculate_scenario_match(\n            strategy.get(\"strategy_type\"\
          , \"\"),\n            primary_scenario,\n            scenario_probability\n\
          \        )\n        \n        liquidity_pass, liquidity_note = check_liquidity(strategy,\
          \ spot, em1)\n        \n        # ç»¼åˆè¯„åˆ†\n        score = 0\n        \n  \
          \      # EV è¯„åˆ† (40åˆ†)\n        if ev > 0.5:\n            score += 40\n  \
          \      elif ev > 0.2:\n            score += 30\n        elif ev > 0:\n \
          \           score += 20\n        \n        # RAR è¯„åˆ† (30åˆ†)\n        if rar\
          \ > 0.3:\n            score += 30\n        elif rar > 0.15:\n          \
          \  score += 25\n        elif rar > 0.05:\n            score += 15\n    \
          \    \n        # å‰§æœ¬åŒ¹é… (20åˆ†)\n        if scenario_match == \"é«˜\":\n     \
          \       score += 20\n        elif scenario_match == \"ä¸­\":\n           \
          \ score += 10\n        \n        # æµåŠ¨æ€§ (10åˆ†)\n        if liquidity_pass:\n\
          \            score += 10\n        \n        ranked.append({\n          \
          \  \"strategy\": strategy,\n            \"ev\": round(ev, 2),\n        \
          \    \"rar\": round(rar, 3),\n            \"pw\": pw,\n            \"scenario_match\"\
          : scenario_match,\n            \"match_reason\": match_reason,\n       \
          \     \"liquidity_pass\": liquidity_pass,\n            \"liquidity_note\"\
          : liquidity_note,\n            \"composite_score\": score\n        })\n\
          \    \n    # æ’åº\n    ranked.sort(key=lambda x: x[\"composite_score\"], reverse=True)\n\
          \    \n    for i, item in enumerate(ranked):\n        item[\"rank\"] = i\
          \ + 1\n    \n    return ranked\n\ndef main(strategies_output: dict, scenario_output:\
          \ dict, \n               agent3_output: dict, **env_vars) -> dict:\n   \
          \ try:\n        strategies = strategies_output.get(\"strategies\", [])\n\
          \        spot = agent3_output.get(\"spot_price\", 0)\n        em1 = agent3_output.get(\"\
          em1_dollar\", 0)\n        \n        scenario_class = scenario_output.get(\"\
          scenario_classification\", {})\n        primary_scenario = scenario_class.get(\"\
          primary_scenario\", \"\")\n        scenario_probability = scenario_class.get(\"\
          scenario_probability\", 0)\n        \n        ranked = rank_strategies(\n\
          \            strategies, \n            primary_scenario, \n            scenario_probability,\
          \ \n            spot, \n            em1\n        )\n        \n        #\
          \ âœ… å…³é”®æ”¹åŠ¨ï¼šæ‰å¹³åŒ–è¾“å‡ºï¼Œæå–ç¬¬ä¸€åçš„å…³é”®æŒ‡æ ‡\n        top1 = ranked[0] if ranked else {}\n\
          \        top2 = ranked[1] if len(ranked) > 1 else {}\n        top3 = ranked[2]\
          \ if len(ranked) > 2 else {}\n        \n        return {\"result\": {\n\
          \            # åŸºç¡€ä¿¡æ¯\n            \"symbol\": agent3_output.get(\"symbol\"\
          , \"\"),\n            \"total_strategies\": len(strategies),\n         \
          \   \"positive_ev_count\": sum(1 for r in ranked if r[\"ev\"] > 0),\n  \
          \          \"analysis_timestamp\": datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\"\
          ),\n            \n            # Top1 ç­–ç•¥ï¼ˆæ‰å¹³åŒ–ï¼‰\n            \"top1_rank\"\
          : top1.get(\"rank\", 0),\n            \"top1_strategy_type\": top1.get(\"\
          strategy\", {}).get(\"strategy_type\", \"\"),\n            \"top1_structure\"\
          : top1.get(\"strategy\", {}).get(\"structure\", \"\"),\n            \"top1_ev\"\
          : top1.get(\"ev\", 0),\n            \"top1_rar\": top1.get(\"rar\", 0),\n\
          \            \"top1_pw\": top1.get(\"pw\", 0),\n            \"top1_scenario_match\"\
          : top1.get(\"scenario_match\", \"\"),\n            \"top1_match_reason\"\
          : top1.get(\"match_reason\", \"\"),\n            \"top1_liquidity_pass\"\
          : top1.get(\"liquidity_pass\", False),\n            \"top1_liquidity_note\"\
          : top1.get(\"liquidity_note\", \"\"),\n            \"top1_composite_score\"\
          : top1.get(\"composite_score\", 0),\n            \n            # Top2 ç­–ç•¥ï¼ˆæ‰å¹³åŒ–ï¼‰\n\
          \            \"top2_rank\": top2.get(\"rank\", 0),\n            \"top2_strategy_type\"\
          : top2.get(\"strategy\", {}).get(\"strategy_type\", \"\"),\n           \
          \ \"top2_structure\": top2.get(\"strategy\", {}).get(\"structure\", \"\"\
          ),\n            \"top2_ev\": top2.get(\"ev\", 0),\n            \"top2_rar\"\
          : top2.get(\"rar\", 0),\n            \"top2_composite_score\": top2.get(\"\
          composite_score\", 0),\n            \n            # Top3 ç­–ç•¥ï¼ˆæ‰å¹³åŒ–ï¼‰\n     \
          \       \"top3_rank\": top3.get(\"rank\", 0),\n            \"top3_strategy_type\"\
          : top3.get(\"strategy\", {}).get(\"strategy_type\", \"\"),\n           \
          \ \"top3_structure\": top3.get(\"strategy\", {}).get(\"structure\", \"\"\
          ),\n            \"top3_ev\": top3.get(\"ev\", 0),\n            \"top3_rar\"\
          : top3.get(\"rar\", 0),\n            \"top3_composite_score\": top3.get(\"\
          composite_score\", 0),\n            \n            # å®Œæ•´æ’åºåˆ—è¡¨ï¼ˆåºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ï¼‰\n\
          \            \"ranking_json\": json.dumps(ranked, ensure_ascii=False)\n\
          \        }}\n        \n    except Exception as e:\n        return {\"result\"\
          : {\n            \"error\": True,\n            \"error_message\": str(e)\n\
          \        }}"
        code_language: python3
        desc: ç­–ç•¥å¯¹æ¯”é‡åŒ–è®¡ç®—å¼•æ“
        outputs:
          result:
            children: null
            type: string
        selected: false
        title: ' CODE4 ç­–ç•¥å¯¹æ¯”è®¡ç®—'
        type: code
        variables:
        - value_selector:
          - '6001'
          - structured_output
          - strategies
          value_type: object
          variable: strategies_output
        - value_selector:
          - '5001'
          - structured_output
          value_type: object
          variable: scenario_output
        - value_selector:
          - '3001'
          - structured_output
          value_type: object
          variable: agent3_output
      height: 80
      id: '1008'
      position:
        x: 3086.726501466131
        y: 107.40802282053434
      positionAbsolute:
        x: 3086.726501466131
        y: 107.40802282053434
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nfrom datetime import datetime\nfrom typing import Dict,\
          \ List, Tuple, Any\n\ndef main(agent3_output: dict,\n         first_parse_data:\
          \ str = \"\",\n         current_symbol: str = \"\",\n         data_status:\
          \ str = \"initial\",\n         **env_vars) -> dict:\n    \"\"\"\n    æ•°æ®èšåˆèŠ‚ç‚¹\
          \ v5 - å¢é‡åˆå¹¶ä¼˜åŒ–ç‰ˆ\n    \n    æ ¸å¿ƒæ”¹è¿›:\n    1. æ™ºèƒ½å¢é‡åˆå¹¶ï¼šå¤šæ¬¡ä¸Šä¼ è‡ªåŠ¨ç´¯ç§¯æ•°æ®\n    2. å­—æ®µçº§è¿½è¸ªï¼šè®°å½•æ¯ä¸ªå­—æ®µçš„æ¥æºå’Œè´¨é‡\n\
          \    3. é˜²æ­¢è¦†ç›–ï¼šæœ‰æ•ˆæ•°æ®ä¸ä¼šè¢«æ— æ•ˆæ•°æ®è¦†ç›–\n    4. è‡ªåŠ¨å®Œæˆï¼šè¾¾åˆ° 22/22 è‡ªåŠ¨è¿›å…¥åˆ†ææµç¨‹\n    \"\"\"\n\
          \    try:\n        \n        current_data = agent3_output\n        # \U0001F525\
          \ è°ƒè¯•æ—¥å¿— 1: æ£€æŸ¥è¾“å…¥æ•°æ®\n        print(f\"\U0001F4E5 è¾“å…¥æ•°æ®ç±»å‹: {type(current_data)}\"\
          )\n        print(f\"\U0001F4E5 targets ç±»å‹: {type(current_data.get('targets'))}\"\
          )\n        print(f\"\U0001F4E5 targets å†…å®¹é¢„è§ˆ: {str(current_data.get('targets'))[:200]}\"\
          )\n        \n        symbol = extract_symbol(current_data)\n        current_status\
          \ = current_data.get(\"status\", \"missing_data\")\n        \n        is_accumulation_mode,\
          \ judgment = judge_accumulation_mode(\n            current_data=current_data,\n\
          \            cached_first_data=first_parse_data,\n            cached_symbol=current_symbol,\n\
          \            cached_status=data_status\n        )\n        \n        print(f\"\
          \U0001F4CA ç´¯ç§¯æ¨¡å¼: {is_accumulation_mode}, åŸå› : {judgment}\")\n        \n \
          \       if is_accumulation_mode:\n            if not first_parse_data:\n\
          \                merged_data = current_data\n                merge_history\
          \ = [{\n                    \"round\": 1,\n                    \"timestamp\"\
          : datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\"),\n                    \"\
          fields_added\": count_valid_fields(current_data),\n                    \"\
          action\": \"é¦–æ¬¡è§£æ\"\n                }]\n                last_merge_failed\
          \ = False\n            else:\n                first_data = json.loads(first_parse_data)\n\
          \                \n                # \U0001F525 è°ƒè¯•æ—¥å¿— 2: åˆå¹¶å‰çš„æ•°æ®ç»Ÿè®¡\n     \
          \           first_count = count_valid_fields(first_data)\n             \
          \   new_count = count_valid_fields(current_data)\n                print(f\"\
          \U0001F4CA åˆå¹¶å‰: ç¼“å­˜æ•°æ® {first_count} ä¸ªå­—æ®µ, æ–°æ•°æ® {new_count} ä¸ªå­—æ®µ\")\n       \
          \         \n                merged_data, merge_info = smart_merge(first_data,\
          \ current_data)\n                \n                # \U0001F525 è°ƒè¯•æ—¥å¿— 3:\
          \ åˆå¹¶åçš„ç»“æœ\n                merged_count = count_valid_fields(merged_data)\n\
          \                print(f\"\U0001F4CA åˆå¹¶å: {merged_count} ä¸ªå­—æ®µ\")\n      \
          \          print(f\"\U0001F4CA æ–°å¢: {merge_info['new_fields_count']}, æ›´æ–°:\
          \ {merge_info['updated_fields_count']}\")\n                \n          \
          \      # æ›´æ–°åˆå¹¶å†å²\n                history = first_data.get(\"_merge_history\"\
          , [])\n                history.append({\n                    \"round\":\
          \ len(history) + 1,\n                    \"timestamp\": datetime.now().strftime(\"\
          %Y-%m-%d %H:%M:%S\"),\n                    \"fields_added\": merge_info[\"\
          new_fields_count\"],\n                    \"fields_updated\": merge_info.get(\"\
          updated_fields_count\", 0),\n                    \"action\": \"å¢é‡è¡¥é½\" if\
          \ not merge_info.get(\"merge_failed\") else \"åˆå¹¶å¤±è´¥\",\n                \
          \    \"failure_reason\": merge_info.get(\"failure_reason\", \"\")\n    \
          \            })\n                merged_data[\"_merge_history\"] = history\n\
          \                merge_history = history\n                last_merge_failed\
          \ = merge_info.get(\"merge_failed\", False)\n        else:\n           \
          \ # æ–°ä»»åŠ¡\n            merged_data = current_data\n            merge_history\
          \ = [{\n                \"round\": 1,\n                \"timestamp\": datetime.now().strftime(\"\
          %Y-%m-%d %H:%M:%S\"),\n                \"fields_added\": count_valid_fields(current_data),\n\
          \                \"action\": \"æ–°ä»»åŠ¡å¼€å§‹\"\n            }]\n            last_merge_failed\
          \ = False\n        \n        # éªŒè¯\n        validation_result = enhanced_validation_v2(merged_data)\n\
          \        \n        # \U0001F525 è°ƒè¯•æ—¥å¿— 4: éªŒè¯ç»“æœ\n        print(f\"âœ… éªŒè¯ç»“æœ: å®Œæˆç‡\
          \ {validation_result['summary']['completion_rate']}%\")\n        print(f\"\
          âœ… æä¾›å­—æ®µ: {validation_result['summary']['provided']}/{validation_result['summary']['total_required']}\"\
          )\n        \n        if not isinstance(current_data, dict):\n          \
          \  raise ValueError(f\"agent3_output ç±»å‹é”™è¯¯: {type(current_data)}\")\n   \
          \     \n        # æå–å½“å‰æ•°æ®\n        symbol = extract_symbol(current_data)\n\
          \        current_status = current_data.get(\"status\", \"missing_data\"\
          )\n        \n        # === æ ¸å¿ƒä¼˜åŒ– 1: æ™ºèƒ½åˆ¤æ–­æ˜¯å¦ç´¯ç§¯æ¨¡å¼ ===\n        is_accumulation_mode,\
          \ judgment = judge_accumulation_mode(\n            current_data=current_data,\n\
          \            cached_first_data=first_parse_data,\n            cached_symbol=current_symbol,\n\
          \            cached_status=data_status\n        )\n        \n        if\
          \ is_accumulation_mode:\n            # === æ ¸å¿ƒä¼˜åŒ– 2: å¢é‡åˆå¹¶ ===\n          \
          \  if not first_parse_data:\n                # ç¬¬ä¸€æ¬¡ä¸Šä¼ \n                merged_data\
          \ = current_data\n                merge_history = [{\n                 \
          \   \"round\": 1,\n                    \"timestamp\": datetime.now().strftime(\"\
          %Y-%m-%d %H:%M:%S\"),\n                    \"fields_added\": count_valid_fields(current_data),\n\
          \                    \"action\": \"é¦–æ¬¡è§£æ\"\n                }]\n        \
          \    else:\n                # ç¬¬ N æ¬¡ä¸Šä¼  - æ‰§è¡Œå¢é‡åˆå¹¶\n                first_data\
          \ = json.loads(first_parse_data)\n                merged_data, merge_info\
          \ = smart_merge(first_data, current_data)\n                \n          \
          \      # æ›´æ–°åˆå¹¶å†å²\n                history = first_data.get(\"_merge_history\"\
          , [])\n                history.append({\n                    \"round\":\
          \ len(history) + 1,\n                    \"timestamp\": datetime.now().strftime(\"\
          %Y-%m-%d %H:%M:%S\"),\n                    \"fields_added\": merge_info[\"\
          new_fields_count\"],\n                    \"fields_updated\": merge_info[\"\
          updated_fields_count\"],\n                    \"action\": \"å¢é‡è¡¥é½\"\n   \
          \             })\n                merged_data[\"_merge_history\"] = history\n\
          \                merge_history = history\n        else:\n            # æ–°ä»»åŠ¡ï¼ˆSymbol\
          \ å˜åŒ–ï¼‰\n            merged_data = current_data\n            merge_history\
          \ = [{\n                \"round\": 1,\n                \"timestamp\": datetime.now().strftime(\"\
          %Y-%m-%d %H:%M:%S\"),\n                \"fields_added\": count_valid_fields(current_data),\n\
          \                \"action\": \"æ–°ä»»åŠ¡å¼€å§‹\"\n            }]\n        \n     \
          \   # === æ ¸å¿ƒä¼˜åŒ– 3: ä¸‰çº§éªŒè¯ï¼ˆåŸºäºåˆå¹¶åçš„æ•°æ®ï¼‰===\n        validation_result = enhanced_validation_v2(merged_data)\n\
          \        \n        # æ›´æ–°çŠ¶æ€\n        if validation_result[\"is_complete\"\
          ]:\n            final_status = \"ready\"\n            merged_data[\"status\"\
          ] = \"data_ready\"\n        else:\n            final_status = \"awaiting_data\"\
          \n            merged_data[\"status\"] = \"missing_data\"\n        \n   \
          \     # ç”Ÿæˆè¡¥é½æŒ‡å¼•ï¼ˆåŸºäºå®é™…ç¼ºå¤±å­—æ®µï¼‰\n        missing_fields = validation_result[\"\
          missing_fields\"]\n        è¡¥é½æŒ‡å¼• = generate_smart_guide(\n            missing_fields=missing_fields,\n\
          \            merge_history=merge_history,\n            total_fields=22\n\
          \        )\n        \n        # === æ ¸å¿ƒä¼˜åŒ– 4: è¿”å›ç»“æ„åŒ–çš„è¾“å‡º ===\n        result_data\
          \ = {\n            **merged_data,\n            \"validation_summary\": validation_result[\"\
          summary\"],\n            \"åˆ¤æ–­ä¾æ®\": judgment,\n            \"_merge_history\"\
          : merge_history\n        }\n        \n        return {\n            \"result\"\
          : json.dumps(result_data, ensure_ascii=False, indent=2),\n            \n\
          \            # ä¼šè¯å˜é‡\n            \"first_parse_data\": json.dumps(merged_data,\
          \ ensure_ascii=False) if final_status == \"awaiting_data\" else \"\",\n\
          \            \"current_symbol\": symbol,\n            \"data_status\": final_status,\n\
          \            \"missing_count\": len(missing_fields),\n            \n   \
          \         # è¡¥é½æŒ‡å¼•ï¼ˆæ‰å¹³åŒ–è¾“å‡ºï¼‰\n            \"user_guide_summary\": è¡¥é½æŒ‡å¼•.get(\"\
          summary\", \"\"),\n            \"user_guide_commands\": è¡¥é½æŒ‡å¼•.get(\"commands_text\"\
          , \"\"),\n            \"user_guide_progress\": è¡¥é½æŒ‡å¼•.get(\"progress\", \"\
          \"),\n            \"user_guide_priority_critical\": è¡¥é½æŒ‡å¼•.get(\"critical_text\"\
          , \"\"),\n            \"user_guide_priority_high\": è¡¥é½æŒ‡å¼•.get(\"high_text\"\
          , \"\"),\n            \"user_guide_priority_medium\": è¡¥é½æŒ‡å¼•.get(\"medium_text\"\
          , \"\"),\n            \"user_guide_next_action\": è¡¥é½æŒ‡å¼•.get(\"next_action\"\
          , \"\"),\n            \"user_guide_merge_log\": è¡¥é½æŒ‡å¼•.get(\"merge_log\",\
          \ \"\")\n        }\n    \n    except Exception as e:\n        import traceback\n\
          \        return {\n            \"result\": json.dumps({\n              \
          \  \"error\": True,\n                \"error_message\": str(e),\n      \
          \          \"error_traceback\": traceback.format_exc()\n            }, ensure_ascii=False,\
          \ indent=2),\n            \"first_parse_data\": first_parse_data,\n    \
          \        \"current_symbol\": current_symbol,\n            \"data_status\"\
          : \"error\",\n            \"missing_count\": 0,\n            \"user_guide_summary\"\
          : f\"âš ï¸ ç³»ç»Ÿé”™è¯¯: {str(e)}\",\n            \"user_guide_commands\": \"\",\n\
          \            \"user_guide_progress\": \"\",\n            \"user_guide_priority_critical\"\
          : \"\",\n            \"user_guide_priority_high\": \"\",\n            \"\
          user_guide_priority_medium\": \"\",\n            \"user_guide_next_action\"\
          : \"è¯·æ£€æŸ¥æ•°æ®åé‡è¯•\",\n            \"user_guide_merge_log\": \"\"\n        }\n\
          \n\n# ============= æ ¸å¿ƒå‡½æ•° 1: æ™ºèƒ½åˆ¤æ–­ç´¯ç§¯æ¨¡å¼ =============\n\ndef judge_accumulation_mode(current_data:\
          \ dict,\n                            cached_first_data: str,\n         \
          \                   cached_symbol: str,\n                            cached_status:\
          \ str) -> Tuple[bool, str]:\n    \"\"\"\n    åˆ¤æ–­æ˜¯å¦è¿›å…¥ç´¯ç§¯æ¨¡å¼ï¼ˆå¢é‡è¡¥é½ï¼‰\n    \n  \
          \  Returns:\n        (is_accumulation, reason)\n    \"\"\"\n    # æƒ…å†µ 1:\
          \ æ— ç¼“å­˜ â†’ é¦–æ¬¡è§£æ\n    if not cached_first_data or cached_status == \"initial\"\
          :\n        return True, \"é¦–æ¬¡ä¸Šä¼ ,å¼€å§‹è§£æ\"\n    \n    # æƒ…å†µ 2: Symbol å˜åŒ– â†’ æ–°ä»»åŠ¡\n\
          \    current_symbol = extract_symbol(current_data)\n    if current_symbol\
          \ != cached_symbol:\n        return False, f\"Symbol å˜åŒ–({cached_symbol}â†’{current_symbol}),å¼€å§‹æ–°ä»»åŠ¡\"\
          \n    \n    # æƒ…å†µ 3: ç¼“å­˜çŠ¶æ€ä¸º ready â†’ å·²å®Œæˆ,ä¸å†ç´¯ç§¯\n    if cached_status == \"ready\"\
          :\n        return False, \"æ•°æ®å·²å®Œæ•´,å¼€å§‹æ–°ä»»åŠ¡\"\n    \n    # æƒ…å†µ 4: ç¼“å­˜ç­‰å¾…è¡¥é½ â†’ ç´¯ç§¯æ¨¡å¼\n\
          \    if cached_status == \"awaiting_data\":\n        return True, \"æ£€æµ‹åˆ°å†å²ç¼“å­˜,è¿›å…¥å¢é‡è¡¥é½æ¨¡å¼\"\
          \n    \n    # é»˜è®¤: ç´¯ç§¯æ¨¡å¼\n    return True, \"è¿›å…¥ç´¯ç§¯æ¨¡å¼\"\n\n\n# =============\
          \ æ ¸å¿ƒå‡½æ•° 2: æ™ºèƒ½åˆå¹¶ç®—æ³• =============\n\ndef smart_merge(first_data: dict, new_data:\
          \ dict) -> Tuple[dict, dict]:\n    \"\"\"\n    æ™ºèƒ½å¢é‡åˆå¹¶ï¼ˆå¢å¼ºç‰ˆï¼‰\n    \n    æ–°å¢ç‰¹æ€§:\n\
          \    1. æ£€æµ‹æ–°æ•°æ®æ˜¯å¦ä¸ºç©º\n    2. å¦‚æœæ–°æ•°æ®ä¸ºç©ºï¼Œç›´æ¥è¿”å›æ—§æ•°æ®ï¼ˆä¸åˆå¹¶ï¼‰\n    3. è®°å½•åˆå¹¶å¤±è´¥çš„åŸå› \n    \"\
          \"\"\n    merged = first_data.copy()\n    \n    # æå– targets\n    first_targets\
          \ = get_target_dict(first_data)\n    new_targets = get_target_dict(new_data)\n\
          \    \n    # \U0001F525 æ ¸å¿ƒä¿®å¤ï¼šæ£€æµ‹æ–°æ•°æ®æ˜¯å¦ä¸ºç©º\n    new_valid_count = count_valid_fields_in_dict(new_targets)\n\
          \    \n    if new_valid_count == 0:\n        # æ–°æ•°æ®ä¸ºç©ºï¼Œä¸æ‰§è¡Œåˆå¹¶\n        print(\"\
          âš ï¸ è­¦å‘Š: æ–°æ•°æ®æ— æœ‰æ•ˆå­—æ®µï¼Œè·³è¿‡åˆå¹¶\")\n        merge_info = {\n            \"new_fields_count\"\
          : 0,\n            \"updated_fields_count\": 0,\n            \"merge_failed\"\
          : True,\n            \"failure_reason\": \"æ–°æ•°æ®æ— æœ‰æ•ˆå­—æ®µï¼ˆå¯èƒ½è§£æå¤±è´¥ï¼‰\"\n        }\n\
          \        return merged, merge_info  # è¿”å›åŸæ•°æ®\n    \n    # ç»Ÿè®¡ä¿¡æ¯\n    new_fields_count\
          \ = 0\n    updated_fields_count = 0\n    \n    # åˆå¹¶å„ä¸ª section\n    for section\
          \ in [\"gamma_metrics\", \"directional_metrics\", \"atm_iv\", \"walls\"\
          ]:\n        if section not in first_targets:\n            first_targets[section]\
          \ = {}\n        \n        if section in new_targets:\n            for key,\
          \ new_value in new_targets[section].items():\n                old_value\
          \ = first_targets[section].get(key)\n                \n                if\
          \ is_valid_value(new_value):\n                    if not is_valid_value(old_value):\n\
          \                        first_targets[section][key] = new_value\n     \
          \                   new_fields_count += 1\n                    elif old_value\
          \ != new_value:\n                        first_targets[section][key] = new_value\n\
          \                        updated_fields_count += 1\n    \n    # åˆå¹¶é¡¶å±‚å­—æ®µ\n\
          \    for key in [\"spot_price\", \"em1_dollar\", \"symbol\"]:\n        old_value\
          \ = first_targets.get(key)\n        new_value = new_targets.get(key)\n \
          \       \n        if is_valid_value(new_value):\n            if not is_valid_value(old_value):\n\
          \                first_targets[key] = new_value\n                new_fields_count\
          \ += 1\n            elif old_value != new_value:\n                first_targets[key]\
          \ = new_value\n                updated_fields_count += 1\n    \n    # \U0001F525\
          \ ä¿®å¤ï¼šå¦‚æœæ²¡æœ‰ä»»ä½•æ–°å¢æˆ–æ›´æ–°ï¼Œæ ‡è®°ä¸ºå¤±è´¥\n    if new_fields_count == 0 and updated_fields_count\
          \ == 0:\n        print(\"âš ï¸ è­¦å‘Š: åˆå¹¶æœªäº§ç”Ÿä»»ä½•å˜åŒ–ï¼Œå¯èƒ½æ•°æ®é‡å¤æˆ–è§£æå¤±è´¥\")\n        merge_info\
          \ = {\n            \"new_fields_count\": 0,\n            \"updated_fields_count\"\
          : 0,\n            \"merge_failed\": True,\n            \"failure_reason\"\
          : \"æ— æ–°å¢æˆ–æ›´æ–°å­—æ®µ\"\n        }\n        return merged, merge_info\n    \n   \
          \ # åˆå¹¶ indices\n    if \"indices\" not in merged:\n        merged[\"indices\"\
          ] = {}\n    \n    if \"indices\" in new_data:\n        for index_name in\
          \ [\"spx\", \"qqq\"]:\n            if index_name in new_data[\"indices\"\
          ]:\n                if index_name not in merged[\"indices\"]:\n        \
          \            merged[\"indices\"][index_name] = {}\n                \n  \
          \              for key, new_value in new_data[\"indices\"][index_name].items():\n\
          \                    old_value = merged[\"indices\"][index_name].get(key)\n\
          \                    if is_valid_value(new_value) and not is_valid_value(old_value):\n\
          \                        merged[\"indices\"][index_name][key] = new_value\n\
          \    \n    # åˆå¹¶æŠ€æœ¯é¢æ•°æ®\n    if \"technical_analysis\" in new_data:\n     \
          \   ta = new_data[\"technical_analysis\"]\n        if ta and ta.get(\"ta_score\"\
          , 0) > 0:\n            merged[\"technical_analysis\"] = ta\n    \n    #\
          \ æ›´æ–° targets\n    merged[\"targets\"] = first_targets\n    \n    merge_info\
          \ = {\n        \"new_fields_count\": new_fields_count,\n        \"updated_fields_count\"\
          : updated_fields_count,\n        \"merge_failed\": False\n    }\n    \n\
          \    return merged, merge_info\n\n\ndef count_valid_fields_in_dict(target_dict:\
          \ dict) -> int:\n    \"\"\"ç»Ÿè®¡å­—å…¸ä¸­çš„æœ‰æ•ˆå­—æ®µæ•°é‡\"\"\"\n    count = 0\n    \n   \
          \ for section in [\"gamma_metrics\", \"directional_metrics\", \"atm_iv\"\
          , \"walls\"]:\n        if section in target_dict and isinstance(target_dict[section],\
          \ dict):\n            for value in target_dict[section].values():\n    \
          \            if is_valid_value(value):\n                    count += 1\n\
          \    \n    for key in [\"spot_price\", \"em1_dollar\"]:\n        if is_valid_value(target_dict.get(key)):\n\
          \            count += 1\n    \n    return count\n\n\ndef is_valid_value(value:\
          \ Any) -> bool:\n    \"\"\"åˆ¤æ–­å€¼æ˜¯å¦æœ‰æ•ˆï¼ˆéç¼ºå¤±ï¼‰\"\"\"\n    if value is None:\n \
          \       return False\n    if value == -999:\n        return False\n    if\
          \ value in [\"N/A\", \"æ•°æ®ä¸è¶³\", \"\", \"unknown\"]:\n        return False\n\
          \    return True\n\n\ndef get_target_dict(data: dict) -> dict:\n    \"\"\
          \"\n    æå– targets å­—å…¸ï¼ˆå¢å¼ºé˜²å¾¡æ€§ï¼‰\n    \n    è¿”å›ä¼˜å…ˆçº§:\n    1. å¦‚æœ targets æ˜¯éç©ºå­—å…¸\
          \ â†’ ç›´æ¥è¿”å›\n    2. å¦‚æœ targets æ˜¯éç©ºåˆ—è¡¨ â†’ è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ \n    3. å¦‚æœ targets ä¸ºç©ºæˆ–ç¼ºå¤± â†’ è¿”å›ç©ºå­—å…¸ï¼ˆä½†ä¼šåœ¨æ—¥å¿—ä¸­è­¦å‘Šï¼‰\n\
          \    \"\"\"\n    targets = data.get(\"targets\")\n    \n    # æƒ…å†µ 1: None\
          \ æˆ–ç¼ºå¤±\n    if targets is None:\n        print(\"âš ï¸ è­¦å‘Š: targets å­—æ®µç¼ºå¤±\")\n\
          \        return {}\n    \n    # æƒ…å†µ 2: ç©ºåˆ—è¡¨\n    if isinstance(targets, list):\n\
          \        if not targets:  # ç©ºåˆ—è¡¨\n            print(\"âš ï¸ è­¦å‘Š: targets æ˜¯ç©ºåˆ—è¡¨\"\
          )\n            return {}\n        return targets[0]\n    \n    # æƒ…å†µ 3: å­—å…¸\n\
          \    if isinstance(targets, dict):\n        if not targets:  # ç©ºå­—å…¸\n   \
          \         print(\"âš ï¸ è­¦å‘Š: targets æ˜¯ç©ºå­—å…¸\")\n        return targets\n    \n\
          \    # æƒ…å†µ 4: å…¶ä»–ç±»å‹ï¼ˆå¼‚å¸¸ï¼‰\n    print(f\"âŒ é”™è¯¯: targets ç±»å‹å¼‚å¸¸ - {type(targets)}\"\
          )\n    return {}\n\n\n# ============= æ ¸å¿ƒå‡½æ•° 3: å¢å¼ºéªŒè¯ v2 =============\n\n\
          def enhanced_validation_v2(data: dict) -> dict:\n    \"\"\"\n    ä¸‰çº§éªŒè¯å¢å¼ºç‰ˆï¼ˆåŸºäºåˆå¹¶åçš„æ•°æ®ï¼‰\n\
          \    \n    Returns:\n        {\n            \"is_complete\": bool,\n   \
          \         \"missing_fields\": list,\n            \"summary\": dict\n   \
          \     }\n    \"\"\"\n    target = get_target_dict(data)\n    \n    # 22\
          \ ä¸ªå¿…éœ€å­—æ®µ\n    required_fields = {\n        # é¡¶å±‚å­—æ®µ\n        \"spot_price\"\
          : (target, \"spot_price\"),\n        \"em1_dollar\": (target, \"em1_dollar\"\
          ),\n        \n        # walls\n        \"walls.call_wall\": (target.get(\"\
          walls\", {}), \"call_wall\"),\n        \"walls.put_wall\": (target.get(\"\
          walls\", {}), \"put_wall\"),\n        \"walls.major_wall\": (target.get(\"\
          walls\", {}), \"major_wall\"),\n        \"walls.major_wall_type\": (target.get(\"\
          walls\", {}), \"major_wall_type\"),\n        \n        # gamma_metrics\n\
          \        \"gamma_metrics.gap_distance_dollar\": (target.get(\"gamma_metrics\"\
          , {}), \"gap_distance_dollar\"),\n        \"gamma_metrics.gap_distance_em1_multiple\"\
          : (target.get(\"gamma_metrics\", {}), \"gap_distance_em1_multiple\"),\n\
          \        \"gamma_metrics.cluster_strength_ratio\": (target.get(\"gamma_metrics\"\
          , {}), \"cluster_strength_ratio\"),\n        \"gamma_metrics.net_gex\":\
          \ (target.get(\"gamma_metrics\", {}), \"net_gex\"),\n        \"gamma_metrics.net_gex_sign\"\
          : (target.get(\"gamma_metrics\", {}), \"net_gex_sign\"),\n        \"gamma_metrics.vol_trigger\"\
          : (target.get(\"gamma_metrics\", {}), \"vol_trigger\"),\n        \"gamma_metrics.spot_vs_trigger\"\
          : (target.get(\"gamma_metrics\", {}), \"spot_vs_trigger\"),\n        \"\
          gamma_metrics.monthly_cluster_override\": (target.get(\"gamma_metrics\"\
          , {}), \"monthly_cluster_override\"),\n        \n        # directional_metrics\n\
          \        \"directional_metrics.dex_same_dir_pct\": (target.get(\"directional_metrics\"\
          , {}), \"dex_same_dir_pct\"),\n        \"directional_metrics.vanna_dir\"\
          : (target.get(\"directional_metrics\", {}), \"vanna_dir\"),\n        \"\
          directional_metrics.vanna_confidence\": (target.get(\"directional_metrics\"\
          , {}), \"vanna_confidence\"),\n        \"directional_metrics.iv_path\":\
          \ (target.get(\"directional_metrics\", {}), \"iv_path\"),\n        \"directional_metrics.iv_path_confidence\"\
          : (target.get(\"directional_metrics\", {}), \"iv_path_confidence\"),\n \
          \       \n        # atm_iv\n        \"atm_iv.iv_7d\": (target.get(\"atm_iv\"\
          , {}), \"iv_7d\"),\n        \"atm_iv.iv_14d\": (target.get(\"atm_iv\", {}),\
          \ \"iv_14d\"),\n        \"atm_iv.iv_source\": (target.get(\"atm_iv\", {}),\
          \ \"iv_source\"),\n    }\n    \n    # æ£€æŸ¥ç¼ºå¤±å­—æ®µ\n    missing_fields = []\n\
          \    for field_path, (parent_dict, key) in required_fields.items():\n  \
          \      value = parent_dict.get(key) if isinstance(parent_dict, dict) else\
          \ None\n        if not is_valid_value(value):\n            missing_fields.append({\n\
          \                \"field\": field_path,\n                \"current_value\"\
          : value\n            })\n    \n    total_required = len(required_fields)\n\
          \    provided = total_required - len(missing_fields)\n    completion_rate\
          \ = int((provided / total_required) * 100)\n    \n    is_complete = len(missing_fields)\
          \ == 0\n    \n    return {\n        \"is_complete\": is_complete,\n    \
          \    \"missing_fields\": missing_fields,\n        \"summary\": {\n     \
          \       \"total_required\": total_required,\n            \"provided\": provided,\n\
          \            \"missing_count\": len(missing_fields),\n            \"completion_rate\"\
          : completion_rate\n        }\n    }\n\n\n# ============= æ ¸å¿ƒå‡½æ•° 4: æ™ºèƒ½æŒ‡å¼•ç”Ÿæˆ\
          \ =============\n\ndef generate_smart_guide(missing_fields: list,\n    \
          \                     merge_history: list,\n                         total_fields:\
          \ int,\n                         last_merge_failed: bool = False) -> dict:\n\
          \    \"\"\"\n    ç”Ÿæˆæ™ºèƒ½è¡¥é½æŒ‡å¼•\n    \n    æ–°å¢ç‰¹æ€§:\n    1. æ˜¾ç¤ºç´¯ç§¯è¿›åº¦\n    2. æ˜¾ç¤ºåˆå¹¶å†å²\n\
          \    3. ä¼˜å…ˆçº§åŠ¨æ€è°ƒæ•´\n    \"\"\"\n    if not missing_fields:\n        return\
          \ {\n            \"summary\": \"âœ… æ•°æ®å®Œæ•´,æ— éœ€è¡¥é½\",\n            \"commands_text\"\
          : \"æ— \",\n            \"progress\": f\"100% ({total_fields}/{total_fields})\"\
          ,\n            \"critical_text\": \"æ— \",\n            \"high_text\": \"\
          æ— \",\n            \"medium_text\": \"æ— \",\n            \"next_action\":\
          \ \"è¿›å…¥åˆ†ææµç¨‹\",\n            \"merge_log\": format_merge_history(merge_history)\n\
          \        }\n    \n    provided_count = total_fields - len(missing_fields)\n\
          \    progress = f\"{int((provided_count/total_fields)*100)}% ({provided_count}/{total_fields})\"\
          \n\n    warning = \"\"\n    if last_merge_failed:\n        warning = \"\\\
          n\\nâš ï¸ **è­¦å‘Š**: ä¸Šæ¬¡ä¸Šä¼ çš„æ•°æ®æœªèƒ½æˆåŠŸè¯†åˆ«ï¼Œè¯·ç¡®ä¿ï¼š\\n\" \\\n                  \"1. å›¾ç‰‡æ¸…æ™°å®Œæ•´\\\
          n\" \\\n                  \"2. åŒ…å«ç›®æ ‡è‚¡ç¥¨çš„æœŸæƒæ•°æ®\\n\" \\\n                  \"\
          3. å‘½ä»¤æ‰§è¡Œç»“æœå®Œæ•´æ˜¾ç¤º\"\n    \n    # æ ¹æ®å­—æ®µè·¯å¾„ç”Ÿæˆå‘½ä»¤å»ºè®®\n    commands = []\n    priority_groups\
          \ = {\"critical\": [], \"high\": [], \"medium\": []}\n    \n    for item\
          \ in missing_fields:\n        field_path = item[\"field\"]\n        cmd_info\
          \ = suggest_command(field_path)\n        \n        priority = cmd_info[\"\
          priority\"]\n        priority_groups[priority].append({\n            \"\
          å­—æ®µ\": field_path,\n            \"å‘½ä»¤\": cmd_info[\"command\"],\n        \
          \    \"è¯´æ˜\": cmd_info[\"description\"]\n        })\n        \n        if\
          \ cmd_info[\"command\"] not in commands:\n            commands.append(cmd_info[\"\
          command\"])\n    \n    # æ ¼å¼åŒ–è¾“å‡º\n    return {\n        \"summary\": f\"âŒ\
          \ å½“å‰è¿›åº¦ {progress}, è¿˜éœ€è¡¥é½ {len(missing_fields)} ä¸ªå­—æ®µ{warning}\",\n        \"\
          commands_text\": \"\\n\".join(commands[:5]),  # æœ€å¤šæ˜¾ç¤º 5 æ¡\n        \"progress\"\
          : progress,\n        \"critical_text\": format_priority_items(priority_groups[\"\
          critical\"]),\n        \"high_text\": format_priority_items(priority_groups[\"\
          high\"]),\n        \"medium_text\": format_priority_items(priority_groups[\"\
          medium\"]),\n        \"next_action\": f\"\U0001F4CB è¯·ç»§ç»­ä¸Šä¼ å›¾è¡¨è¡¥é½å‰©ä½™ {len(missing_fields)}\
          \ ä¸ªå­—æ®µï¼ˆæ”¯æŒå¤šæ¬¡ä¸Šä¼ ç´¯ç§¯ï¼‰\",\n        \"merge_log\": format_merge_history(merge_history)\n\
          \    }\n\n\ndef suggest_command(field_path: str) -> dict:\n    \"\"\"æ ¹æ®å­—æ®µè·¯å¾„å»ºè®®å‘½ä»¤\"\
          \"\"\n    command_map = {\n        \"gamma_metrics.vol_trigger\": {\n  \
          \          \"command\": \"!trigger SYMBOL 60\",\n            \"description\"\
          : \"Gamma è§¦å‘çº¿\",\n            \"priority\": \"critical\"\n        },\n \
          \       \"gamma_metrics.net_gex\": {\n            \"command\": \"!gexn SYMBOL\
          \ 60 98\",\n            \"description\": \"å‡€ Gamma æ•å£\",\n            \"\
          priority\": \"critical\"\n        },\n        \"walls.call_wall\": {\n \
          \           \"command\": \"!gexr SYMBOL 25 7w\",\n            \"description\"\
          : \"Call å¢™ä½\",\n            \"priority\": \"high\"\n        },\n       \
          \ \"atm_iv.iv_7d\": {\n            \"command\": \"!skew SYMBOL ivmid atm\
          \ 7\",\n            \"description\": \"7æ—¥ ATM æ³¢åŠ¨ç‡\",\n            \"priority\"\
          : \"high\"\n        },\n        \"directional_metrics.dex_same_dir_pct\"\
          : {\n            \"command\": \"!dexn SYMBOL 25 14w\",\n            \"description\"\
          : \"DEX æ–¹å‘ä¸€è‡´æ€§\",\n            \"priority\": \"medium\"\n        },\n   \
          \     # ... æ›´å¤šæ˜ å°„\n    }\n    \n    return command_map.get(field_path, {\n\
          \        \"command\": f\"!gexr SYMBOL 25 7w\",  # é»˜è®¤å‘½ä»¤\n        \"description\"\
          : field_path,\n        \"priority\": \"medium\"\n    })\n\n\ndef format_priority_items(items:\
          \ list) -> str:\n    \"\"\"æ ¼å¼åŒ–ä¼˜å…ˆçº§åˆ—è¡¨\"\"\"\n    if not items:\n        return\
          \ \"æ— \"\n    \n    result = []\n    for i, item in enumerate(items, 1):\n\
          \        result.append(\n            f\"{i}. **{item['å­—æ®µ']}**\\n\"\n   \
          \         f\"   - å‘½ä»¤: `{item['å‘½ä»¤']}`\\n\"\n            f\"   - è¯´æ˜: {item['è¯´æ˜']}\"\
          \n        )\n    return \"\\n\\n\".join(result)\n\n\ndef format_merge_history(history:\
          \ list) -> str:\n    \"\"\"æ ¼å¼åŒ–åˆå¹¶å†å²\"\"\"\n    if not history:\n        return\
          \ \"æ— å†å²è®°å½•\"\n    \n    lines = []\n    for record in history:\n        lines.append(\n\
          \            f\"ç¬¬{record['round']}è½® ({record['timestamp']}): \"\n      \
          \      f\"{record['action']}, \"\n            f\"æ–°å¢ {record.get('fields_added',\
          \ 0)} ä¸ªå­—æ®µ\"\n        )\n    return \"\\n\".join(lines)\n\n\n# =============\
          \ è¾…åŠ©å‡½æ•° =============\n\ndef extract_symbol(data: dict) -> str:\n    \"\"\
          \"æå–è‚¡ç¥¨ä»£ç \"\"\"\n    target = get_target_dict(data)\n    return target.get(\"\
          symbol\", data.get(\"symbol\", \"UNKNOWN\"))\n\n\ndef count_valid_fields(data:\
          \ dict) -> int:\n    \"\"\"ç»Ÿè®¡æœ‰æ•ˆå­—æ®µæ•°é‡\"\"\"\n    target = get_target_dict(data)\n\
          \    count = 0\n    \n    for section in [\"gamma_metrics\", \"directional_metrics\"\
          , \"atm_iv\", \"walls\"]:\n        if section in target and isinstance(target[section],\
          \ dict):\n            for value in target[section].values():\n         \
          \       if is_valid_value(value):\n                    count += 1\n    \n\
          \    for key in [\"spot_price\", \"em1_dollar\"]:\n        if is_valid_value(target.get(key)):\n\
          \            count += 1\n    \n    return count"
        code_language: python3
        desc: '#1009 é›†æˆä¼šè¯å˜é‡æ›´æ–°'
        outputs:
          current_symbol:
            children: null
            type: string
          data_status:
            children: null
            type: string
          first_parse_data:
            children: null
            type: string
          missing_count:
            children: null
            type: number
          result:
            children: null
            type: string
          user_guide_commands:
            children: null
            type: string
          user_guide_merge_log:
            children: null
            type: string
          user_guide_next_action:
            children: null
            type: string
          user_guide_priority_critical:
            children: null
            type: string
          user_guide_priority_high:
            children: null
            type: string
          user_guide_priority_medium:
            children: null
            type: string
          user_guide_progress:
            children: null
            type: string
          user_guide_summary:
            children: null
            type: string
        selected: false
        title: CODE_AGGREGATOR
        type: code
        variables:
        - value_selector:
          - '3001'
          - structured_output
          value_type: object
          variable: agent3_output
        - value_selector:
          - conversation
          - first_parse_data
          value_type: string
          variable: first_parse_data
        - value_selector:
          - conversation
          - current_symbol
          value_type: string
          variable: current_symbol
        - value_selector:
          - conversation
          - data_status
          value_type: string
          variable: data_status
        - value_selector:
          - conversation
          - missing_count
          value_type: number
          variable: missing_count
      height: 80
      id: '1009'
      position:
        x: 1111.0783319055154
        y: 517.35302117182
      positionAbsolute:
        x: 1111.0783319055154
        y: 517.35302117182
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: '{{#1009.result#}}'
        selected: false
        title: ç›´æ¥å›å¤ 4
        type: answer
        variables: []
      height: 103
      id: '1763130136495'
      position:
        x: 1893.076894256682
        y: 667.9553875882742
      positionAbsolute:
        x: 1893.076894256682
        y: 667.9553875882742
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    viewport:
      x: -1339.347342719586
      y: 93.15286215750052
      zoom: 0.9176398815152124
  rag_pipeline_variables: []
