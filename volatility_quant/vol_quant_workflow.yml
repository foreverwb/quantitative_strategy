app:
  description: 'æ³¢åŠ¨ç‡å¥—åˆ©ç­–ç•¥'
  icon: ğŸ¤–
  icon_background: '#FFEAD5'
  mode: advanced-chat
  name: vol-quant_workflow
  use_icon_as_answer_icon: false
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/openai_api_compatible:0.0.24@2266d6adfeafd3a161ba4a033553f4ff8a8b1d07be54f4b11ce9e68032889ac3
    version: null
kind: app
version: 0.4.0
workflow:
  conversation_variables: []
  environment_variables:
  - description: è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿæ¬¡æ•°
    id: cecebd51-0647-4ab1-902e-58e3713456cf
    name: MONTE_CARLO_SIMULATIONS
    selector:
    - env
    - MONTE_CARLO_SIMULATIONS
    value: '10000'
    value_type: string
  - description: '# æ— é£é™©åˆ©ç‡ï¼ˆç”¨äºBSæ¨¡å‹ï¼‰'
    id: 78280691-03c2-4476-9ee8-31472bbd955b
    name: RISK_FREE_RATE
    selector:
    - env
    - RISK_FREE_RATE
    value: '0.05'
    value_type: string
  - description: L>=1.0æ—¶åšå¤šæ³¢åŠ¨ç‡æ¦‚ç‡ä¸‹é™
    id: 5525253a-c885-42c6-ad22-19699a917786
    name: PROB_LONG_L1_0
    selector:
    - env
    - PROB_LONG_L1_0
    value: '0.55'
    value_type: string
  - description: L>=1.5æ—¶åšå¤šæ³¢åŠ¨ç‡æ¦‚ç‡
    id: 23f5fd45-15c6-459b-8a80-bf541f4a201d
    name: PROB_LONG_L1_5
    selector:
    - env
    - PROB_LONG_L1_5
    value: '0.60'
    value_type: string
  - description: L>=2.0æ—¶åšå¤šæ³¢åŠ¨ç‡æ¦‚ç‡
    id: 6ec80689-ddb8-415c-82f3-c0a476d01097
    name: PROB_LONG_L2_0
    selector:
    - env
    - PROB_LONG_L2_0
    value: '0.65'
    value_type: string
  - description: ''
    id: 287bb18e-5cba-4b6b-9535-de421e26dab4
    name: WEIGHT_VRP_LONG
    selector:
    - env
    - WEIGHT_VRP_LONG
    value: '0.25'
    value_type: string
  - description: ''
    id: 61f6b67e-3cd0-4fb3-a731-eda71f3a3533
    name: WEIGHT_GEX_LONG
    selector:
    - env
    - WEIGHT_GEX_LONG
    value: '0.18'
    value_type: string
  - description: ''
    id: 6d50b104-3e70-43ca-a90d-3dd561a32f94
    name: WEIGHT_VEX_LONG
    selector:
    - env
    - WEIGHT_VEX_LONG
    value: '0.18'
    value_type: string
  - description: ''
    id: 749169ba-5cac-49c5-862d-431fe6580b98
    name: WEIGHT_CARRY_LONG
    selector:
    - env
    - WEIGHT_CARRY_LONG
    value: '0.08'
    value_type: string
  - description: ''
    id: 60f510da-097b-4eb8-8117-b367a4ffee3c
    name: WEIGHT_SKEW_LONG
    selector:
    - env
    - WEIGHT_SKEW_LONG
    value: '0.08'
    value_type: string
  - description: ''
    id: 349b3c5a-3b8d-4ba0-93e5-9527f5ef9ae8
    name: WEIGHT_VRP_SHORT
    selector:
    - env
    - WEIGHT_VRP_SHORT
    value: '0.30'
    value_type: string
  - description: ''
    id: fd3bb6f0-556f-4ece-b7fa-9911a6de7699
    name: WEIGHT_GEX_SHORT
    selector:
    - env
    - WEIGHT_GEX_SHORT
    value: '0.12'
    value_type: string
  - description: ''
    id: c1aafa4a-8b7d-44cb-998d-2a0fbde2faae
    name: WEIGHT_CARRY_SHORT
    selector:
    - env
    - WEIGHT_CARRY_SHORT
    value: '0.18'
    value_type: string
  - description: åšå¤šæ³¢åŠ¨ç‡Låˆ†æ•°é—¨æ§›
    id: 80632eef-372f-46ea-8968-08875bba1981
    name: DECISION_THRESHOLD_LONG
    selector:
    - env
    - DECISION_THRESHOLD_LONG
    value: '1.00'
    value_type: string
  - description: åšç©ºæ³¢åŠ¨ç‡Såˆ†æ•°é—¨æ§›
    id: 0b6c6658-734f-4984-a1d6-318a35d54015
    name: DECISION_THRESHOLD_SHORT
    selector:
    - env
    - DECISION_THRESHOLD_SHORT
    value: '1.00'
    value_type: string
  - description: æ¦‚ç‡é—¨æ§›
    id: 93465a47-23d5-4ab1-b4e1-ef70229003f0
    name: PROB_THRESHOLD
    selector:
    - env
    - PROB_THRESHOLD
    value: '0.55'
    value_type: string
  - description: Edge EVå¿…é¡»>0
    id: 787a82e0-45aa-4117-9bc7-793b83d31044
    name: EDGE_EV_THRESHOLD
    selector:
    - env
    - EDGE_EV_THRESHOLD
    value: '0'
    value_type: string
  - description: Edgeæœ€ä½ç›ˆäºæ¯”
    id: dd480a6c-a157-46a2-bbdf-283cc28ecdde
    name: EDGE_RR_THRESHOLD
    selector:
    - env
    - EDGE_RR_THRESHOLD
    value: '1.5'
    value_type: string
  - description: è·VOL TRIGGERé˜ˆå€¼%(è§†ä¸ºä¸­æ€§)
    id: 7d31d5ec-a884-484b-86a1-c5e60c8d475a
    name: TRIGGER_NEUTRAL_PCT
    selector:
    - env
    - TRIGGER_NEUTRAL_PCT
    value: '0.2'
    value_type: string
  - description: Gamma Wallæ¥è¿‘åº¦é˜ˆå€¼%
    id: 461c2129-b20d-43bc-a3cb-8e1efdb65aa9
    name: GAMMA_WALL_PROX_THRESHOLD
    selector:
    - env
    - GAMMA_WALL_PROX_THRESHOLD
    value: '0.5'
    value_type: string
  - description: RIM>=0.6è§†ä¸ºç›˜ä¸­åŠ¨èƒ½æœ‰æ•ˆ
    id: ffa721e1-9974-435f-ab5d-2255ec9ffb77
    name: RIM_ACTIVE_THRESHOLD
    selector:
    - env
    - RIM_ACTIVE_THRESHOLD
    value: '0.6'
    value_type: string
  - description: RIM<=0.4åå¼±
    id: a2a1b0e7-b635-4876-b33f-e6bbba9b9e07
    name: RIM_WEAK_THRESHOLD
    selector:
    - env
    - RIM_WEAK_THRESHOLD
    value: '0.4'
    value_type: string
  features:
    file_upload:
      allowed_file_extensions:
      - .JPG
      - .JPEG
      - .PNG
      - .GIF
      - .WEBP
      - .SVG
      allowed_file_types:
      - image
      allowed_file_upload_methods:
      - local_file
      - remote_url
      enabled: false
      fileUploadConfig:
        audio_file_size_limit: 50
        batch_count_limit: 5
        file_size_limit: 15
        image_file_size_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 3
    opening_statement: ''
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        sourceType: start
        targetType: llm
      id: 1001-llm
      source: '1001'
      sourceHandle: source
      target: llm
      targetHandle: target
      type: custom
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: if-else
      id: llm-source-1003-target
      source: llm
      sourceHandle: source
      target: '1003'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: 1003-true-2001-target
      source: '1003'
      sourceHandle: 'true'
      target: '2001'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: answer
      id: 2001-source-2002-target
      source: '2001'
      sourceHandle: source
      target: answer
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: 1003-bc8d0973-baba-4332-88b3-bfbe4e341190-3001-target
      source: '1003'
      sourceHandle: bc8d0973-baba-4332-88b3-bfbe4e341190
      target: '3001'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: answer
      id: 2001-source-2002-target
      source: '2001'
      sourceHandle: source
      target: '2002'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: if-else
      id: 3001-source-1763047571352-target
      source: '3001'
      sourceHandle: source
      target: '1763047571352'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: answer
      id: 1763047571352-70915da9-857e-42ab-b45f-6de71d443129-1763047646569-target
      source: '1763047571352'
      sourceHandle: 70915da9-857e-42ab-b45f-6de71d443129
      target: '1763047646569'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: code
      id: 1763047571352-true-4001-target
      source: '1763047571352'
      sourceHandle: 'true'
      target: '4001'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: code
      id: 4001-source-5001-target
      source: '4001'
      sourceHandle: source
      target: '5001'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 5001-source-6001-target
      source: '5001'
      sourceHandle: source
      target: '6001'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: llm
      id: 6001-source-7001-target
      source: '6001'
      sourceHandle: source
      target: '7001'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 7001--7002-target
      source: '7001'
      sourceHandle: source
      target: '7002'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: code
      id: 7002-source-7003-target
      source: '7002'
      sourceHandle: source
      target: '7003'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 7003--8001-target
      source: '7003'
      sourceHandle: source
      target: '8001'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: llm
        targetType: answer
      id: 8001-source-8002-target
      source: '8001'
      sourceHandle: source
      target: '8002'
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        selected: false
        title: å¼€å§‹
        type: start
        variables: []
      height: 52
      id: '1001'
      position:
        x: 80
        y: 282
      positionAbsolute:
        x: 80
        y: 282
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: åˆ¤æ–­è¾“å…¥ç±»å‹
        memory:
          query_prompt_template: '{{#sys.query#}}


            {{#sys.files#}}'
          role_prefix:
            assistant: ''
            user: ''
          window:
            enabled: false
            size: 10
        model:
          completion_params:
            temperature: 0.3
          mode: chat
          name: Qwen3-8B
          provider: langgenius/openai_api_compatible/openai_api_compatible
        prompt_template:
        - id: 01a841c6-a56b-47f5-b789-56ba99a17f50
          role: system
          text: "ä½ æ˜¯è·¯ç”±åŠ©æ‰‹ï¼Œåˆ¤æ–­ç”¨æˆ·è¾“å…¥å±äºä»¥ä¸‹å“ªä¸€ç±»ï¼Œä»…è¾“å‡ºä¸€ä¸ªå…³é”®è¯ï¼š\n                \n1. \"VARIABLES\"\
            \ - ç”¨æˆ·æä¾›æ ‡çš„ä»£ç ã€äº‹ä»¶ç±»å‹ç­‰å˜é‡ä¿¡æ¯\n2. \"DATA\" - ç”¨æˆ·å›ä¼ gexbotå›¾è¡¨æ•°æ®ï¼ˆåŒ…å«å›¾ç‰‡æˆ–æ•°æ®æˆªå›¾ï¼‰\n3. \"\
            INVALID\" - å…¶ä»–æ— æ•ˆè¾“å…¥\n\n\nåˆ¤æ–­è§„åˆ™ï¼š\n- è‹¥æ¶ˆæ¯åŒ…å«æ ‡çš„ä»£ç ï¼ˆ1-5ä¸ªå¤§å†™å­—æ¯ï¼‰ä¸”æåˆ°äº‹ä»¶ç±»å‹ã€DTEç­‰ä¿¡æ¯ â†’ VARIABLES\n\
            - è‹¥ä¸Šä¼ äº†å›¾ç‰‡æ–‡ä»¶ â†’ DATA\n- å…¶ä»– â†’ INVALID"
        selected: false
        title: Router
        type: llm
        vision:
          enabled: false
      height: 116
      id: llm
      position:
        x: 380
        y: 282
      positionAbsolute:
        x: 380
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: ã€å‘½ä»¤æ¸…å•å›å¤ã€‘{{#2001.text#}}
        selected: false
        title: ç›´æ¥å›å¤
        type: answer
        variables: []
      height: 119
      id: '2002'
      position:
        x: 1347.0055413355958
        y: 146.16624006787654
      positionAbsolute:
        x: 1347.0055413355958
        y: 146.16624006787654
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        cases:
        - case_id: 'true'
          conditions:
          - comparison_operator: is
            id: f07e03f3-5176-4004-aadc-66e529768d54
            value: VARIABLES
            varType: string
            variable_selector:
            - llm
            - text
          id: 'true'
          logical_operator: and
        - case_id: bc8d0973-baba-4332-88b3-bfbe4e341190
          conditions:
          - comparison_operator: not empty
            id: a984d6b5-59b5-4cc2-898b-03c0b11b4a89
            value: ''
            varType: array[file]
            variable_selector:
            - sys
            - files
          id: bc8d0973-baba-4332-88b3-bfbe4e341190
          logical_operator: and
        selected: false
        title: æ¡ä»¶åˆ†æ”¯
        type: if-else
      height: 172
      id: '1003'
      position:
        x: 702
        y: 282
      positionAbsolute:
        x: 702
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            temperature: 0.3
          mode: chat
          name: Qwen3-8B
          provider: langgenius/openai_api_compatible/openai_api_compatible
        prompt_template:
        - id: 8f8a1d50-dc15-4517-aafc-3032b38e4771
          role: system
          text: "ä½ æ˜¯gexbotå‘½ä»¤ç”ŸæˆåŠ©æ‰‹ã€‚æ ¹æ®ç”¨æˆ·æä¾›çš„å˜é‡ï¼Œç”Ÿæˆæ ‡å‡†åŒ–çš„æ•°æ®æŠ“å–å‘½ä»¤æ¸…å•ã€‚\n                \nã€è¾“å…¥è§£æã€‘\n\
            ä»ç”¨æˆ·è¾“å…¥ä¸­æå–ï¼š\n- symbol: æ ‡çš„ä»£ç ï¼ˆå¤§å†™ï¼‰\n- event_type: äº‹ä»¶ç±»å‹ï¼ˆè´¢æŠ¥/FOMC/CPI/éå†œ/å¹¶è´­/å…¶ä»–/æ— ï¼‰\n\
            - holding_window: æŒä»“çª—å£ï¼ˆå¦‚ 5-20 DTEï¼‰\n- strategy_preference: ç­–ç•¥åå¥½ï¼ˆdelta-neutral\
            \ æˆ– å…è®¸deltaæš´éœ²ï¼‰\n\n\nã€å‘½ä»¤æ ¼å¼è§„èŒƒã€‘\n- æ¯æ¡å‘½ä»¤ç‹¬å ä¸€è¡Œï¼Œä¾¿äºå¤åˆ¶\n- å‚æ•°æŒ‰å›ºå®šé¡ºåºï¼Œçœç•¥ä¸é€‚ç”¨çš„å‚æ•°ä½\n-\
            \ contract/filter: atm / ntm\n- expiration_filter: w(å‘¨) / m(æœˆ) / *(å…¨éƒ¨)\n\
            \n\nã€å‚æ•°é¡ºåºã€‘\n- !gexn / !gexr: {SYMBOL} {strikes} {dte}\n- !vexn: {SYMBOL}\
            \ {strikes} {dte} {expiration_filter}\n- !vanna: {SYMBOL} {contract_filter}\
            \ {dte} {expiration_filter}\n- !term: {SYMBOL} {dte} {expiration_filter}\n\
            - !skew: {SYMBOL} {metric} {contract_or_option} {dte} {expiration_filter}\n\
            - !surface: {SYMBOL} {metric} {contract_filter} {dte} {expiration_filter}\n\
            - !trigger: {SYMBOL} {dte}\n\n\nã€æ ‡å‡†å‘½ä»¤æ¸…å•ã€‘\næ ¹æ® holding_window å’Œ event_type\
            \ è°ƒæ•´ DTE å‚æ•°ï¼š\n- äº‹ä»¶å‰(5-20 DTE): ä½¿ç”¨è¾ƒçŸ­DTE\n- å¸¸è§„(30-45 DTE): ä½¿ç”¨æ ‡å‡†DTE\n- é•¿å‘¨æœŸ:\
            \ æ‰©å±•DTE\n\n\n**å¿…å¤‡å‘½ä»¤**ï¼ˆæŒ‰é¡ºåºè¾“å‡ºï¼‰:\n!trigger {SYMBOL} 98\n!gexn {SYMBOL} 15\
            \ 98\n!gexr {SYMBOL} 15 98\n!vexn {SYMBOL} 15 190 *\n!vanna {SYMBOL} atm\
            \ 190 *\n!vanna {SYMBOL} ntm 90\n!term {SYMBOL} 365 w\n!term {SYMBOL}\
            \ 365 m\n!skew {SYMBOL} ivmid atm 30\n!skew {SYMBOL} ivmid ntm 30\n!skew\
            \ {SYMBOL} ivmid put 30 w\n!surface {SYMBOL} ivmid 98\n!surface {SYMBOL}\
            \ ivmid ntm 98\n!surface {SYMBOL} ivask ntm 98\n!surface {SYMBOL} spread\
            \ atm 98\n\n\n**æ¡ä»¶æ‰©å±•**ï¼ˆæ ¹æ®åœºæ™¯ï¼‰:\n- äº‹ä»¶å‰: å¢åŠ  extrinsic, theta, gex, vex\n\
            - ç›˜ä¸­è·¯å¾„: å¢åŠ  gamma, spread, ivask\n- äº‹ä»¶å: å¢åŠ  vex, theta, vanna\n\n\nã€è¾“å‡ºæ ¼å¼ã€‘\n\
            ## gexbot æ•°æ®æŠ“å–å‘½ä»¤æ¸…å•\n\n\n**æ ‡çš„**: {SYMBOL}\n**äº‹ä»¶ç±»å‹**: {event_type}\n**æŒä»“çª—å£**:\
            \ {holding_window}\n**ç­–ç•¥åå¥½**: {strategy_preference}\n\n\n### å¿…å¤‡å‘½ä»¤ï¼ˆè¯·é€è¡Œå¤åˆ¶æ‰§è¡Œï¼‰\n\
            ```\n{å‘½ä»¤åˆ—è¡¨ï¼Œæ¯è¡Œä¸€æ¡}\n```\n\n\n### è¡¥å……æ•°æ®éœ€æ±‚\nè¯·åŒæ—¶æä¾›ä»¥ä¸‹æ•°æ®ï¼š\n1. **HVæ•°æ®**: HV10,\
            \ HV20, HV60 (Yang-Zhangå£å¾„, 252å¹´åŒ–)\n2. **RIMæ•°æ®** (å¯é€‰ï¼Œæå‡ç²¾åº¦):\n    - æ–¹æ³•1:\
            \ è¿‘{w}åˆ†é’Ÿé«˜ä½ä»·åŒºé—´\n    - æ–¹æ³•2: ATM IV æˆ– ATM 30D IV\n    - æ–¹æ³•3: ATM straddleä»·æ ¼\n\
            3. **å¢å¼ºæ•°æ®** (å¯é€‰):\n    - VVIXæ°´å¹³\n    - VIX9D / VIX\n    - ä¸»è¦ä»·ä½OIèšé›†\n\n\
            \n### å›ä¼ è¦æ±‚\n- æ¯å¼ å›¾/è¾“å‡ºè¯·æ³¨æ˜å‘½ä»¤å…¨æ–‡ä¸æ—¶é—´æˆ³(ET)\n- å¯é™„æ”¶ç›˜ä»·ä¸å½“æ—¥å˜åŠ¨\n- è‹¥å‘½ä»¤è¾“å‡ºä¸ºç©ºæˆ–å¼‚å¸¸ï¼Œè¯·ç›´æ¥è¯´æ˜"
        - id: 81bae211-b154-44b1-9853-9dc99ef34760
          role: user
          text: ''
        selected: false
        title: å‘½ä»¤æ¸…å•ç”Ÿæˆ
        type: llm
        vision:
          enabled: false
      height: 88
      id: '2001'
      position:
        x: 1004
        y: 282
      positionAbsolute:
        x: 1004
        y: 282
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        model:
          completion_params:
            temperature: 0.7
          mode: chat
          name: Qwen3-VL-235B-A22B-Thinking
          provider: langgenius/openai_api_compatible/openai_api_compatible
        prompt_template:
        - id: 02f38dd4-5235-494a-9771-e2fc10fcb93f
          role: system
          text: "ä½ æ˜¯gexbotå›¾è¡¨è§£æä¸æ•°æ®æ ¡éªŒAgentã€‚\n                \nã€ä»»åŠ¡ã€‘\n1. è¯†åˆ«å¹¶æå–gexbotå›¾è¡¨ä¸­çš„å…³é”®æ•°å€¼\n\
            2. æ ¡éªŒæ ¸å¿ƒå­—æ®µå®Œæ•´æ€§\n3. å¯¹ç¼ºå¤±å­—æ®µç»™å‡ºè¡¥é½æ–¹æ³•\n\n\nã€æ ¸å¿ƒå­—æ®µæ¸…å•ã€‘ï¼ˆ22ä¸ªå¿…éœ€å­—æ®µï¼‰\n**VOL TRIGGER ç›¸å…³**:\n\
            - vol_trigger: VOL TRIGGERæ•°å€¼ï¼ˆæ¥è‡ª !trigger å‘½ä»¤ï¼‰\n- spot: ç°ä»·\n- spot_vs_trigger:\
            \ ç°ä»·ç›¸å¯¹VOL TRIGGERä½ç½®ï¼ˆabove/below/nearï¼‰\n    - above: Spot >= VOL TRIGGER\
            \ â†’ NET-GEX > 0\n    - below: Spot < VOL TRIGGER â†’ NET-GEX < 0\n    -\
            \ near: |Spot - VOL TRIGGER| / Spot <= 0.2% â†’ ä¸­æ€§/æ˜“ç¿»è½¬\n- net_gex_sign:\
            \ NET-GEXç¬¦å·ï¼ˆpositive/negative/neutralï¼‰\n\n\n**Gamma Walls**:\n- gamma_wall:\
            \ Gamma Wallä½ç½®\n- call_wall: Call Wallä½ç½®\n- put_wall: Put Wallä½ç½®\n- gamma_wall_prox:\
            \ min(|Spot - GammaWall_i|/Spot)\n\n\n**IV/HV æ•°æ®**:\n- iv_event_w_atm:\
            \ äº‹ä»¶å‘¨ATM IV\n- iv_m1_atm: è¿‘æœˆATM IV\n- iv_m2_atm: æ¬¡è¿‘æœˆATM IV\n- hv10: å†å²æ³¢åŠ¨ç‡10æ—¥\n\
            - hv20: å†å²æ³¢åŠ¨ç‡20æ—¥\n- hv60: å†å²æ³¢åŠ¨ç‡60æ—¥\n\n\n**ç»“æ„æ€§æŒ‡æ ‡**:\n- vex_net: VEXå‡€å€¼ï¼ˆ5-60\
            \ DTEï¼‰\n- vanna_atm: Vanna ATM\n- term_slope: æœŸé™ç»“æ„æ–œç‡\n- put_skew_25: Put\
            \ Skew 25Î”\n- call_skew_25: Call Skew 25Î”\n- spread_atm: ATM Spread\n\
            - ask_premium_atm: ATM Ask Premium %\n\n\nã€å›¾è¡¨è¯†åˆ«è§„åˆ™ã€‘\n- !trigger å›¾è¡¨: è¯†åˆ«\
            \ VOL TRIGGER / GAMMA WALL / CALL WALL / PUT WALL\n- !gexn / !gexr å›¾è¡¨:\
            \ è¯†åˆ« NET-GEX ç¬¦å·ã€å¢™ä½\n- !vexn å›¾è¡¨: è¯†åˆ« VEX å‡€å€¼\n- !vanna å›¾è¡¨: è¯†åˆ« Vanna ATM ç¬¦å·ä¸å¼ºåº¦\n\
            - !term å›¾è¡¨: è¯†åˆ«æœŸé™ç»“æ„æ–œç‡\n- !skew å›¾è¡¨: è¯†åˆ« Put/Call Skew\n- !surface spread/ivask\
            \ å›¾è¡¨: è¯†åˆ«æµåŠ¨æ€§æŒ‡æ ‡\n\n\nã€ç¼ºå¤±å­—æ®µè¡¥é½æ–¹æ³•ã€‘\nä¼˜å…ˆçº§ critical:\n- vol_trigger: !trigger\
            \ {SYMBOL} 98\n- spot: ä»ä»»æ„å›¾è¡¨æå–æˆ–ç”¨æˆ·æä¾›\n- net_gex_sign: æ ¹æ® spot vs vol_trigger\
            \ åˆ¤å®š\n\n\nä¼˜å…ˆçº§ high:\n- gamma_wall_prox: !trigger æˆ– !gexr æå–å¢™ä½è®¡ç®—\n- iv_event_w_atm:\
            \ !skew {SYMBOL} ivmid atm {dte}\n- hv10: ç”¨æˆ·æä¾›æˆ–ä»å¹³å°è·å–\n\n\nä¼˜å…ˆçº§ medium:\n\
            - vex_net: !vexn {SYMBOL} 15 190 *\n- vanna_atm: !vanna {SYMBOL} atm 190\
            \ *\n- term_slope: !term {SYMBOL} 365 w\n\n\nã€è¾“å‡ºJSONã€‘\nä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°schemaè¾“å‡ºï¼ŒåŒ…å«ï¼š\n\
            - symbol: æ ‡çš„ä»£ç \n- timestamp: æ•°æ®æ—¶é—´æˆ³(ET)\n- status: data_ready / missing_data\n\
            - core_fields: æ‰€æœ‰æ ¸å¿ƒå­—æ®µçš„æå–å€¼ï¼ˆç¼ºå¤±ç”¨nullï¼‰\n- missing_fields: ç¼ºå¤±å­—æ®µåˆ—è¡¨ï¼ˆå«ä¼˜å…ˆçº§ã€è¡¥é½å‘½ä»¤ã€æ›¿ä»£æ–¹æ³•ï¼‰\n\
            - next_step: proceed_to_analysis / request_missing_data"
        - id: d2dcaf20-2791-4e8b-80e8-162836af58e2
          role: user
          text: 'ã€ä¸Šä¼ æ–‡ä»¶ã€‘

            {{#sys.files#}}

            '
        selected: false
        structured_output:
          schema:
            properties:
              core_fields:
                properties:
                  ask_premium_atm:
                    type: number
                  call_skew_25:
                    type: number
                  call_wall:
                    type: number
                  gamma_wall:
                    type: number
                  gamma_wall_prox:
                    type: number
                  hv10:
                    type: number
                  hv20:
                    type: number
                  hv60:
                    type: number
                  iv_event_w_atm:
                    type: number
                  iv_m1_atm:
                    type: number
                  iv_m2_atm:
                    type: number
                  net_gex_sign:
                    enum:
                    - positive
                    - negative
                    - neutral
                    type: string
                  put_skew_25:
                    type: number
                  put_wall:
                    type: number
                  spot:
                    type: number
                  spot_vs_trigger:
                    enum:
                    - above
                    - below
                    - near
                    type: string
                  spread_atm:
                    type: number
                  term_slope:
                    type: number
                  vanna_atm:
                    type: number
                  vex_net:
                    type: number
                  vol_trigger:
                    type: number
                required:
                - vol_trigger
                - spot
                - net_gex_sign
                - gamma_wall_prox
                - iv_event_w_atm
                - hv10
                type: object
              missing_fields:
                items:
                  properties:
                    alternative:
                      type: string
                    command:
                      type: string
                    field:
                      type: string
                    priority:
                      enum:
                      - critical
                      - high
                      - medium
                      - low
                      type: string
                  type: object
                type: array
              next_step:
                enum:
                - proceed_to_analysis
                - request_missing_data
                type: string
              status:
                enum:
                - data_ready
                - missing_data
                type: string
              symbol:
                type: string
              timestamp:
                type: string
            required:
            - symbol
            - timestamp
            - status
            - core_fields
            - missing_fields
            - next_step
            type: object
        structured_output_enabled: true
        title: Agent 3 æ•°æ®æ ¡éªŒ
        type: llm
        vision:
          configs:
            detail: high
            variable_selector:
            - sys
            - files
          enabled: true
      height: 88
      id: '3001'
      position:
        x: 1004
        y: 409
      positionAbsolute:
        x: 1004
        y: 409
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        cases:
        - case_id: 'true'
          conditions:
          - comparison_operator: contains
            id: 53c59dbf-fdcc-4f6f-b939-7fc6d995270d
            value: case-ready
            varType: string
            variable_selector:
            - '3001'
            - structured_output
            - status
          id: 'true'
          logical_operator: and
        - case_id: 70915da9-857e-42ab-b45f-6de71d443129
          conditions:
          - comparison_operator: is
            id: 6f7f45b7-a466-4f70-b677-9dcd422765e0
            value: case-missing
            varType: object
            variable_selector:
            - '3001'
            - structured_output
            - status
          id: 70915da9-857e-42ab-b45f-6de71d443129
          logical_operator: and
        selected: false
        title: æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
        type: if-else
      height: 172
      id: '1763047571352'
      position:
        x: 1306
        y: 409
      positionAbsolute:
        x: 1306
        y: 409
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: '{{#3001.text#}}'
        selected: false
        title: è¿”å›ç¼ºå¤±æ•°æ®æç¤º
        type: answer
        variables: []
      height: 103
      id: '1763047646569'
      position:
        x: 1617
        y: 592
      positionAbsolute:
        x: 1617
        y: 592
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport math\n\ndef calculate_features(core_fields: dict,\
          \ env_vars: dict) -> dict:\n\"\"\"è®¡ç®—æ³¢åŠ¨ç‡äº¤æ˜“ç‰¹å¾\"\"\"\n\n# æå–æ ¸å¿ƒå­—æ®µ\nspot = core_fields.get('spot',\
          \ 0)\nvol_trigger = core_fields.get('vol_trigger', 0)\niv_event_w = core_fields.get('iv_event_w_atm',\
          \ 0)\niv_m1 = core_fields.get('iv_m1_atm', 0)\niv_m2 = core_fields.get('iv_m2_atm',\
          \ 0)\nhv10 = core_fields.get('hv10', 0)\nhv20 = core_fields.get('hv20',\
          \ 0)\nhv60 = core_fields.get('hv60', 0)\nvex_net = core_fields.get('vex_net',\
          \ 0)\nvanna_atm = core_fields.get('vanna_atm', 0)\nterm_slope = core_fields.get('term_slope',\
          \ 0)\nput_skew_25 = core_fields.get('put_skew_25', 0)\ncall_skew_25 = core_fields.get('call_skew_25',\
          \ 0)\nspread_atm = core_fields.get('spread_atm', 0)\nask_premium = core_fields.get('ask_premium_atm',\
          \ 0)\ngamma_wall_prox = core_fields.get('gamma_wall_prox', 0)\n\n# 1. VRP\
          \ (Variance Risk Premium)\nvrp_ew = iv_event_w - hv10 if iv_event_w and\
          \ hv10 else 0\nvrp_30 = iv_m1 - hv20 if iv_m1 and hv20 else 0\n\n# 2. Term\
          \ Structure\nterm_curv = 0  # ç®€åŒ–å¤„ç†ï¼Œéœ€è¦æ›´å¤šæœŸé™ç‚¹\nif iv_m1 and iv_m2:\n    term_curv\
          \ = iv_m2 - 2*iv_m1 + iv_event_w if iv_event_w else 0\n\n# 3. Skew\nskew_asym\
          \ = (put_skew_25 - call_skew_25) if put_skew_25 and call_skew_25 else 0\n\
          \n# 4. RV Momentum\nrv_momo = (hv10 / hv60 - 1) if hv10 and hv60 and hv60\
          \ > 0 else 0\n\n# 5. GEX Level (åŸºäºVOL TRIGGER)\nspot_vs_trigger = core_fields.get('spot_vs_trigger',\
          \ 'unknown')\nif spot_vs_trigger == 'below':\n    gex_level = 1  # è´ŸGEXï¼Œè¶‹åŠ¿å€¾å‘ï¼Œåšå¤šæ³¢åŠ¨\n\
          elif spot_vs_trigger == 'above':\n    gex_level = -1  # æ­£GEXï¼ŒåŒºé—´å€¾å‘ï¼Œåšç©ºæ³¢åŠ¨\n\
          else:\n    gex_level = 0  # ä¸­æ€§\n\n# 6. Pin Risk\ntrigger_neutral_pct = float(env_vars.get('TRIGGER_NEUTRAL_PCT',\
          \ 0.2)) / 100\ngamma_wall_prox_threshold = float(env_vars.get('GAMMA_WALL_PROX_THRESHOLD',\
          \ 0.5)) / 100\n\npin_risk = 0\nif (gamma_wall_prox <= gamma_wall_prox_threshold\
          \ and \n    spot_vs_trigger == 'above'):\n    pin_risk = -1  # Piné£é™©ï¼Œä¸åˆ©äºåšå¤šæ³¢åŠ¨\n\
          \nfeatures = {\n    # åŸå§‹ç‰¹å¾\n    'vrp_ew': round(vrp_ew, 4),\n    'vrp_30':\
          \ round(vrp_30, 4),\n    'term_slope': round(term_slope, 4),\n    'term_curv':\
          \ round(term_curv, 4),\n    'skew_asym': round(skew_asym, 4),\n    'rv_momo':\
          \ round(rv_momo, 4),\n    'gex_level': gex_level,\n    'pin_risk': pin_risk,\n\
          \    'vex_net': vex_net,\n    'vanna_atm': vanna_atm,\n    'spread_atm':\
          \ spread_atm,\n    'ask_premium_atm': ask_premium,\n    'gamma_wall_prox':\
          \ round(gamma_wall_prox, 4),\n    \n    # æ´¾ç”Ÿç‰¹å¾\n    'vrp_sel': vrp_ew if\
          \ abs(vrp_ew) > 0.001 else vrp_30,  # é€‰æ‹©ä½¿ç”¨çš„VRP\n}\n\nreturn features\n\n\
          def main(validation_output: str, **env_vars) -> dict:\n\"\"\"ä¸»å‡½æ•°\"\"\"\n\
          try:\n    data = json.loads(validation_output)\n    core_fields = data.get('core_fields',\
          \ {})\n    \n    features = calculate_features(core_fields, env_vars)\n\
          \    \n    result = {\n        'symbol': data.get('symbol', ''),\n     \
          \   'timestamp': data.get('timestamp', ''),\n        'features': features,\n\
          \        'status': 'success'\n    }\n    \n    return {'result': json.dumps(result,\
          \ ensure_ascii=False, indent=2)}\n    \nexcept Exception as e:\n    return\
          \ {'result': json.dumps({\n        'error': True,\n        'message': str(e)\n\
          \    }, ensure_ascii=False)}"
        code_language: python3
        desc: 'è®¡ç®—VRP, Skew, RV Momentumç­‰ç‰¹å¾ #4001'
        outputs:
          result:
            children: null
            type: string
        selected: false
        title: CODE1 ç‰¹å¾è®¡ç®—
        type: code
        variables:
        - value_selector:
          - '3001'
          - structured_output
          value_type: object
          variable: validation_output
      height: 96
      id: '4001'
      position:
        x: 1617
        y: 429.42252683918616
      positionAbsolute:
        x: 1617
        y: 429.42252683918616
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport math\n\ndef z_score(x, mean=0, std=1):\n    \"\"\
          \"ç®€åŒ–z-scoreè®¡ç®—\"\"\"\n    if std == 0:\n        return 0\n    return (x -\
          \ mean) / std\n\ndef calculate_signals(features: dict, env_vars: dict) ->\
          \ dict:\n    \"\"\"è®¡ç®—æ ‡å‡†åŒ–ä¿¡å·\"\"\"\n    \n    # æå–ç‰¹å¾\n    vrp_sel = features.get('vrp_sel',\
          \ 0)\n    term_slope = features.get('term_slope', 0)\n    term_curv = features.get('term_curv',\
          \ 0)\n    skew_asym = features.get('skew_asym', 0)\n    gex_level = features.get('gex_level',\
          \ 0)\n    pin_risk = features.get('pin_risk', 0)\n    vex_net = features.get('vex_net',\
          \ 0)\n    vanna_atm = features.get('vanna_atm', 0)\n    rv_momo = features.get('rv_momo',\
          \ 0)\n    spread_atm = features.get('spread_atm', 0)\n    ask_premium =\
          \ features.get('ask_premium_atm', 0)\n    \n    # æ ‡å‡†åŒ–ä¿¡å·ï¼ˆå¤šæ³¢åŠ¨ä¸ºæ­£åˆ†ï¼‰\n    s_vrp\
          \ = -z_score(vrp_sel, mean=0, std=0.05)  # VRPé«˜â†’åšç©ºæ³¢åŠ¨ï¼Œå–è´Ÿâ†’å¤šæ³¢åŠ¨æ­£åˆ†\n    s_carry\
          \ = -z_score(term_slope, mean=0, std=0.02) - 0.5 * z_score(term_curv, mean=0,\
          \ std=0.01)\n    s_skew = z_score(skew_asym, mean=0, std=0.05)\n    s_gex\
          \ = gex_level + pin_risk  # gex_levelå·²è€ƒè™‘æ–¹å‘ï¼Œpin_riskä¸ºè´Ÿ\n    s_vex = z_score(-vex_net,\
          \ mean=0, std=100)  # VEXè´Ÿâ†’å¤šæ³¢åŠ¨\n    s_vanna = -z_score(abs(vanna_atm), mean=0,\
          \ std=0.01)  # |Vanna|å¤§â†’ä¸åˆ©\n    s_rv = z_score(rv_momo, mean=0, std=0.2)\n\
          \    \n    # æµåŠ¨æ€§æƒ©ç½š\n    s_liq = -(max(0, z_score(spread_atm, mean=0.01,\
          \ std=0.01)) + \n                0.5 * max(0, z_score(ask_premium, mean=0,\
          \ std=0.02)))\n    \n    # å¢å¼ºä¿¡å·ï¼ˆç®€åŒ–ç‰ˆï¼Œé»˜è®¤0ï¼‰\n    s_vov = 0\n    s_vix_ts =\
          \ 0\n    s_rim = 0\n    s_compress = 0\n    s_eir_long = 0\n    s_eir_short\
          \ = 0\n    s_corr_idx = 0\n    s_flow_putcrowd = 0\n    \n    signals =\
          \ {\n        's_vrp': round(s_vrp, 3),\n        's_carry': round(s_carry,\
          \ 3),\n        's_skew': round(s_skew, 3),\n        's_gex': round(s_gex,\
          \ 3),\n        's_vex': round(s_vex, 3),\n        's_vanna': round(s_vanna,\
          \ 3),\n        's_rv': round(s_rv, 3),\n        's_liq': round(s_liq, 3),\n\
          \        's_vov': s_vov,\n        's_vix_ts': s_vix_ts,\n        's_rim':\
          \ s_rim,\n        's_compress': s_compress,\n        's_eir_long': s_eir_long,\n\
          \        's_eir_short': s_eir_short,\n        's_corr_idx': s_corr_idx,\n\
          \        's_flow_putcrowd': s_flow_putcrowd\n    }\n    \n    return signals\n\
          \ndef calculate_scores(signals: dict, env_vars: dict) -> dict:\n    \"\"\
          \"è®¡ç®—LongVolScoreå’ŒShortVolScore\"\"\"\n    \n    # åšå¤šæ³¢åŠ¨ç‡æƒé‡\n    w_vrp_long\
          \ = float(env_vars.get('WEIGHT_VRP_LONG', 0.25))\n    w_gex_long = float(env_vars.get('WEIGHT_GEX_LONG',\
          \ 0.18))\n    w_vex_long = float(env_vars.get('WEIGHT_VEX_LONG', 0.18))\n\
          \    w_carry_long = float(env_vars.get('WEIGHT_CARRY_LONG', 0.08))\n   \
          \ w_skew_long = float(env_vars.get('WEIGHT_SKEW_LONG', 0.08))\n    \n  \
          \  # LongVolScore\n    long_vol_score = (\n        w_vrp_long * signals['s_vrp']\
          \ +\n        w_gex_long * signals['s_gex'] +\n        w_vex_long * signals['s_vex']\
          \ +\n        w_carry_long * signals['s_carry'] +\n        w_skew_long *\
          \ signals['s_skew'] +\n        0.05 * signals['s_vanna'] +\n        0.06\
          \ * signals['s_rv'] +\n        0.10 * signals['s_liq'] +\n        0.07 *\
          \ signals['s_vov'] +\n        0.05 * signals['s_vix_ts'] +\n        0.05\
          \ * signals['s_rim'] +\n        0.05 * signals['s_compress'] +\n       \
          \ 0.04 * signals['s_eir_long']\n    )\n    \n    # åšç©ºæ³¢åŠ¨ç‡æƒé‡\n    w_vrp_short\
          \ = float(env_vars.get('WEIGHT_VRP_SHORT', 0.30))\n    w_gex_short = float(env_vars.get('WEIGHT_GEX_SHORT',\
          \ 0.12))\n    w_carry_short = float(env_vars.get('WEIGHT_CARRY_SHORT', 0.18))\n\
          \    \n    # ShortVolScore\n    short_vol_score = (\n        w_vrp_short\
          \ * (-signals['s_vrp']) +\n        w_gex_short * (-signals['s_gex']) +\n\
          \        0.12 * (-signals['s_vex']) +\n        w_carry_short * (-signals['s_carry'])\
          \ +\n        0.08 * (-signals['s_skew']) +\n        0.05 * (-signals['s_rv'])\
          \ +\n        0.10 * signals['s_liq'] +\n        0.07 * (-signals['s_vov'])\
          \ +\n        0.05 * (-signals['s_vix_ts']) +\n        0.05 * (-signals['s_rim'])\
          \ +\n        0.05 * (-signals['s_compress']) +\n        0.06 * signals['s_eir_short']\
          \ +\n        0.05 * signals['s_corr_idx'] +\n        0.04 * signals['s_flow_putcrowd']\n\
          \    )\n    \n    return {\n        'long_vol_score': round(long_vol_score,\
          \ 3),\n        'short_vol_score': round(short_vol_score, 3),\n        'score_breakdown':\
          \ {\n            'long': {\n                'vrp': round(w_vrp_long * signals['s_vrp'],\
          \ 3),\n                'gex': round(w_gex_long * signals['s_gex'], 3),\n\
          \                'vex': round(w_vex_long * signals['s_vex'], 3),\n     \
          \           'carry': round(w_carry_long * signals['s_carry'], 3),\n    \
          \            'skew': round(w_skew_long * signals['s_skew'], 3)\n       \
          \     },\n            'short': {\n                'vrp': round(w_vrp_short\
          \ * (-signals['s_vrp']), 3),\n                'gex': round(w_gex_short *\
          \ (-signals['s_gex']), 3),\n                'carry': round(w_carry_short\
          \ * (-signals['s_carry']), 3)\n            }\n        }\n    }\n\ndef main(features_output:\
          \ str, **env_vars) -> dict:\n    \"\"\"ä¸»å‡½æ•°\"\"\"\n    try:\n        data\
          \ = json.loads(features_output)\n        features = data.get('features',\
          \ {})\n        \n        signals = calculate_signals(features, env_vars)\n\
          \        scores = calculate_scores(signals, env_vars)\n        \n      \
          \  result = {\n            'symbol': data.get('symbol', ''),\n         \
          \   'timestamp': data.get('timestamp', ''),\n            'signals': signals,\n\
          \            'scores': scores,\n            'status': 'success'\n      \
          \  }\n        \n        return {'result': json.dumps(result, ensure_ascii=False,\
          \ indent=2)}\n        \n    except Exception as e:\n        return {'result':\
          \ json.dumps({\n            'error': True,\n            'message': str(e)\n\
          \        }, ensure_ascii=False)}"
        code_language: python3
        desc: 'è®¡ç®— LongVolScore & ShortVolScore #5001'
        outputs:
          result:
            children: null
            type: string
        selected: false
        title: CODE2 ä¿¡å·æ‰“åˆ†
        type: code
        variables:
        - value_selector:
          - '4001'
          - result
          value_type: string
          variable: features_output
      height: 96
      id: '5001'
      position:
        x: 1919
        y: 429.42252683918616
      positionAbsolute:
        x: 1919
        y: 429.42252683918616
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: 'æ ¡å‡†åšå¤š/åšç©ºæ³¢åŠ¨ç‡æ¦‚ç‡  #6001'
        model:
          completion_params:
            temperature: 0.7
          mode: chat
          name: Qwen3-8B
          provider: langgenius/openai_api_compatible/openai_api_compatible
        prompt_template:
        - id: 5f6d5256-8eb9-47f2-9e69-dc9c273030cb
          role: system
          text: "ä½ æ˜¯æ¦‚ç‡æ ¡å‡†Agentï¼Œè´Ÿè´£å°†LongVolScore/ShortVolScoreè½¬åŒ–ä¸ºå¯ä¿¡æ¦‚ç‡ã€‚\n             \
            \   \nã€ä»»åŠ¡ã€‘\n1. æ ¹æ®è¯„åˆ†è®¡ç®—åšå¤š/åšç©ºæ³¢åŠ¨ç‡çš„æ¦‚ç‡\n2. åº”ç”¨ä¸‰åˆ†ç±»å†³ç­–é—¨æ§›\n3. åˆ¤å®šæœ€ç»ˆæ–¹å‘\n\n\nã€è¾“å…¥æ•°æ®ã€‘\n\
            è¯„åˆ†ç»“æœ: {{#5001.result#}}\n\n\nã€æ¦‚ç‡æ ‡å®šæ–¹æ³•ã€‘\né‡‡ç”¨å†·å¯åŠ¨å…ˆéªŒï¼ˆåç»­å¯ç”¨å†å²å›æµ‹ä¼˜åŒ–ï¼‰ï¼š\n\n\n**åšå¤šæ³¢åŠ¨ç‡æ¦‚ç‡\
            \ p_long(L)**:\n- L >= 2.0 â†’ p_long â‰ˆ 0.65-0.70 (high confidence)\n- L\
            \ >= 1.5 â†’ p_long â‰ˆ 0.60-0.65 (medium confidence)\n- L >= 1.0 â†’ p_long\
            \ â‰ˆ 0.55-0.60 (medium confidence)\n- L < 1.0 â†’ p_long < 0.55 (low confidence)\n\
            \n\n**åšç©ºæ³¢åŠ¨ç‡æ¦‚ç‡ p_short(S)**:\n- S >= 2.0 â†’ p_short â‰ˆ 0.65-0.70 (high confidence)\n\
            - S >= 1.5 â†’ p_short â‰ˆ 0.60-0.65 (medium confidence)\n- S >= 1.0 â†’ p_short\
            \ â‰ˆ 0.55-0.60 (medium confidence)\n- S < 1.0 â†’ p_short < 0.55 (low confidence)\n\
            \n\nã€ä¸‰åˆ†ç±»å†³ç­–é—¨æ§›ã€‘\n**åšå¤šæ³¢åŠ¨ç‡**:\n- L >= {{#env.DECISION_THRESHOLD_LONG#}} \n\
            - AND S <= 0.30\n- AND p_long >= {{#env.PROB_THRESHOLD#}}\n- ä¼˜é€‰: L >=\
            \ 1.5 AND p_long >= 0.60\n\n\n**åšç©ºæ³¢åŠ¨ç‡**:\n- S >= {{#env.DECISION_THRESHOLD_SHORT#}}\n\
            - AND L <= 0.30\n- AND p_short >= {{#env.PROB_THRESHOLD#}}\n- ä¼˜é€‰: S >=\
            \ 1.5 AND p_short >= 0.60\n\n\n**è§‚æœ›**:\n- ä¸æ»¡è¶³ä¸Šè¿°ä»»ä¸€æ¡ä»¶\n\n\nã€è¾“å‡ºJSONã€‘\nä¸¥æ ¼æŒ‰schemaè¾“å‡ºï¼ŒåŒ…å«ï¼š\n\
            - probability_calibration: æ¦‚ç‡æ ‡å®šç»“æœ\n- decision_gate: å†³ç­–é—¨æ§ç»“æœ"
        - id: ca246e78-10d2-4457-aa10-310b75dc93fd
          role: user
          text: è¯·æ ¹æ®è¯„åˆ†ç»“æœè¿›è¡Œæ¦‚ç‡æ ¡å‡†ï¼š {{#5001.result#}}
        selected: false
        structured_output:
          schema:
            properties:
              decision_gate:
                properties:
                  final_direction:
                    description: æœ€ç»ˆæ–¹å‘åˆ¤å®š
                    enum:
                    - åšå¤šæ³¢åŠ¨ç‡
                    - åšç©ºæ³¢åŠ¨ç‡
                    - è§‚æœ›
                    type: string
                  gate_check:
                    properties:
                      conflict_check:
                        type: string
                      long_score_check:
                        type: string
                      prob_check:
                        type: string
                      short_score_check:
                        type: string
                    type: object
                  long_vol_pass:
                    description: åšå¤šæ³¢åŠ¨ç‡æ˜¯å¦é€šè¿‡é—¨æ§›
                    type: boolean
                  short_vol_pass:
                    description: åšç©ºæ³¢åŠ¨ç‡æ˜¯å¦é€šè¿‡é—¨æ§›
                    type: boolean
                required:
                - long_vol_pass
                - short_vol_pass
                - final_direction
                type: object
              probability_calibration:
                properties:
                  confidence:
                    description: æ¦‚ç‡ç½®ä¿¡åº¦
                    enum:
                    - high
                    - medium
                    - low
                    type: string
                  method:
                    description: æ¦‚ç‡æ ‡å®šæ–¹æ³•
                    enum:
                    - å†·å¯åŠ¨å…ˆéªŒ
                    - å†å²å›æµ‹
                    - Platt_scaling
                    type: string
                  p_long:
                    description: åšå¤šæ³¢åŠ¨ç‡æ¦‚ç‡
                    maximum: 1
                    minimum: 0
                    type: number
                  p_short:
                    description: åšç©ºæ³¢åŠ¨ç‡æ¦‚ç‡
                    maximum: 1
                    minimum: 0
                    type: number
                  rationale:
                    description: æ¦‚ç‡åˆ¤æ–­ç†ç”±
                    type: string
                required:
                - p_long
                - p_short
                - method
                type: object
              symbol:
                type: string
            required:
            - symbol
            - probability_calibration
            - decision_gate
            type: object
        structured_output_enabled: true
        title: Agent 6 æ¦‚ç‡æ ¡å‡†
        type: llm
        vision:
          enabled: false
      height: 116
      id: '6001'
      position:
        x: 2221
        y: 429.42252683918616
      positionAbsolute:
        x: 2221
        y: 429.42252683918616
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: '#7001 æ ¹æ®å†³ç­–æ–¹å‘ç”Ÿæˆå¯æ‰§è¡Œç­–ç•¥'
        model:
          completion_params:
            temperature: 0.7
          mode: chat
          name: Qwen3-8B
          provider: langgenius/openai_api_compatible/openai_api_compatible
        prompt_template:
        - id: 6e42fee5-6ac5-45cf-9589-6e6ff02d8e47
          role: system
          text: "ä½ æ˜¯ç­–ç•¥æ˜ å°„Agentï¼Œæ ¹æ®å†³ç­–æ–¹å‘ç”Ÿæˆå¯æ‰§è¡Œçš„æœŸæƒç­–ç•¥ã€‚\n                \nã€ä»»åŠ¡ã€‘\n1. æ ¹æ®decision_gateçš„final_directioné€‰æ‹©ç­–ç•¥ç±»å‹\n\
            2. ç”Ÿæˆä¸‰æ¡£ç­–ç•¥ï¼ˆè¿›å–/å‡è¡¡/ä¿å®ˆï¼‰\n3. ä¼°ç®—æ¯ä¸ªç­–ç•¥çš„èƒœç‡ã€ç›ˆäºæ¯”ã€æœŸæœ›æ”¶ç›Š\n4. ç¡®ä¿æ‰€æœ‰ç­–ç•¥æ»¡è¶³Edgeé—¨æ§›\n\n\nã€è¾“å…¥æ•°æ®ã€‘\n\
            - æ¦‚ç‡æ ¡å‡†ç»“æœ: {{#6001.structured_output#}}\n- æ ¸å¿ƒå­—æ®µ: {{#3001.structured_output.core_fields#}}\n\
            - ç‰¹å¾: {{#4001.result#}}\n\n\nã€ç­–ç•¥æ˜ å°„è§„åˆ™ã€‘\n\n\n## åšå¤šæ³¢åŠ¨ç‡ç­–ç•¥\n\n\n### è¿›å–ç‰ˆï¼ˆç›ˆäºæ¯”â‰¥2:1ï¼‰\n\
            **Long Straddle/Strangle**:\n- DTE: äº‹ä»¶5-20Dï¼›éäº‹ä»¶30-45D\n- è¡Œæƒ: ä¹°ATM straddleï¼›è‹¥strangleç”¨30-35Î”ä¸¤ç¿¼\n\
            - å…¥åœº: 5-15åˆ†é’Ÿrealizedâ‰¥impliedÃ—0.6ï¼Œä¸”Spot<VOL_TRIGGERæˆ–åˆšä¸‹ç ´è§¦å‘çº¿\n- é€€å‡º: RV/IVå›å½’ã€RRè¾¾æ ‡ã€é‡è¿”è§¦å‘çº¿ä¹‹ä¸Šã€è§¦åŠåå‘gamma\
            \ wall\n\n\n**Bull Call Spread**ï¼ˆè¶‹åŠ¿åšå¤šï¼‰:\n- DTE: 14-35D\n- è·¯å¾„: buy {25-35Î”}\
            \ call / sell {é˜»åŠ›ä½æˆ–gamma wallé™„è¿‘} call\n- ç®¡ç†: ç›ˆåˆ©é”å®š50-70%ä»·å·®å®½åº¦ï¼›å¤±æ•ˆå›è½è‡³å£å’ä¸‹ä¸”RIM<0.4\n\
            \n\n### å‡è¡¡ç‰ˆï¼ˆç›ˆäºæ¯”1.2-1.8:1ï¼‰\n**Calendar/Diagonal**:\n- è·¯å¾„: sellè¿‘æœˆATMï¼›buyæ¬¡è¿‘æœˆåŒ/ç•¥å¤–ä»·\n\
            - æ¡ä»¶: TermSlopeâ‰¤0æˆ–äº‹ä»¶å‘¨æŠ¬å‡åé¢„æœŸå›è½\n\n\n**Debit Vertical**:\n- Bull call: buy\
            \ {Î”â‰ˆ0.35} call / sell {Î”â‰ˆ0.15-0.20} call\n\n\n### ä¿å®ˆç‰ˆï¼ˆç›ˆäºæ¯”0.8-1.2:1ï¼Œé«˜èƒœç‡ï¼‰\n\
            ä»…åœ¨åšå¤šæ³¢åŠ¨ç‡æ—¶ä¸æ¨èä¿å®ˆç‰ˆ\n\n\n## åšç©ºæ³¢åŠ¨ç‡ç­–ç•¥\n\n\n### ä¿å®ˆç‰ˆï¼ˆä¼˜å…ˆï¼ŒRR 0.8-1.2:1ï¼‰\n**Iron Condor\
            \ / Short Strangle**:\n- DTE: 14-45Dï¼›äº‹ä»¶åT-T+1ä¼˜å…ˆ\n- è·¯å¾„: sell {10-20Î”} call\
            \ / sell {10-20Î”} putï¼›ä¿æŠ¤ç¿¼buy {3-5Î”}\n- æ¡ä»¶: Spotâ‰¥VOL_TRIGGERã€GammaWallProxâ‰¤0.5-1.0%ã€RIMâ‰¤0.4\n\
            - ç®¡ç†: æ”¶å–50-70%ä¿¡ç”¨é¢å³äº†ç»“ï¼›è·Œç ´è§¦å‘çº¿æˆ–çªç ´gamma wallç«‹å³å‡ä»“\n\n\n**ATM/Near-ATM Credit\
            \ Spread**:\n- è´´æ­£å£å’Â±0.5%-1.0%ï¼Œå®½åº¦æŒ‰1.0-1.5Ã—ATR\n\n\n### å‡è¡¡ç‰ˆ\n**Credit Vertical**:\n\
            - è´´å¢™æ”¶ç§Ÿï¼Œå®½åº¦é€‚ä¸­\n\n\nã€Edgeä¼°ç®—ã€‘\nå¯¹æ¯ä¸ªç­–ç•¥ä¼°ç®—ï¼š\n- win_rate: åŸºäºp_long/p_shortå’Œç­–ç•¥ç±»å‹è°ƒæ•´\n\
            \    - Straddle/Strangle: win_rate = p_long Ã— 0.9\n    - Credit Spread:\
            \ win_rate = p_short Ã— 1.1ï¼ˆä½†æœ€é«˜0.75ï¼‰\n- rr_ratio: æ ¹æ®ç­–ç•¥ç»“æ„\n    - Straddle:\
            \ \"2:1\" ~ \"3:1\"\n    - Credit Spread: \"1:2\" ~ \"1:3\"\n- ev: å¿«é€Ÿè¿‘ä¼¼\n\
            \    - Long straddle: (RV - IV) Ã— vega - carry - æˆæœ¬\n    - Credit spread:\
            \ ä¿¡ç”¨é¢ - P(è§¦ç¢°) Ã— äºæŸé¢ - æˆæœ¬\n- meets_threshold: EV>0 AND RRâ‰¥{{#env.EDGE_RR_THRESHOLD#}}\n\
            \n\nã€å…³é”®çº¦æŸã€‘\n1. æ‰€æœ‰ç­–ç•¥å¿…é¡»æ˜ç¡®DTEã€è¡Œæƒä»·ï¼ˆç”¨Î”æˆ–è·ç¦»è¡¨ç¤ºï¼‰ã€å…¥åœºæ¡ä»¶ã€é€€å‡ºè§„åˆ™\n2. å¿…é¡»å¼•ç”¨VOL_TRIGGERã€Gamma\
            \ Wallç­‰å…³é”®ä½\n3. Edgeä¼°ç®—å¿…é¡»åŒ…å«èƒœç‡ã€ç›ˆäºæ¯”ã€EV\n4. ä»…è¾“å‡ºæ»¡è¶³Edgeé—¨æ§›çš„ç­–ç•¥\n\n\nã€è¾“å‡ºJSONã€‘\n\
            ä¸¥æ ¼æŒ‰schemaè¾“å‡ºï¼Œstrategiesæ•°ç»„åŒ…å«1-3ä¸ªç­–ç•¥æ–¹æ¡ˆ"
        - id: e2470e2c-3e7a-49a3-8a5b-7e5c3c4a73ed
          role: user
          text: 'è¯·ç”Ÿæˆç­–ç•¥æ–¹æ¡ˆã€‚

            ã€æ•°æ®æ±‡æ€»ã€‘

            æ ¸å¿ƒå­—æ®µ: {{#3001.structured_output.core_fields#}}

            ç‰¹å¾: {{#4001.result#}}

            ä¿¡å·è¯„åˆ†: {{#5001.result#}}

            æ¦‚ç‡æ ¡å‡†: {{#6001.structured_output#}}"'
        selected: false
        structured_output:
          schema:
            properties:
              direction:
                enum:
                - åšå¤šæ³¢åŠ¨ç‡
                - åšç©ºæ³¢åŠ¨ç‡
                - è§‚æœ›
                type: string
              strategies:
                items:
                  properties:
                    description:
                      type: string
                    dte:
                      type: string
                    edge_estimate:
                      properties:
                        ev:
                          type: string
                        ev_numeric:
                          type: number
                        meets_threshold:
                          type: boolean
                        note:
                          type: string
                        rr_ratio:
                          type: string
                        win_rate:
                          type: string
                      required:
                      - win_rate
                      - rr_ratio
                      - ev
                      type: object
                    entry:
                      properties:
                        condition:
                          type: string
                        timing:
                          type: string
                        trigger:
                          type: string
                      type: object
                    exit:
                      properties:
                        profit_target:
                          type: string
                        regime_change:
                          type: string
                        stop_loss:
                          type: string
                        time_decay:
                          type: string
                      type: object
                    legs:
                      items:
                        properties:
                          action:
                            type: string
                          delta:
                            type: string
                          rationale:
                            type: string
                          strike:
                            type: string
                          type:
                            type: string
                        type: object
                      type: array
                    structure:
                      type: string
                    tier:
                      enum:
                      - è¿›å–ç‰ˆ
                      - å‡è¡¡ç‰ˆ
                      - ä¿å®ˆç‰ˆ
                      type: string
                  required:
                  - tier
                  - structure
                  - dte
                  - legs
                  - entry
                  - exit
                  - edge_estimate
                  type: object
                type: array
              symbol:
                type: string
            required:
            - symbol
            - direction
            - strategies
            type: object
        structured_output_enabled: true
        title: Agent 7 ç­–ç•¥æ˜ å°„
        type: llm
        vision:
          enabled: false
      height: 116
      id: '7001'
      position:
        x: 2523
        y: 429.42252683918616
      positionAbsolute:
        x: 2523
        y: 429.42252683918616
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: '{{#8001.text#}}'
        selected: false
        title: è¾“å‡ºæœ€ç»ˆæŠ¥å‘Š
        type: answer
        variables: []
      height: 104
      id: '8002'
      position:
        x: 3757.7450272723518
        y: 457.8640140662676
      positionAbsolute:
        x: 3757.7450272723518
        y: 457.8640140662676
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "\nimport json\nimport numpy as np\nfrom scipy.stats import norm\nfrom\
          \ scipy.optimize import brentq\n\n\ndef bs_delta(S, K, T, r, sigma, option_type):\n\
          \    \"\"\"Black-Scholes Delta\"\"\"\n    if T <= 0:\n        return 1.0\
          \ if (option_type == 'call' and S > K) else 0.0\n    \n    d1 = (np.log(S/K)\
          \ + (r + 0.5*sigma**2)*T) / (sigma*np.sqrt(T))\n    \n    if option_type\
          \ == 'call':\n        return norm.cdf(d1)\n    else:  # put\n        return\
          \ norm.cdf(d1) - 1\n\n\ndef find_strike_by_delta(S, target_delta, T, r,\
          \ sigma, option_type):\n    \"\"\"åæ¨æ»¡è¶³ç›®æ ‡Deltaçš„è¡Œæƒä»·\"\"\"\n    def objective(K):\n\
          \        return bs_delta(S, K, T, r, sigma, option_type) - target_delta\n\
          \    \n    # æœç´¢èŒƒå›´:ç°ä»·çš„ 50%-150%\n    try:\n        strike = brentq(objective,\
          \ S * 0.5, S * 1.5)\n        return round(strike, 2)\n    except:\n    \
          \    # å¤‡ç”¨:çº¿æ€§è¿‘ä¼¼\n        if option_type == 'call':\n            return round(S\
          \ * (1 + (0.5 - target_delta) * 0.3), 2)\n        else:\n            return\
          \ round(S * (1 - (0.5 - abs(target_delta)) * 0.3), 2)\n\n\ndef calculate_strikes_from_strategy(strategy,\
          \ core_fields, env_vars):\n    \"\"\"ä¸ºå•ä¸ªç­–ç•¥è®¡ç®—æ‰€æœ‰è¡Œæƒä»·\"\"\"\n    spot = core_fields.get('spot',\
          \ 0)\n    gamma_wall = core_fields.get('gamma_wall', spot)\n    call_wall\
          \ = core_fields.get('call_wall', spot * 1.05)\n    put_wall = core_fields.get('put_wall',\
          \ spot * 0.95)\n    iv_atm = core_fields.get('iv_event_w_atm', 0.25)\n \
          \   \n    # è§£æ DTE\n    dte_str = strategy.get('dte', '30å¤©')\n    dte =\
          \ int(''.join(filter(str.isdigit, dte_str)))\n    T = dte / 365\n    r =\
          \ float(env_vars.get('RISK_FREE_RATE', 0.05))\n    \n    # ä»ç¯å¢ƒå˜é‡è·å–é˜ˆå€¼\n \
          \   gamma_wall_prox = float(env_vars.get('GAMMA_WALL_PROX_THRESHOLD', 0.5))\
          \ / 100\n    \n    updated_legs = []\n    \n    for leg in strategy.get('legs',\
          \ []):\n        leg_copy = leg.copy()\n        action = leg.get('action',\
          \ '')\n        option_type = leg.get('type', '')\n        delta_str = leg.get('delta',\
          \ '')\n        strike_desc = leg.get('strike', '')\n        \n        strike_calculated\
          \ = None\n        method_used = None\n        \n        # æ–¹æ³•1: Delta æ³•\n\
          \        if 'Î”' in delta_str or 'delta' in delta_str.lower():\n        \
          \    try:\n                target_delta = float(delta_str.replace('Î”', '').replace('delta',\
          \ '').strip())\n                if option_type == 'put' and target_delta\
          \ > 0:\n                    target_delta = -target_delta\n             \
          \   \n                strike_calculated = find_strike_by_delta(\n      \
          \              spot, target_delta, T, r, iv_atm, option_type\n         \
          \       )\n                method_used = 'delta_method'\n            except:\n\
          \                pass\n        \n        # æ–¹æ³•2: å£å’æ³•\n        if strike_calculated\
          \ is None and ('wall' in strike_desc.lower() or 'å£å’' in strike_desc):\n\
          \            if 'gamma' in strike_desc.lower():\n                if action\
          \ == 'sell':\n                    # å–æ–¹:è´´å¢™å¤–ä¾§\n                    strike_calculated\
          \ = round(gamma_wall * (1 - gamma_wall_prox), 2)\n                else:\n\
          \                    strike_calculated = round(gamma_wall, 2)\n        \
          \        method_used = 'barrier_method_gamma'\n            \n          \
          \  elif 'call' in strike_desc.lower():\n                strike_calculated\
          \ = round(call_wall * (1 - gamma_wall_prox), 2)\n                method_used\
          \ = 'barrier_method_call'\n            \n            elif 'put' in strike_desc.lower():\n\
          \                strike_calculated = round(put_wall * (1 + gamma_wall_prox),\
          \ 2)\n                method_used = 'barrier_method_put'\n        \n   \
          \     # æ–¹æ³•3: ATR æ³•(éœ€è¦ ATR æ•°æ®)\n        if strike_calculated is None and\
          \ 'atr' in strike_desc.lower():\n            # å‡è®¾ ATR ä¸ºç°ä»·çš„ 2%(å®é™…åº”ä»æ•°æ®è·å–)\n\
          \            atr = spot * 0.02\n            multiplier = 1.5\n         \
          \   \n            if option_type == 'call':\n                strike_calculated\
          \ = round(spot + atr * multiplier, 2)\n            else:\n             \
          \   strike_calculated = round(spot - atr * multiplier, 2)\n            method_used\
          \ = 'atr_method'\n        \n        # æ–¹æ³•4: ç™¾åˆ†æ¯”æ³•(æè¿°ä¸­æœ‰ Â±x%)\n        if strike_calculated\
          \ is None:\n            import re\n            pct_match = re.search(r'([+-]?\\\
          d+\\.?\\d*)%', strike_desc)\n            if pct_match:\n               \
          \ pct = float(pct_match.group(1)) / 100\n                strike_calculated\
          \ = round(spot * (1 + pct), 2)\n                method_used = 'percentage_method'\n\
          \        \n        # å…œåº•: ä½¿ç”¨ ATM\n        if strike_calculated is None:\n\
          \            strike_calculated = round(spot, 2)\n            method_used\
          \ = 'atm_fallback'\n        \n        leg_copy['strike_calculated'] = strike_calculated\n\
          \        leg_copy['calculation_method'] = method_used\n        updated_legs.append(leg_copy)\n\
          \    \n    strategy['legs'] = updated_legs\n    return strategy\n\n\ndef\
          \ main(strategies_json: str, core_fields_json: str, **env_vars) -> dict:\n\
          \    \"\"\"ä¸»å‡½æ•°\"\"\"\n    try:\n        strategies_data = json.loads(strategies_json)\n\
          \        \n        # å…¼å®¹å¤„ç†:å¯èƒ½æ˜¯dictæˆ–ç›´æ¥æ˜¯list\n        if isinstance(strategies_data,\
          \ dict):\n            strategies = strategies_data.get('strategies', [])\n\
          \            symbol = strategies_data.get('symbol', '')\n            direction\
          \ = strategies_data.get('direction', '')\n        else:\n            strategies\
          \ = strategies_data\n            symbol = ''\n            direction = ''\n\
          \        \n        # core_fieldså¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–dict\n        if isinstance(core_fields_json,\
          \ str):\n            core_fields_data = json.loads(core_fields_json)\n \
          \       else:\n            core_fields_data = core_fields_json\n       \
          \ \n        core_fields = core_fields_data.get('core_fields', core_fields_data)\n\
          \        \n        updated_strategies = []\n        for strategy in strategies:\n\
          \            updated_strategy = calculate_strikes_from_strategy(\n     \
          \           strategy, core_fields, env_vars\n            )\n           \
          \ updated_strategies.append(updated_strategy)\n        \n        result\
          \ = {\n            'symbol': symbol,\n            'direction': direction,\n\
          \            'strategies_with_strikes': updated_strategies,\n          \
          \  'status': 'success'\n        }\n        \n        return {'result': json.dumps(result,\
          \ ensure_ascii=False, indent=2)}\n    \n    except Exception as e:\n   \
          \     return {'result': json.dumps({\n            'error': True,\n     \
          \       'message': str(e)\n        }, ensure_ascii=False)}\n"
        code_language: python3
        desc: '#7002 ''è®¡ç®—å…·ä½“è¡Œæƒä»·(Î”æ³•/å£å’æ³•/ATRæ³•)'''
        outputs:
          result:
            children: null
            type: string
        selected: false
        title: CODE3 è¡Œæƒä»·è®¡ç®—
        type: code
        variables:
        - value_selector:
          - '7001'
          - structured_output
          value_type: object
          variable: strategies_json
        - value_selector:
          - '3001'
          - structured_output
          value_type: object
          variable: core_fields_json
      height: 96
      id: '7002'
      position:
        x: 2834.3952073467954
        y: 429.42252683918616
      positionAbsolute:
        x: 2834.3952073467954
        y: 429.42252683918616
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport numpy as np\nfrom scipy.stats import norm\nfrom\
          \ scipy.optimize import brentq\n\n\ndef bs_delta(S, K, T, r, sigma, option_type):\n\
          \    \"\"\"Black-Scholes Delta\"\"\"\n    if T <= 0:\n        return 1.0\
          \ if (option_type == 'call' and S > K) else 0.0\n    \n    d1 = (np.log(S/K)\
          \ + (r + 0.5*sigma**2)*T) / (sigma*np.sqrt(T))\n    \n    if option_type\
          \ == 'call':\n        return norm.cdf(d1)\n    else:  # put\n        return\
          \ norm.cdf(d1) - 1\n\n\ndef find_strike_by_delta(S, target_delta, T, r,\
          \ sigma, option_type):\n    \"\"\"åæ¨æ»¡è¶³ç›®æ ‡Deltaçš„è¡Œæƒä»·\"\"\"\n    def objective(K):\n\
          \        return bs_delta(S, K, T, r, sigma, option_type) - target_delta\n\
          \    \n    # æœç´¢èŒƒå›´:ç°ä»·çš„ 50%-150%\n    try:\n        strike = brentq(objective,\
          \ S * 0.5, S * 1.5)\n        return round(strike, 2)\n    except:\n    \
          \    # å¤‡ç”¨:çº¿æ€§è¿‘ä¼¼\n        if option_type == 'call':\n            return round(S\
          \ * (1 + (0.5 - target_delta) * 0.3), 2)\n        else:\n            return\
          \ round(S * (1 - (0.5 - abs(target_delta)) * 0.3), 2)\n\n\ndef calculate_strikes_from_strategy(strategy,\
          \ core_fields, env_vars):\n    \"\"\"ä¸ºå•ä¸ªç­–ç•¥è®¡ç®—æ‰€æœ‰è¡Œæƒä»·\"\"\"\n    spot = core_fields.get('spot',\
          \ 0)\n    gamma_wall = core_fields.get('gamma_wall', spot)\n    call_wall\
          \ = core_fields.get('call_wall', spot * 1.05)\n    put_wall = core_fields.get('put_wall',\
          \ spot * 0.95)\n    iv_atm = core_fields.get('iv_event_w_atm', 0.25)\n \
          \   \n    # è§£æ DTE\n    dte_str = strategy.get('dte', '30å¤©')\n    dte =\
          \ int(''.join(filter(str.isdigit, dte_str)))\n    T = dte / 365\n    r =\
          \ float(env_vars.get('RISK_FREE_RATE', 0.05))\n    \n    # ä»ç¯å¢ƒå˜é‡è·å–é˜ˆå€¼\n \
          \   gamma_wall_prox = float(env_vars.get('GAMMA_WALL_PROX_THRESHOLD', 0.5))\
          \ / 100\n    \n    updated_legs = []\n    \n    for leg in strategy.get('legs',\
          \ []):\n        leg_copy = leg.copy()\n        action = leg.get('action',\
          \ '')\n        option_type = leg.get('type', '')\n        delta_str = leg.get('delta',\
          \ '')\n        strike_desc = leg.get('strike', '')\n        \n        strike_calculated\
          \ = None\n        method_used = None\n        \n        # æ–¹æ³•1: Delta æ³•\n\
          \        if 'Î”' in delta_str or 'delta' in delta_str.lower():\n        \
          \    try:\n                target_delta = float(delta_str.replace('Î”', '').replace('delta',\
          \ '').strip())\n                if option_type == 'put' and target_delta\
          \ > 0:\n                    target_delta = -target_delta\n             \
          \   \n                strike_calculated = find_strike_by_delta(\n      \
          \              spot, target_delta, T, r, iv_atm, option_type\n         \
          \       )\n                method_used = 'delta_method'\n            except:\n\
          \                pass\n        \n        # æ–¹æ³•2: å£å’æ³•\n        if strike_calculated\
          \ is None and ('wall' in strike_desc.lower() or 'å£å’' in strike_desc):\n\
          \            if 'gamma' in strike_desc.lower():\n                if action\
          \ == 'sell':\n                    # å–æ–¹:è´´å¢™å¤–ä¾§\n                    strike_calculated\
          \ = round(gamma_wall * (1 - gamma_wall_prox), 2)\n                else:\n\
          \                    strike_calculated = round(gamma_wall, 2)\n        \
          \        method_used = 'barrier_method_gamma'\n            \n          \
          \  elif 'call' in strike_desc.lower():\n                strike_calculated\
          \ = round(call_wall * (1 - gamma_wall_prox), 2)\n                method_used\
          \ = 'barrier_method_call'\n            \n            elif 'put' in strike_desc.lower():\n\
          \                strike_calculated = round(put_wall * (1 + gamma_wall_prox),\
          \ 2)\n                method_used = 'barrier_method_put'\n        \n   \
          \     # æ–¹æ³•3: ATR æ³•(éœ€è¦ ATR æ•°æ®)\n        if strike_calculated is None and\
          \ 'atr' in strike_desc.lower():\n            # å‡è®¾ ATR ä¸ºç°ä»·çš„ 2%(å®é™…åº”ä»æ•°æ®è·å–)\n\
          \            atr = spot * 0.02\n            multiplier = 1.5\n         \
          \   \n            if option_type == 'call':\n                strike_calculated\
          \ = round(spot + atr * multiplier, 2)\n            else:\n             \
          \   strike_calculated = round(spot - atr * multiplier, 2)\n            method_used\
          \ = 'atr_method'\n        \n        # æ–¹æ³•4: ç™¾åˆ†æ¯”æ³•(æè¿°ä¸­æœ‰ Â±x%)\n        if strike_calculated\
          \ is None:\n            import re\n            pct_match = re.search(r'([+-]?\\\
          d+\\.?\\d*)%', strike_desc)\n            if pct_match:\n               \
          \ pct = float(pct_match.group(1)) / 100\n                strike_calculated\
          \ = round(spot * (1 + pct), 2)\n                method_used = 'percentage_method'\n\
          \        \n        # å…œåº•: ä½¿ç”¨ ATM\n        if strike_calculated is None:\n\
          \            strike_calculated = round(spot, 2)\n            method_used\
          \ = 'atm_fallback'\n        \n        leg_copy['strike_calculated'] = strike_calculated\n\
          \        leg_copy['calculation_method'] = method_used\n        updated_legs.append(leg_copy)\n\
          \    \n    strategy['legs'] = updated_legs\n    return strategy\n\n\ndef\
          \ main(strategies_json: str, core_fields_json: str, **env_vars) -> dict:\n\
          \    \"\"\"ä¸»å‡½æ•°\"\"\"\n    try:\n        strategies_data = json.loads(strategies_json)\n\
          \        \n        # å…¼å®¹å¤„ç†:å¯èƒ½æ˜¯dictæˆ–ç›´æ¥æ˜¯list\n        if isinstance(strategies_data,\
          \ dict):\n            strategies = strategies_data.get('strategies', [])\n\
          \            symbol = strategies_data.get('symbol', '')\n            direction\
          \ = strategies_data.get('direction', '')\n        else:\n            strategies\
          \ = strategies_data\n            symbol = ''\n            direction = ''\n\
          \        \n        # core_fieldså¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–dict\n        if isinstance(core_fields_json,\
          \ str):\n            core_fields_data = json.loads(core_fields_json)\n \
          \       else:\n            core_fields_data = core_fields_json\n       \
          \ \n        core_fields = core_fields_data.get('core_fields', core_fields_data)\n\
          \        \n        updated_strategies = []\n        for strategy in strategies:\n\
          \            updated_strategy = calculate_strikes_from_strategy(\n     \
          \           strategy, core_fields, env_vars\n            )\n           \
          \ updated_strategies.append(updated_strategy)\n        \n        result\
          \ = {\n            'symbol': symbol,\n            'direction': direction,\n\
          \            'strategies_with_strikes': updated_strategies,\n          \
          \  'status': 'success'\n        }\n        \n        return {'result': json.dumps(result,\
          \ ensure_ascii=False, indent=2)}\n    \n    except Exception as e:\n   \
          \     return {'result': json.dumps({\n            'error': True,\n     \
          \       'message': str(e)\n        }, ensure_ascii=False)}"
        code_language: python3
        desc: '#7003 è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿè®¡ç®— Edge'
        outputs:
          result:
            children: null
            type: string
        selected: false
        title: CODE4 Edgeä¼°ç®—
        type: code
        variables:
        - value_selector:
          - '7002'
          - result
          value_type: string
          variable: strategies_json
        - value_selector:
          - '3001'
          - structured_output
          value_type: object
          variable: core_fields_json
      height: 80
      id: '7003'
      position:
        x: 3135.3512954193734
        y: 429.42252683918616
      positionAbsolute:
        x: 3135.3512954193734
        y: 429.42252683918616
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: '#8001 æ±‡æ€»ç”Ÿæˆæœ€ç»ˆå†³ç­–æŠ¥å‘Š'
        model:
          completion_params:
            temperature: 0.7
          mode: chat
          name: Qwen3-8B
          provider: langgenius/openai_api_compatible/openai_api_compatible
        prompt_template:
        - id: 1faa3cc7-1923-4429-a15a-29ec71e96e59
          role: system
          text: "ä½ æ˜¯æœ€ç»ˆå†³ç­–æŠ¥å‘Šç”ŸæˆAgent,è´Ÿè´£æ±‡æ€»æ‰€æœ‰åˆ†æç»“æœå¹¶ç”Ÿæˆå®Œæ•´çš„å¯æ‰§è¡Œç­–ç•¥æŠ¥å‘Šã€‚\nã€ä»»åŠ¡ã€‘\n1. æ±‡æ€»æ•°æ®æ ¡éªŒã€ç‰¹å¾è®¡ç®—ã€ä¿¡å·æ‰“åˆ†ã€æ¦‚ç‡æ ¡å‡†ã€ç­–ç•¥æ˜ å°„ã€è¡Œæƒä»·è®¡ç®—ã€Edgeä¼°ç®—çš„æ‰€æœ‰ç»“æœ\n\
            2. ç”Ÿæˆç»“æ„åŒ–çš„å†³ç­–æŠ¥å‘Š\n3. åŒ…å«å¸‚åœºçŠ¶æ€ã€æ ¸å¿ƒç»“è®ºã€ä¿¡å·è¯„åˆ†ã€æ¨èç­–ç•¥ã€é£é™©æç¤ºã€ç›‘æ§è¦ç‚¹\nã€è¾“å…¥æ•°æ®ã€‘\n- æ ¸å¿ƒå­—æ®µ: {{#3001.structured_output#}}\n\
            - ç‰¹å¾: {{#4001.result#}}\n- ä¿¡å·è¯„åˆ†: {{#5001.result#}}\n- æ¦‚ç‡æ ¡å‡†: {{#6001.structured_output#}}\n\
            - ç­–ç•¥(å«è¡Œæƒä»·ä¸Edge): {{#7003.result#}}\nã€è¾“å‡ºæ ¼å¼ã€‘\nç”ŸæˆMarkdownæ ¼å¼çš„å†³ç­–æŠ¥å‘Š,åŒ…å«:\n# æ³¢åŠ¨ç‡äº¤æ˜“å†³ç­–æŠ¥å‘Š\n\
            **æ ‡çš„**: {SYMBOL} | **ç°ä»·**: {SPOT} | **VOL TRIGGER**: {VOL_TRIGGER}  \n\
            **åˆ†ææ—¶é—´**: {TIMESTAMP} (ET)\n---\n## 1. æ ¸å¿ƒç»“è®º\n**å†³ç­–æ–¹å‘**: \n{åšå¤šæ³¢åŠ¨ç‡/åšç©ºæ³¢åŠ¨ç‡/è§‚æœ›}\
            \  \n**æ¦‚ç‡**: \n{p_long/p_short} (ç½®ä¿¡åº¦: {high/medium/low})  \n**ä¸»è¦ç†ç”±**:\
            \ \n[å¼•ç”¨VOL TRIGGERåˆ¤æ®ã€VRPã€GEXç­‰æ ¸å¿ƒå› ç´ ]\n---\n## 2. å¸‚åœºçŠ¶æ€\n### Gamma Regime\n\
            - **VOL TRIGGER**: {value}\n- **ç°ä»·ä½ç½®**: {above/below/near} â†’ NET-GEX {positive/negative/neutral}\n\
            - **è§£è¯»**: [è¯´æ˜æ­£/è´ŸGammaå¯¹æ³¢åŠ¨çš„å½±å“]\n### å…³é”®ä½\n- **Gamma Wall**: {value} (è·ç¦»:\
            \ {%})\n- **Call Wall**: {value}\n- **Put Wall**: {value}\n---\n## 3.\
            \ ä¿¡å·è¯„åˆ†\n### åšå¤šæ³¢åŠ¨ç‡è¯„åˆ†: {L}\n**åˆ†è§£**:\n- VRP: {value}\n- GEX: {value}\n- VEX:\
            \ {value}\n- Carry: {value}\n- Skew: {value}\n\n### åšç©ºæ³¢åŠ¨ç‡è¯„åˆ†: {S}\n**åˆ†è§£**:\n\
            - VRP: {value}\n- GEX: {value}\n- Carry: {value}\n\n---\n## 4. æ¨èç­–ç•¥\n\
            [å¯¹æ¯ä¸ªé€šè¿‡Edgeé—¨æ§›çš„ç­–ç•¥]\n### {ä¿å®ˆç‰ˆ/å‡è¡¡ç‰ˆ/è¿›å–ç‰ˆ} - {ç­–ç•¥åç§°}\n\n**æè¿°**: [ç®€è¦è¯´æ˜ç­–ç•¥é€»è¾‘]\n\n\
            **å‚æ•°**:\n- DTE: {dte}å¤©\n- è¡ŒæƒåŒºé—´:\n  - [Leg1]: {action} {strike_calculated}\
            \ {type} ({delta}, {calculation_method})\n  - [Leg2]: ...\n\n**å…¥åœº**:\n\
            - è§¦å‘: [å…·ä½“æ¡ä»¶]\n- æ—¶æœº: [å…·ä½“æ—¶é—´]\n- æ¡ä»¶: [å…¶ä»–çº¦æŸ]\n\n**é€€å‡º**:\n- æ­¢ç›ˆ: [ç›®æ ‡]\n- æ­¢æŸ:\
            \ [æ¡ä»¶]\n- æ—¶é—´: [æœ€æ™šé€€å‡ºæ—¶é—´]\n- Regimeå˜åŒ–: [è§¦å‘æ¡ä»¶]\n\n**Edgeä¼°ç®—**:\n- èƒœç‡: {win_rate}\n\
            - ç›ˆäºæ¯”: {rr_ratio}\n- æœŸæœ›æ”¶ç›Š: {ev}\n- å¹³å‡ç›ˆåˆ©: {avg_win}\n- å¹³å‡äºæŸ: {avg_loss}\n\
            - æœ€å¤§å›æ’¤: {max_drawdown}\n- æ˜¯å¦æ»¡è¶³é—¨æ§›: {âœ…/âŒ}\n\n---\n\n## 5. é£é™©æç¤º\n\n- æµåŠ¨æ€§:\
            \ [Spread_atmè¯„ä¼°]\n- Piné£é™©: [GammaWallProxè¯„ä¼°]\n- 0DTE: å·²è§„é¿\n- äº‹ä»¶é£é™©: [æ˜¯å¦è·¨æœŸ]\n\
            \n---\n## 6. ç›‘æ§è¦ç‚¹\n*å¼ºåŒ–å…³æ³¨**:\n- VOL TRIGGERè·¨è¶Š({value})\n- Gamma Wallçªç ´({value})\n\
            - 5-15åˆ†é’ŸRIMå˜åŒ–\n- Spreadæ‰©å¤§\n**é€€å‡ºè§¦å‘**:\n- Spotç©¿è¶Š{VOL_TRIGGER}(æ–¹å‘)\n- GammaWallProx\
            \ < {threshold}\n- IVæ‰©å¼ >{threshold}\n\n---\n**æŠ¥å‘Šç”Ÿæˆ**: {TIMESTAMP} "
        - role: user
          text: '"è¯·ç”Ÿæˆæœ€ç»ˆå†³ç­–æŠ¥å‘Šã€‚

            ã€æ•°æ®æ±‡æ€»ã€‘

            æ ¸å¿ƒå­—æ®µ: {{#3001.structured_output#}}

            ç‰¹å¾: {{#4001.result#}}

            ä¿¡å·è¯„åˆ†: {{#5001.result#}}

            æ¦‚ç‡æ ¡å‡†: {{#6001.structured_output#}}

            ç­–ç•¥æ–¹æ¡ˆ: {{#7003.result#}}"


            '
        selected: false
        title: Agent 8 æœ€ç»ˆå†³ç­–
        type: llm
        vision:
          enabled: false
      height: 116
      id: '8001'
      position:
        x: 3435.7712127956465
        y: 429.42252683918616
      positionAbsolute:
        x: 3435.7712127956465
        y: 429.42252683918616
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    viewport:
      x: -1256.5539446616135
      y: -45.12527489519948
      zoom: 0.6328782969851434
  rag_pipeline_variables: []
